// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Component","./model/models","sap/ui/model/resource/ResourceModel"],function(C,m,R){"use strict";var I=false;return C.extend("sap.ushell_abap.plugins.fcc-transport-ui.Component",{metadata:{manifest:"json"},init:function(){if(I){return;}I=true;this.setModel(m.createDeviceModel(),"device");var r=new R({bundleName:"sap.ushell_abap.plugins.fcc-transport-ui.i18n.i18n"});sap.ui.getCore().setModel(r,"i18n");var e=sap.ui.getCore().getEventBus();e.subscribe("sap.fcc.services.siteService","beforeSave",function(c,E,s){s.doBeforeSave(this.onBeforeSave,this);}.bind(this));},openDialog:function(M){sap.ui.require(["sap/m/Label","sap/ui/layout/form/GridElementData","sap/m/Input","sap/ui/fl/LrepConnector","sap/ui/model/json/JSONModel","sap/ui/core/ListItem","sap/ui/core/library","sap/m/ComboBox","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/m/Dialog","sap/ui/layout/form/Form","sap/ui/layout/form/GridLayout","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement"],function(L,G,a,b,J,c,d,e,f,T,B,D,F,g,h,i){var V=d.ValueState;var k=jQuery.Deferred(),r=M,l=M.package,n=M.transport;var o=new L({text:"{i18n>LABEL_TITLE_PACKAGE}",layoutData:new G({hCells:"2"})});var p=new a({maxLength:30,layoutData:new G({hCells:"auto"}),change:function(E){M.package=E.getSource().getValue().toUpperCase();E.getSource().setValue(M.package);if(M.package){if(M.package==="$TMP"){M.transport="";w.setEnabled(false);s.setEnabled(false);s.setSelectedKey("");return;}if(!String.prototype.startsWith){String.prototype.startsWith=function(j,P){P=P||0;return this.indexOf(j,P)===P;};}var H="/sap/bc/ui2/cdm_fcc/vhtr",K="GET",N="package="+M.package,O=b.createConnector();O.send(H,K,N,null).then(function(M){var P=[],Q;if(Array.isArray(M.response.transports)){for(var j in M.response.transports){Q=M.response.transports[j];P.push({"transportId":Q.transportid,"description":Q.description});}}else{Q=M.response.transports;P.push({"transportId":Q.transportid,"description":Q.description});}var S=new J();S.setData(P);sap.ui.getCore().setModel(S);s.bindItems("/",new c({key:"{transportId}",text:"{transportId}",additionalText:"{description}"}));M.transport=s.getFirstItem();s.setSelectedItem(M.transport);s.fireChangeEvent(M.transport);p.setValueState(V.None);w.setEnabled(true);s.setEnabled(true);},function(j){jQuery.sap.log.info(JSON.stringify(j));p.setEnabled(true);p.setValueState(V.Error);if(j.code===500){p.setValueStateText(sap.ui.getCore().getModel("i18n").getProperty("ERROR_HTTP500"));}else if(j.code===404){p.setValueStateText(sap.ui.getCore().getModel("i18n").getProperty("ERROR_HTTP404"));}else{p.setValueStateText(sap.ui.getCore().getModel("i18n").getProperty("ERROR_REQUESTFAILED"));}w.setEnabled(false);s.setEnabled(false);s.setSelectedKey("");});}else{M.transport="";s.setEnabled(false);s.setSelectedKey("");}}});var q=new L({text:"{i18n>LABEL_TITLE_TRANSPORT}",layoutData:new G({hCells:"2"})});var s=new e({layoutData:new G({hCells:"auto"}),showSecondaryValues:true,enabled:false,items:{path:"/",template:new c({key:"{transportId}",text:"{transportId}",additionalText:"{description}"})},change:function(E){M.transport=E.getSource().getValue();if(M.transport){w.setEnabled(true);}}});var t=new f({selected:false,layoutData:new G({hCells:"1"}),select:function(){if(t.getSelected()){r.checkboxFlag=true;}else{r.checkboxFlag=false;}}});var u=new T({text:"{i18n>CHKBOX_TXT_BATCHOBJECTS}",tooltip:"{i18n>CHKBOX_TXT_BATCHOBJECTS}",wrapping:true,layoutData:new G({hCells:"auto"})});var v=new B({text:"{i18n>BTN_TITLE_LOCALOBJECT}",tooltip:"{i18n>BTN_TITLE_LOCALOBJECT}",press:function(){r.package="$tmp";r.transport="";A.close();}});var w=new B({text:"{i18n>BTN_TITLE_OK}",tooltip:"{i18n>BTN_TITLE_OK}",enabled:false,press:function(){A.close();}});var x=new B({text:"{i18n>BTN_TITLE_CANCEL}",tooltip:"{i18n>BTN_TITLE_CANCEL}",press:function(){r.package=l;r.transport=n;r.cancelClickedFlag=true;A.close();if(r.operation==="CREATE"){var j=sap.ui.getCore().getEventBus();j.publish("sap.fcc.services.siteService","onCancelCreation");}}});if(M.package){p.setValue(M.package);p.setEnabled(false);v.setEnabled(false);p.fireChangeEvent(M.package);}var y="";if(M.id===""||M.type===""){y="{i18n>DLG_TITLE_DEFAULTNAME}";}else{var z=sap.ui.getCore().getModel("i18n").getResourceBundle();y=z.getText("DLG_TITLE_"+M.type.toUpperCase(),[M.id]);}var A=new D({title:y,resizable:true,draggable:true,content:[new F({width:"400px",editable:true,layout:new g({singleColumn:true}),formContainers:[new h({formElements:[new i({label:o,fields:[p]}),new i({label:q,fields:[s]}),new i({fields:[t,u]})]})]})],buttons:[v,w,x],afterClose:function(){A.destroy();k.resolve(r);}});A.open();return k.promise();});},onBeforeSave:function(c){var t=this;return new jQuery.Deferred(function(d){try{var r=c,M=[],i;for(i in c.BATCH){var a=c.BATCH[i];M[i]={"operation":a.metadata.operation,"id":a.metadata.id,"type":a.metadata.entityType,"package":a.metadata.package,"transport":a.metadata.transportId,"openDialogFlag":false,"checkboxFlag":false,"cancelClickedFlag":false};}for(i=0;i<M.length;i++){if(M[i].operation==="CREATE"){M[i].openDialogFlag=true;}else if(!M[i].package){M[i].openDialogFlag=true;}else if(M[i].package.toUpperCase()==="$TMP"){M[i].openDialogFlag=false;}else if(M[i].package&&!M[i].transport){for(var j=0;j<M.length;j++){if(i!=j&&M[i].package===M[j].package&&M[j].transport){M[i].transport=M[j].transport;r.BATCH[i].metadata.transportId=M[j].transport;break;}else{M[i].openDialogFlag=true;}}}}t.processEntry(t,r,d,M,0);}catch(e){d.reject(e);}}).promise();},processEntry:function(_,r,d,M,i){var l=M.length;while(M[i].openDialogFlag===false){if(i<l-1){i++;}else{break;}}if(M[i].openDialogFlag===true){_.openDialog(M[i]).done(function(a){var j;r.BATCH[i].metadata.package=a.package;r.BATCH[i].metadata.transportId=a.transport;if(a.checkboxFlag===true&&a.package&&a.cancelClickedFlag===false){if(a.operation==="CREATE"&&a.package.toUpperCase()!=="$TMP"){for(j=i+1;j<M.length;j++){if(M[j].type===a.type){r.BATCH[j].metadata.package=a.package;r.BATCH[j].metadata.transportId=a.transport;M[j].openDialogFlag=false;}}}else{for(j=i+1;j<M.length;j++){if(M[j].package===a.package){r.BATCH[j].metadata.transportId=a.transport;M[j].openDialogFlag=false;}}}}if(M[i].cancelClickedFlag===true&&M.length===1){d.reject(sap.ui.getCore().getModel("i18n").getProperty("MSG_SINGLECANCEL"));}else if(++i<M.length){_.processEntry(_,r,d,M,i);}else{var c=0,b=0;for(j=0;j<M.length;j++){if(M[j].openDialogFlag===true){b++;}if(M[j].cancelClickedFlag===true){c++;}}if(b===c){d.reject(sap.ui.getCore().getModel("i18n").getProperty("MSG_ALLPOPUPSCANCELLED"));}else{d.resolve(r);}}}).fail(function(){});}}});});
