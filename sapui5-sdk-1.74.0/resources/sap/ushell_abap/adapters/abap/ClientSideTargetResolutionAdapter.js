// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/isPlainObject","sap/ushell/utils","sap/ui2/srvc/ODataWrapper"],function(q,O,a,u){"use strict";var S="sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter",n=["sap-wd-configId","SAP-WD-CONFIGID","sap-client","SAP-CLIENT","System","SYSTEM","sap-language","SAP-LANGUAGE","sap-wd-htmlrendermode","sap-wd-deltarendering","wdallowvaluesuggest","sap-wd-lightspeed","sap-wd-remotedesktop","sap-wd-flashdebug","sap-accessibility","sap-theme","sap-*","SAP-*","wd*","WD*"];var C=function(s,p,A){var t=this;this._oLocalSystemAlias={http:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},https:{id:"",host:"",port:"",pathPrefix:"/sap/bc/"},rfc:{id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},id:"",client:"",language:""};this.hasSegmentedAccess=true;this._oAdapterConfig=A&&A.config;this._wdLengthLimit=1800;this._oODataWrapper=undefined;this._getODataWrapper=function(){if(!this._oODataWrapper){this._oODataWrapper=sap.ui2.srvc.createODataWrapper("/sap/opu/odata/UI2/INTEROP/");}return this._oODataWrapper;};this._aTargetMappings=[];this._aInbounds=[];this._aInitialSegment=undefined;this._oSystemAliasBuffer=new u.Map();this._storeFromFullStartupResponse=function(f){if(f){if(f.targetMappings){t._aTargetMappings=f.targetMappings;}if(f.systemAliases){t._writeUserSystemAliasesToBuffer(f.systemAliases);}}};this._fallbackToFullStartupRequest=function(r,R){q.sap.log.debug("Falling back to full start_up request from adapter","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._requestAllTargetMappings().done(function(f){t._storeFromFullStartupResponse(f);r();}).fail(function(m){R(m);});};this._iTargetMappingsUnusedPromiseRejectCount=0;this._oInitialSegmentPromise=A&&A.config&&A.config.initialSegmentPromise||(new Promise(function(r,R){t._iTargetMappingsUnusedPromiseRejectCount++;if(t._iTargetMappingsUnusedPromiseRejectCount===2){t._fallbackToFullStartupRequest(r,R);}}));this._oNavTargetPromise=A&&A.config&&A.config.navTargetDataPromise||(new Promise(function(r,R){t._iTargetMappingsUnusedPromiseRejectCount++;if(t._iTargetMappingsUnusedPromiseRejectCount===2){t._fallbackToFullStartupRequest(r,R);}}));this._oInitialSegmentPromise.then(function(b){if(b===null){q.sap.log.debug("Initial target mappings segment promise resolved with 'null'","Will not process initial target mappings segments again (mostly likely because this is no longer needed)","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return;}if(t._aTargetMappings.length===0){q.sap.log.debug("Segmented start_up response returned","storing system aliases and inbounds from segment","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");var r=b[0],T=b[1],c=b[2];t._aTargetMappings=T;t._writeUserSystemAliasesToBuffer(c);t._aInitialSegment=r;}else{q.sap.log.debug("Segmented start_up response returned","ignoring response because the full target mapping response returned before","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");}}).catch(function(r){q.sap.log.error("Initial segment promise was rejected.",r,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");});this._oNavTargetPromise.then(function(f){q.sap.log.debug("Full start_up response returned","storing system aliases and inbounds","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._storeFromFullStartupResponse(f);});};C.prototype.resolveHashFragmentFallback=function(o,i,p){var s=this._constructShellHashForLpdCust(i,p),b=p&&p["sap-system"]&&p["sap-system"][0],d=new q.Deferred();this._resolveHashFragmentBE(s||o).done(function(r){if(r&&b){r["sap-system"]=r["sap-system"]||b;}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};C.prototype.getInbounds=function(s){var d=new q.Deferred(),t=this;this._oInitialSegmentPromise.then(function(i){if(i===null){return;}if(t._isInSegment(s,t._aInitialSegment)){q.sap.log.debug("Got inbounds from initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._aInbounds=t._formatDirectStart(t._aTargetMappings);d.resolve(t._aInbounds);}else{q.sap.log.debug("Did not get inbound in initial segment","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");}});this._oNavTargetPromise.then(function(){q.sap.log.debug("Got inbounds from full start_up response","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._aInbounds=t._formatDirectStart(t._aTargetMappings);t.getInbounds=function(){return new q.Deferred().resolve(t._aInbounds).promise();};d.resolve(t._aInbounds);},function(m){d.reject(m);});return d.promise();};C.prototype._isInSegment=function(s,b){if(!Array.isArray(b)||!Array.isArray(s)){return false;}return s.every(function(e){return!b.every(function(t){return!(e.semanticObject===t.semanticObject&&e.action===t.action);});});};C.prototype._requestAllTargetMappings=function(){var p=sap.ui2.srvc.getParameterMap();var d=new q.Deferred();var r="/sap/bc/ui2/start_up?so=%2A&action=%2A&",c=(O.create("services.targetMappings",this._oAdapterConfig).cacheId&&("&sap-cache-id="+O.create("services.targetMappings",this._oAdapterConfig).cacheId))||"";function b(N){var v=p[N];if(v){r+=N+"="+encodeURIComponent(v[0])+"&";}}b("sap-language");b("sap-client");sap.ui2.srvc.get(r+"&shellType="+sap.ushell_abap.getShellType()+"&depth=0"+c,false,function(N){var o=JSON.parse(N);if(!o){d.reject("Malformed Full TM Result");}d.resolve(o);},function(m){d.reject(m);});return d.promise();};C.prototype._formatDirectStart=function(d){var t=this;if(!d){this._aInitialSegment=undefined;return[];}function m(s,o){var T={};var M=s.match(/^([^-]+)-([^~]+)/);if(!M){q.sap.log.warning("The target mapping id "+s+" is not valid","this target mapping will be discarded","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined;}if(!o.hasOwnProperty("text")){o.text="";}T.semanticObject=M[1];T.action=M[2];T.id=s;T.title=o.text;T.permanentKey="X-SAP-UI2-PAGE:"+o.catalogId+":"+o.tmChipId;var f={};["applicationType","applicationDependencies","applicationData","postParameters","text","url","systemAlias"].forEach(function(p){f[p]=o[p];});T.resolutionResult=sap.ushell_abap.bootstrap.adjustNavTargetResult(f);T.resolutionResult.additionalInformation=T.resolutionResult.additionalInformation||"";T.resolutionResult.appId=T.permanentKey;var r=T.resolutionResult,b=r.applicationType;if(s.indexOf("Shell-startWCF")===0&&b==="URL"){T.resolutionResult.systemAliasSemantics="apply";}T.resolutionResult.applicationType=t._formatApplicationType(s,T.resolutionResult);T.resolutionResult.systemAlias=o.systemAlias||"";T.deviceTypes=o.formfactors;T.resolutionResult["sap.ui"]={};T.resolutionResult["sap.ui"].technology=T.resolutionResult.applicationType;if(T.resolutionResult["sap.ui"].technology==="SAPUI5"){T.resolutionResult["sap.ui"].technology="UI5";}if(T.resolutionResult["sap.ui"].technology==="TR"){T.resolutionResult["sap.ui"].technology="GUI";}if(!T.deviceTypes){T.deviceTypes=o.formFactors||{};}T.deviceTypes.desktop=T.deviceTypes.desktop||false;T.deviceTypes.phone=T.deviceTypes.phone||false;T.deviceTypes.tablet=T.deviceTypes.tablet||false;if(Array.isArray(o.signature)){T.signature={};T.signature.additionalParameters=o.allowParams?"allowed":"ignored";T.signature.parameters={};o.signature.forEach(function(B){var p={};var U;var N=B.name;if(B.defaultValue&&B.defaultValue.value){p.defaultValue={};p.defaultValue.value=B.defaultValue.value;p.defaultValue.format=B.defaultValue.format||"plain";U=t._extractUserDefaultValue(p.defaultValue.value);if(U){p.defaultValue={"value":U,"format":"reference"};}}if(B.filter&&B.filter.value){p.filter={};p.filter.value=B.filter.value;p.filter.format=B.filter.format||"plain";U=t._extractUserDefaultValue(p.filter.value);if(U){p.filter={"value":U,"format":"reference"};}}if(B.renameTo){p.renameTo=B.renameTo;}p.required=B.required||false;T.signature.parameters[N]=p;});}else{T.signature=q.extend(true,{parameters:{}},o.signature);T.signature.additionalParameters=T.signature.additionalParameters||(o.allowParams?"allowed":"ignored");Object.keys(T.signature.parameters).forEach(function(k){var p=T.signature.parameters[k];if(p.filter){p.filter.format=p.filter.format||"plain";}if(p.defaultValue){p.defaultValue.format=p.defaultValue.format||"plain";}p.required=p.required||false;if(p.filter&&p.filter.hasOwnProperty("format")&&!(p.filter.hasOwnProperty("value"))){delete p.filter;}if(p.defaultValue&&p.defaultValue.hasOwnProperty("format")&&!(p.defaultValue.hasOwnProperty("value"))){delete p.defaultValue;}});}var c=T.signature&&T.signature.parameters&&T.signature.parameters["sap-hide-intent-link"];if(c&&c.hasOwnProperty("defaultValue")){T.hideIntentLink=c.defaultValue.value==="true";}if(c&&!c.required&&c.hasOwnProperty("defaultValue")){delete T.signature.parameters["sap-hide-intent-link"];}if(typeof o.parameterMappings==="object"){Object.keys(o.parameterMappings).forEach(function(k){var e=o.parameterMappings[k];if(k&&e.target){T.signature.parameters[k]=T.signature.parameters[k]||{};T.signature.parameters[k].renameTo=e.target;}});}return T;}var R=[];Object.keys(d).forEach(function(k){var r=m(k,d[k]);if(r){R.push(r);}});return R;};C.prototype._formatApplicationType=function(t,r){var A=r.applicationType,U=r.url||"";function l(N,d){q.sap.log.warning("Cannot detect application type for TargetMapping id '"+t+"', will default to "+d+" application type","TargetMapping URL is '"+U+"'",S);}if(A==="SAPUI5"){return"SAPUI5";}if(A==="URL"&&r.additionalInformation&&r.additionalInformation.indexOf("SAPUI5.Component=")===0){return"SAPUI5";}if(A==="WDA"||A==="TR"||A==="WCF"){return A;}if(t.indexOf("Shell-startWCF")===0&&A==="URL"){return"WCF";}if(A==="NWBC"){if(U.indexOf("/~canvas;window=app/wda")>=0){return"WDA";}if(U.indexOf("/~canvas;window=app/transaction")>=0){return"TR";}l(r,"TR");return"TR";}if(A!=="URL"){l(r,"URL");}return"URL";};C.prototype._extractUserDefaultValue=function(s){var r,b=new RegExp("^%%(UserDefault[.].+)%%$"),m=b.exec(s);return m?m[1]:r;};C.prototype._formatSignature=function(o,A){var t=this,r={"parameters":{},"additionalParameters":A===false?"ignored":"allowed"};if(!o.results){return r;}o.results.forEach(function(e){var p,E=e.name,s,U;if(Object.prototype.hasOwnProperty.call(r.parameters,E)){q.sap.log.error("Duplicate property name "+E+" in "+JSON.stringify(o),"sap.ui2.srvc.ClientSideTargetResolutionAdapter._formatSignature");}r.parameters[E]={"required":t._getObjectDefaulting(e,"required",false)};p=r.parameters[E];s=t._getObjectDefaulting(e,"value","");if(e.regexp===true){p.filter={"value":(s===""?".*":s),"format":"regexp"};return;}if(e.required===false){U=t._extractUserDefaultValue(s);if(U){p.defaultValue={"value":U,"format":"reference"};return;}if(s!==""){p.defaultValue={"value":s};}return;}if(e.required===true&&e.value){U=t._extractUserDefaultValue(s);if(U){p.filter={"value":U,"format":"reference"};return;}if(s!==""){p.filter={"value":s};}}});return r;};C.prototype._mergeParameterMappingsIntoSignature=function(s,o){var p=o.results;if(!p){return;}p.forEach(function(P){var b=P.source;var t=P.target;if(t){s.parameters[b]=s.parameters[b]||{};if(s.parameters[b].renameTo){q.sap.log.warning("duplicate parameter mapping for'"+b+"'","OData Parameter mappings is "+JSON.stringify(P,null,"   "),S);}s.parameters[b].renameTo=t;}});};C.prototype._formatDeviceTypes=function(f){var r={},t=this;["desktop","tablet","phone"].forEach(function(p){r[p]=t._getObjectDefaulting(f,p,false);});return r;};C.prototype._getObjectDefaulting=function(r,s,d){var o=O.get(s||"",r);return(o===undefined)?d:o;};C.prototype._constructShellHashForLpdCust=function(i,p){var l="",f,t=q.sap.getObject("resolutionResult._original",2,i);if(!a(t)){f="the given target mapping is not an object";}if(!f&&!t.hasOwnProperty("id")){f="no id found in target mapping _original object";}if(!f&&typeof t.id!=="string"){f="the target mapping id was not a string";}if(!f&&t.id.length===0){f="the target mapping id was an empty string";}if(f){q.sap.log.error("Cannot construct Shell Hash for LPD_CUST resolution",f,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");return undefined;}l+=t.id;var b=sap.ushell.Container.getService("URLParsing").paramsToString(p);if(b.length>0){l+="?"+b;}return l;};C.prototype._openBatchQueueUnlessOpen=function(o){if(o.isBatchQueueOpen()){return false;}o.openBatchQueue();return true;};C.prototype._getShellType=function(){if(sap&&sap.ushell_abap&&typeof sap.ushell_abap.getShellType==="function"){return sap.ushell_abap.getShellType();}return"FLP";};C.prototype._resolveHashFragmentBE=function(f){var d=new q.Deferred(),t=this,b,F=sap.ui2.srvc.getFormFactor();function e(U){return encodeURIComponent(U).replace(/'/g,"''");}b=this._openBatchQueueUnlessOpen(this._getODataWrapper());this._oODataWrapper.read("ResolveLink?linkId='"+e(f)+"'&shellType='"+t._getShellType()+"'"+(F?"&formFactor='"+e(F)+"'":""),function(r){var i,D="",A;if(r.results.length){if(r.results.length>1){for(i=0;i<r.results.length;i+=1){delete r.results[i].__metadata;D+=(i===0?"used target: ":"\nignored target: ")+JSON.stringify(r.results[i]);}q.sap.log.error("INTEROP service's ResolveLink operation "+"returned "+r.results.length+" targets for hash '#"+f+"', first one is used.",D,"sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");}r=r.results[0];A=sap.ushell_abap.bootstrap.adjustNavTargetResult(r);A.url=sap.ushell_abap.bootstrap.addPostParametersToNavTargetResultUrl(r.postParameters,A.url);if(A&&A.applicationType==="SAPUI5"){A.applicationType="URL";}t._compactTooLongWdaUrl(A).done(function(c){d.resolve(c);}).fail(function(m){d.reject("Could not resolve link '"+f+"' due to compactation failure"+m);});}else{d.reject("Could not resolve link '"+f+"'");}},function(m){d.reject(m);});if(b){t._getODataWrapper().submitBatchQueue(function(){},d.reject.bind(d));}return d.promise();};C.prototype._compactTooLongWdaUrl=function(r){var d=new q.Deferred();if(r&&r.applicationType==="NWBC"&&r.url&&r.url.indexOf("/ui2/nwbc/~canvas;window=")===0&&r.url.length>this._getWDAUrlShorteningLengthLimit()){this._compactUrl(r.url).done(function(c){r.url=c;d.resolve(r);}).fail(d.reject.bind(d));return d.promise();}return d.resolve(r).promise();};C.prototype._compactUrl=function(U){var m=U.match(/\?.*/);var o=sap.ushell.Container.getService("URLParsing");if(!(m&&m[0]&&m[0].length>this._getWDAUrlShorteningLengthLimit()-200)){return new q.Deferred().resolve(U).promise();}var p=o.parseParameters(m[0]);var d=new q.Deferred();sap.ushell.Container.getService("ShellNavigation").compactParams(p,n,undefined).done(function(c){var r=U.match(/^[^?]*/)[0]+"?"+o.paramsToString(c);d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};C.prototype._getWDAUrlShorteningLengthLimit=function(){var N=u.getParameterValueBoolean("sap-ushell-nowdaurlshortening");if(N){return 6000000;}return this._wdLengthLimit;};C.prototype.resolveSystemAlias=function(s){var m,d=new q.Deferred(),t=this,o;o=this._readSystemAliasFromBuffer(s);if(o){q.sap.log.debug("System alias '"+s+"' was already buffered","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");window.setTimeout(function(){d.resolve(o);},0);}else{q.sap.log.debug("System alias '"+s+"' is not in buffer","","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");var r=function(){o=t._readSystemAliasFromBuffer(s);if(o){q.sap.log.debug("System alias '"+s+"' is now in buffer","Skipping INTEROP service call","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");d.resolve(o);}else{q.sap.log.debug("System alias '"+s+"' still not in buffer","Resolving via INTEROP service","sap.ushell_abap.adapters.abap.ClientSideTargetResolutionAdapter");t._readSystemAliasViaInterop(s).fail(function(e){d.reject(e);}).done(function(b){o=t._fixSystemAlias(b);if(o&&o.id){t._writeSystemAliasToBuffer(o);d.resolve(o);}else{m="Data returned for system alias is not valid";q.sap.log.warning("ClientSideTargetResolutionAdapter: "+m);d.reject(m);}});}};this._oInitialSegmentPromise.then(r,r);}return d.promise();};C.prototype._writeUserSystemAliasesToBuffer=function(s){var t=this;if(typeof s==="undefined"){return;}if(a(s)){Object.keys(s).forEach(function(b){t._writeSystemAliasToBuffer(t._fixSystemAlias(s[b]));});return;}s.forEach(function(o){t._writeSystemAliasToBuffer(t._fixSystemAlias(o));});};C.prototype._readSystemAliasFromBuffer=function(s){var r=this._oSystemAliasBuffer.get(s);if(!r&&s===""){return this._oLocalSystemAlias;}return r;};C.prototype._writeSystemAliasToBuffer=function(s){if(s&&s.id){this._oSystemAliasBuffer.put(s.id,s);}return s;};C.prototype._fixSystemAlias=function(s){s=s||{};delete s.__metadata;var f={};f.id=s.id||"";f.client=s.client||"";f.language=s.language||"";["http","https"].forEach(function(d){if(s.hasOwnProperty(d)){delete s[d].__metadata;if(s[d].id!==""){f[d]=q.extend({id:"",host:"",port:"",pathPrefix:""},s[d]);}}});if(s.hasOwnProperty("rfc")&&s.rfc.id){delete s.rfc.__metadata;f.rfc=q.extend({id:"",systemId:"",host:"",service:0,loginGroup:"",sncNameR3:"",sncQoPR3:""},s.rfc);}return f;};C.prototype._readSystemAliasViaInterop=function(s){var d=new q.Deferred(),r="SystemAliases(id='"+encodeURIComponent(s)+"')?$format=json";this._getODataWrapper().read(r,function(o){d.resolve(o);},function(m){d.reject(m);});return d.promise();};C.prototype.getSystemAliases=function(){return(this._oSystemAliasBuffer&&this._oSystemAliasBuffer.entries)||{};};return C;},true);
