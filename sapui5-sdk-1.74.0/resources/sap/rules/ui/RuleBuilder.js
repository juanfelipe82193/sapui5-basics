/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/m/Select","sap/ui/core/Item","sap/rules/ui/DecisionTable","sap/rules/ui/DecisionTableConfiguration","sap/rules/ui/TextRuleConfiguration","sap/rules/ui/RuleType","sap/rules/ui/RuleFormat","sap/rules/ui/TextRule"],function(q,l,C,S,I,D,a,T,R,b,c){"use strict";var r=C.extend("sap.rules.ui.RuleBuilder",{metadata:{library:"sap.rules.ui",properties:{types:{type:"sap.rules.ui.RuleType[]",defaultValue:[sap.rules.ui.RuleType.DecisionTable,sap.rules.ui.RuleType.TextRule]},bindingContextPath:{type:"string",group:"Misc"},editable:{type:"boolean",defaultValue:true}},aggregations:{_ruleTypeSelector:{type:"sap.m.ComboBox",multiple:false,singularName:"_ruleTypeSelector",visibility:"hidden"},_rule:{type:"sap.rules.ui.RuleBase",multiple:false,singularName:"_rule",visibility:"hidden"},decisionTableConfiguration:{type:"sap.rules.ui.DecisionTableConfiguration",multiple:false,singularName:"decisionTableConfiguration"},textRuleConfiguration:{type:"sap.rules.ui.TextRuleConfiguration",multiple:false,singularName:"textRuleConfiguration"}},associations:{"expressionLanguage":{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"},"astExpressionLanguage":{type:"sap.rules.ui.services.AstExpressionLanguage",multiple:false,singularName:"astExpressionLanguage"}},events:{}},init:function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateDisplayedControl=true;this.needRebind=true;this._internalModel=this._initInternalModel();this.setModel(this._internalModel,"ruleBuilderInternalModel");},validate:function(){var o=this.getAggregation("_rule");if(o){o.validate();}},_initInternalModel:function(){var d={types:this.getTypes(),bindingContextPath:this.getBindingContextPath(),editable:this.getEditable(),decisionTableConfiguration:{},textRuleConfiguration:{}};var m=new sap.ui.model.json.JSONModel();m.setData(d);return m;},_getModel:function(){return this.getModel();},_setBindingContext:function(){var d=this.getBindingContextPath();var m=this._getModel();var o=new sap.ui.model.Context(m,d);this.setBindingContext(o);},_createRuleset:function(){return null;},_createTextRule:function(){var t=this.getTextRuleConfiguration();if(!t){t=new sap.rules.ui.TextRuleConfiguration();this.setTextRuleConfiguration(t);};var o=new sap.rules.ui.TextRule({bindingContextPath:{path:"ruleBuilderInternalModel>/bindingContextPath"},modelName:{path:"ruleBuilderInternalModel>/modelName"},editable:{path:"ruleBuilderInternalModel>/editable"},enableSettings:{path:"ruleBuilderInternalModel>/textRuleConfiguration/enableSettings"},expressionLanguage:this.getExpressionLanguage(),astExpressionLanguage:this.getAstExpressionLanguage()});return o;},_createDecisionTable:function(){var d=this.getDecisionTableConfiguration();if(!d){d=new sap.rules.ui.DecisionTableConfiguration();this.setDecisionTableConfiguration(d);};sap.rules.ui.DecisionTable.prototype.VISIBLEROWCOUNT=this.getDecisionTableConfiguration().getVisibleRowCount();sap.rules.ui.DecisionTable.prototype.THRESHOLD=this.getDecisionTableConfiguration().getThreshold();var o=new sap.rules.ui.DecisionTable({bindingContextPath:{path:"ruleBuilderInternalModel>/bindingContextPath"},modelName:{path:"ruleBuilderInternalModel>/modelName"},editable:{path:"ruleBuilderInternalModel>/editable"},cellFormat:{path:"ruleBuilderInternalModel>/decisionTableConfiguration/cellFormat"},enableSettings:{path:"ruleBuilderInternalModel>/decisionTableConfiguration/enableSettings"},hitPolicies:{path:"ruleBuilderInternalModel>/decisionTableConfiguration/hitPolicies"},decisionTableFormat:{path:"ruleBuilderInternalModel>/decisionTableConfiguration/decisionTableFormat"},expressionLanguage:this.getExpressionLanguage(),astExpressionLanguage:this.getAstExpressionLanguage()});return o;},_createDisplayedControl:function(d){var o;switch(d){case sap.rules.ui.RuleType.DecisionTable:o=this._createDecisionTable();break;case"sap.rules.ui.RuleType.Ruleset":o=this._createRuleset();break;case sap.rules.ui.RuleType.TextRule:o=this._createTextRule();break;default:break;};this.setAggregation("_rule",o,true);},_createRuleTypeSelector:function(){var m=this;this.oBundle.getText('decisionTable');var o=new sap.ui.model.json.JSONModel({items:[{key:sap.rules.ui.RuleType.DecisionTable,text:this.oBundle.getText('decisionTable')}]});var d=new sap.m.ComboBox({width:"25%",items:{path:'ruleTypes>/items',template:new sap.ui.core.Item({text:"{ruleTypes>text}",key:"{ruleTypes>key}"})},change:function(e){var s=e.getSource().getSelectedKey();m._createDisplayedControl.call(m,s);}}).setModel(o,"ruleTypes");this.setAggregation("_ruleTypeSelector",d,true);},setEditable:function(v){this._internalModel.setProperty("/editable",v);return this.setProperty("editable",v,true);},setBindingContextPath:function(v,d){var o=this.getBindingContextPath();if(d||(v&&(o!==v))){this.needRebind=true;this._internalModel.setProperty("/bindingContextPath",v);this._needReBind();return this.setProperty("bindingContextPath",v);}},setModelName:function(v){this.needRebind=true;this._internalModel.setProperty("/modelName",v);return this.setProperty("modelName",v);},_setTextRuleConfigurationProperty:function(p,v){var P="/textRuleConfiguration/"+p;this._internalModel.setProperty(P,v);},setTextRuleConfiguration:function(t){t.attachChange(function(e){this.getParent()._setTextRuleConfigurationProperty.call(this.getParent(),e.getParameter("name"),e.getParameter("value"))});this._setTextRuleConfigurationProperty("enableSettings",t.getEnableSettings());return this.setAggregation("textRuleConfiguration",t,true)},_setDecisionTableConfigurationProperty:function(p,v){var P="/decisionTableConfiguration/"+p;this._internalModel.setProperty(P,v);},setDecisionTableConfiguration:function(d){d.attachChange(function(e){this.getParent()._setDecisionTableConfigurationProperty.call(this.getParent(),e.getParameter("name"),e.getParameter("value"))});this._setDecisionTableConfigurationProperty("enableSettings",d.getEnableSettings());this._setDecisionTableConfigurationProperty("hitPolicies",d.getHitPolicies());this._setDecisionTableConfigurationProperty("cellFormat",d.getCellFormat());this._setDecisionTableConfigurationProperty("decisionTableFormat",d.getDecisionTableFormat());this._setDecisionTableConfigurationProperty("visibleRowCount",d.getVisibleRowCount());this._setDecisionTableConfigurationProperty("threshold",d.getThreshold());return this.setAggregation("decisionTableConfiguration",d,true)},setExpressionLanguage:function(e){var o=this.getAggregation("_rule");if(o){o.setExpressionLanguage(e);}return this.setAssociation("expressionLanguage",e,true);},setAstExpressionLanguage:function(A){var o=this.getAggregation("_rule");if(o){o.setAstExpressionLanguage(A);}return this.setAssociation("astExpressionLanguage",A,true);},resetControl:function(){var o=this.getAggregation("_rule");if(o){o.destroy();}},_needReBind:function(){if(this.needRebind){this.resetControl();var o=this.getTypes();if(o&&o.length===1){this._createDisplayedControl(o[0]);this.needCreateDisplayedControl=false;}this.needRebind=false;}},onBeforeRendering:function(){this._needReBind();}});return r;},true);
