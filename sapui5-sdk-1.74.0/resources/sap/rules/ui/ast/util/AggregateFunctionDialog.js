sap.ui.define(["sap/ui/core/Control","sap/m/List","sap/ui/model/json/JSONModel","sap/rules/ui/ast/constants/Constants"],function(C,L,J,a){"use strict";var b;var A=function(){this._vocabularyExpressionId="";this.functionLabelDisplay="";this.functionLabel="";this._aggregateFunctionSelected="";this._whereExpressionId="";this._groupBy=[];this.functionLabelExpression="";this.displayTextVocabulary="";this.jsonDataArray=[];this.groupBySelectEnable=true;this._countFunctionSelected=false;this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");};A.prototype._filterAggregateFunction=function(c){var f=[];if(c&&c.aggregate){for(var i=0;i<c.aggregate.length;i++){if(c.aggregate[i].name!==a.FILTER){f.push(c.aggregate[i]);}}return{aggregate:f};}};A.prototype._createFunctionSelectionDropDown=function(c){var t=this;c=this._filterAggregateFunction(c);var m=new sap.ui.model.json.JSONModel(c);this.functionSelect=new sap.m.Select({selectedKey:this._aggregateFunctionSelected,forceSelection:false,showSecondaryValues:true,layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),change:function(e){this._aggregateFunctionSelected=e.getSource().getSelectedItem().getText();if(this._aggregateFunctionSelected===a.COUNT){this._countFunctionSelected=true;this.astExpressionBasicForVocabulary.setCountFunctionSelected(true);}else{this._countFunctionSelected=false;this.astExpressionBasicForVocabulary.setCountFunctionSelected(false);}this.astExpressionBasicForVocabulary.setValue("");this.applyButton.setEnabled(false);this.astExpressionBasicForWhere.setEditable(false);this.groupBySelect.setEnabled(false);this._whereExpressionId="";this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.functionLabelField.setValue("");this.groupBySelect.setSelectedKeys([]);}.bind(this)}).addStyleClass("sapAstExpressionDialogField");this.functionSelect.setModel(m);this.functionSelect.bindItems({path:"/aggregate",template:new sap.ui.core.ListItem({text:"{name}",key:"{name}",additionalText:"{label}"})});return this.functionSelect;};A.prototype._enableField=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected){return true;}else{return false;}};A.prototype._enableFieldGroupBy=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.groupBySelectEnable){return true;}else{return false;}};A.prototype._enableFieldWhere=function(){if(this._vocabularyExpressionId&&this._aggregateFunctionSelected&&this.jsonDataArray.length===0){return true;}else{return false;}};A.prototype._createVocabularyAstExpression=function(s){var t=this;var j=[];this.astExpressionBasicForVocabulary=new sap.rules.ui.AstExpressionBasic({value:this._vocabularyExpressionId,countFunctionSelected:this._countFunctionSelected,jsonData:this.jsonDataArray,astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionVocabulary:true,ariaLabelledBy:s,editable:true,change:function(e){this._vocabularyExpressionId=e.getParameter("newValue");this.sDataObjectSelected=t._getDataObjectFromExpression(t._vocabularyExpressionId);if(t._vocabularyExpressionId&&this._aggregateFunctionSelected){if(e.getSource().getProperty("jsonData")&&e.getSource().getProperty("jsonData").length>0){t._helperForSelectFunction(e);}else{if(this.sDataObjectSelected){this.functionLabelDisplay=this._aggregateFunctionSelected+'('+this.sDataObjectSelected.label+')';this.functionLabel=this._aggregateFunctionSelected+'('+this.dataObjectId+')';this.functionLabelField.setValue(t.functionLabelDisplay);this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.applyButton.setEnabled(true);this.jsonDataArray=[];var c=this._setDataObjectInfoForWhereConditionAutoSuggestion();this.astExpressionBasicForWhere.setDataObjectInfo(c);this._bindGroupByDropDown();this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setEditable(true);this.groupBySelectEnable=(this._aggregateFunctionSelected!==a.COUNTDISTINCT&&this._aggregateFunctionSelected!==a.DISTINCT)?true:false;this.groupBySelect.setEnabled(this.groupBySelectEnable);if(!this._isDataObjectStructure()&&!this._isDataObjectElement()){this.astExpressionBasicForVocabulary.setValueState("None");}}}}else{this.applyButton.setEnabled(false);this.astExpressionBasicForWhere.setEditable(false);this.groupBySelect.setEnabled(false);this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";this.astExpressionBasicForWhere.setDataObjectInfo("");this.functionLabelField.setValue("");this.groupBySelect.setSelectedKeys([]);this.jsonDataArray=[];this.astExpressionBasicForVocabulary.setValueState("None");}}.bind(this)});this.astExpressionBasicForVocabulary.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForVocabulary;};A.prototype._helperForSelectFunction=function(e){if(e.getSource().getProperty("jsonData")&&e.getSource().getProperty("jsonData").length>0){this.functionLabelExpression=e.getSource().getProperty("jsonData")[0].functionLabel;this.jsonDataArray=e.getSource().getProperty("jsonData");this.sDataObjectSelected=this._getDataObjectFromExpression(this.functionLabelExpression);if(!this._isDataObjectStructure()&&!this._isDataObjectElement()){this.astExpressionBasicForVocabulary.setValueState("None");}else{this.astExpressionBasicForVocabulary.setValueState("Error");}if(Object.keys(this.jsonDataArray[0].attributes).length===0||Object.keys(this.jsonDataArray[0].attributes).length>1){this.applyButton.setEnabled(false);this.astExpressionBasicForVocabulary.setValueState("Error");this.astExpressionBasicForVocabulary.setValueStateText(this.oBundle.getText("invalidAttribute"));}else{this.applyButton.setEnabled(true);this.astExpressionBasicForVocabulary.setValueState("None");}this.displayTextVocabulary=e.getParameter("displayText");this.functionLabelDisplay=this._aggregateFunctionSelected+'('+this.displayTextVocabulary+')';this.functionLabelField.setValue(this.functionLabelDisplay);this.functionLabel=this._aggregateFunctionSelected+'('+this.functionLabelExpression+')';this.astExpressionBasicForWhere.setValue("");this._whereExpressionId="";var s=this._setDataObjectInfoForWhereConditionAutoSuggestion();this.astExpressionBasicForWhere.setDataObjectInfo(s);this._bindGroupByDropDown();this._groupBy=[];this.groupBySelected=[];this.astExpressionBasicForWhere.setEditable(false);this.groupBySelectEnable=(this._aggregateFunctionSelected!==a.COUNTDISTINCT&&this._aggregateFunctionSelected!==a.DISTINCT)?true:false;this.groupBySelect.setEnabled(this.groupBySelectEnable);}};A.prototype._setDataObjectInfoForWhereConditionAutoSuggestion=function(){var v="";if(this.jsonDataArray&&this.jsonDataArray.length>0){return this._aggregateFunctionSelected+"(FILTER("+this._vocabularyExpressionId+",";}else if(this.dataObjectId){var d=this.dataObjectId;if(this.includes(d,"/")){d=d.replace("/","");}v=this._returnDataObjectBasedOnCardinality(this._vocabularyExpressionId);if(v){return this._aggregateFunctionSelected+"(FILTER("+v+",";}return this._aggregateFunctionSelected+"(FILTER(/"+d+",";}};A.prototype._getDataObjectFromExpression=function(e){var d="";if(e&&e.trim()&&this.includes(e,"(")){var r=/\(([^)]+),/;var m=e.split("(");d=(m[0]===a.SELECT||m[0]===a.TOP||m[0]===a.BOTTOM||m[0]===a.FIRST)?(this.jsonDataArray[0]?this.jsonDataArray[0].dataObject:""):"";d=d.replace("/","");}else if(e&&e.trim()){var s=e.split("/");d=s[1];}if(d){var D={};d=d.trim();var t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var o=t.getTermByTermId(d);if(o){D={name:t.getTermByTermId(d)._termName,label:t.getTermByTermId(d)._label};this.dataObjectId="/"+d;}return D;}};A.prototype._createWhereAstExpressionBasic=function(){var t=this;this.oModel=new sap.ui.model.json.JSONModel();this.oModel.setData({value:this._whereExpressionId,});this.astExpressionBasicForWhere=new sap.rules.ui.AstExpressionBasic({astExpressionLanguage:this._oAstExpressionLanguage,enableAggregateFunctionWhereClause:true,value:this._whereExpressionId,editable:t._enableFieldWhere(),dataObjectInfo:this._setDataObjectInfoForWhereConditionAutoSuggestion(),change:function(e){t._whereExpressionId=e.getParameter("newValue");}.bind(this)});this.astExpressionBasicForWhere.setModel(this.oModel);this.astExpressionBasicForWhere.addStyleClass("sapAstExpressionDialog");return this.astExpressionBasicForWhere;};A.prototype._createGroupByDropDown=function(){var t=this;this.groupBySelect=new sap.m.MultiComboBox({showSecondaryValues:true,enabled:t._enableFieldGroupBy(),selectionFinish:function(e){t._groupBy=[];for(var i=0;i<e.getSource().getSelectedItems().length;i++){var c="./"+e.getSource().getSelectedItems()[i].getKey();t._groupBy.push(c);}}}).addStyleClass("sapAstExpressionDialogField");this.groupBySelect.bindItems({path:"/terms",template:new sap.ui.core.ListItem({text:"{label}",key:"{id}"})});this._bindGroupByDropDown();return this.groupBySelect;};A.prototype._bindGroupByDropDown=function(){var v="";if(this.dataObjectId){v=this._returnDataObjectBasedOnCardinality(this._vocabularyExpressionId);if(v){var c=this._getSuggestionsForTheGivenInput(v);}else{var c=this._getSuggestionsForTheGivenInput(this.dataObjectId);}var d=this._getAttributesForGroupBy(c.autoComplete.categories);var m=new sap.ui.model.json.JSONModel(d);this.groupBySelect.setModel(m);}if(this.groupBySelected){this.groupBySelect.setSelectedKeys(this.groupBySelected);}};A.prototype._getAttributesForGroupBy=function(s){var c=[];if(s&&s.terms){for(var i=0;i<s.terms.length;i++){if(s.terms[i].type==='E'){c.push(s.terms[i]);}}return{terms:c};}};A.prototype._createFunctionLabel=function(){this.functionLabelField=new sap.m.TextArea({value:this.functionLabelDisplay,enabled:false,width:"100%",height:"34px"}).addStyleClass("sapAstFieldMargin sapAstExpressionDialogTextField");return this.functionLabelField;};A.prototype._clearData=function(){this._vocabularyExpressionId="";this.functionLabelDisplay="";this.functionLabel="";this._aggregateFunctionSelected="";this._groupBy=[];this._whereExpressionId="";this.groupBySelected=[];this.dataObjectId="";this.functionLabelExpression="";this.displayTextVocabulary="";this._countFunctionSelected=false;this.jsonDataArray=[];this.groupBySelectEnable=true;};A.prototype._convertFunctionLabelToText=function(d,f){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var o=this.termsProvider.getTermNameFromASTNodeReference(d);f=f.replace(d,o);return f};A.prototype._createAggregationFunctionDialog=function(d,c,e,f,j){var t=this;this._clearData();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this._oAstExpressionLanguage=e;if(j){this._whereExpressionId=j.filter;this._aggregateFunctionSelected=j.function;this.functionLabel=j.functionLabel;this.functionLabelDisplay=this._convertFunctionLabelToText(j.dataObject,j.functionLabel);if(j.groupBy){for(var i=0;i<j.groupBy.length;i++){this.groupBySelected.push(j.groupBy[i].replace("./",""));}}this._groupBy=j.groupBy;this.dataObjectId=j.dataObject;if(this._aggregateFunctionSelected===a.COUNT){this._countFunctionSelected=true;}if(typeof j.vocabulary==="object"||j.vocabulary instanceof Object){this._vocabularyExpressionId=j.selectExpression;this.jsonDataArray=[j.vocabulary];}else{this._vocabularyExpressionId=j.vocabulary;}this.groupBySelectEnable=(this._aggregateFunctionSelected!==a.COUNTDISTINCT&&this._aggregateFunctionSelected!==a.DISTINCT)?true:false;}var F=t._createFunctionSelectionDropDown(d);var v=new sap.m.Text({text:t.oBundle.getText("vocabulary"),tooltip:t.oBundle.getText("vocabulary"),textAlign:"End",width:"90%",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"})});var w=t._createWhereAstExpressionBasic();var g=t._createGroupByDropDown();var o=t._createFunctionLabel();var h=new sap.ui.layout.form.SimpleForm({layout:sap.ui.layout.form.SimpleFormLayout.ResponsiveGridLayout,editable:true,content:[new sap.m.Label({text:t.oBundle.getText("function"),tooltip:t.oBundle.getText("function"),labelFor:F.getId()}),F,v,t._createVocabularyAstExpression(v.getId()),new sap.m.Label({text:t.oBundle.getText("where"),tooltip:t.oBundle.getText("where"),labelFor:w.getId()}),w,new sap.m.Label({text:t.oBundle.getText("group_by"),tooltip:t.oBundle.getText("group_by"),labelFor:g.getId()}),g,new sap.m.Label({text:t.oBundle.getText("function_label"),tooltip:t.oBundle.getText("function_label"),labelFor:o.getId()}).addStyleClass("sapAstDialogLabelMargin"),o]});var k=new sap.m.Dialog({title:this.oBundle.getText("configure_aggr_title"),contentWidth:"800px",showHeader:true,afterOpen:function(){t.astExpressionBasicForWhere.setValue(t._whereExpressionId);},beforeClose:function(){f(false);},content:[h],buttons:[this.applyButton=new sap.m.Button({text:t.oBundle.getText("apply"),enabled:t._enableField(),tooltip:t.oBundle.getText("applyChangesBtnTooltip"),press:function(l){if(t._isDataObjectStructure()||t._isDataObjectElement()){t.astExpressionBasicForVocabulary.setValueState("Error");t.astExpressionBasicForVocabulary.setValueStateText(t.oBundle.getText("StructureElementNotSupported"));}else{t.astExpressionBasicForVocabulary.setValueState("None");if(t.jsonDataArray&&t.jsonDataArray.length>0){var m=t._whereExpressionId;var n=t._groupBy;var p=t._createJson(t._aggregateFunctionSelected,t.jsonDataArray[0],m,n,t.functionLabel,t.dataObjectId);}else{var m=t._whereExpressionId;var n=t._groupBy;var p=t._createJson(t._aggregateFunctionSelected,t._vocabularyExpressionId,m,n,t.functionLabel,t.dataObjectId);}l.getSource().mProperties={value:t.functionLabel,jsonData:p};c(l);t._setModal(false);k.close();k.destroy();}}}),new sap.m.Button({text:t.oBundle.getText("cancel"),tooltip:t.oBundle.getText("cancelBtnTooltip"),press:function(l){t._setModal(false);k.close();k.destroy();}})]}).addStyleClass("sapUiSizeCompact");this._setModal(true);k.open();};A.prototype._returnDataObjectBasedOnCardinality=function(v){var c="";if(this.jsonDataArray&&this.jsonDataArray.length>0){if(this.jsonDataArray[0]&&this.jsonDataArray[0].attributes){for(var k in this.jsonDataArray[0].attributes){c=this.jsonDataArray[0].doVocabId+k.replace(".","");break;}}}else{c=this._vocabularyExpressionId;}if(c){var s=c.split("/");var d=s[1];var i=0;var t;var e="";if(s.length>2){for(var f=2;f<s.length;f++){d+="."+s[f];t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(d);if(t&&t._dataObjectType==="AO"&&t._cardinality==="1..n"){i=f;}}if(i>0){for(var f=1;f<=i;f++){e+="/"+s[f];}}}if(e){return e;}else{return"/"+s[1];}}};A.prototype._isDataObjectStructure=function(){if(this._aggregateFunctionSelected===a.COUNT){this.tableId=this._vocabularyExpressionId;this.tableId=this.tableId.replace(/\//,"");this.tableId=this.tableId.replace(/\//g,".");var t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.tableId);if(t&&t._dataObjectType&&t._dataObjectType==="S"){return true;}else if(t&&t._dataObjectType&&t._dataObjectType==="AO"&&t._cardinality&&t._cardinality==="1..1"){return true;}}else{this.tableId=this._returnDataObjectBasedOnCardinality(this._vocabularyExpressionId);if(this.tableId&&(this.tableId.match(/\//g)||[]).length===1){var t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.tableId.replace(/\//,""));if(t&&t._dataObjectType==="S"){return true;}}}return false;};A.prototype._isDataObjectElement=function(){var j=this.jsonDataArray?this.jsonDataArray[0]:undefined;var d=j?j.dataObject:this._vocabularyExpressionId;this.elementDOId=d.replace(/\//,"");this.elementDOId=this.elementDOId.trim();var t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(this.elementDOId);if(t&&(t._isDataObjectElement||t.isResultDataObjectElement)){return true;}return false;};A.prototype._setModal=function(v){var p=sap.ui.getCore().byId("popover");if(p){p.setModal(v);}};A.prototype._createJson=function(f,v,w,g,c,d){return{"function":f,"vocabulary":v,"filter":w,"groupBy":g,"functionLabel":c,"dataObject":d,}};A.prototype._getSuggestionsForTheGivenInput=function(i){var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);var u=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(t);var s={};s.AttributeContext=true;s.OperationsContext=false;var c=this._oAstExpressionLanguage.getSuggesstions(u,s);return c;};A.prototype.includes=function(p,s){var r=false;if(p.indexOf(s)!==-1){r=true;}return r;};return{getInstance:function(){if(!b){b=new A();b.constructor=null;}return b;}};},true);
