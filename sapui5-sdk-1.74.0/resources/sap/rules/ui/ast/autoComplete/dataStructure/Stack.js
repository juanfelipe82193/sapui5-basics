sap.ui.define(["sap/rules/ui/ast/autoComplete/node/TermNode","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/autoComplete/dataStructure/BaseStack","sap/rules/ui/ast/provider/FunctionProvider","sap/rules/ui/ast/provider/OperatorProvider","sap/rules/ui/ast/autoComplete/dataStructure/FunctionalStack","sap/rules/ui/ast/autoComplete/dataStructure/ArrayAndRangeStack","sap/rules/ui/ast/autoComplete/node/OperatorNode","sap/rules/ui/ast/autoComplete/dataStructure/ComparisionOperatorStack"],function(T,C,B,F,O,a,A,b,c){"use strict";var S=function(){B.apply(this,arguments);this._probableBusinessDataReturnTypeList=[];this._probableDataObjectReturnTypeList=[];this._isContextComparision=false;this._comparisionLeftOperandBusinessType=null;};S.prototype=new B();S.prototype.constructor=B;S.prototype.push=function(t){var d=t.getTokenType();var r;var n;if(this.getTop()&&"push"in this.getTop()){r=this.getTop().push(t);if(r&&r.bTokenPushed==true||(r&&"errorCode"in r)){if(r.bFunctionClosed==true){return this._handleFunctionClosed();}else if(r.bArrayAndRangeClosed==true){return this._handleArrayAndRangeClosed();}else if(r.bComparisionOperatorClosed){return this._handleComparisionOperatorClosed(r,t);}return r;}}switch(d){case C.AND:case C.OR:var o=this._getNodeRecursively(this._top);if(o&&"getBusinessDataType"in o&&o.getBusinessDataType()==C.BOOLEANBUSINESSDATATYPE){this.empty();return{bTokenPushed:true};}return{bTokenPushed:false};case C.RIGHTPARENTHESIS:return this._handleRightParenthesisToken(t);case C.LEFTPARENTHESIS:return this._handleLeftParenthesisToken(t);case C.STRINGBUSINESSDATATYPE:case C.DATEBUSINESSDATATYPE:case C.BOOLEANBUSINESSDATATYPE:case C.TIMEBUSINESSDATATYPE:case C.QUANTITYBUSINESSDATATYPE:case C.NUMBERBUSINESSDATATYPE:case C.GEOBUSINESSDATATYPE:case C.UTC_TIMESTAMP:case C.TERM:return this._handleTermAndLiteralToken(t);case C.OPERATOR:return this._handleOpertorToken(t);case C.RANGE_OPERATOR:case C.ARRAY_OPERATOR:var s=t.getText();var e=O.getInstance().getOperatorByName(s.toUpperCase());n=new A(this.getTermPrefixId());n.setOperator(e);n.setPrevious(this._top);this._top=n;this._size+=1;return{bTokenPushed:true};case C.COMPARISION_OPERATOR:return this._createComparisionStack(t.getText());case C.FUNCTION:var f=t.getText();var g=F.getInstance().getFunctionByName(f.toUpperCase());n=new a(this.getTermPrefixId());n.setFunction(g);n.setPrevious(this._top);this._top=n;this._size+=1;return{bTokenPushed:true};case C.COMMA:return{bTokenPushed:false,error:"invalid character comma"};case C.WS:return{bTokenPushed:true};default:return{bTokenPushed:false,error:"unidentified  token"};}};S.prototype._createComparisionStack=function(o){var t=this._getNodeRecursively(this._top);if(t&&"getBusinessDataType"in t&&t.getBusinessDataType()){if((o==='='||o==='!=')&&(t.getBusinessDataType()===C.BOOLEANBUSINESSDATATYPE)){this.empty();return{bTokenPushed:true};}var n;n=new c(this.getTermPrefixId());n.setName(o);n.setLeftOperandBusinessDataType(t.getBusinessDataType());n.setPrevious(this._top);this._top=n;this._size+=1;return{bTokenPushed:true};}else{return{bTokenPushed:false,errorCode:5,error:"Could not Determine BussinessDataType of Left Operarnd for ComparisionOperator : "+o};}};S.prototype._doesStackContainsFunctions=function(n){var p=n;while("getTop"in n&&n.getTop()){if(n instanceof a){return true;}p=n;n=n.getTop();}return false;};S.prototype.getProbableBusinessDataReturnTypeList=function(){return this._probableBusinessDataReturnTypeList;};S.prototype.setProbableBusinessDataReturnTypeList=function(p){this._probableBusinessDataReturnTypeList=p;return this;};S.prototype.getProbableDataObjectReturnTypeList=function(){return this._probableDataObjectReturnTypeList;};S.prototype.setProbableDataObjectReturnTypeList=function(p){this._probableDataObjectReturnTypeList=p;return this;};S.prototype.isContextComparision=function(){return this._isContextComparision;};S.prototype.setContextComparision=function(i){this._isContextComparision=i;};S.prototype.setComparisionLeftOperandType=function(d){this._comparisionLeftOperandBusinessType=d;};S.prototype.getComparisionLeftOperandBusinessType=function(){return this._comparisionLeftOperandBusinessType;};S.prototype._handleTermAndLiteralToken=function(t){var n=this._nodeManager.getNode(t,this.getTermPrefixId());var d;var e;var i=false;var f={bTokenPushed:false,errorCode:1};if(this.getSize()==0){n.setPrevious(this._top);this._top=n;this._size+=1;return{bTokenPushed:true};}else if(this.getTop()&&"getNodeType"in this.getTop()&&this.getTop().getNodeType()==C.OPERATORNODE&&this._top.getPrevious()&&("getBusinessDataType"in this._top.getPrevious()||(this._getNodeRecursively(this._top.getPrevious())&&"getBusinessDataType"in this._getNodeRecursively(this._top.getPrevious())))){d=new T();var o=this._getNodeRecursively(this._top);var g=o.getOperatorMetadata();var p=this._getNodeRecursively(this._top.getPrevious());var h=p?p.getBusinessDataType():"";if(p&&"getDataObjectType"in p)var j=p.getDataObjectType();e=p.getName()+" "+o.getName()+" "+n.getName();d.setName(e).setLabel(e);if(j){var r=g.getReturnValueDataObjectTypeCollection()[j][n.getDataObjectType()];if(r){d.setDataObjectType(r);}else{f["expectedDataObjectTypeList"]=Object.keys(g.getReturnValueDataObjectTypeCollection()[j]);i=true;}}if(h){var k=g.getReturnValueBussinessDataTypeCollection()[h][n.getBusinessDataType()];if(k){d.setBusinessDataType(k);}else{f["expectedBusinessDataTypeList"]=Object.keys(g.getReturnValueBussinessDataTypeCollection()[h]);i=true;}}if(i){return f;}this.pop();this.pop();d.setPrevious(this._top);this._top=d;this._size+=1;return{bTokenPushed:true};}else if(this.getTop()&&this.getTop()instanceof b&&(this.getTop().getName()==C.MINUS||this.getTop().getName()==C.LOGICAL_NOT)){d=new T();e=this.getTop().getName()+" "+n.getName();d.setName(e).setLabel(e);if(this.getTop().getName()==C.MINUS&&(n instanceof T&&!(n.getBusinessDataType()==C.NUMBERBUSINESSDATATYPE))||!(t.getTokenType()==C.NUMBERBUSINESSDATATYPE)){f["expectedBusinessDataTypeList"]=[C.NUMBERBUSINESSDATATYPE];i=true;}else if(this.getTop().getName()==C.LOGICAL_NOT&&(n instanceof T&&!(n.getBusinessDataType()==C.BOOLEANBUSINESSDATATYPE)||!(t.getTokenType()==C.BOOLEANBUSINESSDATATYPE))){f["expectedBusinessDataTypeList"]=[C.BOOLEANBUSINESSDATATYPE];i=true;}if(i){return f;}else if(this.getTop().getName()==C.MINUS){d.setBusinessDataType(C.NUMBERBUSINESSDATATYPE);d.setDataObjectType(C.Element);}else if(this.getTop().getName()==C.LOGICAL_NOT){d.setBusinessDataType(C.BOOLEANBUSINESSDATATYPE);d.setDataObjectType(C.Element);}this.pop();d.setPrevious(this._top);this._top=d;this._size+=1;return{bTokenPushed:true};}else{return{bTokenPushed:false,error:"Token should be prefixed with operator"};}};S.prototype._handleOpertorToken=function(t){var n=this._nodeManager.getNode(t);var d=this._getNodeRecursively(this._top);if(d){var p=this._getNodeRecursively(this._top);var e;var f;if(p&&"getBusinessDataType"in p)f=p.getBusinessDataType();if(p&&"getDataObjectType"in p){e=p.getDataObjectType();}var o=n.getOperatorMetadata();if(e&&o.getReturnValueDataObjectTypeCollection()&&o.getReturnValueDataObjectTypeCollection()[e]){n.setProbableDataObjectReturnTypeList(Object.keys(o.getReturnValueDataObjectTypeCollection()[e]));}else if(e){return{bTokenPushed:false,errorCode:3,error:"Left operand DataObject type : "+e+" is not matching given operator DataObject"};}if(f&&o.getReturnValueBussinessDataTypeCollection()&&o.getReturnValueBussinessDataTypeCollection()&&o.getReturnValueBussinessDataTypeCollection()[f]){n.setProbableBusinessDataReturnTypeList(Object.keys(o.getReturnValueBussinessDataTypeCollection()[f]));}else if(f){return{bTokenPushed:false,errorCode:4,error:"Left operand businessDatatype : "+f+" is not matching given operator businessDataType"};}n.setPrevious(this._top);this._top=n;this._size+=1;return{bTokenPushed:true};}else if(!(d instanceof T)&&(t.getText()==C.MINUS||t.getText()==C.LOGICAL_NOT)){n.setPrevious(this._top);if(t.getText()==C.MINUS){n.setProbableBusinessDataReturnTypeList([C.NUMBERBUSINESSDATATYPE]);}else{n.setProbableBusinessDataReturnTypeList([C.BOOLEANBUSINESSDATATYPE]);}n.setProbableDataObjectReturnTypeList([C.Element]);this._top=n;this._size+=1;return{bTokenPushed:true};}else{return{bTokenPushed:false,error:"Operator should be preceded with term/Expression"};}};S.prototype._handleLeftParenthesisToken=function(t){if(this.getHasOpenParenthesis()===false){this.setHasOpenParenthesis(true);var n=new sap.rules.ui.ast.autoComplete.dataStructure.Stack(this.getTermPrefixId());if(this._top){n.setPrevious(this._top);}else{n.setPrevious(this);}n.setProbableDataObjectReturnTypeList(this.getProbableDataObjectReturnTypeList());n.setProbableBusinessDataReturnTypeList(this.getProbableBusinessDataReturnTypeList());this._top=n;this._size+=1;return{bTokenPushed:true};}return{bTokenPushed:false};};S.prototype._closeComparisionStack=function(t){var o=this._getComparisionStack(t);var d=this._getNodeRecursively(o.getTop());var e=new T();var f=o.getOperatorMetadata();var p=this._getNodeRecursively(o.getPrevious());var g=p.getBusinessDataType();if(p&&"getDataObjectType"in p)var h=p.getDataObjectType();var i=p.getName()+" "+f.getName()+" "+d.getName();e.setName(i).setLabel(i);var j={bTokenPushed:false,errorCode:1};var k=false;if(h){var l=f.getReturnValueDataObjectTypeCollection()[h][d.getDataObjectType()];if(l){e.setDataObjectType(l);}else{j["expectedDataObjectTypeList"]=Object.keys(f.getReturnValueDataObjectTypeCollection()[h]);k=true;}}if(g){var m=f.getReturnValueBussinessDataTypeCollection()[g][d.getBusinessDataType()];if(m){e.setBusinessDataType(m);}else{j["expectedBusinessDataTypeList"]=Object.keys(f.getReturnValueBussinessDataTypeCollection()[g]);k=true;}}if(k){return j;}e.setPrevious(null);this._top=e;this._size=1;return{bTokenPushed:true};};S.prototype._handleRightParenthesisToken=function(t){var d;if(this.getHasOpenParenthesis()==true){d=this._getNodeRecursively(this._top);this.setHasOpenParenthesis(false);if(this.getSize()>0&&this._top.getPrevious()&&"getNodeType"in this._top.getPrevious()&&this._top.getPrevious().getNodeType()==C.OPERATORNODE){return this._calculateTopNode();}else if(this._doesStackContainsComparisionOperator(this.getTop())){return this._closeComparisionStack(this.getTop());}else{this._top=d;}return{bTokenPushed:true}}return{bTokenPushed:false,error:"Extra right parenthesis"};};S.prototype._handleFunctionClosed=function(){return this._calculateTopNode();};S.prototype._handleArrayAndRangeClosed=function(){var d=new T();d.setName("Array and range Operator").setLabel("Array and range Operator");d.setBusinessDataType(C.BOOLEANBUSINESSDATATYPE);d.setDataObjectType(C.Element);d.setPrevious(null);this._top=d;this.size=1;return{bTokenPushed:true}};S.prototype._handleComparisionOperatorClosed=function(r,t){var d=this._getNodeRecursively(this._top);var o=r.oMetadata;var l=this._top.getPrevious();var e={bTokenPushed:false,errorCode:1};var f=new T();var g=d.getName()+" "+o.getName()+" "+l.getName();var s=o.getReturnValueBussinessDataTypeCollection()[l.getBusinessDataType()][d.getBusinessDataType()];if(s){f.setBusinessDataType(C.BOOLEANBUSINESSDATATYPE);f.setDataObjectType(C.Element);f.setPrevious(null);f.setName(g).setLabel(g);this._top=f;this._size=1;if(t&&t.getTokenType()==C.AND||t.getTokenType()==C.OR){this.empty();return{bTokenPushed:true};}return this._createComparisionStack(t.getText());}return e;};S.prototype._doesStackContainsComparisionOperator=function(n){if(n&&n instanceof c){return true;}while(n&&"getTop"in n){n=n.getTop();if(n instanceof c){return true;}}return false;};S.prototype._getComparisionStack=function(n){if(n&&n instanceof c){return n;}while(n&&"getTop"in n){n=n.getTop();if(n instanceof c){return n;}}return n;};S.prototype._calculateTopNode=function(){var t=this._getNodeRecursively(this._top);var d=new T();var o=this._top.getPrevious();var e;var p;if(o&&"getOperator"in o&&o.getOperator()&&"getSupportedFunctions"in o.getOperator()&&o.getOperator().getSupportedFunctions()){var s=o.getOperator().getSupportedFunctions();p=this._getNodeRecursively(o.getPrevious());var i=false;for(var l=0;l<s.length;l++){if(s[l].name.toLocaleUpperCase()==t.getName()){e=p.getName()+" "+o.getOperator().getName()+" "+t.getName();d.setName(e).setLabel(e);if(s[l].dataObjectTypeList&&s[l].dataObjectTypeList[0]){d.setDataObjectType(s[l].dataObjectTypeList[0]);}d.setBusinessDataType(s[l].businessDataType);i=true;}}if(!i){return{bTokenPushed:false,errorCode:6}}}else if(o){var f=o.getOperatorMetadata();p=this._getNodeRecursively(o.getPrevious());var g=p.getBusinessDataType();if(p&&"getDataObjectType"in p)var h=p.getDataObjectType();e=p.getName()+" "+f.getName()+" "+t.getName();d.setName(e).setLabel(e);var j={bTokenPushed:false,errorCode:1};var k=false;if(h&&t.getDataObjectType()){var m=f.getReturnValueDataObjectTypeCollection()[h][t.getDataObjectType()];if(m){d.setDataObjectType(m);}else{j["expectedDataObjectTypeList"]=Object.keys(f.getReturnValueDataObjectTypeCollection()[h]);k=true;}}if(g&&t.getBusinessDataType()){var n=f.getReturnValueBussinessDataTypeCollection()[g][t.getBusinessDataType()];if(n){d.setBusinessDataType(n);}else{j["expectedBusinessDataTypeList"]=Object.keys(f.getReturnValueBussinessDataTypeCollection()[g]);k=true;}}if(k){return j;}}else{d.setName(t.getName()).setLabel(t.getLabel());d.setBusinessDataType(t.getBusinessDataType());d.setDataObjectType(t.getDataObjectType());}d.setPrevious(null);this._top=d;this._size=1;return{bTokenPushed:true}};return S;},true);
