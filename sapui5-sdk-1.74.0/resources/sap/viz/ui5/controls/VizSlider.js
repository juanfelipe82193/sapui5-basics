/*!
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/core/Control','./VizFrame','./VizRangeSlider','./common/utils/Constants','sap/ui/Device',"sap/ui/thirdparty/jquery","sap/base/util/deepEqual","./VizSliderRenderer"],function(B,V,a,C,D,q,d){"use strict";var b={plotArea:{dataLabel:{visible:false}},legend:{visible:false},categoryAxis:{visible:false},valueAxis:{title:{visible:false}},title:{visible:false},interaction:{noninteractiveMode:true},timeAxis:{visible:false}};var c=B.extend("sap.viz.ui5.controls.VizSlider",{metadata:{library:"sap.viz",properties:{vizType:{type:"string",group:"Misc",defaultValue:"column"},uiConfig:{type:"object",group:"Misc",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'800px'},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'200px'},valueAxisVisible:{type:"boolean",group:"Misc",defaultValue:true},showPercentageLabel:{type:"boolean",group:"Appearance",defaultValue:true},showStartEndLabel:{type:"boolean",group:"Appearance",defaultValue:true},range:{type:"object",group:"Appearance",defaultValue:null},_categoryRange:{type:"object",group:"Appearance",defaultValue:null,visibility:"hidden"}},aggregations:{_vizFrame:{type:"sap.viz.ui5.controls.VizFrame",multiple:false,visibility:"hidden"},_rangeSlider:{type:"sap.viz.ui5.controls.VizRangeSlider",multiple:false,visibility:"hidden"},dataset:{type:"sap.viz.ui5.data.Dataset",multiple:false},feeds:{type:"sap.viz.ui5.controls.common.feeds.FeedItem",multiple:true,singularName:"feed"}},events:{rangeChanged:{}}}});c.prototype.applySettings=function(){B.prototype.applySettings.apply(this,arguments);var v=new V({width:this.getWidth(),height:this.getHeight(),vizType:this.getVizType(),uiConfig:this.getUiConfig()});v.attachRenderComplete(m.bind(this));var r=new a({visible:false,showAdvancedTooltip:false,showHandleTooltip:false});r.setParentFrame(this);this.setAggregation("_vizFrame",v);this.setAggregation("_rangeSlider",r);r.attachChange(p.bind(this));};var S=["info/column","info/line","info/timeseries_line","info/timeseries_column"];c.prototype.setVizType=function(v){if(v.indexOf("info/")!==0){v="info/"+v;}if(S.indexOf(v)===-1){v="info/null";}this.setProperty('vizType',v);return this;};c.prototype.getDataset=function(e){var v=this._getVizFrame();return(v&&v.getDataset())||this.getAggregation("dataset");};c.prototype.addFeed=function(e){var v=this._getVizFrame();if(v){v.addFeed(e);}else{this.addAggregation("feeds",e);}return this;};c.prototype.removeFeed=function(e){var v=this._getVizFrame();if(v){v.removeFeed(e);}else{this.removeAggregation("feeds",e);}return this;};c.prototype.removeAllFeeds=function(){var v=this._getVizFrame();if(v){v.removeAllFeeds();}else{this.removeAllAggregation("feeds");}return this;};c.prototype.getFeeds=function(){var v=this._getVizFrame();return(v&&v.getFeeds())||this.getAggregation("feeds");};c.prototype.exit=function(){var v=this._getVizFrame();v&&v.detachRenderComplete(m.bind(this),this);var r=this.getAggregation("_rangeSlider");r&&r.detachChange(p.bind(this));};c.prototype._getVizFrame=function(){return this.getAggregation("_vizFrame");};c.prototype._getRangeSlider=function(){return this.getAggregation("_rangeSlider");};c.prototype.onAfterRendering=function(){var v=this._getVizFrame();var e={valueAxis:{visible:this.getProperty("valueAxisVisible")}};e=q.extend(true,{},e,b);v.setVizProperties(e);v.setUiConfig(this.getProperty("uiConfig"));v.setVizType(this.getProperty("vizType"));v.setHeight(this.getProperty("height"));v.setWidth(this.getProperty("width"));var n=this.getAggregation("dataset");if(n){this.removeAggregation("dataset");v.setDataset(n);}var o=this.getAggregation("feeds");if(o){this.removeAllAggregation("feeds");v.removeAllFeeds();for(var i=0;i<o.length;++i){v.addFeed(o[i]);}}var r=this._getRangeSlider();r.setShowStartEndLabel(this.getProperty("showStartEndLabel"));r.setShowPercentageLabel(this.getProperty("showPercentageLabel"));};c.prototype.setRange=function(r){this.setProperty("range",r);this.invalidate();if(this._getVizFrame()){if(this._getVizFrame()._vizFrame){u.call(this,r);}}return this;};c.prototype._setCategoryRange=function(e){this.setProperty("_categoryRange",e);this.invalidate();if(this._getVizFrame()){if(this._getVizFrame()._vizFrame){j.call(this,e);}}return this;};function f(){var t=this.getVizType();return t==="info/timeseries_column"||t==="info/timeseries_line";}function g(){var t=this.getVizType();return t==="info/column"||t==="info/line";}function h(o){return o[Object.keys(o)[0]];}c.prototype.getRange=function(){if(!f.apply(this)){return null;}return this.rangeState;};c.prototype._getCategoryRange=function(){if(!g.apply(this)){return null;}return this.categoryRangeState;};c.prototype._getTooltipContent=function(s,e,i){var n=s,o=e;if(g.apply(this)){if(i==="end"&&o-n>1){o--;}}var v=this._getVizFrame();return v._getDataRange(n,o).displayValues[i];};function u(r){var e=this._getRangeSlider();var v=this._getVizFrame();e.setRange(k.call(this,r));var i=e.getRange();var n=v._getDataRange(i[0],i[1]);this.rangeState={start:h(n.start),end:h(n.end)};}function j(e){var r=this._getRangeSlider();var v=this._getVizFrame();r.setRange(l.call(this,e));var i=r.getRange();var n=v._getDataRange(i[0]+1,i[1]-1);this.categoryRangeState={start:n.data[0],end:n.data[n.data.length-1]};}function k(i){if(!f.apply(this)){return null;}if(!i||(!("start"in i)&&!("end"in i))){return[0,100];}var r=new Date(i.start).getTime();var e=new Date(i.end).getTime();var t=this._getVizFrame()._getDataRange(0,100);var n=this.getRange();var o=h(t.start);var s=h(t.end);if(!n){n={};n.start=o;n.end=s;}r=isNaN(r)?n.start:r;e=isNaN(e)?n.end:e;if(r<e&&r<s&&e>o){r=Math.max(r,o);e=Math.min(e,s);var v=s-o;return[(r-o)/v*100,(e-o)/v*100];}return[0,100];}function l(i){if(!g.apply(this)){return null;}if(!i||(!("start"in i)&&!("end"in i))){return[0,100];}var t=this._getVizFrame()._getDataRange(0,100);var e=t.data.length;var n=t.data[0];var o=t.data[e-1];var r=this._getCategoryRange()||{start:n,end:o};var s=i.start||r.start;var v=i.end||r.end;var w=-1,x=-1;t.data.forEach(function(y,z){if(d(s,y)){w=z;}if(d(v,y)){x=z+1;}});if(w<x&&w<e&&x>0){w=Math.max(w,0);x=Math.min(x,e);return[w/e*100,x/e*100];}return[0,100];}function m(){var s=this._getVizFrame()._states().plot.sizeInfo;var v=this._getVizFrame();this._curRange=[];var r=this._getRangeSlider();if(s){r.setWidth(s.width+"px");r.setHeight(s.height+"px");r.setLeft(s.x+"px");r.setTop(s.y+"px");r.setVisible(true);r.invalidate();if(f.apply(this)){var e=this.rangeState?this.rangeState:this.getProperty("range");u.call(this,e);}if(g.apply(this)){var i=this.categoryRangeState?this.categoryRangeState:this.getProperty("_categoryRange");j.call(this,i);}}else{r.setVisible(false);}v._setTitleAria("A noninteractive "+v._getMetadata().name+" with Range Slider ");}function p(e,i){var r=e.getParameters().range;if(this._curRange[0]===r[0]&&this._curRange[1]===r[1]){return;}else{var v=this._getVizFrame();var n=v._getDataRange(r[0],r[1]);if(f.apply(this)){this.rangeState={start:h(n.start),end:h(n.end)};}if(g.apply(this)){if(r[1]-r[0]>1){n=v._getDataRange(r[0],r[1]-1);}this.categoryRangeState={start:n.data[0],end:n.data[n.data.length-1]};}this._curRange[0]=r[0];this._curRange[1]=r[1];delete n.displayValues;this.fireEvent("rangeChanged",{data:n});}}return c;});
