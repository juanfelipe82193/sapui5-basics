// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/ui/Device","sap/ui/model/Filter","sap/ushell/ui/launchpad/TileState","sap/ushell/components/_HomepageManager/PagingManager","sap/ushell/components/_HomepageManager/DashboardLoadingManager","sap/ushell/EventHub","sap/ushell/Config","sap/ushell/utils","sap/ushell/resources","sap/ushell/components/DestroyHelper","sap/ushell/components/GroupsHelper","sap/ushell/components/MessagingHelper","sap/m/GenericTile","sap/m/SelectDialog","sap/m/StandardListItem","sap/ushell/components/_HomepageManager/PersistentPageOperationAdapter","sap/ushell/components/_HomepageManager/TransientPageOperationAdapter","sap/ui/model/FilterOperator","sap/m/library","sap/ui/model/Context","sap/m/MessageToast","sap/base/Log","sap/ui/performance/Measurement"],function(Q,B,D,F,T,P,a,e,s,u,r,d,g,m,G,S,b,c,f,h,l,C,M,L,n){"use strict";var o=l.GenericTileScope;var p={PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"};var _=[];var t=false;function v(R){_.push(R);if(!t){t=true;_.shift()();}}function w(){if(_.length===0){t=false;}else{_.shift()();}}function x(){_=[];t=false;}var y=[];return B.extend("sap.ushell.components.HomepageManager",{metadata:{publicMethods:["getModel","getDashboardView","loadPersonalizedGroups","resetGroupsOnFailure","addGroupToModel","addTileToGroup","deleteTilesFromGroup"]},analyticsConstants:p,constructor:function(i,j){if(sap.ushell.components.getHomepageManager){var H=sap.ushell.components.getHomepageManager();if(!H.view){H.setDashboardView(j.view);}return H;}sap.ui.getCore().attachThemeChanged(u.handleTilesVisibility);sap.ushell.components.getHomepageManager=(function(q){return function(){return q;};}(this));this.oPageOperationAdapter=c.getInstance();this.oPageBuilderService=sap.ushell.Container.getService("LaunchPage");this.oModel=j.model;this.oRouter=j.router;this.oDashboardView=j.view;this.oSortableDeferred=new Q.Deferred();this.oSortableDeferred.resolve();this.registerEvents();this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0;this.tileUuid=null;this.bIsGroupsModelLoading=false;this.segmentsStore=[];this.bIsFirstSegment=true;this.bIsFirstSegmentViewLoaded=false;this.aGroupsFrame=null;this.iMinNumOfTilesForBlindLoading=this.oModel.getProperty("/optimizeTileLoadingThreshold")||100;this.bIsScrollModeAccordingKPI=false;this.oGroupNotLockedFilter=new F("isGroupLocked",h.EQ,false);this.bLinkPersonalizationSupported=this.oPageOperationAdapter.isLinkPersonalizationSupported();this.oDashboardLoadingManager=new a("loadingManager",{oDashboardManager:this});if(this.oRouter){var k=this.oRouter.getTarget("home");k.attachDisplay(function(q){this.oDashboardView=q.getParameter("view");}.bind(this));}var E=s.last("/core/home/enableTransientMode");y.push(s.on("/core/home/enableTransientMode").do(function(N){if(E===N){return;}E=N;this._changeMode(N);}.bind(this)));this.oModel.bindProperty("/tileActionModeActive").attachChange(this._changeLinksScope.bind(this));return undefined;},isBlindLoading:function(){var i=s.last("/core/home/homePageGroupDisplay");if((i===undefined||i==="scroll")&&this.bIsScrollModeAccordingKPI){L.info("isBlindLoading reason IsScrollModeAccordingKPI and IsScrollMode: true");return true;}if(this.oModel.getProperty("/tileActionModeActive")){L.info("isBlindLoading reason TileActionModeActive : true");return true;}return false;},createMoveActionDialog:function(i){var j=this.oGroupNotLockedFilter,k=new S(i,{title:r.i18n.getText("moveTileDialog_title"),rememberSelections:false,search:function(E){var V=E.getParameter("value"),q=new F("title",h.Contains,V),z=E.getSource().getBinding("items");z.filter([q,j]);},contentWidth:"400px",contentHeight:"auto",confirm:function(E){var q=E.getParameter("selectedContexts");this.publishMoveActionEvents(q,i);}.bind(this),cancel:function(){var q=Q(".sapUshellTile[tabindex=\"0\"]")[0];if(q){q.focus();}},items:{path:"/groups",filters:[j],template:new b({title:"{title}"})}});return k;},publishMoveActionEvents:function(i,j){var E=sap.ui.getCore().getEventBus();if(i.length){var k=this.tileType==="link"?"links":"tiles",q=i[0].getObject().groupId,z={sTileId:this.tileUuid,sToItems:k,sFromItems:k,sTileType:k,toGroupId:i[0].getObject().groupId,toIndex:i[0].getObject()[this.tileType==="link"?"links":"tiles"].length,source:j};if(D.system.desktop){z.callBack=sap.ushell.components.ComponentKeysHandler.callbackSetFocus.bind(sap.ushell.components.ComponentKeysHandler);}E.publish("launchpad","scrollToGroup",{groupId:q});E.publish("launchpad","movetile",z);}},_changeLinksScope:function(E){var i=this;if(this.bLinkPersonalizationSupported){var I=E.getSource().getValue();this.oModel.getProperty("/groups").forEach(function(j,k){if(!j.isGroupLocked){i._changeGroupLinksScope(j,I?"Actions":"Display");}});}},_changeGroupLinksScope:function(i,j){var k=this;i.links.forEach(function(q,z){k._changeLinkScope(q.content[0],j);});},_changeLinkScope:function(i,j){var k=i.getScope?i:i.getContent()[0];if(this.bLinkPersonalizationSupported&&k.setScope){k.setScope(j);}},registerEvents:function(){var E=sap.ui.getCore().getEventBus();E.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);E.subscribe("launchpad","tabSelected",this.getSegmentTabContentViews,this);E.subscribe("sap.ushell.services.Bookmark","bookmarkTileAdded",this._addBookmarkToModel,this);E.subscribe("sap.ushell.services.Bookmark","catalogTileAdded",this._refreshGroupInModel,this);E.subscribe("sap.ushell.services.Bookmark","bookmarkTileDeleted",this.loadPersonalizedGroups,this);E.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);E.subscribe("launchpad","createGroupAt",this._createGroupAt,this);E.subscribe("launchpad","deleteGroup",this._deleteGroup,this);E.subscribe("launchpad","resetGroup",this._resetGroup,this);E.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);E.subscribe("launchpad","moveGroup",this._moveGroup,this);E.subscribe("launchpad","deleteTile",this._deleteTile,this);E.subscribe("launchpad","movetile",this._moveTile,this);E.subscribe("launchpad","sortableStart",this._sortableStart,this);E.subscribe("launchpad","sortableStop",this._sortableStop,this);E.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);E.subscribe("launchpad","convertTile",this._convertTile,this);this.oPageBuilderService.registerTileActionsProvider(this._addFLPActionsToTile.bind(this));},_changeMode:function(i){var j=this.getModel().getProperty("/groups");if(i){this.oPageOperationAdapter=f.getInstance();var k=this.oPageOperationAdapter.transformGroupModel(j);this.getModel().setProperty("/groups",k);}else{this.oPageOperationAdapter=c.getInstance();d.destroyFLPAggregationModels(j);this.getModel().setProperty("/groups",[]);this.loadPersonalizedGroups();}},_addFLPActionsToTile:function(i){var j=this.bLinkPersonalizationSupported&&this.oPageOperationAdapter.isLinkPersonalizationSupported(i),A=[];A.push(this._getMoveTileAction(i));if(j){A.push(this._getConvertTileAction(i));}return A;},_getConvertTileAction:function(i){var E=sap.ui.getCore().getEventBus(),j=this,k=j.oPageOperationAdapter.getTileType(i);return{text:k==="link"?r.i18n.getText("ConvertToTile"):r.i18n.getText("ConvertToLink"),press:function(q){var z={tile:q};if(D.system.desktop){z.callBack=sap.ushell.components.ComponentKeysHandler.callbackSetFocus.bind(sap.ushell.components.ComponentKeysHandler);}E.publish("launchpad","convertTile",z);}};},_getMoveTileAction:function(i){var j=this;return{text:r.i18n.getText("moveTileDialog_action"),press:function(){j.tileType=j.oPageOperationAdapter.getTileType(i);j.tileUuid=j.getModelTileById(j.oPageOperationAdapter.getTileId(i),j.tileType==="link"?"links":"tiles").uuid;var k=j.tileType==="tile"?j.moveTileDialog:j.moveLinkDialog;if(j.tileType==="tile"||j.tileType==="link"){if(!k){k=j.createMoveActionDialog("move"+j.tileType+"Dialog");k.setModel(j.oModel);if(j.tileType==="tile"){j.moveTileDialog=k;}else{j.moveLinkDialog=k;}}else{k.getBinding("items").filter([j.oGroupNotLockedFilter]);}k.open();}}};},_handleTileAppearanceAnimation:function(j){if(!j){return;}var k=["webkit",""];function q(z,A){for(var i=0;i<k.length;i++){A=A.toLowerCase();j.attachBrowserEvent(k[i]+A,function(E){if(E.originalEvent&&E.originalEvent.animationName==="sapUshellTileEntranceAnimation"){j.removeStyleClass("sapUshellTileEntrance");}},false);}}q(j,"AnimationEnd");j.addStyleClass("sapUshellTileEntrance");},destroy:function(){var E=sap.ui.getCore().getEventBus();E.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);E.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);E.unsubscribe("launchpad","createGroupAt",this._createGroupAt,this);E.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);E.unsubscribe("launchpad","resetGroup",this._resetGroup,this);E.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);E.unsubscribe("launchpad","moveGroup",this._moveGroup,this);E.unsubscribe("launchpad","deleteTile",this._deleteTile,this);E.unsubscribe("launchpad","movetile",this._moveTile,this);E.unsubscribe("launchpad","sortableStart",this._sortableStart,this);E.unsubscribe("launchpad","sortableStop",this._sortableStop,this);E.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);sap.ui.getCore().detachThemeChanged(u.handleTilesVisibility);y.forEach(function(i){i.off();});c.destroy();f.destroy();sap.ushell.components.getHomepageManager=undefined;B.prototype.destroy.apply(this,arguments);},_sortableStart:function(){this.oSortableDeferred=new Q.Deferred();},_createBookmark:function(i,E,j){var k=j.group?j.group.object:"";delete j.group;function q(){sap.ushell.Container.getServiceAsync("Bookmark").then(function(z){z.addBookmark(j,k).always(w).done(function(){m.showLocalizedMessage("tile_created_msg");}).fail(function(A){L.error("Failed to add bookmark",A,"sap.ushell.ui.footerbar.AddBookmarkButton");m.showLocalizedError("fail_to_add_tile_msg");});});}v(q);},_addBookmarkToModel:function(i,E,j){var k=j.tile,q,z=j.group,A,H,I,N,J;if(!j||!k){this.bIsGroupsModelDirty=true;if(!this.bGroupsModelLoadingInProcess){this._handleBookmarkModelUpdate();}return;}if(!z){q=this.getModel().getProperty("/groups");for(J=0;J<q.length;J++){if(q[J].isDefaultGroup===true){z=q[J].object;break;}}}H=this._getIndexOfGroupByObject(z);I=this.oModel.getProperty("/groups/"+H);A=this.oPageOperationAdapter.getPreparedTileModel(k,I.isGroupLocked);this.getTileView(A);I.tiles.push(A);I.visibilityModes=u.calcVisibilityModes(I,true);N=I.tiles.length;this._updateModelWithTileView(H,N);this.oModel.setProperty("/groups/"+H,I);},_refreshGroupInModel:function(i,E,j){var k=this;this.oPageOperationAdapter.refreshGroup(j).then(function(q){if(!q){return;}var z=k._getIndexOfGroupByObject(q.object);q.visibilityModes=u.calcVisibilityModes(q.object,true);k.oModel.setProperty("/groups/"+z,q);if(q.tiles){q.tiles.forEach(function(A){k.getTileView(A);});}});},_sortableStop:function(){this.oSortableDeferred.resolve();},_handleAfterSortable:function(i){return function(){var j=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){i.apply(null,j);});}.bind(this);},_createGroupAt:function(j,E,k){var q=parseInt(k.location,10),z=this.oModel.getProperty("/groups"),A=this.oPageOperationAdapter.getPreparedGroupModel(null,false,q===z.length,k),H=this.oModel,i;A.index=q;z.splice(q,0,A);for(i=0;i<z.length-1;i++){z[i].isLastGroup=false;}for(i=q+1;i<z.length;i++){z[i].index++;}H.setProperty("/groups",z);},_getIndexOfGroupByObject:function(i){var j=this.oModel.getProperty("/groups");return this.oPageOperationAdapter.getIndexOfGroup(j,i);},getTileActions:function(i){return this.oPageOperationAdapter.getTileActions(i);},addTileToGroup:function(i,j){var k=i+"/tiles",q=this.oModel.getProperty(i),N=this.oModel.getProperty(k).length;var z=this.oModel.getProperty(i+"/isGroupLocked"),A=this.oModel.getProperty("/personalization");q.tiles[N]=this.oPageOperationAdapter.getPreparedTileModel(j,z);this.getTileView(q.tiles[N]);q.visibilityModes=u.calcVisibilityModes(q,A);this._updateModelWithTileView(q.index,N);this.oModel.setProperty(i,q);},addTilesToGroupByCatalogTileId:function(j,k){var q=j.getBindingContext();for(var i=0;i<k.length;i++){this.addTileToGroupByCatalogTileId(q.sPath,k[i]);}},addTileToGroupByCatalogTileId:function(i,j){var N,k,q;if(!s.last("/core/home/enableTransientMode")){return;}q=this.oPageOperationAdapter.getTileModelByCatalogTileId(j);if(!q){return;}this.oDashboardLoadingManager.setTileResolved(q);N=this.oModel.getProperty(i+"/tiles").length;k=this.oModel.getProperty(i);k.tiles[N]=q;this.oModel.setProperty(i,k);},_getPathOfTile:function(i){var j=this.oModel.getProperty("/groups"),k=null,q=null,z,E=function(A,H){if(H.uuid===i){q=A;return false;}return undefined;};Q.each(j,function(A,H){Q.each(H.tiles,E);if(q!==null){k=A;z="tiles";return false;}Q.each(H.links,E);if(q!==null){k=A;z="links";return false;}return undefined;});return k!==null?"/groups/"+k+"/"+z+"/"+q:null;},_moveInArray:function(A,i,j){if(j>=A.length){var k=j-A.length;while((k--)+1){A.push(undefined);}}A.splice(j,0,A.splice(i,1)[0]);},_updateGroupIndices:function(A){var k;for(k=0;k<A.length;k++){A[k].index=k;}},_deleteGroup:function(i,E,j){var k=this,q=this.oModel,z=j.groupId,A=q.getProperty("/groups"),H=g.getIndexOfGroup(A,z),I=A.length-1===H,J=null,K,N;K=I?H-1:H;d.destroyFLPAggregationModel(q.getProperty("/groups/"+H));J=A.splice(H,1)[0];if(I){q.setProperty("/groups/"+K+"/isLastGroup",I);}q.setProperty("/groups",A);this._updateGroupIndices(A);if(K>=0){N=sap.ui.getCore().getEventBus();window.setTimeout(Q.proxy(N.publish,N,"launchpad","scrollToGroup",{groupId:q.getProperty("/groups")[K].groupId}),200);}function O(){k.oPageOperationAdapter.deleteGroup(J).then(function(){m.showLocalizedMessage("group_deleted_msg",[J.title]);w();},function(){k._resetGroupsOnFailure("fail_to_delete_group_msg");});}v(O);},_resetGroup:function(i,E,j){var k=this,q=j.groupId,z=this.oModel,A=z.getProperty("/groups"),H=g.getIndexOfGroup(A,q),I=k.oModel.getProperty("/groups/indexOfDefaultGroup")===H,J=z.getProperty("/groups/"+H),K,N;z.setProperty("/groups/"+H+"/sortable",false);function O(){k.oPageOperationAdapter.resetGroup(J,I).then(function(R){k._handleAfterSortable(function(q,U,V){var A=k.oModel.getProperty("/groups"),H=g.getIndexOfGroup(A,q);k._loadGroup(H,V||U);m.showLocalizedMessage("group_reset_msg",[U.title]);k.oModel.setProperty("/groups/"+H+"/sortable",true);K=sap.ui.getCore().byId("dashboardGroups").getGroupControlByGroupId(q);N=K.getBindingContext().getObject().links;if(N&&N.length&&!K.getIsGroupLocked()){k._changeGroupLinksScope(K.getBindingContext().getObject(),k.oModel.getProperty("/tileActionModeActive")?o.Actions:o.Display);}if(K){K.rerender();e.emit("updateGroups",Date.now());u.handleTilesVisibility();}})(q,J,R);w();},function(){k._resetGroupsOnFailure("fail_to_reset_group_msg");});}v(O);},_moveGroup:function(j,E,k){var q=k.fromIndex,z=k.toIndex,A=this.oModel,H=A.getProperty("/groups"),I=A.getProperty("/tileActionModeActive"),J,K,N=this,i,O;if(!I){q=this._adjustFromGroupIndex(q,H);}J=H[q];K=J.groupId;if(!I){z=this._adjustToGroupIndex(z,H,K);}O=H[z];this._moveInArray(H,q,z);this._updateGroupIndices(H);for(i=0;i<H.length-1;i++){H[i].isLastGroup=false;}H[H.length-1].isLastGroup=true;A.setProperty("/groups",H);function R(){H=A.getProperty("/groups");var J=A.getProperty(g.getModelPathOfGroup(H,K));if(!J.object){return;}N.oPageOperationAdapter.getOriginalGroupIndex(O,H).then(function(U){var V={iFromIndex:q,iToIndex:z};return N.oPageOperationAdapter.moveGroup(J,U,V);}).then(w,function(){N._resetGroupsOnFailure("fail_to_move_group_msg");});}v(R);},_adjustToGroupIndex:function(j,k,q){var z=0,I=false,i=0;for(i=0;i<k.length&&z<j;i++){if(k[i].isGroupVisible){if(k[i].groupId===q){I=true;}else{z++;}}}if(I){return i-1;}return i;},_adjustFromGroupIndex:function(j,k){var q=0,i;for(i=0;i<k.length;i++){if(k[i].isGroupVisible){q++;}if(q===j+1){return i;}}return j;},_changeGroupTitle:function(i,E,j){var k=this,N=j.newTitle,q=this.oModel.getProperty("/groups"),z=j.groupId,A=g.getIndexOfGroup(q,z),H=k.oModel.getProperty("/groups/indexOfDefaultGroup")===A,I=this.oModel.getProperty("/groups/"+A),O=I.title;this.oModel.setProperty("/groups/"+A+"/title",N);function J(){var R;if(I.isLastGroup){R=k.oPageOperationAdapter.addGroupAt(I,undefined,H);}else{var U=k.oModel.getProperty("/groups")[A+1];R=k.oPageOperationAdapter.getOriginalGroupIndex(U,q).then(function(V){return k.oPageOperationAdapter.addGroupAt(I,V,H);});}R.then(function(V){k._handleAfterSortable(function(W,X){var Y=k.oModel.getProperty("/groups"),Z=g.getIndexOfGroup(Y,W);k._loadGroup(Z,X);})(z,V);w();},function(){k._resetGroupsOnFailure("fail_to_create_group_msg");});}function K(){this.oPageOperationAdapter.renameGroup(I,N,O).then(function(){w();},function(){k._resetGroupsOnFailure("fail_to_rename_group_msg");});}if(!I.object){w.call(this);v(J.bind(this));}else{v(K.bind(this));}},addGroupToModel:function(i){var j=this.oPageOperationAdapter.getPreparedGroupModel(i,false,true,{isRendered:true}),k=this.oModel.getProperty("/groups"),q=k.length,z;if(q>0){k[q-1].isLastGroup=false;}j.index=q;k.push(j);this.oModel.setProperty("/groups/",k);z=new C(this.oModel,"/groups/"+q);return z;},_deleteTile:function(i,E,j){var k=this,q=j.tileId,z=this.oModel.getProperty("/groups"),I=j.items||"tiles";Q.each(z,function(A,H){var J=false;Q.each(H[I],function(K,N){if(N.uuid!==q){return true;}d.destroyTileModel(k.oModel.getProperty("/groups/"+A+"/"+I+"/"+K));var O=H[I].splice(K,1)[0],R=k.oModel.getProperty("/personalization");H.visibilityModes=u.calcVisibilityModes(H,R);k.oModel.setProperty("/groups/"+A,H);function U(){k.oPageOperationAdapter.removeTile(H,O).then(function(){w();},function(){k._resetGroupsOnFailure("fail_to_remove_tile_msg");});}v(U);u.handleTilesVisibility();J=true;return false;});return!J;});},deleteTilesFromGroup:function(i,R){var j=this.oModel.getProperty("/groups"),k=g.getIndexOfGroup(j,i),q=this.oModel.getProperty("/groups/"+k),z=[];["tiles","links"].forEach(function(A){z=q[A].filter(function(E){if(R.indexOf(E.uuid)<0){return true;}return false;});q[A]=z;});q.visibilityModes=u.calcVisibilityModes(q,true);this.oModel.setProperty("/groups/"+k,q);},_getGroupIndex:function(i){var j=this.oModel.getProperty("/groups"),k=this._getNewGroupInfo(j,i);if(k){return k.newGroupIndex;}return undefined;},_convertTile:function(i,E,j){var k=j.tile?j.tile:j,q=j.srcGroupId?this._getGroupIndex(j.srcGroupId):undefined,z=j.srcGroupId?this.oModel.getProperty("/groups/"+q):k.getParent().getBindingContext().getObject(),A=k.getBindingContext().sPath.split("/"),H=k.getBindingContext().getObject(),O=A[A.length-2],I=H.uuid,J=parseInt(A[A.length-1],10),K=j.toIndex!==undefined?j.toIndex:undefined,N=this.oModel.getProperty("/tileActionModeActive"),R=j.toGroupId?this._getGroupIndex(j.toGroupId):z.index,U=j.toGroupId?this.oModel.getProperty("/groups/"+R):z,V=this;var W=this._getIndexForConvert(O,J,K,z,U),X={"tileIndex":J,"groupIndex":q,"group":z};function Y(){H.tileIsBeingMoved=true;var Z=this.oPageOperationAdapter.moveTile(H,W,z,U,O==="links"?"tile":"link");Z.then(function($){V._showMoveTileMessage(H,z,U);V._handleAfterSortable(function(I,$){var a1=V._getPathOfTile(I),b1=$.content;if(a1){if(O==="tiles"){V._attachLinkPressHandlers(b1);V._addDraggableAttribute(b1);V._changeLinkScope(b1,N?"Actions":"Display");}var c1={"tileIndex":K,"groupIndex":R,"group":U},d1={"tile":H,"view":b1,"type":O,"tileObj":$.object};H.tileIsBeingMoved=true;V.replaceTileViewAfterConvert(X,c1,d1);e.emit("updateGroups",Date.now());u.handleTilesVisibility();if(j.callBack){j.callBack(b1);}}})(I,$);w();},function(){V._handleAfterSortable(V._resetGroupsOnFailure.bind(V))("fail_to_move_tile_msg");});}v(Y.bind(this));},replaceTileViewAfterConvert:function(i,j,k){var q=k.tile,z=q.content;q.tileIsBeingMoved=false;q.content=[k.view];q.object=k.tileObj;q.originalTileId=this.oPageOperationAdapter.getTileId(k.tileObj);i.group[k.type].splice(i.tileIndex,1);if(j.tileIndex!==undefined){j.group[k.type==="tiles"?"links":"tiles"].splice(j.tileIndex,0,q);}else{j.group[k.type==="tiles"?"links":"tiles"].push(q);}this.oModel.setProperty("/groups/"+j.groupIndex,j.group);this.oModel.setProperty("/groups/"+i.groupIndex,i.group);if(k.type==="links"){this._handleTileAppearanceAnimation(q.content[0].getParent());}else{this._handleTileAppearanceAnimation(q.content[0]);}if(z&&z[0]){z[0].destroy();}},_getIndexForConvert:function(i,j,k,q,z){var A;if(i==="tiles"){if(k!==undefined){A=z[i].length+k;}else{A=z[i].length+z.links.length;}if(q.groupId===z.groupId){A--;}}else{A=k||q.tiles.length;j+=q.tiles.length;}return{"tileIndex":j,"newTileIndex":A};},_getIndexForMove:function(i,j,k,q,z){var A;if(i==="tiles"){A=k!==undefined?k:q[i].length;}else{if(k!==undefined){A=q.tiles.length+k;}else{A=q.tiles.length+q.links.length;}j+=z.tiles.length;}return{"tileIndex":j,"newTileIndex":A};},_getTileInfo:function(i,j,I){var k;Q.each(i,function(q,z){var A=false;Q.each(z[I],function(E,H){if(H.uuid===j){k={"oTile":H,"tileIndex":E,"oGroup":z,"groupIndex":q};A=true;return false;}return undefined;});return!A;});return k;},_getNewGroupInfo:function(i,N){var j;Q.each(i,function(k,q){if(q.groupId===N){j={"oNewGroup":q,"newGroupIndex":k};}});return j;},_moveTile:function(i,E,j){var k=j.toIndex,N=j.toGroupId,q=j.sTileId,z=j.source,A=j.sTileType==="tiles"||j.sTileType==="tile"?"tile":"link",H=j.sToItems,I=j.sFromItems,J=this.oModel.getProperty("/tileActionModeActive"),K=this.oModel.getProperty("/groups"),O,R,U,V,W,X={},Y=this;V=this._getTileInfo(K,q,I);W=this._getNewGroupInfo(K,N);if(V.oGroup.groupId===W.oNewGroup.groupId&&(z==="movetileDialog"||k===null||z==="movelinkDialog")){if(j.callBack&&V.oTile&&V.oTile.content&&V.oTile.content.length){j.callBack(V.oTile.content[0]);}return;}if(A==="link"){V.oTile.content[0].addStyleClass("sapUshellZeroOpacity");}if(A==="tile"&&H==="tiles"){if(k&&k>W.oNewGroup[H].length){k=W.oNewGroup[H].length;}}if(V.oGroup.groupId===N&&H===I){if(k===null||k===undefined){V.oGroup[H].splice(V.tileIndex,1);k=V.oGroup[H].length;V.oGroup[H].push(V.oTile);}else{k=this._adjustTileIndex(k,V.oTile,V.oGroup,H);this._moveInArray(V.oGroup[H],V.tileIndex,k);}this.oModel.setProperty("/groups/"+V.groupIndex+"/"+H,V.oGroup[H]);}else{U=this.oModel.getProperty("/personalization");V.oGroup[I].splice(V.tileIndex,1);V.oGroup.visibilityModes=u.calcVisibilityModes(V.oGroup,U);this.oModel.setProperty("/groups/"+V.groupIndex+"/"+I,V.oGroup[I]);if(k===null||k===undefined){k=W.oNewGroup[H].length;W.oNewGroup[H].push(V.oTile);}else{k=this._adjustTileIndex(k,V.oTile,W.oNewGroup,H);W.oNewGroup[H].splice(k,0,V.oTile);}W.oNewGroup.visibilityModes=u.calcVisibilityModes(W.oNewGroup,U);this.oModel.setProperty("/groups/"+W.newGroupIndex+"/"+H,W.oNewGroup[H]);}e.emit("updateGroups",Date.now());u.handleTilesVisibility();O=this.oModel.getProperty("/groups/"+V.groupIndex);R=this.oModel.getProperty("/groups/"+W.newGroupIndex);X=this._getIndexForMove(I,V.tileIndex,k,W.oNewGroup,O);function Z(){V.oTile.tileIsBeingMoved=true;this.oPageOperationAdapter.moveTile(V.oTile,X,O,R,A).then(function($){var a1=Y._getPathOfTile(q);Y._showMoveTileMessage(V.oTile,O,R);if(a1){Y.oModel.setProperty(a1+"/object",$.object);Y.oModel.setProperty(a1+"/originalTileId",$.originalTileId);var b1=Y.oModel.getProperty(a1+"/content"),c1=$.content;if(H==="links"){Y._changeLinkScope(c1,J?"Actions":"Display");Y._attachLinkPressHandlers(c1);Y._addDraggableAttribute(c1);Y._handleTileAppearanceAnimation(c1);V.oTile.content=[c1];Y.oModel.setProperty(a1,Q.extend({},V.oTile));Y.oModel.setProperty("/groups/"+W.newGroupIndex+"/"+H,Y.oModel.getProperty("/groups/"+W.newGroupIndex+"/"+H));}else{Y.oModel.setProperty(a1+"/content",[c1]);}if(b1&&b1[0]){var d1=c1.onAfterRendering;c1.onAfterRendering=function(){d1.apply(this);b1[0].destroy();c1.onAfterRendering=d1;};}Y.oModel.setProperty(a1+"/tileIsBeingMoved",false);if(j.callBack){j.callBack(c1);}}w();},function(){Y._resetGroupsOnFailure("fail_to_move_tile_msg");});}v(Z.bind(this));},_showMoveTileMessage:function(i,j,k){var q=this.oPageOperationAdapter.getTileTitle(i),z=k.title,A=r.i18n.getText("added_tile_to_group"),E=q+" "+A+" "+z;if(j.groupId!==k.groupId){M.show(E);}},_adjustTileIndex:function(j,k,q,I){var z=0,A=false,i=0;for(i=0;i<q[I].length&&z<j;i++){if(q[I][i].isTileIntentSupported){if(q[I][i]===k){A=true;}else{z++;}}}if(A){return i-1;}return i;},getModel:function(){return this.oModel;},getDashboardView:function(){return this.oDashboardView;},setDashboardView:function(i){this.oDashboardView=i;return this;},setTileVisible:function(i,V){this.oPageOperationAdapter.setTileVisible(i.object,V);},refreshTile:function(i){this.oPageOperationAdapter.refreshTile(i.object);},updateSettings:function(i){this.oModel=i.model||this.oModel;this.oConfig=i.config||this.oConfig;this.oRouter=i.router||this.oRouter;this.oDashboardView=i.view||this.oDashboardView;},_resetGroupsOnFailure:function(i,j){x();m.showLocalizedError(i,j);this.bStartLoadRemainSegment=false;this.loadPersonalizedGroups();this.oModel.updateBindings(true);},resetGroupsOnFailure:function(){this._resetGroupsOnFailure.apply(this,arguments);},_bindSegment:function(i,j){var k,q,z,A;for(k=0;k<j.length;k++){z=j[k];A=z.index;q=i[A];if(q){q.isRendered=true;q.tiles=q.tiles.concat(z.tiles);q.links=q.links.concat(z.links);}}return i;},createGroupsModelFrame:function(i,j){var k,q=[],O,z;z=function(A){var E=Q.extend({},A);E.tiles=[];E.pendingLinks=[];E.links=[];return E;};for(k=0;k<i.length;k++){O=i[k];q[k]=z(O);q[k].isRendered=false;q[k].visibilityModes=u.calcVisibilityModes(O,j);}return q;},_splitGroups:function(i,j){var k,q=[],z=0,I=this.oModel.getProperty("/homePageGroupDisplay")==="tabs",A=0,E;var H=500;for(k=0;k<i.length;k++){E=i[k];q.push(E);if(!this.segmentsStore.length){z+=this.PagingManager.getGroupHeight(E,j===k);}else{A+=E.tiles.length+E.links.length;}if(I&&!this.segmentsStore.length&&z>0){q.loadTilesView=true;this.segmentsStore.push(q);q=[];z=0;}if(z>=1||A>=H){this.segmentsStore.push(q);q=[];z=0;A=0;}}if(q.length){this.segmentsStore.push(q);}},_processSegment:function(i){var j=this.segmentsStore.shift();if(!j){return i;}if(this.isBlindLoading()===false){if(this.oModel.getProperty("/homePageGroupDisplay")!=="tabs"||j.loadTilesView){this.getSegmentContentViews(j);}}i=this._bindSegment(i,j);return i;},getSegmentContentViews:function(i){var j,k,q,z;for(j=0;j<i.length;j++){q=i[j];for(k=0;k<q.tiles.length;k++){z=q.tiles[k];if(z.isTileIntentSupported){this.getTileView(z);}}for(k=0;k<q.links.length;k++){z=q.links[k];if(z.isTileIntentSupported){this.getTileView(z,q.index);}}}this.bIsFirstSegmentViewLoaded=true;},getSegmentTabContentViews:function(i,E,j){var k,q,z=j.iSelectedGroup,A;A=this.oModel.getProperty("/groups/"+z);for(k=0;k<A.tiles.length;k++){q=A.tiles[k];if(q.isTileIntentSupported){this.getTileView(q);}}for(k=0;k<A.links.length;k++){q=A.links[k];if(q.isTileIntentSupported){this.getTileView(q,z);}}},_handleBookmarkModelUpdate:function(){this.bIsGroupsModelDirty=false;this.bGroupsModelLoadingInProcess=true;this.loadPersonalizedGroups();},_modelLoaded:function(){this.bGroupsModelLoadingInProcess=false;if(this.bIsGroupsModelDirty){this._handleBookmarkModelUpdate();}},handleFirstSegmentLoaded:function(){var i=this.oModel.getProperty("/groups");if(this.aGroupsFrame){Array.prototype.push.apply(i,this.aGroupsFrame);this.aGroupsFrame=null;}this._initializeAnchorNavigationBar();if(!this.bStartLoadRemainSegment){this._processRemainingSegments();}},_initializeAnchorNavigationBar:function(){var A,i=sap.ushell.components.getHomepageManager().getDashboardView();A=i.getAnchorItemTemplate();this.oDashboardView.oAnchorNavigationBar.bindAggregation("groups",{path:"/groups",template:A});},_processRemainingSegments:function(){var U;if(this.segmentsStore.length>0){window.setTimeout(function(){U=this._processSegment(this.oModel.getProperty("/groups"));this.oModel.setProperty("/groups",U);this.bIsFirstSegment=false;this._processRemainingSegments();}.bind(this),0);}else{this.bIsGroupsModelLoading=false;this._updateModelWithTileView(0,0);u.handleTilesVisibility();sap.ui.getCore().getEventBus().publish("launchpad","dashboardModelContentLoaded");e.emit("updateGroups",Date.now());}},_setGroupModel:function(j){if(this.bIsGroupsModelLoading){L.info("Skip set the group model, because the group model is still loading");return;}var i=0,k,q=0,z=0,A=0,E,H,I=null,J,K,N=[];this.bIsGroupsModelLoading=true;try{q=this.oModel.getProperty("/groups").length;}catch(O){}for(i=j.length;i<q;++i){d.destroyFLPAggregationModel(this.oModel.getProperty("/groups/"+i));}if(!this.PagingManager){var R=Q("#dashboardGroups").width();if(!R){R=window.innerWidth;}var U=Q("#sapUshellDashboardPage-cont").height();if(U<100){U=window.innerHeight;}this.PagingManager=new P("dashboardPaging",{supportedElements:{tile:{className:"sapUshellTile"},link:{className:"sapUshellLinkTile"}},containerHeight:U,containerWidth:R});}j.forEach(function(V){if(V.isGroupVisible){z+=V.tiles.length;}});this.bIsScrollModeAccordingKPI=z>this.iMinNumOfTilesForBlindLoading;this.aGroupsFrame=this.createGroupsModelFrame(j,this.oModel.getProperty("/personalization"));for(i=0;i<this.aGroupsFrame.length;i++){if(this.aGroupsFrame[i].isGroupVisible&&this.aGroupsFrame[i].visibilityModes[0]){if(I===null){I=i;this.aGroupsFrame[i].isGroupSelected=true;this.oModel.setProperty("/iSelectedGroup",i);}A++;if(A>1){this.aGroupsFrame[I].showGroupHeader=false;break;}}}this._splitGroups(j,I);H=this.segmentsStore[0]?this.segmentsStore[0].length:0;E=this.aGroupsFrame.splice(0,H);n.start("FLP:DashboardManager._processSegment","_processSegment","FLP");N=this._processSegment(E);j.every(function(V,W){if(V.isDefaultGroup){k=W;return false;}return true;});N.indexOfDefaultGroup=k;if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){J=this.getDashboardView();if(J){K=J.oDashboardGroupsBox;K.getBinding("groups").filter([J.oFilterSelectedGroup]);}}n.end("FLP:DashboardManager._processSegment");this.oModel.setProperty("/groups",N);this.aGroupModel=N;if(this.oDashboardView){e.once("firstSegmentCompleteLoaded").do(function(){u.setPerformanceMark("FLP-TTI-Homepage",{bUseUniqueMark:true});}).do(this.handleFirstSegmentLoaded.bind(this));}else{setTimeout(function(){Array.prototype.push.apply(this.aGroupModel,this.aGroupsFrame);this.aGroupsFrame=null;this.bStartLoadRemainSegment=true;this._processRemainingSegments();}.bind(this),0);}if(this.bIsFirstSegmentViewLoaded){e.emit("firstSegmentCompleteLoaded",true);}n.end("FLP:DashboardManager.loadGroupsFromArray");Q.sap.flpmeasure.end(0,"Process & render the first segment/tiles");},getPreparedGroupModel:function(){return this.aGroupModel;},_loadGroup:function(i,N){var j=this,k="/groups/"+i,O=j.oModel.getProperty(k),I=O.isLastGroup,q=O.groupId;d.destroyFLPAggregationModel(O);if(q){N.groupId=q;}N.isLastGroup=I;N.index=i;N.isRendered=true;this.oModel.setProperty(k,N);},_hasPendingLinks:function(j){for(var i=0;i<j.length;i++){if(j[i].content[0]===undefined){return true;}}return false;},_addModelToTileViewUpdateQueue:function(i,j){this.tileViewUpdateQueue.push({uuid:i,view:j});},_updateModelWithTileView:function(i,j){var k=this;if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID);}this.tileViewUpdateTimeoutID=window.setTimeout(function(){k.tileViewUpdateTimeoutID=undefined;k.oSortableDeferred.done(function(){k._updateModelWithTilesViews(i,j);});},50);},_updateGroupModelWithTilesViews:function(i,k,z,A){var E,U,H,I,J=k||0;for(var j=J;j<i.length;j=j+1){E=i[j];for(var q=0;q<this.tileViewUpdateQueue.length;q++){U=this.tileViewUpdateQueue[q];if(E.uuid===U.uuid){z.push(q);if(U.view){if(A){E.content=[U.view];}else{E.content[0].destroy();E.content=[U.view];}this.oDashboardLoadingManager.setTileResolved(E);H=this.oPageOperationAdapter.getTileSize(E.object);I=((H!==null)&&(H==="1x2"))||false;if(E.long!==I){E.long=I;}}else{E.content[0].setState("Failed");}break;}}}},_updateModelWithTilesViews:function(j,k){var q=this.oModel.getProperty("/groups"),z=j||0,A=[];if(!q||this.tileViewUpdateQueue.length===0){return;}for(var i=z;i<q.length;i=i+1){this._updateGroupModelWithTilesViews(q[i].tiles,k,A);if(q[i].links){this._updateGroupModelWithTilesViews(q[i].links,k,A,true);if(q[i].pendingLinks.length>0){if(!q[i].links){q[i].links=[];}q[i].links=q[i].links.concat(q[i].pendingLinks);q[i].pendingLinks=[];}}}var E=[],H;for(H=0;H<this.tileViewUpdateQueue.length;H++){if(A.indexOf(H)===-1){E.push(this.tileViewUpdateQueue[H]);}}this.tileViewUpdateQueue=E;this.oModel.setProperty("/groups",q);},getModelTileById:function(i,I){var j=this.oModel.getProperty("/groups"),k,q=false;j.every(function(z){z[I].every(function(A){if(A.uuid===i||A.originalTileId===i){k=A;q=true;}return!q;});return!q;});return k;},_addDraggableAttribute:function(V){if(this.isIeHtml5DnD()){V.addEventDelegate({onAfterRendering:function(){this.$().attr("draggable","true");}.bind(V)});}},_attachLinkPressHandlers:function(V){var E=sap.ui.getCore().getEventBus(),i=V.attachPress?V:V.getContent()[0];i.attachPress(function(j){var k=V.getBindingContext().getObject().tileIsBeingMoved;if(!k&&this.getScope&&this.getScope()==="Actions"){switch(j.getParameters().action){case"Press":var q=V.getState?V.getState():"";if(q!=="Failed"){sap.ushell.components.homepage.ActionMode._openActionsMenu(j,V);}break;case"Remove":var z=V.getBindingContext().getObject().uuid;E.publish("launchpad","deleteTile",{tileId:z,items:"links"});break;default:break;}}else{E.publish("launchpad","dashboardTileLinkClick");}});},handleDisplayModeChange:function(N){this.oModel.setProperty("/homePageGroupDisplay",N);switch(N){case"scroll":this._handleDisplayModeChangeToScroll();break;case"tabs":this._handleDisplayModeChangeToTabs();break;}},_handleDisplayModeChangeToTabs:function(){var j=this.oModel.getProperty("/iSelectedGroup"),k=this.oModel.getProperty("/groups");if(k.length>0){for(var i=0;i<k.length;i++){this.oModel.setProperty("/groups/"+i+"/isGroupSelected",false);}this.oModel.setProperty("/groups/"+j+"/isGroupSelected",true);}},_handleDisplayModeChangeToScroll:function(){if(this.isBlindLoading()){return;}var k=this.oModel.getProperty("/groups"),q,z,A,E=[],i,j;for(i=0;i<k.length;i++){q=k[i];z=q.tiles||[];for(j=0;j<z.length;j++){A=z[j];if(A.content.length===0){this.getTileView(A,i);}}E=q.links||[];for(j=0;j<E.length;j++){this.getTileView(E[j],i);}}this.oModel.refresh(false);var H=this.oModel.getProperty("/iSelectedGroup");if(H){setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","scrollToGroup",{groupId:k[H].groupId});},100);}},getTileViewsFromArray:function(R){var i=this;if(R.length===0){return;}R.forEach(function(j){i.getTileView(j.oTile,j.iGroup);});this.oModel.refresh(false);if(this.bIsFirstSegmentViewLoaded===false){this.bIsFirstSegmentViewLoaded=true;e.emit("firstSegmentCompleteLoaded",true);}},getTileView:function(i,j){var k=this.oPageOperationAdapter.getTileType(i.object);if(this.oDashboardLoadingManager.isTileViewRequestIssued(i)){return;}this.oDashboardLoadingManager.setTileInProgress(i);this.oPageOperationAdapter.setTileVisible(i.object,false);if(k==="card"){this._loadCardData(i);}else{this._loadTileData(i,j,k);}},_loadCardData:function(i){var j=sap.ui.getCore().byId(i.controlId),k=Q.sap.flpmeasure.startFunc(0,"Loading of data and rendering for all cards",5,"loadCardData",i.object);if(j&&j.setManifest&&this.isBlindLoading()){j.setManifest(i.manifest);}i.content=[i.manifest];this.oDashboardLoadingManager.setTileResolved(i);Q.sap.flpmeasure.endFunc(0,"Loading of data and rendering for all cards",k);},getCurrentHiddenGroupIds:function(i){return this.oPageOperationAdapter.getCurrentHiddenGroupIds(i);},_loadTileData:function(i,j,k){var q=this,z=this.oPageOperationAdapter.getTileView(i),A,E,H,U=this._addModelToTileViewUpdateQueue,I,N=false,J=i.uuid,K=false,O=Q.sap.flpmeasure.startFunc(0,"Service + model binding and rendering for all tile-Views",5,"getTileView",i.object);if(z.state()==="resolved"){K=true;}z.done(function(V){if(V.oController&&V.oController.navigationTargetUrl&&!i.isCustomTile){i.target=V.oController.navigationTargetUrl;}I=V;if(I.getComponentInstance){n.average("FLP:getComponentInstance","get info for navMode","FLP1");var R=I.getComponentInstance().getComponentData();if(R&&R.properties){i.navigationMode=R.properties.navigationMode;}n.end("FLP:getComponentInstance");}q.oDashboardLoadingManager.setTileResolved(i);A=V.getMode?V.getMode():"ContentMode";if(q.bLinkPersonalizationSupported&&A==="LineMode"){q._attachLinkPressHandlers(I);q._addDraggableAttribute(I);if(j>=0){E=q.oModel.getProperty("/groups");if(E[j]){i.content=[I];H=q.oModel.getProperty("/groups/"+j+"/links");q.oModel.setProperty("/groups/"+j+"/links",[]);q.oModel.setProperty("/groups/"+j+"/links",H);}}}else if(q.isBlindLoading()){if(i.content&&i.content.length>0){i.content[0].destroy();}i.content=[I];if(j>=0&&!K){q.oModel.refresh(false);}}if(q.isBlindLoading()){var W=q.oPageOperationAdapter.getTileSize(i.object);var X=W==="1x2";if(i.long!==X){i.long=X;}}else if(A==="LineMode"){i.content=[I];if(N){H=q.oModel.getProperty("/groups/"+j+"/links");q.oModel.setProperty("/groups/"+j+"/links",[]);q.oModel.setProperty("/groups/"+j+"/links",H);}}else if(i.content.length===0){i.content=[I];}else{U.apply(q,[J,I]);q._updateModelWithTileView(0,0);}Q.sap.flpmeasure.endFunc(0,"Service + model binding and rendering for all tile-Views",O);});z.fail(function(){if(q.oPageOperationAdapter.getTileType(i.object)==="link"&&q.bLinkPersonalizationSupported){I=q.oPageOperationAdapter.getFailedLinkView(i);q._attachLinkPressHandlers(I);}else{I=new T({state:"Failed"});}i.content=[I];});if(!I){if(q.oPageOperationAdapter.getTileType(i.object)==="link"){N=true;I=new G({mode:"LineMode"});}else{I=new T();}i.content=[I];}},isIeHtml5DnD:function(){return(D.browser.msie||D.browser.edge)&&(D.system.combi||D.system.tablet);},loadPersonalizedGroups:function(){var i=this;var j=new Q.Deferred();this.oPageOperationAdapter.getPage().then(function(k){i._setGroupModel(k);j.resolve();},function(){m.showLocalizedError("fail_to_load_groups_msg");});Q.sap.flpmeasure.start(0,"Service: Get Data for Dashboard",4);n.start("FLP:DashboardManager.loadPersonalizedGroups","loadPersonalizedGroups","FLP");return j.promise();}});});
