// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/ushell/components/tiles/indicatorTileUtils/cache","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(g,a,m,q,L){"use strict";var D=m.DeviationIndicator;var V=m.ValueColor;var S=m.Size;var b=m.LoadState;var F=m.FrameType;var C=g.extend("sap.ushell.components.tiles.indicatorcomparison.ComparisonTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false;},_processDataForComparisonChart:function(d,e,u){var f=[],h={},i,t,l;var j;var T=[];var k=this;var n=null;for(i=0;i<d.results.length;i++){var o=d.results[i];}T=sap.ushell.components.tiles.indicatorTileUtils.util.getAllMeasuresWithLabelText(this.oTileApi.url.addSystemToServiceUrl(this.oConfig.EVALUATION.ODATA_URL),this.oConfig.EVALUATION.ODATA_ENTITYSET);for(i=0,l=T.length;i<l;i++){t=T[i];h[t.key]=t.value;}var p=k.oConfig.TILE_PROPERTIES.COLUMN_NAMES||k.oConfig.EVALUATION.COLUMN_NAMES;for(i=0;i<p.length;i++){var r={};var s=p[i];r.value=Number(o[s.COLUMN_NAME]);var v=Number(o[s.COLUMN_NAME]);var w=false;var x=0;var y=k._getEvaluationThresholdMeasures();var I=y?Array.prototype.indexOf.call(y,s.COLUMN_NAME):-1;if(I>-1){w=true;x=k.oConfig.EVALUATION.SCALING;}if(k.oConfig.EVALUATION.SCALING===-2&&w){v*=100;}var c=k.isCurrencyMeasure(s.COLUMN_NAME);if(u&&u[i]&&o[u[i].name]){n=o[u[i].name];}j=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(v,x,k.oConfig.EVALUATION.SCALING,k.oConfig.EVALUATION.DECIMAL_PRECISION,c,n);if(k.oConfig.EVALUATION.SCALING===-2&&w){j+=" %";}r.displayValue=j.toString();if(u){if(u[i]&&o[u[i].name]){r.displayValue+=" "+o[u[i].name];}}r.color=s.semanticColor;r.title=h[s.COLUMN_NAME]||s.COLUMN_NAME;r.measure=s.COLUMN_NAME;r.isCurM=c;f.push(r);}return f;},fetchChartData:function(r,c,s,E){function d(A,B){var G=false;if(A&&A.results&&A.results.length){for(var i=0,l=B.length;i<l&&!G;i++){G=A.results[0][B[i].COLUMN_NAME]!==null;}}return G;}var t=this;try{var f=this.oConfig.EVALUATION.ODATA_ENTITYSET;var h=this.oConfig.EVALUATION.COLUMN_NAME;var k=h,j;if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES){for(j=0;j<this.oConfig.TILE_PROPERTIES.COLUMN_NAMES.length;j++){if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[j].COLUMN_NAME!==this.oConfig.EVALUATION.COLUMN_NAME){k=k+","+this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[j].COLUMN_NAME;}}}else{for(j=0;j<this.oConfig.EVALUATION.COLUMN_NAMES.length;j++){if(this.oConfig.EVALUATION.COLUMN_NAMES[j].COLUMN_NAME!==this.oConfig.EVALUATION.COLUMN_NAME){k=k+","+this.oConfig.EVALUATION.COLUMN_NAMES[j].COLUMN_NAME;}}}var n=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(r);var o=a.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){if(o){var p=o.Data&&JSON.parse(o.Data);}}var u=t.oTileApi.configuration.getParameterValueAsString("timeStamp");var v=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(t.oConfig.TILE_PROPERTIES.id,u,t.chipCacheTime,t.chipCacheTimeUnit,t.tilePressed);if((p&&!p.rightData)||!o||(!v&&t.oTileApi.visible.isVisible())||n||(c&&t.oTileApi.visible.isVisible())||t.getView().getViewData().refresh){if(t.kpiValueFetchDeferred){t.kpiValueFetchDeferred=false;var w=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var x=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oRunTimeODataModel,f,k,null,w,3);this.comparisionChartODataRef=x.model.read(x.uri,null,null,true,function(i){t.kpiValueFetchDeferred=true;var l={};if(x.unit){l.unit=x.unit;}if(d(i,t.oConfig.TILE_PROPERTIES.COLUMN_NAMES||t.oConfig.EVALUATION.COLUMN_NAMES)){t.oConfig.TILE_PROPERTIES.FINALVALUE=i;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,k.split(",")[0],x.unit);l.data=t.oConfig.TILE_PROPERTIES.FINALVALUE;var A={};t.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();A.ChipId=t.oConfig.TILE_PROPERTIES.id;A.Data=JSON.stringify(l);A.CacheMaxAge=Number(t.chipCacheTime);A.CacheMaxAgeUnit=t.chipCacheTimeUnit;A.CacheType=1;var B=t.getLocalCache(A);t.updateDatajobScheduled=false;var G=t.oConfig.TILE_PROPERTIES.id+"data";var H=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(G);if(H){clearTimeout(H);H=undefined;}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){a.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,B);var U=false;if(o){U=true;}if(t.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(t.oTileApi,t.oConfig.TILE_PROPERTIES.id,A,U,function(i){if(i){t.cacheTime=i&&i.CachedTime;a.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,i);t.setTimeStamp();}if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}});}}else{var I=a.getKpivalueById(t.oConfig.TILE_PROPERTIES.id),J;if(I){if(!I.CachedTime){I.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();}J=I.Data;if(J){J=JSON.parse(J);J.rightData=l;}I.Data=JSON.stringify(J);a.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,I);}else{J={};J.rightData=l;B.Data=JSON.stringify(J);a.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,B);}t.cacheWriteData=l;}s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(i.results.length===0){t.oConfig.TILE_PROPERTIES.FINALVALUE=i;if(a.getKpivalueById(t.oConfig.TILE_PROPERTIES.id)){l=a.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);l.data=i;}else{l.data=i;}a.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,l);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{a.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,{empty:"empty"});t.setNoData();}},function(i){t.kpiValueFetchDeferred=true;if(i&&i.response){L.error(i.message+" : "+i.request.requestUri);E.call(t,i);}});}}else if(o&&o.Data){var y;var z=t.oConfig&&t.oConfig.TILE_PROPERTIES&&t.oConfig.TILE_PROPERTIES.tileType;if(z.indexOf("DT-")===-1){y=o.Data&&JSON.parse(o.Data);}else{y=o.Data&&JSON.parse(o.Data);y=y.rightData;}t.cacheTime=o.CachedTime;if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){q.proxy(t.setTimeStamp(t.cacheTime),t);}if(y.data&&y.data.length){t.oConfig.TILE_PROPERTIES.FINALVALUE=y.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else{t.oConfig.TILE_PROPERTIES.FINALVALUE=y.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}}else{t.setNoData();}}catch(e){t.kpiValueFetchDeferred=true;E.call(t,e);}},doProcess:function(r,i){var t=this;this.setTextInTile();this.fetchChartData(r,i,function(k){this.CALCULATED_KPI_VALUE=k;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType===F.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(F.TwoByOne);t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());var c={};c.data=this.CALCULATED_KPI_VALUE;t.getView().getViewData().deferredObj.resolve();}else{t.oKpiTileView.oGenericTile.setFrameType(F.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(b.Loaded);}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"COMP");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible());}},this.logError);},doDummyProcess:function(){var t=this;this.setTextInTile();t._updateTileModel({value:8888,size:S.Auto,frameType:F.OneByOne,state:b.Loading,valueColor:V.Error,indicator:D.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1.2,color:"Good"},{title:"Measure 2",value:0.78,color:"Good"},{title:"Measure 3",value:1.4,color:"Error"}]});this.oKpiTileView.oGenericTile.setState(b.Loaded);}});return C;});
