// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ui/thirdparty/URI","sap/ushell/components/tiles/utils","sap/ushell/components/tiles/utilsRT","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/services/AppType","sap/m/library","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/util/UriParameters"],function(O,U,u,a,A,C,b,l,J,q,c){"use strict";var G=l.GenericTileScope;var d=l.GenericTileMode;sap.ui.getCore().loadLibrary("sap.m");sap.ui.controller("sap.ushell.components.tiles.applauncherdynamic.DynamicTile",{timer:null,_aDoableObject:{},oDataRequest:null,sConfigNavigationTargetUrlOld:"",REFRESH_INTERVAL_MIN:10,constructTargetUrlWithSapSystem:function(n,s){var o,h;if(s){o=sap.ushell.Container.getService("URLParsing");if(o.isIntentUrl(n)){h=o.parseShellHash(n);if(!h.params){h.params={};}h.params["sap-system"]=s;n="#"+o.constructShellHash(h);}else{n+=((n.indexOf("?")<0)?"?":"&")+"sap-system="+s;}}return n;},onInit:function(){var v=this.getView(),V=v.getViewData(),t=V.chip,o=a.getConfiguration(t,t.configurationUi.isEnabled(),false),m,k,K,e=this,N=o.navigation_target_url,s;this.sConfigNavigationTargetUrlOld=o.navigation_target_url;q.sap.log.setLevel(2,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");this.bIsRequestCompleted=false;this.oShellModel=A.getElementsModel();s=t.url.getApplicationSystem();this.navigationTargetUrl=this.constructTargetUrlWithSapSystem(N,s);m=new J({sizeBehavior:C.last("/core/home/sizeBehavior"),wrappingType:C.last("/core/home/wrappingType"),config:o,mode:o.display_mode||d.ContentMode,data:a.getDataToDisplay(o,{number:((t.preview&&t.preview.isEnabled())?1234:"...")}),nav:{navigation_target_url:(t.configurationUi&&t.configurationUi.isEnabled()?"":this.navigationTargetUrl)},search:{display_highlight_terms:[]}});v.setModel(m);this._aDoableObject=C.on("/core/home/sizeBehavior").do(function(S){m.setProperty("/sizeBehavior",S);});if(t.types){t.types.attachSetType(function(T){if(e.tileType!=T){var m=e.getView().getModel();if(T==="link"){m.setProperty("/mode",d.LineMode);}else{m.setProperty("/mode",m.getProperty("/config/display_mode")||d.ContentMode);}e.tileType=T;}});}if(!this.tileType){this.tileType="tile";}if(t.search){k=v.getModel().getProperty("/config/display_search_keywords");K=k.split(/[, ]+/).filter(function(n,i){return n&&n!=="";});if(o.display_title_text&&o.display_title_text!==""&&K.indexOf(o.display_title_text)===-1){K.push(o.display_title_text);}if(o.display_subtitle_text&&o.display_subtitle_text!==""&&K.indexOf(o.display_subtitle_text)===-1){K.push(o.display_subtitle_text);}if(o.display_info_text&&o.display_info_text!==""&&K.indexOf(o.display_info_text)===-1){K.push(o.display_info_text);}if(o.display_number_unit&&o.display_number_unit!==""&&K.indexOf(o.display_number_unit)===-1){K.push(o.display_number_unit);}t.search.setKeywords(K);t.search.attachHighlight(function(h){v.getModel().setProperty("/search/display_highlight_terms",h);});}if(t.bag&&t.bag.attachBagsUpdated){t.bag.attachBagsUpdated(function(h){if(h.indexOf("tileProperties")>-1){u._updateTilePropertiesTexts(v,t.bag.getBag("tileProperties"));}});}if(t.configuration&&t.configuration.attachConfigurationUpdated){t.configuration.attachConfigurationUpdated(function(h){if(h.indexOf("tileConfiguration")>-1){u._updateTileConfiguration(v,t.configuration.getParameterValueAsString("tileConfiguration"));}});}if(t.preview){t.preview.setTargetUrl(this.navigationTargetUrl);t.preview.setPreviewIcon(o.display_icon_url);t.preview.setPreviewTitle(o.display_title_text);if(t.preview.setPreviewSubtitle&&typeof t.preview.setPreviewSubtitle==="function"){t.preview.setPreviewSubtitle(o.display_subtitle_text);}}if(t.configurationUi.isEnabled()){t.configurationUi.setUiProvider(function(){var h=u.getConfigurationUi(v,"sap.ushell.components.tiles.applauncherdynamic.Configuration");t.configurationUi.attachCancel(e.onCancelConfiguration.bind(null,h));t.configurationUi.attachSave(e.onSaveConfiguration.bind(null,h));return h;});this.getView().getContent()[0].setTooltip(u.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"));}else if(!t.preview||!t.preview.isEnabled()){if(!s){sap.ushell.Container.addRemoteSystemForServiceUrl(o.service_url);}this.bNeedsRefresh=true;this.iNrOfTimerRunning=0;}if(t.refresh){t.refresh.attachRefresh(this.refreshHandler.bind(this));}if(t.visible){t.visible.attachVisible(this.visibleHandler.bind(this));}if(t.actions){var f=o.actions,E;if(f){E=f.slice();}else{E=[];}var T=m.getProperty("/mode")===d.LineMode?"link":"tile",g=a.getTileSettingsAction(m,this.onSaveRuntimeSettings.bind(this),T);E.push(g);t.actions.setActionsProvider(function(){return E;});}sap.ui.getCore().getEventBus().subscribe("launchpad","sessionTimeout",this.stopRequests,this);},stopRequests:function(){if(this.timer){clearTimeout(this.timer);}if(this.oDataRequest){try{this.bIsAbortRequestFlow=true;this.oDataRequest.abort();}catch(e){q.sap.log.warning(e.name,e.message);}this.bNeedsRefresh=true;this.bIsAbortRequestFlow=undefined;}},onExit:function(){this.stopRequests();sap.ui.getCore().getEventBus().unsubscribe("launchpad","sessionTimeout",this.stopRequests,this);this._aDoableObject.off();},onPress:function(e){var v=this.getView(),V=v.getViewData(),m=v.getModel(),t=m.getProperty("/nav/navigation_target_url"),T=V.chip,o=m.getProperty("/config");if(e.getSource().getScope&&e.getSource().getScope()===G.Display){if(T.configurationUi.isEnabled()){T.configurationUi.display();}else if(t){if(t[0]==="#"){hasher.setHash(t);}else{var L=C.last("/core/shell/enableRecentActivity")&&C.last("/core/shell/enableRecentActivityLogging");if(L){var r={title:o.display_title_text,appType:b.URL,url:o.navigation_target_url,appId:o.navigation_target_url};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(r);}window.open(t,"_blank");}}}},extractData:function(D){var n,k=["results","icon","title","number","numberUnit","info","infoState","infoStatus","targetParams","subtitle","stateArrow","numberState","numberDigits","numberFactor"];if(typeof D==="object"&&Object.keys(D).length===1){n=Object.keys(D)[0];if(Array.prototype.indexOf.call(k,n)===-1){return D[n];}}return D;},onSaveRuntimeSettings:function(s){var v=this.getView(),V=v.getModel(),t=v.getViewData().chip,o=V.getProperty("/config"),S=s.getModel();o.display_title_text=S.getProperty("/title");o.display_subtitle_text=S.getProperty("/subtitle");o.display_info_text=S.getProperty("/info");o.display_search_keywords=S.getProperty("/keywords");var e=t.bag.getBag("tileProperties");e.setText("display_title_text",o.display_title_text);e.setText("display_subtitle_text",o.display_subtitle_text);e.setText("display_info_text",o.display_info_text);e.setText("display_search_keywords",o.display_search_keywords);function f(E){q.sap.log.error(E,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");}e.save(function(){q.sap.log.debug("property bag 'tileProperties' saved successfully");V.setProperty("/config",o);V.setProperty("/data/display_title_text",o.display_title_text);V.setProperty("/data/display_subtitle_text",o.display_subtitle_text);V.setProperty("/data/display_info_text",o.display_info_text);V.refresh();},f);},onSaveConfiguration:function(o){var D=q.Deferred(),m=o.getModel(),t=m.getProperty("/tileModel"),T=o.getViewData().chip,e=u.tileActionsRows2TileActionsArray(m.getProperty("/config/tile_actions_rows")),f={display_icon_url:m.getProperty("/config/display_icon_url"),display_number_unit:m.getProperty("/config/display_number_unit"),service_url:m.getProperty("/config/service_url"),service_refresh_interval:m.getProperty("/config/service_refresh_interval"),navigation_use_semantic_object:m.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:m.getProperty("/config/navigation_target_url"),navigation_semantic_object:q.trim(m.getProperty("/config/navigation_semantic_object"))||"",navigation_semantic_action:q.trim(m.getProperty("/config/navigation_semantic_action"))||"",navigation_semantic_parameters:q.trim(m.getProperty("/config/navigation_semantic_parameters")),display_search_keywords:m.getProperty("/config/display_search_keywords")};var r=u.checkInputOnSaveConfig(o);if(!r){r=u.checkTileActions(o);}if(r){D.reject("mandatory_fields_missing");return D.promise();}if(f.navigation_use_semantic_object){f.navigation_target_url=a.getSemanticNavigationUrl(f);m.setProperty("/config/navigation_target_url",f.navigation_target_url);}var g=T.bag.getBag("tileProperties");g.setText("display_title_text",m.getProperty("/config/display_title_text"));g.setText("display_subtitle_text",m.getProperty("/config/display_subtitle_text"));g.setText("display_info_text",m.getProperty("/config/display_info_text"));g.setText("display_search_keywords",f.display_search_keywords);var h=T.bag.getBag("tileNavigationActions");u.populateTileNavigationActionsBag(h,e);function i(E,j){q.sap.log.error(E,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");D.reject(E,j);}T.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(f)},function(){var j=a.getConfiguration(T,false,false),k=a.getConfiguration(T,true,false),m=new J({config:j,tileModel:t});o.setModel(m);t.setData({data:k,nav:{navigation_target_url:""}},false);if(T.preview){T.preview.setTargetUrl(j.navigation_target_url);T.preview.setPreviewIcon(j.display_icon_url);T.preview.setPreviewTitle(j.display_title_text);if(T.preview.setPreviewSubtitle&&typeof T.preview.setPreviewSubtitle==="function"){T.preview.setPreviewSubtitle(j.display_subtitle_text);}}g.save(function(){q.sap.log.debug("property bag 'tileProperties' saved successfully");if(T.title){T.title.setTitle(j.display_title_text,function(){D.resolve();},i);}else{D.resolve();}},i);h.save(function(){q.sap.log.debug("property bag 'navigationProperties' saved successfully");},i);},i);return D.promise();},successHandlerFn:function(r,R){var v=this.getView(),m=v.getModel(),o=m.getProperty("/config"),V=v.getViewData(),t=V.chip,s=t.url.getApplicationSystem(),D;this.oDataRequest=undefined;if(typeof R==="object"){var e=new c(r).get("$inlinecount");if(e&&e==="allpages"){R={number:R.__count};}else{R=this.extractData(R);}}else if(typeof R==="string"){R={number:R};}if(V.properties&&V.properties.info){if(typeof R==="object"){R.info=V.properties.info;}}D=a.getDataToDisplay(o,R);m.setProperty("/data",D);if(this.sConfigNavigationTargetUrlOld!==o.navigation_target_url){this.navigationTargetUrl=this.constructTargetUrlWithSapSystem(o.navigation_target_url,s);this.sConfigNavigationTargetUrlOld=this.navigationTargetUrl;}m.setProperty("/nav/navigation_target_url",a.addParamsToUrl(this.navigationTargetUrl,D));var i=o.service_refresh_interval;if(i>0){i=Math.max(i,this.REFRESH_INTERVAL_MIN);q.sap.log.info("Wait "+i+" seconds before calling "+o.service_url+" again",null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");this.refeshAfterInterval(i);}},errorHandlerFn:function(m,i){var v=this.getView(),M=v.getModel(),o=M.getProperty("/config"),s=m&&m.message?m.message:m,r=u.getResourceBundleModel().getResourceBundle();this.oDataRequest=undefined;if(s==="Request aborted"){q.sap.log.info("Data request from service "+o.service_url+" was aborted",null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");}else{if(m.response){s+=" - "+m.response.statusCode+" "+m.response.statusText;}var L=i?q.sap.log.warning:q.sap.log.error;L("Failed to update data via service\n"+"  service URL: "+o.service_url+"\n"+"  "+s,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");}if(!this.bIsAbortRequestFlow){M.setProperty("/data",a.getDataToDisplay(o,{number:"???",info:r.getText("dynamic_data.error"),infoState:"Critical"}));}},onCancelConfiguration:function(o){var v=o.getViewData(),m=o.getModel(),t=m.getProperty("/tileModel"),T=v.chip,e=a.getConfiguration(T,false,false);m.setData({config:e,tileModel:t},false);},prepareToLoadData:function(){var D=this.getView(),o=D.getModel().getProperty("/config"),t=D.getViewData().chip,s=o.service_url,r,g,e=this;if(!s){this.errorHandlerFn("No service URL given!",true);return;}if(/;o=([;\/?]|$)/.test(s)){s=t.url.addSystemToServiceUrl(s);}if(this.serviceUrlWithDefaults){g=new q.Deferred().resolve({url:this.serviceUrlWithDefaults}).promise();}else{r=sap.ushell.Container.getService("ReferenceResolver");g=r.resolveUserDefaultParameters(s);}g.done(e.loadData.bind(e)).fail(e.errorHandlerFn.bind(e));},loadData:function(r){if(r.defaultsWithoutValue&&r.defaultsWithoutValue.length>0){this.errorHandlerFn("The service URL contains User Default(s) with no set value: "+r.defaultsWithoutValue.join(", "),true);return;}if(r.ignoredReferences&&r.ignoredReferences.length>0){this.errorHandlerFn("The service URL contains invalid Reference(s): "+r.ignoredReferences.join(", "),false);return;}var s=r.url,S,e,R,o;this.serviceUrlWithDefaults=s;R={"Cache-Control":"no-cache, no-store, must-revalidate","Pragma":"no-cache","Expires":"0","Accept-Language":(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||""};if(sap.ushell.Container){S=sap.ui.getCore().getConfiguration().getSAPLogonLanguage();if(S){R["sap-language"]=S;}e=sap.ushell.Container.getLogonSystem()?sap.ushell.Container.getLogonSystem().getClient():"";o=new U(s);if(e&&!o.protocol()){R["sap-client"]=e;}}if(S&&s.indexOf("sap-language=")===-1){s=s+(s.indexOf("?")>=0?"&":"?")+"sap-language="+S;}this.oDataRequest=O.read({requestUri:s,headers:R},this.successHandlerFn.bind(this,s),this.errorHandlerFn.bind(this));},refreshTile:function(){var v=this.getView(),V=v.getViewData(),i=V.chip.visible.isVisible();if(i&&this.bNeedsRefresh){this.bNeedsRefresh=false;if(!this.oDataRequest){this.prepareToLoadData();}}},refeshAfterInterval:function(r){var t=this;this.iNrOfTimerRunning++;window.setTimeout(function(){t.iNrOfTimerRunning--;if(t.iNrOfTimerRunning===0){t.bNeedsRefresh=true;t.refreshTile();}},r*1000);},refreshHandler:function(){this.bNeedsRefresh=true;this.refreshTile();},visibleHandler:function(i){if(i){this.refreshTile();}else{this.stopRequests();}}});},false);
