// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery"],function(B,M,q){"use strict";var D=B.extend("sap.ushell.components._HomepageManager.DashboardLoadingManager",{metadata:{},constructor:function(i,s){var e=sap.ui.getCore().getEventBus();this.currentVisibleTiles=[];this.aRefreshTiles=[];this.oBusyIndicatorTiles={};this.oActiveDynamicTiles={};this.oResolvedTiles={};this.oInProgressTiles={};this.oDashboardManager=s.oDashboardManager;e.subscribe("launchpad","visibleTilesChanged",this._onVisibilityChanged,this);e.subscribe("launchpad","dashboardTileClick",this._addTileToRefreshArray,this);e.subscribe("launchpad","refreshTiles",this._refreshTiles,this);e.subscribe("launchpad","setTilesNoVisibility",this._setTilesNoVisibility,this);e.subscribe("launchpad","onHiddenTab",this._setTilesNoVisibility,this);},_onVisibilityChanged:function(c,e,v){this.currentVisibleTiles=v;if(this.oDashboardManager.isBlindLoading()){this.manageTilesView();}this.manageBusyIndicatorTiles();this.manageDynamicTiles();},manageDynamicTiles:function(){var v;M.average("DashboardLoadingManagerActiveDynamicTile","Manage Active Dynamic Tiles","FLP_SHELL");var k,V,t,a,n={},c=q.extend(true,{},{},this.oActiveDynamicTiles);for(var i=0;i<this.currentVisibleTiles.length;i++){var o=this.currentVisibleTiles[i];if(!o.bIsExtanded){delete c[o.oTile.uuid];}}for(k in c){t=this.oActiveDynamicTiles[k];a=t.object;this.oDashboardManager.setTileVisible(t,false);}for(V=0;V<this.currentVisibleTiles.length;V++){v=this.currentVisibleTiles[V];if(!v.bIsExtanded){t=v.oTile;a=t.object;if(this.oActiveDynamicTiles[t.uuid]===undefined&&a){this.oDashboardManager.setTileVisible(t,true);}n[t.uuid]=t;}}this.oActiveDynamicTiles=n;M.end("DashboardLoadingManagerActiveDynamicTile");},isTileViewRequestIssued:function(t){if(this.oInProgressTiles[t.uuid]===undefined&&this.oResolvedTiles[t.uuid]===undefined){return false;}return true;},manageBusyIndicatorTiles:function(){M.average("DashboardLoadingManagerBusyIndicators","Manage Busy Indicators on Tiles","FLP_SHELL");var v,c,C,I,r=[],b,a=[];for(c in this.oBusyIndicatorTiles){b=true;I=this.oBusyIndicatorTiles[c];if(this.oResolvedTiles[c]===undefined){for(var i=0;i<this.currentVisibleTiles.length;i++){if(this.currentVisibleTiles[i].oTile.uuid===I.oTile.uuid){b=false;break;}}if(b){r.push(I);}}}for(v=0;v<this.currentVisibleTiles.length;v++){C=this.currentVisibleTiles[v];if(this.oBusyIndicatorTiles[C.oTile.uuid]===undefined&&this.oResolvedTiles[C.oTile.uuid]===undefined){a.push(C);}}for(v=0;v<r.length;v++){C=r[v];if(C.oTile.content[0]&&C.oTile.content[0].setState){if(C.oTile.content[0].getState){if(C.oTile.content[0].getState()!=="Failed"){C.oTile.content[0].setState();}}else{C.oTile.content[0].setState();}}delete this.oBusyIndicatorTiles[C.oTile.uuid];}for(v=0;v<a.length;v++){C=a[v];if(C.oTile.content[0]&&C.oTile.content[0].setState){if(C.oTile.content[0].getState){if(C.oTile.content[0].getState()!=="Failed"){C.oTile.content[0].setState("Loading");}}else{C.oTile.content[0].setState("Loading");}}this.oBusyIndicatorTiles[C.oTile.uuid]=C;}M.end("DashboardLoadingManagerBusyIndicators");},setTileInProgress:function(t){this.oInProgressTiles[t.uuid]=t;},setTileResolved:function(t){delete this.oInProgressTiles[t.uuid];this.oResolvedTiles[t.uuid]=t;},_addTileToRefreshArray:function(c,e,d){this.aRefreshTiles.push(d.uuid);},_refreshTiles:function(){for(var v=0;v<this.currentVisibleTiles.length;v++){var t=this.currentVisibleTiles[v].oTile;var a=t.object;if(a){for(var r=0;r<this.aRefreshTiles.length;r++){if(t.uuid===this.aRefreshTiles[r]){this.aRefreshTiles.splice(r,1);this.oDashboardManager.setTileVisible(t,true);this.oDashboardManager.refreshTile(t);break;}}}}},_setTilesNoVisibility:function(){if(!sap.ushell.Container){return;}for(var v=0;v<this.currentVisibleTiles.length;v++){var t=this.currentVisibleTiles[v].oTile;var a=t.object;if(a){this.oDashboardManager.setTileVisible(t,false);}delete this.oActiveDynamicTiles[t.uuid];}},manageTilesView:function(){var v,c,r=[];for(v=0;v<this.currentVisibleTiles.length;v++){c=this.currentVisibleTiles[v];if(this.oInProgressTiles[c.oTile.uuid]===undefined&&this.oResolvedTiles[c.oTile.uuid]===undefined){r.push(c);}}this.oDashboardManager.getTileViewsFromArray(r);}});return D;});
