// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","./DashboardUIActions","sap/ushell/utils","sap/ushell/EventHub","sap/ui/Device","sap/ushell/resources","sap/ushell/Layout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log"],function(q,D,u,E,a,r,L,F,b,c){"use strict";sap.ui.controller("sap.ushell.components.homepage.DashboardContent",{onInit:function(){var e=sap.ui.getCore().getEventBus();this.handleDashboardScroll=this._handleDashboardScroll.bind(this);e.subscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","actionModeInactive",this._handleGroupVisibilityChanges,this);e.subscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.addEventListener("visibilitychange",u.handleTilesVisibility,false);if(a.browser.mobile){e.subscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);}this.isDesktop=(a.system.desktop&&(navigator.userAgent.toLowerCase().indexOf("tablet")<0));},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);e.unsubscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.unsubscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.removeEventListener("visibilitychange",u.handleTilesVisibility,false);if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.destroy();delete this.oDashboardUIActionsModule;}},onAfterRendering:function(){u.setPerformanceMark("FLP - dashboard after rendering");var h=sap.ushell.components.getHomepageManager();if(!h.getPreparedGroupModel()){h.loadPersonalizedGroups();}else{E.once("firstSegmentCompleteLoaded").do(h.handleFirstSegmentLoaded.bind(h));}var e=sap.ui.getCore().getEventBus(),m,t,g,i,d;e.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.unsubscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);e.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.subscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);a.orientation.attachHandler(function(){var j=q("#dashboardGroups").find(".sapUshellTileContainer").filter(":visible");if(j.length){m=this.getView().getModel();t=m.getProperty("/topGroupInViewPortIndex");if(j.get(t)){g=sap.ui.getCore().byId(j.get(t).id);i=m.getProperty("/editTitle");this._publishAsync("launchpad","scrollToGroup",{group:g,isInEditTitle:i});}}},this);q(window).bind("resize",function(){clearTimeout(d);d=setTimeout(this.resizeHandler.bind(this),300);}.bind(this));this._updateTopGroupInModel();},_dashboardDeleteTileHandler:function(e){var t=e.getSource(),T=t.getBindingContext().getObject(),d={tileId:T.uuid};sap.ui.getCore().getEventBus().publish("launchpad","deleteTile",d,this);},dashboardTilePress:function(e){var t=e.getSource();if(!t){return;}if(a.system.desktop){var s=document.activeElement.id.indexOf("feedTile")!==-1;if(document.activeElement.tagName!=="INPUT"&&s!==true){if(sap.ui.getCore().byId(t.getId())){sap.ushell.components.ComponentKeysHandler.setTileFocus(t.$());}}}sap.ui.getCore().getEventBus().publish("launchpad","dashboardTileClick",{uuid:t.getUuid()});},_updateTopGroupInModel:function(){var m=this.getView().getModel(),t=this._getIndexOfTopGroupInViewPort();var s=this._getModelGroupFromVisibleIndex(t);m.setProperty("/iSelectedGroup",s);m.setProperty("/topGroupInViewPortIndex",t);},_getIndexOfTopGroupInViewPort:function(){var v=this.getView(),d=v.getDomRef(),s=d.getElementsByTagName("section"),j=q(s).find(".sapUshellTileContainer"),o=j.not(".sapUshellHidden").eq(0).offset(),f=(o&&o.top)||0,t=[],n=s[0].scrollTop,e=0;if(!j||!o){return e;}j.each(function(){if(!q(this).hasClass("sapUshellHidden")){var h=q(this).parent().offset().top;t.push([h,h+q(this).parent().height()]);}});var g=n+f;q.each(t,function(i,h){var k=h[0],l=h[1];if(k-24<=g&&g<=l){e=i;return false;}});return e;},_handleDashboardScroll:function(){var v=this.getView(),m=v.getModel(),n=400;var h=m.getProperty("/homePageGroupDisplay"),e=h!=="tabs",t=m.getProperty("/tileActionModeActive");function H(){u.handleTilesVisibility();}clearTimeout(this.timeoutId);this.timeoutId=setTimeout(H,n);if(!a.system.phone){v.oAnchorNavigationBar.closeOverflowPopup();}if(e||t){this._updateTopGroupInModel();}v.oAnchorNavigationBar.reArrangeNavigationBarElements();},_handleGroupDeletion:function(g){var e=sap.ui.getCore().getEventBus(),G=g.getObject(),i=G.removable,s=G.title,d=G.groupId,R=r.i18n,m=sap.ushell.Container.getService("Message"),A,C;sap.ui.require(["sap/m/MessageBox"],function(M){A=M.Action;C=(i?A.DELETE:R.getText("ResetGroupBtn"));m.confirm(R.getText(i?"delete_group_msg":"reset_group_msg",s),function(o){if(o===C){e.publish("launchpad",i?"deleteGroup":"resetGroup",{groupId:d});}},R.getText(i?"delete_group":"reset_group"),[C,A.CANCEL]);});},_modelLoaded:function(){this.bModelInitialized=true;sap.ushell.Layout.getInitPromise().then(function(){this._initializeUIActions();}.bind(this));},_initializeUIActions:function(){if(!this.oDashboardUIActionsModule){this.oDashboardUIActionsModule=new D();}this.oDashboardUIActionsModule.initializeUIActions(this);},_forceBrowserRerenderElement:function(e){var d=window.requestAnimationFrame||window.webkitRequestAnimationFrame;if(d){d(function(){var f=e.style.display;e.style.display="none";e.style.display=f;});}else{c.info("unsupported browser for animation frame");}},_webkitMobileRenderFix:function(){if(a.browser.chrome||a.os.android){this._forceBrowserRerenderElement(document.body);}},resizeHandler:function(){u.recalculateBottomSpace();u.handleTilesVisibility();if(E.last("AppRendered")!==undefined){E.emit("AppRendered",undefined);}if(L&&q("#dashboardGroups").is(":visible")){L.reRenderGroupsLayout(null);this._initializeUIActions();}},_appOpenedHandler:function(C,e,d){var p,P,m=this.getView().getModel();p=this.getOwnerComponent();P=p.getMetadata().getComponentName();if(d.additionalInformation&&d.additionalInformation.indexOf(P)===-1){u.setTilesNoVisibility();}if(m.getProperty("/tileActionModeActive")&&sap.ushell.components.homepage.ActionMode){sap.ushell.components.homepage.ActionMode.toggleActionMode(m,"Menu Item");}if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.disableAllDashboardUiAction();}},_scrollToGroupByName:function(C,e,d){var g=this.getView().getModel().getProperty("/groups"),G=d.groupName,l=sap.ushell.Container.getService("LaunchPage");g.forEach(function(o){if(l.getGroupTitle(o.object)===G){this._scrollToGroup(C,e,{groupId:o.groupId});}}.bind(this));},_scrollToGroup:function(C,e,d){var g=d.group?d.group.getGroupId():d.groupId;var G;if(this.oView.oDashboardGroupsBox.getGroups()){G=this.oView.oDashboardGroupsBox.getGroups().reduce(function(f,h){return h&&h.getGroupId()===g?h:f;},null);}var o=G&&G.getDomRef();if(!o){return;}var t=o.querySelector(".sapUshellTileContainerEditMode")||o.querySelector(".sapUshellTilesContainer-sortable");if(!t){return;}document.getElementById("sapUshellDashboardPage-cont").scrollTop=t.offsetTop;setTimeout(function(){if(a.system.desktop){var j=G.$();if(d.restoreLastFocusedTile){var l=false;if(d.restoreLastFocusedTileContainerById){j=q("#"+d.restoreLastFocusedTileContainerById);l=true;}sap.ushell.components.ComponentKeysHandler.goToLastVisitedTile(j,l);}else if(d.groupChanged){var f=j.find(".sapUshellTile, .sapMGTLineMode, .sapFCard").filter(":visible").eq(0);if(f.length){sap.ushell.components.ComponentKeysHandler.setTileFocus(f);}}}if(d.isInEditTitle){G.setEditMode(true);}u.handleTilesVisibility();},0);},_handleDrop:function(e,d){var l=L.getLayoutEngine(),t=l.layoutEndCallback(),i=!t.dstArea,o=sap.ui.getCore().getEventBus(),n,f,T,g=q.Deferred(),v=this.getView(),m=v.getModel(),h=m.getProperty("/homePageGroupDisplay")&&m.getProperty("/homePageGroupDisplay")==="tabs",j=m.getProperty("/tileActionModeActive"),I=true,k=!!(m.getProperty("/personalization")&&(a.browser.msie||a.browser.edge)&&a.browser.version>=11&&(a.system.combi||a.system.tablet)),p=t.tile.getBindingContext().getObject().isLinkPersonalizationSupported;L.getLayoutEngine()._toggleAnchorItemHighlighting(false);if(t.dstGroup){var s=t.dstGroup.getBindingContext(),w=s.getProperty(s.sPath).isGroupLocked;I=i&&w;}if(!t.tileMovedFlag||(k&&l.isTabBarCollision())||I||(!p&&t.dstArea==="links")){o.publish("launchpad","sortableStop");return null;}if(!j&&!h&&t.dstArea==="links"&&!t.dstGroupData.getLinks().length){o.publish("launchpad","sortableStop");return null;}n=true;f=true;if((t.srcGroup!==t.dstGroup)){n=f=false;}else if(t.tile!==t.dstGroup.getTiles()[t.dstTileIndex]){f=false;}T=this._getTileUuid(t.tile);if(t.srcGroup&&t.srcGroup.removeAggregation&&t.srcArea){t.srcGroup.removeAggregation("tiles",t.tile,n);}var S=t.dstGroupData&&t.dstGroupData.insertAggregation&&t.dstArea===t.srcArea;if(S){t.tile.sParentAggregationName=t.dstArea;t.dstGroupData.insertAggregation(t.dstArea,t.tile,t.dstTileIndex,f);g=this._handleSameTypeDrop(t,T,S);}else if(i){g=this._handleShortDrop(t,T,S);}else{g=this._handleConvertDrop(t,S,d);}if(this.getView().getModel()){this.getView().getModel().setProperty("/draggedTileLinkPersonalizationSupported",true);}o.publish("launchpad","sortableStop");return g.promise();},_handleSameTypeDrop:function(t,T,s){var e=sap.ui.getCore().getEventBus(),d=q.Deferred();t.tile._getBindingContext().oModel.setProperty(t.tile._getBindingContext().sPath+"/draggedInTabBarToSourceGroup",false);e.publish("launchpad","movetile",{sTileId:T,sToItems:t.dstArea?t.dstArea:"tiles",sFromItems:t.srcArea?t.srcArea:"tiles",sTileType:t.dstArea?t.dstArea.substr(0,t.dstArea.length-1):undefined,toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,longDrop:s,callBack:function(){d.resolve();}});return d.promise();},_handleShortDrop:function(t,T,s){var e=sap.ui.getCore().getEventBus(),d=q.Deferred();e.publish("launchpad","movetile",{sTileId:T,sToItems:t.srcArea||"tiles",sFromItems:t.srcArea||"tiles",sTileType:t.srcArea?t.srcArea.substr(0,t.srcArea.length-1):undefined,toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,longDrop:s,callBack:function(){d.resolve();}});return d.promise();},_handleConvertDrop:function(t,s,d){var e=sap.ui.getCore().getEventBus(),o=q.Deferred();e.publish("launchpad","convertTile",{toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,tile:sap.ui.getCore().byId(d.id),srcGroupId:t.srcGroup.getGroupId?t.srcGroup.getGroupId():t.srcGroup.groupId,longDrop:s,callBack:function(){o.resolve();}});return o.promise();},_getTileUuid:function(t){if(t.getUuid){return t.getUuid();}var T=t.getBindingContext().getObject();if(T.getParent){return T.getParent().getUuid();}return T.uuid;},_handleDrag:function(e,d){var t=L.getLayoutEngine().layoutEndCallback(),T=t.tile.getBindingContext().getObject(),m=this.getView().getModel();if(m){m.setProperty("/draggedTileLinkPersonalizationSupported",T.isLinkPersonalizationSupported);}},_handleTabBarItemPressEventHandler:function(C,e,d){var v=this.getView(),m=v.getModel(),g=m.getProperty("/groups"),G=d.iGroupIndex;for(var i=0;i<g.length;i++){m.setProperty("/groups/"+i+"/isGroupSelected",false);}m.setProperty("/groups/"+G+"/isGroupSelected",true);this._handleTabBarItemPress(C,e,G);},_handleTabBarItemPress:function(C,e,g,o){var v=this.getView(),s,f;if(o){s=o.getParameter("group").getIndex();}else{s=g;}sap.ui.getCore().getEventBus().publish("launchpad","tabSelected",{iSelectedGroup:s});f=this._getVisibleGroupIndex(s);v.oDashboardGroupsBox.removeLinksFromUnselectedGroups();v.oDashboardGroupsBox.getBinding("groups").filter([v.oFilterSelectedGroup]);v.oAnchorNavigationBar.setSelectedItemIndex(f);v.oAnchorNavigationBar.reArrangeNavigationBarElements();setTimeout(function(){u.handleTilesVisibility();},0);},_getVisibleGroupIndex:function(s){var g=this.getView().getModel().getProperty("/groups");var h=0;for(var i=0;i<s;i++){if(!g[i].isGroupVisible||!g[i].visibilityModes[0]){h++;}}return s-h;},_getModelGroupFromVisibleIndex:function(s){var g=this.getView().getModel().getProperty("/groups"),v=0;for(var i=0;i<g.length;i++){if(g[i].isGroupVisible&&g[i].visibilityModes[0]){v++;if(v>s){return i;}}}return 0;},_handleAnchorItemPress:function(e){var v=this.getView(),m=v.getModel(),g=m.getProperty("/groups");if(a.system.phone&&e.getParameter("manualPress")){e.oSource.openOverflowPopup();}for(var i=0;i<g.length;i++){if(m.getProperty("/groups/"+i+"/isGroupSelected")===true){m.setProperty("/groups/"+i+"/isGroupSelected",false);}}m.setProperty("/groups/"+e.getParameter("group").getIndex()+"/isGroupSelected",true);m.setProperty("/iSelectedGroup",e.getParameter("group").getIndex());if(m.getProperty("/homePageGroupDisplay")&&m.getProperty("/homePageGroupDisplay")==="tabs"&&!m.getProperty("/tileActionModeActive")){this._handleTabBarItemPress(undefined,undefined,undefined,e);}else{if(!m.getProperty("/tileActionModeActive")){v.oDashboardGroupsBox.getBinding("groups").filter([new F("isGroupVisible",b.EQ,true)]);}else{v.oDashboardGroupsBox.getBinding("groups").filter([]);}this._scrollToGroup("launchpad","scrollToGroup",{group:e.getParameter("group"),groupChanged:true,focus:(e.getParameter("action")==="sapenter")});}},_addGroupHandler:function(d){var i,p=d.getSource().getBindingContext().getPath(),e=p.split("/");i=window.parseInt(e[e.length-1],10);if(d.getSource().sParentAggregationName==="afterContent"){i=i+1;}sap.ui.getCore().getEventBus().publish("launchpad","createGroupAt",{title:"",location:i,isRendered:true});},_publishAsync:function(C,e,d){var B=sap.ui.getCore().getEventBus();window.setTimeout(q.proxy(B.publish,B,C,e,d),1);},_changeGroupVisibility:function(g){var B=g.getPath(),m=g.getModel(),G=m.getProperty(B+"/isGroupVisible");if(m.getProperty(B+"/isDefaultGroup")||m.getProperty(B+"/isGroupLocked")){return;}m.setProperty(B+"/isGroupVisible",!G);},_handleGroupVisibilityChanges:function(C,e,o){var l=sap.ushell.Container.getService("LaunchPage"),m=this.getView().getModel(),h=sap.ushell.components.getHomepageManager(),d=h.getCurrentHiddenGroupIds(m),s=d.length===o.length,i=s,p;d.some(function(H,I){if(!i){return true;}i=o&&Array.prototype.indexOf.call(o,H)!==-1;return!i;});if(!i){p=l.hideGroups(d);p.done(function(){m.updateBindings("groups");});p.fail(function(){var f=sap.ushell.Container.getService("Message");f.error(r.i18n.getText("hideGroups_error"));});}window.setTimeout(function(){u.recalculateBottomSpace();},0);},_updateShellHeader:function(){if(!this.oShellUIService){this._initializeShellUIService();}else{this.oShellUIService.setTitle();this.oShellUIService.setHierarchy();}},_initializeShellUIService:function(){return sap.ui.require(["sap/ushell/ui5service/ShellUIService"],function(S){this.oShellUIService=new S({scopeObject:this.getOwnerComponent(),scopeType:"component"});this.oShellUIService.setTitle();this.oShellUIService.setHierarchy();return this.oShellUIService;}.bind(this));},_deactivateActionModeInTabsState:function(){var v=this.getView(),m=v.getModel(),i;var g=m.getProperty("/groups");for(i=0;i<g.length;i++){m.setProperty("/groups/"+i+"/isGroupSelected",false);}var s=v.oAnchorNavigationBar.getSelectedItemIndex();var h=0;if(!this._isGroupVisible(s)){for(i=0;i<g.length;i++){if(!this._isGroupVisible(i)){h++;}else{s=i;break;}}}else{for(i=0;i<s;i++){if(!this._isGroupVisible(i)){h++;}}}var f=s-h;v.oAnchorNavigationBar.setSelectedItemIndex(f);v.oAnchorNavigationBar.adjustItemSelection();m.setProperty("/groups/"+s+"/isGroupSelected",true);v.oDashboardGroupsBox.removeLinksFromAllGroups();var G=m.getProperty("/homePageGroupDisplay");if(G&&G==="tabs"){v.oDashboardGroupsBox.getBinding("groups").filter([v.oFilterSelectedGroup]);}},_isGroupVisible:function(g){var G=this.getView().getModel().getProperty("/groups");return(G[g].isGroupVisible&&G[g].visibilityModes[0]);}});});
