// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/m/StandardListItem","sap/m/SelectDialog","sap/ui/core/Component"],function(L,q,F,a,S,b,C){"use strict";sap.ui.controller("sap.ushell.components.appfinder.HierarchyFolders",{onInit:function(){this.oDialog=null;this.getView().setModel(this.getView().getViewData().easyAccessSystemsModel,"easyAccessSystems");this.getView().setModel(this.getView().getViewData().subHeaderModel,"subHeaderModel");this.getSelectedSystem().then(function(s){if(s){this.setSystemSelected(s);}else{this.setSystemSelected(undefined);this.onSystemSelectionPress();}}.bind(this),function(){this.setSystemSelected(undefined);this.onSystemSelectionPress();});},onExit:function(){if(this.oDialog){this.destroyDialog();}},onAfterRendering:function(){var j=q("#"+this.getView().getId());j.on("click",function(){this.exitSearchMode();}.bind(this));},getPersonalizer:function(){if(this.oPersonalizer){return this.oPersonalizer;}var p=sap.ushell.Container.getService("Personalization"),c=C.getOwnerComponentFor(this),s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true},P={container:"appfinder.HierarchyFolders",item:"lastSelectedSystem"};this.oPersonalizer=p.getPersonalizer(P,s,c);return this.oPersonalizer;},getSelectedSystem:function(){var d=new q.Deferred(),s=this.getView().getModel("easyAccessSystems").getProperty("/systemsList");if(s&&s.length&&s.length===1){var e=s[0];this.setSystemSelectedInPersonalization(e);d.resolve(e);}else{this.getSelectedSystemInPersonalization().then(function(p){if(p){var c=false;for(var i=0;i<s.length;i++){if((s[i].systemName&&s[i].systemName===p.systemName)||(s[i].systemId===p.systemId)){c=true;d.resolve(p);}}if(!c){d.resolve();this.setSystemSelectedInPersonalization();}}else{d.resolve();}}.bind(this));}return d.promise();},setSystemSelected:function(s){this.getView().getModel("easyAccessSystems").setProperty("/systemSelected",s);this.setSystemSelectedInPersonalization(s);},getSelectedSystemInPersonalization:function(){var d=new q.Deferred();this.getPersonalizer().getPersData().then(function(p){if(p){d.resolve(p);}else{d.resolve();}},function(e){L.error("Failed to get selected system from the personalization",e,"sap.ushell.components.appfinder.HierarchyFolders");d.reject();});return d.promise();},setSystemSelectedInPersonalization:function(s){this.getPersonalizer().setPersData(s).fail(function(e){L.error("Failed to save selected system in the personalization",e,"sap.ushell.components.appfinder.HierarchyFolders");});},onSystemSelectionPress:function(){var s=this.getView().getModel("easyAccessSystems").getProperty("/systemsList");if(s&&s.length&&s.length<=1){return;}var d=this.createDialog();d.open();},createDialog:function(){var t=this;if(!this.oDialog){this.oDialog=new b({id:"systemSelectionDialog",title:t.getView().translationBundle.getText("easyAccessSelectSystemDialogTitle"),multiSelect:false,contentHeight:"20rem",items:{path:"/systemsList",template:new S({adaptTitleSize:false,title:{parts:["systemName","systemId"],formatter:t.titleFormatter},description:{parts:["systemName","systemId"],formatter:t.descriptionFormatter},selected:{parts:["systemName","systemId"],formatter:t.selectedFormatter.bind(this)}})},confirm:t.systemConfirmHandler.bind(t),search:t.systemSearchHandler.bind(t),cancel:t.destroyDialog.bind(t)});this.oDialog.setModel(this.getView().getModel("easyAccessSystems"));}return this.oDialog;},destroyDialog:function(){this.oDialog.destroyItems();this.oDialog.destroy();this.oDialog=null;},systemConfirmHandler:function(e){var i=e.getParameters().selectedItem,s=i.getBindingContext().getObject();this.setSystemSelected(s);this.destroyDialog();},systemSearchHandler:function(e){var v=e.getParameter("value"),f=new sap.ui.model.Filter("systemName",F.Contains,v),o=new sap.ui.model.Filter("systemId",F.Contains,v),s=new a({filters:[o,f],and:false}),B=e.getSource().getBinding("items");B.filter(s);},titleFormatter:function(s,c){return s||c;},descriptionFormatter:function(s,c){if(s){return c;}return null;},selectedFormatter:function(s,c){var u=this.getView().getModel("easyAccessSystems").getProperty("/systemSelected");if(!u){return false;}if(s){return(u.systemName===s&&u.systemId===c);}return(u.systemId===c);},systemSelectorTextFormatter:function(s){if(s){if(s.systemName){return s.systemName;}return s.systemId;}return this.getView().translationBundle.getText("easyAccessSelectSystemTextWithoutSystem");},exitSearchMode:function(){var s=this.getView().getModel("subHeaderModel");s.setProperty("/search/searchMode",false);s.refresh(true);}});},true);
