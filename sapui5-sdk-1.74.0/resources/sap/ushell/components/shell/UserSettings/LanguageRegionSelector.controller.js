// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/core/Locale","sap/ushell/resources","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel"],function(M,q,L,a,r,b,J){"use strict";sap.ui.controller("sap.ushell.components.shell.UserSettings.LanguageRegionSelector",{onInit:function(){try{this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=this.userInfoService.getUser();}catch(e){L.error("Getting UserInfo service failed.");this.oUser=sap.ushell.Container.getUser();}this.bIsSetLanguage=sap.ushell.Container.getRenderer("fiori2").getModelConfiguration().enableSetLanguage;this.isLanguageChanged=false;this.isLanguagePersonalized=this.oUser.isLanguagePersonalized();this.sLanguage=this._getFormatedLanguage(this.oUser.getLanguage());this.aLanguageList=null;var m=new J();var s=this.oUser.getLanguageText();var c={languageList:[{key:this.sLanguage,text:s}],selectedLanguage:this.sLanguage,selectedLanguageText:s};var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=b.getInstance(l);var d=o.getDatePattern("medium"),t=o.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";c.datePatternList=[{text:d,key:d}];c.timeFormat=T;c.selectedDatePattern=d;var h=this.oView.hourFormatSegmentedButton.getButtons();var f=(T==="12h")?h[0]:h[1];this.oView.hourFormatSegmentedButton.setSelectedButton(f);m.setData(c);this.oView.setModel(m);},getContent:function(){var d=q.Deferred();var t=this;if(this.bIsSetLanguage){M.start("FLP:LanguageRegionSelector.getContent","getContent","FLP");var c=this._getLanguagesList();c.done(function(l){if(l){if(l.length>1){if(!t.isLanguagePersonalized){t.getView().getModel().setProperty("/selectedLanguage","default");}else{t.getView().getModel().setProperty("/selectedLanguage",t.oUser.getLanguage());}t.getView().getModel().setSizeLimit(l.length);t.getView().getModel().setProperty("/languageList",l);t.oView.inputLanguage.setVisible(false);t.oView.selectLanguage.setVisible(true);t.oView.helpingText.setVisible(true);t.oView.helpingTextLabel.setVisible(true);}}M.end("FLP:LanguageRegionSelector.getContent");d.resolve(t.getView());});c.fail(function(e){L.error(e);d.resolve(t.getView());});}else{d.resolve(t.getView());}return d.promise();},getValue:function(){var d=q.Deferred();var s=this.getView().getModel().getProperty("/selectedLanguage");var u=this.oUser.getLanguage();if(s==="default"){d.resolve(this._getFormatedLanguage(u)+" | "+r.i18n.getText("timeFormatFld")+": "+this.getView().getModel().getProperty("/timeFormat"));}else{d.resolve(this._getFormatedLanguage(s)+" | "+r.i18n.getText("timeFormatFld")+": "+this.getView().getModel().getProperty("/timeFormat"));}return d.promise();},onCancel:function(){var d=q.Deferred();if(this.bIsSetLanguage){this.isLanguageChanged=false;var s=this.getView().getModel().getProperty("/selectedLanguage");if(!this.isLanguagePersonalized||this.oUser.getLanguage()!==s){this._handleSelectChange(this.oUser.getLanguage(),"Cancel");d.resolve();}else{d.resolve();}}else{d.resolve();}return d.promise();},onSave:function(){var d=q.Deferred();var o;var s=this.getView().getModel().getProperty("/selectedLanguage");if(this.isLanguageChanged){if(s){o=this.oUser.getLanguage();this.oUser.setLanguage(s);this.userInfoService.updateUserPreferences(this.oUser).done(function(){d.resolve();window.location.reload();}).fail(function(e){this.oUser.setLanguage(o);this._handleSelectChange(o,"Cancel");L.error(e);d.reject(e);}.bind(this));}}else{d.resolve();}return d.promise();},_getFormatedLanguage:function(l){if(l&&l.indexOf("-")>-1){l=l.replace("-"," (").concat(")").toUpperCase();}else if(l){l=l.toUpperCase();}return l;},_handleSelectChange:function(l,m){var o=new a(l);var c=b.getInstance(o);var d=c.getDatePattern("medium"),t=c.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";this.isLanguageChanged=true;if(m==="Cancel"){if(!this.isLanguagePersonalized){this.getView().selectLanguage.setSelectedKey("default");}else{this.getView().selectLanguage.setSelectedKey(l);}this.isLanguageChanged=false;}this.getView().comboDate.setValue(d);var h=this.getView().hourFormatSegmentedButton.getButtons();var s=(T==="12h")?h[0]:h[1];this.getView().hourFormatSegmentedButton.setSelectedButton(s);},_getLanguagesList:function(){var R=q.Deferred();if(this.aLanguageList==null){M.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");var g=this.userInfoService.getLanguageList();g.done(function(d){M.end("FLP:LanguageRegionSelector._getLanguagesList");R.resolve(d);});g.fail(function(){R.reject("Failed to load language list.");});}else{R.resolve(this.aLanguageList);}return R.promise();}});});
