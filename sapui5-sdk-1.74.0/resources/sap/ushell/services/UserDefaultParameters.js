// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/EventProvider","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/base/util/deepEqual","sap/base/util/isEmptyObject"],function(E,u,q,d,a){"use strict";var e="valueStored";var s=["value","noEdit","noStore","extendedValue","alwaysAskPlugin"];function U(A,c,p,C){this._aPlugins=[];this._oUserDefaultParametersNames=undefined;this._oWasParameterPersisted={};var t=this,S=new E();function g(P){var v=(typeof P.getComponentData==="function"&&P.getComponentData()&&P.getComponentData().config&&P.getComponentData().config["sap-priority"])||0;if(typeof v!=="number"||isNaN(v)){return 0;}return v;}this._insertPluginOrdered=function(P,o){var f=g(o),i,h;for(i=0;(i<P.length)&&o;++i){h=g(P[i]);if(o&&(f>h)){P.splice(i,0,o);o=undefined;}}if(o){P.push(o);}return P;};this.registerPlugin=function(P){this._aPlugins=this._insertPluginOrdered(this._aPlugins,P);};function b(i,P,f,v,D){if(i>=P.length){D.resolve(v);return;}if(typeof P[i].getUserDefault!=="function"){b(i+1,P,f,v,D);return;}P[i].getUserDefault(f,v).done(function(n){if(n){b(i+1,P,f,n,D);}else{b(i+1,P,f,v,D);}}).fail(function(){q.sap.log.error("invocation of getUserDefault(\""+f+"\") for plugin "+t._getComponentNameOfPlugin(P[i])+" rejected.",null,"sap.ushell.services.UserDefaultParameters");b(i+1,P,f,v,D);});return;}this._getStoreDate=function(){return new Date().toString();};this._storeValue=function(P,v,f){var t=this;var r=new q.Deferred();var D=new q.Deferred();if(f&&v.extendedValue){sap.ushell.Container.getService("ClientSideTargetResolution").getUserDefaultParameterNames(true).done(function(o){var h=t._extractKeyArrays(o);var i=h.extended;D.resolve(i.indexOf(P)<0);}).fail(function(){D.resolve(false);});}else{D.resolve(false);}D.done(function(R){if(R){v.extendedValue=undefined;}if(f&&t._isInitial(v)){v=undefined;t._oWasParameterPersisted[P]=false;}else{v._shellData=q.extend(true,{storeDate:t._getStoreDate()},v._shellData);}sap.ushell.Container.getService("UserDefaultParameterPersistence").saveParameterValue(P,v).always(function(){var o={parameterName:P,parameterValue:u.clone(v||{})};S.fireEvent(e,o);r.resolve(P);});});return r.promise();};this._getPersistedValue=function(P){var o=sap.ushell.Container.getService("UserDefaultParameterPersistence");return o.loadParameterValue(P);};this._isInitial=function(v){return!v||(!v.value&&!v.extendedValue);};this._haveSameMembersValue=function(o,O,m){return m.every(function(r){return o[r]===O[r]||d(o[r],O[r]);});};this._getUserDefaultParameterNames=function(){if(!this._oUserDefaultParametersNames){this._oUserDefaultParametersNames=new q.Deferred();sap.ushell.Container.getService("ClientSideTargetResolution").getUserDefaultParameterNames(true).done(function(P){var o=t._extractKeyArrays(P);var f=o.extended;var h=o.allParameters;var m=t._arrayToObject(h);if(m.length===0){t._oUserDefaultParametersNames.resolve({});}else{t._oUserDefaultParametersNames.resolve({aAllParameterNames:h,aExtendedParameterNames:f,oMetadataObject:m});}});}return this._oUserDefaultParametersNames.promise();};this._isRelevantParameter=function(P){var D=new q.Deferred();this._getUserDefaultParameterNames().done(function(r){if(r.aAllParameterNames&&r.aAllParameterNames.indexOf(P)!==-1){D.resolve();}else{D.reject();}});return D.promise();};this.hasRelevantMaintainableParameters=function(){var t=this,r=new q.Deferred(),h=false,G=[];t._getUserDefaultParameterNames().done(function(P){if(!a(P)&&P.aAllParameterNames){P.aAllParameterNames.forEach(function(f){var o=t.getValue(f);G.push(o);o.done(function(v){if(v&&!v.hasOwnProperty("noEdit")){h=true;return;}});});q.when.apply(undefined,G).done(function(){r.resolve(h);}).fail(function(){r.resolve();});}else{r.resolve();}});return r.promise();};this.getValue=function(P){var t=this,D=new q.Deferred();this._isRelevantParameter(P).fail(function(){D.resolve({});}).done(function(){q.when(t._getPersistedValue(P)).then(function(o){t._oWasParameterPersisted[P]=true;return q.when(o||{});},function(){return q.when({value:undefined});}).then(function(o){var G=new q.Deferred(),v=u.clone(o),f=sap.ushell.Container.getService("PluginManager");var h=(!o._shellData&&t._isInitial(o))||o.noStore||o.alwaysAskPlugin;if(!h){D.resolve(v);return;}f.loadPlugins("UserDefaults").done(function(){b(0,t._aPlugins,P,o,G);}).fail(function(){q.sap.log.error("Cannot get value for "+P+". One or more plugins could not be loaded.");G.reject("Initialization of plugins failed");});G.done(function(n){if(!t._oWasParameterPersisted[P]||!t._haveSameMembersValue(v,n,s)){t._oWasParameterPersisted[P]=true;t._storeValue(P,n);}D.resolve(n);}).fail(D.reject.bind(D));});});return D.promise();};this._addParameterValuesToParameters=function(P,f){var D=new q.Deferred();var h=[];var t=this;f.forEach(function(i){var n=t.getValue(i);h.push(n);n.done(function(v){P[i].valueObject=v;});});q.when.apply(q,h).done(D.resolve.bind(D,P)).fail(D.reject.bind(D,P));return D.promise();};this._arrayToObject=function(P){var r={};P.forEach(function(f){r[f]={};});return r;};this._getComponentNameOfPlugin=function(P){if(typeof P!=="object"||typeof P.getMetadata!=="function"||!P.getMetadata()||typeof P.getMetadata().getComponentName!=="function"){return"'name of plugin could not be determined'";}return P.getMetadata().getComponentName()||"";};this._getEditorDataAndValue=function(D,f,h,m){var t=this;var P=[];var r=[];t._aPlugins.forEach(function(o,i){if(typeof o.getEditorMetadata==="function"){var n=new q.Deferred();P.push(n);try{var j=P.length-1;o.getEditorMetadata(m).done(function(R){r[j]=R;}).always(function(){n.resolve();}).fail(function(){q.sap.log.error("EditorMetadata for plugin "+t._getComponentNameOfPlugin(o)+"cannot be invoked.",null,"sap.ushell.services.UserDefaultParameters");n.resolve();});}catch(k){q.sap.log.error("Error invoking getEditorMetaData on plugin: "+k+k.stack,null,"sap.ushell.services.UserDefaultParameters");n.resolve();}}});q.when.apply(q,P).done(function(){var i=[];var o=r.reverse().reduce(function(j,n){f.forEach(function(k){if(n[k]&&n[k].editorMetadata){j[k].editorMetadata=n[k].editorMetadata;}});return j;},m);f.forEach(function(j){if(!(o[j]&&o[j].editorMetadata)){i.push(j);}});t._addParameterValuesToParameters(o,f).done(function(j){var k=q.extend(true,{},j),K;h.forEach(function(l){if(k[l]){k[l].editorMetadata=k[l].editorMetadata||{};k[l].editorMetadata.extendedUsage=true;}});K=Object.keys(k).splice(0);K.forEach(function(l){var n;if(k[l].valueObject&&k[l].valueObject.noEdit===true){delete k[l];n=i.indexOf(l);if(n>=0){i.splice(n,1);}}});if(i.length>0){q.sap.log.error("The following parameter names have no editor metadata and thus likely no configured plugin:\n\""+i.join("\",\n\"")+"\".");}D.resolve(k);}).fail(D.reject.bind(D));});};this.editorGetParameters=function(){var D=new q.Deferred();var t=this;this._getUserDefaultParameterNames().done(function(P){if(P.oMetadataObject.length===0){D.resolve({});}else{sap.ushell.Container.getService("PluginManager").loadPlugins("UserDefaults").done(function(){t._getEditorDataAndValue(D,P.aAllParameterNames,P.aExtendedParameterNames,P.oMetadataObject);}).fail(function(){q.sap.log.error("One or more plugins could not be loaded");D.reject("Initialization of plugins failed");});}});return D.promise();};this._extractKeyArrays=function(P){var r={extended:[],simple:[],allParameters:[]};r.simple=(P&&P.simple&&Object.keys(P.simple).sort())||[];r.extended=(P&&P.extended&&Object.keys(P.extended).sort())||[];r.allParameters=r.simple.concat(r.extended.filter(function(f){return r.simple.indexOf(f)<0;})).sort();return r;};this.editorSetValue=function(P,v){return this._storeValue(P,v,true);};this.attachValueStored=function(f){S.attachEvent(e,f);};this.detachValueStored=function(f){S.detachEvent(e,f);};}U.hasNoAdapter=true;return U;},true);
