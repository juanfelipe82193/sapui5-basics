// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_AppState/WindowAdapter","sap/ushell/services/_AppState/SequentializingAdapter","sap/ushell/services/_AppState/AppState","sap/ushell/services/_AppState/Sequentializer","sap/ushell/services/_AppState/AppStatePersistencyMethod","sap/ushell/utils","sap/ui/thirdparty/jquery"],function(W,S,A,a,b,u,q){"use strict";function g(C){return u.isDefined(C)&&u.isDefined(C.transient)?!!C.transient:true;}function c(o,C,p,d){this._oConfig=d&&d.config;this._sSessionKey="";this._oAdapter=new S(o);this._oAdapter=new W(this,this._oAdapter,d);}c.prototype._getSessionKey=function(){if(!this._sSessionKey){this._sSessionKey=this._getGeneratedKey();}return this._sSessionKey;};c.prototype.getAppState=function(k){var d=new q.Deferred(),t=this,o;this._loadAppState(k).done(function(k,D,p,P){o=new A(t,k,false,D,undefined,undefined,undefined,p,P);d.resolve(o);}).fail(function(){o=new A(t,k);d.resolve(o);});return d.promise();};c.prototype._getGeneratedKey=function(){var s=sap.ushell.Container.getService("Personalization").getGeneratedKey();s=("AS"+s).substring(0,40);return s;};c.prototype.createEmptyAppState=function(C,t,p,P){var k=this._getGeneratedKey(),o,s="",d="",U=u.isDefined(t)?t:g(this._oConfig);if(p!==undefined&&!this.isPersistencyMethodSupported(p)){p=undefined;P=undefined;}if(C){if(!(C instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component");}if(C.getMetadata&&C.getMetadata()&&typeof C.getMetadata().getName==="function"){s=C.getMetadata().getName()||"";}if(!s&&C.getMetadata&&C.getMetadata().getComponentName){s=C.getMetadata().getComponentName();}if(C.getMetadata&&C.getMetadata()&&typeof C.getMetadata().getManifest==="function"&&typeof C.getMetadata().getManifest()==="object"&&typeof C.getMetadata().getManifest()["sap.app"]==="object"){d=C.getMetadata().getManifest()["sap.app"].ach||"";}}if(U===true){p=P=undefined;}else if(p===undefined&&this.isPersistencyMethodSupported(b.PersonalState)){p=b.PersonalState;P=undefined;}o=new A(this,k,true,undefined,s,d,U,p,P);return o;};c.prototype.createEmptyUnmodifiableAppState=function(){var k=this._getGeneratedKey(),o;o=new A(this,k,false);return o;};c.prototype._saveAppState=function(k,d,s,C,t,p,P){var e=this._getSessionKey(),U=u.isDefined(t)?t:g(this._oConfig);if(U){p=undefined;P=undefined;}else if(p!=undefined){if(!this.isPersistencyMethodSupported(p)){if(this.isPersistencyMethodSupported(b.PersonalState)){p=b.PersonalState;}else{p=undefined;}P=undefined;}}return this._oAdapter.saveAppState(k,e,d,s,C,U,p,P);};c.prototype._loadAppState=function(k){return this._oAdapter.loadAppState(k);};c.prototype.deleteAppState=function(k){return this._oAdapter.deleteAppState(k);};c._getSequentializer=function(){return new a();};c.prototype.getSupportedPersistencyMethods=function(){if(this._oAdapter.getSupportedPersistencyMethods){return this._oAdapter.getSupportedPersistencyMethods();}return[];};c.prototype.isPersistencyMethodSupported=function(p){var s=this.getSupportedPersistencyMethods();if(s.length>0&&p!==undefined){return(s.indexOf(p)>=0);}else{return false;}};c.prototype.makeStatePersistent=function(k,p,P){var d=new q.Deferred(),t=this;if(this.getSupportedPersistencyMethods().length===0){return d.resolve().promise();}if(this.isPersistencyMethodSupported(p)){t.getAppState(k).done(function(o){if(o._iPersistencyMethod!==p){o.bTransient=false;o._iPersistencyMethod=p;o._oPersistencySettings=P;t._saveAppState(k,o._sData,o._sAppName,o._sACHComponent,false,p,P).done(function(){d.resolve();}).fail(function(m){d.reject(m);});}else{d.resolve();}});}else{d.reject("AppState.makeStatePersistent - adapter does not support persistence method: "+p);}return d.promise();};c.WindowAdapter=W;c.hasNoAdapter=false;return c;},true);
