// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/m/List","sap/m/FlexBox","sap/ui/core/Control","sap/m/StandardListItem","sap/m/Label","sap/ushell/resources","sap/m/VBox","sap/ui/Device","sap/ui/events/KeyCodes","sap/base/Log"],function(q,A,L,F,C,S,a,r,V,D,K,b){"use strict";var c=C.extend("sap.ushell.ui.shell.ShellNavigationMenu",{metadata:{properties:{title:{type:"string",group:"Misc",defaultValue:null},icon:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:null},showTitle:{type:"boolean",defaultValue:false},showRelatedApps:{type:"boolean",defaultValue:true}},aggregations:{items:{type:"sap.m.ListItem",group:"Misc",defaultValue:null,singularName:"item"},miniTiles:{type:"sap.ushell.ui.shell.NavigationMiniTile",group:"Misc",defaultValue:null,singularName:"miniTile"}},events:{}},renderer:{render:function(R,o){var t,m;R.write("<div ");R.writeControlData(o);R.write(">");if(o.getShowTitle()){t=o.oTitle;t.setIcon(o.getIcon());t.setTitle(o.getTitle());R.write("<div id=\"sapUshellNavTitle\" >");R.renderControl(t);R.write("</div>");}if(o.oItemsList){R.renderControl(o.oItemsList);}if(o.getShowRelatedApps()){m=o.getMiniTiles();if(m&&m.length>0){R.renderControl(o.oRelatedAppsVbox);}}R.write("</div>");}}});var d=function(m){this.init(m);};d.prototype.init=function(m){this.keyCodes=K;this.jqElement=m.$();this.jqElement.on("keydown.keyboardNavigation",this.keydownHandler.bind(this));};d.prototype.destroy=function(){if(this.jqElement){this.jqElement.off(".keyboardNavigation");}delete this.jqElement;};d.prototype.keydownHandler=function(e){switch(e.keyCode){case this.keyCodes.ARROW_UP:this.upDownHandler(e,true);break;case this.keyCodes.ARROW_DOWN:this.upDownHandler(e,false);break;case this.keyCodes.ARROW_LEFT:this.leftRightHandler(e,false);break;case this.keyCodes.ARROW_RIGHT:this.leftRightHandler(e,true);break;case this.keyCodes.HOME:this.homeEndHandler(e,true);break;case this.keyCodes.END:this.homeEndHandler(e,false);break;case this.keyCodes.PAGE_UP:this.homeEndHandler(e,true);break;case this.keyCodes.PAGE_DOWN:this.homeEndHandler(e,false);break;default:break;}};d.prototype.upDownHandler=function(e,i){var j=q(document.activeElement);if(!j.hasClass("sapUshellNavMiniTile")){return false;}var f=j.parent().parent();var g=j.parent().index();var h=f.children();var n;if(i){n=g-3;if(n<0){n+=9;}}else{n=(g+3)%h.length;}var k=h[n].children[0];this._setItemFocus(e,q(k));};d.prototype.leftRightHandler=function(e,i){var n=i?"next":"prev",f,g,h,j,k,l,m=q(document.activeElement);if(!m.hasClass("sapUshellNavMiniTile")){return false;}f=m.parent();g=f[n]();h=g.index();j=f.parent();if(h===-1){k=i?0:j.children().length-1;}else{k=h;}l=j.children()[k].children[0];if(!l){return false;}this._setItemFocus(e,q(l));};d.prototype.homeEndHandler=function(e,i){var n=i?"first":"last";var j=q(document.activeElement);if(!j.hasClass("sapUshellNavMiniTile")){return false;}e.preventDefault();var f=this.jqElement.find(".sapUshellNavMiniTile")[n]();this._setItemFocus(e,f);};d.prototype._setItemFocus=function(e,j){e.preventDefault();e.stopImmediatePropagation();q(".sapUshellNavMiniTile").attr("tabindex",-1);j.attr("tabindex",0);j.focus();};d.prototype.setFocusToLastFocusedMiniTile=function(e){var j=q(".sapUshellNavMiniTile[tabindex='0']");if(j&&j[0]){this._setItemFocus(e,q(j));}else{this._setItemFocus(e,q(q(".sapUshellNavMiniTile")[0]));}};c.prototype.init=function(){};c.prototype._createItemsList=function(){this.oItemsList=new L("sapUshellNavHierarchyItems");};c.prototype._createMiniTilesBox=function(){this.oMiniTilesBox=new F("sapUshellNavRelatedAppsFlexBox");};c.prototype._beforeOpen=function(){if(!this.bInitialized){this.oTitle=new S("navMenuInnerTitle").addStyleClass("sapUshellNavigationMenuTitleItem");this.oRelatedAppsTitle=new a("sapUshellRelatedAppsLabel",{text:r.i18n.getText("shellNavMenu_relatedApps")});if(!this.oMiniTilesBox){this._createMiniTilesBox();}this.oRelatedAppsVbox=new V("sapUshellRelatedAppsItems",{items:[this.oRelatedAppsTitle,this.oMiniTilesBox]});this._extendInnerControlsForAccKeyboard();this.bInitialized=true;}};c.prototype._afterOpen=function(){if(D.system.desktop){if(this.keyboardNavigation){this.keyboardNavigation.destroy();}this.keyboardNavigation=new d(this.oMiniTilesBox);}};c.prototype._extendInnerControlsForAccKeyboard=function(){this.oTitle.addCustomData(new A({key:"aria-level",value:"1",writeToDom:true}));if(D.system.desktop){this.oTitle.addCustomData(new A({key:"tabindex",value:"0",writeToDom:true}));this.oItemsList.addEventDelegate({onsaptabprevious:function(e){if(this.getShowTitle()){e.preventDefault();e.stopImmediatePropagation();q("#navMenuInnerTitle").focus();}else{this.keyboardNavigation.setFocusToLastFocusedMiniTile(e);}}.bind(this),onsaptabnext:function(e){if(q(".sapUshellNavMiniTile").length){this.keyboardNavigation.setFocusToLastFocusedMiniTile(e);}else{var o=sap.ui.getCore().byId("allMyAppsButton");this.keyboardNavigation._setItemFocus(e,q((o.getDomRef())));}}.bind(this)});}};c.prototype.getMiniTiles=function(){if(this.oMiniTilesBox){return this.oMiniTilesBox.getItems();}return[];};c.prototype.insertMiniTile=function(m,i){if(!this.oMiniTilesBox){this._createMiniTilesBox();}this.oMiniTilesBox.insertItem(m,i);return this;};c.prototype.addMiniTile=function(m){if(!this.oMiniTilesBox){this._createMiniTilesBox();}if(this.oMiniTilesBox.getItems().length<9){this.oMiniTilesBox.addItem(m);}else{b.warning("ShellNavigationMenu.addMiniTile - miniTiles aggregation is already at maximum size of 9 elements "+"- current item was not added.");}return this;};c.prototype.removeMiniTile=function(i){if(this.oMiniTilesBox){this.oMiniTilesBox.removeItem(i);}return this;};c.prototype.removeAllMiniTiles=function(){if(this.oMiniTilesBox){this.oMiniTilesBox.removeAllItems();}return this;};c.prototype.destroyMiniTiles=function(){if(this.oMiniTilesBox){this.oMiniTilesBox.destroyItems();}return this;};c.prototype.indexOfMiniTile=function(m){if(this.oMiniTilesBox){return this.oMiniTilesBox.indexOfItem(m);}return-1;};c.prototype.getItems=function(){if(this.oItemsList){return this.oItemsList.getItems();}return[];};c.prototype.insertItem=function(h,i){if(!this.oItemsList){this._createItemsList();}h=this._extendHierarchyItemForAcc(h);this.oItemsList.insertItem(h,i);return this;};c.prototype.addItem=function(h){if(!this.oItemsList){this._createItemsList();}h=this._extendHierarchyItemForAcc(h);this.oItemsList.addItem(h);return this;};c.prototype.removeItem=function(i){if(this.oItemsList){this.oItemsList.removeItem(i);}return this;};c.prototype.removeAllItems=function(){if(this.oItemsList){this.oItemsList.removeAllItems();}return this;};c.prototype.destroyItems=function(){if(this.oItemsList){this.oItemsList.destroyItems();}return this;};c.prototype.indexOfItem=function(h){if(this.oItemsList){return this.oItemsList.indexOfItem(h);}return-1;};c.prototype._extendHierarchyItemForAcc=function(i){if(D.system.desktop){i.addEventDelegate({onsapspace:function(e){this.firePress();}.bind(i)});}return i;};c.prototype.exit=function(){if(this.oItemsList){this.oItemsList.destroy();}if(this.oMiniTilesBox){this.oMiniTilesBox.destroy();}if(this.bInitialized){this.oTitle.destroy();this.oRelatedAppsVbox.destroy();this.oRelatedAppsTitle.destroy();}if(this.keyboardNavigation){this.keyboardNavigation.destroy();}};c.prototype.onAfterRendering=function(){if(this.getShowTitle()){q("#sapUshellAppTitlePopover-intHeader").css("height",0);}else{q("#sapUshellAppTitlePopover-intHeader").css("height","0.5rem");}if(this.getShowTitle()){var j=q("#navMenuInnerTitle");j.attr("aria-readonly","true");j.attr("readonly","readonly");}var e=q("#sapUshellNavHierarchyItems ul");e.attr("role","group");e.attr("aria-label",r.i18n.getText("ShellNavigationMenu_HierarchyItemsAriaLabel"));var f=q("#sapUshellNavRelatedAppsFlexBox");f.attr("role","listbox");f.attr("aria-labelledBy","sapUshellRelatedAppsLabel");var g=q(".sapUshellNavMiniTile");for(var i=0;i<g.length;i++){q(g[i]).attr("aria-setsize",g.length);q(g[i]).attr("aria-posinset",i+1);}};return c;});
