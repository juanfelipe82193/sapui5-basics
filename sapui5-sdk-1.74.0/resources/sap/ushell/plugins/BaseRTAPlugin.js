// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/thirdparty/hasher","sap/ui/Device","sap/base/Log","sap/base/util/UriParameters","sap/ushell/plugins/BaseRTAPluginStatus","sap/ui/core/Component","sap/ui/core/BusyIndicator","sap/m/MessageBox","sap/base/util/ObjectPath"],function(q,h,D,L,U,P,C,B,M,O){"use strict";var S=P.STATUS_STARTING;var a=P.STATUS_STARTED;var b=P.STATUS_STOPPING;var c=P.STATUS_STOPPED;var d=C.extend("sap.ushell.plugins.BaseRTAPlugin",{sStatus:c,sType:null,oStartingPromise:null,oStoppingPromise:null,bValidateAppVersion:true,_getRenderer:function(o){var e=new q.Deferred(),r;r=o.getRenderer();if(r){this.oRenderer=r;e.resolve(r);}else{this._onRendererCreated=function(E){r=E.getParameter("renderer");if(r){this.oRenderer=r;e.resolve(r);}else{e.reject("Illegal state: shell renderer not available after recieving 'rendererCreated' event.");}};o.attachRendererCreatedEvent(this._onRendererCreated,this);}return e.promise();},init:function(m){this.mConfig=m;this.i18n=this.getModel("i18n").getResourceBundle();var f=this.getComponentData()&&this.getComponentData().config;if(f){if(typeof f.validateAppVersion==="boolean"){this.bValidateAppVersion=f.validateAppVersion;}}var o=this._getContainer();var A=o.getService("AppLifeCycle");if(this._checkUI5App()){this._checkRestartRTA();}o.registerDirtyStateProvider(this._dirtyStateProvider.bind(this));A.attachAppLoaded(this._onAppLoaded,this);this._getRenderer(o).fail(function(e){L.error(e,undefined,this.mConfig.sComponentName);}.bind(this)).done(function(r){r.addActionButton("sap.ushell.ui.launchpad.ActionItem",{id:this.mConfig.id,text:this.i18n.getText(this.mConfig.text),icon:this.mConfig.icon,press:this._onAdapt.bind(this),visible:this.mConfig.visible&&this._checkUI5App()},true,false,[r.LaunchpadState.App]);}.bind(this));},exit:function(){var o=this._getContainer();o.getService("AppLifeCycle").detachAppLoaded(this._onAppLoaded,this);if(this._onRendererCreated){o.detachRendererCreatedEvent(this._onRendererCreated,this);}},_onAppLoaded:function(){if(this._checkUI5App()){this._checkRestartRTA();this._adaptButtonVisibility(this.mConfig.id,true);}else{this._adaptButtonVisibility(this.mConfig.id,false);}},_getContainer:function(){var o=O.get("sap.ushell.Container");if(!o){throw new Error("Illegal state: shell container not available; this component must be executed in a unified shell runtime context.");}return o;},_getAppDescriptor:function(o){var e;if(o&&o.getMetadata){e=o.getMetadata();if(e&&e.getManifest){return e.getManifest();}}return{};},_checkFlexEnabledOnStart:function(){var o=this._getCurrentRunningApplication(),r=o.componentInstance,A=this._getAppDescriptor(r),f=A["sap.ui5"]&&A["sap.ui5"].flexEnabled;return f!==false;},_handleFlexDisabledOnStart:function(){sap.ui.require(["sap/ui/rta/util/showMessageBox","sap/m/MessageBox"],function(s,M){s(this.i18n.getText("MSG_FLEX_DISABLED"),{icon:M.Icon.INFORMATION,title:this.i18n.getText("HEADER_FLEX_DISABLED"),actions:[M.Action.OK],initialFocus:null,isCustomAction:false});}.bind(this));},_onAdapt:function(){var s=((D.browser.msie&&D.browser.version>10)||D.browser.webkit||D.browser.firefox||D.browser.edge);var f=this._checkFlexEnabledOnStart();if(!s){M.error(this.i18n.getText("MSG_UNSUPPORTED_BROWSER"),{title:this.i18n.getText("ERROR_TITLE"),onClose:null});}else if(!f){this._handleFlexDisabledOnStart();}else{this._startRta();}},_adaptButtonVisibility:function(v,V){if(typeof v==="string"){v=sap.ui.getCore().byId(v);}if(!v){return;}v.setVisible(V);},_checkUI5App:function(){var o=this._getCurrentRunningApplication();var u=o&&o.applicationType==="UI5";return u;},_checkRestartRTA:function(){var u=new U(window.location.href);var s=u.get("sap-ui-layer");var l=s||this.mConfig.layer;var r=!!window.sessionStorage.getItem("sap.ui.rta.restart."+l);if(r){window.sessionStorage.removeItem("sap.ui.rta.restart."+l);this._startRta();}},_getCurrentRunningApplication:function(){var A=this._getContainer().getService("AppLifeCycle");var o=A.getCurrentApplication();return o;},_switchToDefaultMode:function(){if(this._oRTA){this._oRTA.destroy();this.sStatus=c;this.oStartingPromise=null;this.oStoppingPromise=null;this._oRTA=null;}sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);},_startRta:function(){var o=this._getCurrentRunningApplication();var r=o.componentInstance;var s=this.sStatus;switch(s){case S:this.oStartingPromise=this.oStartingPromise;break;case a:this.oStartingPromise=Promise.resolve();break;case b:this.oStartingPromise=this.oStoppingPromise.then(function(){return this._triggerStartRta(r);}.bind(this));break;case c:this.oStartingPromise=this._triggerStartRta(r);break;default:}if(s!==S){this.oStartingPromise.then(function(){this.oStartingPromise=null;}.bind(this));}return this.oStartingPromise;},_triggerStartRta:function(r){this.sStatus=S;return new Promise(function(R){sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);B.show(0);sap.ui.getCore().loadLibraries(["sap.ui.rta"],{async:true}).then(function(){sap.ui.require(["sap/ui/rta/RuntimeAuthoring"],function(e){this.sOldHash=h.getHash();this._oRTA=new e({rootControl:r,validateAppVersion:this.bValidateAppVersion,flexSettings:{layer:this.mConfig.layer,developerMode:this.mConfig.developerMode}});this._oRTA.attachEvent("start",this._onStartHandler,this);this._oRTA.attachEvent("failed",this._errorHandler,this);this._oRTA.attachEvent("stop",this._switchToDefaultMode,this);this._loadPlugins(this._oRTA).then(function(){return this._oRTA.start().then(function(){B.hide();R();}).catch(this._errorHandler.bind(this));}.bind(this));}.bind(this));}.bind(this));}.bind(this)).then(function(){this.sStatus=a;}.bind(this));},_stopRta:function(){var s=this.sStatus;switch(s){case S:this.oStoppingPromise=this.oStartingPromise.then(function(){return this._triggerStopRta.apply(this,arguments);}.bind(this));break;case a:this.oStoppingPromise=this._triggerStopRta.apply(this,arguments);break;case b:this.oStoppingPromise=this.oStoppingPromise;break;case c:this.oStoppingPromise=Promise.resolve();break;default:}if(s!==b){this.oStoppingPromise.then(function(){this.oStoppingPromise=null;}.bind(this));}return this.oStoppingPromise;},_triggerStopRta:function(){this.sStatus=b;return this._oRTA.stop.apply(this._oRTA,arguments).then(function(){this._switchToDefaultMode();}.bind(this));},_errorHandler:function(e){B.hide();if(e==="Reload triggered"){this.sStatus=c;}else{this._switchToDefaultMode();var E;var m;if(e instanceof Error){E=e.stack;m=this.i18n.getText("TECHNICAL_ERROR");}else if(typeof e==="string"){E=m=e;}L.error("Cannot start UI Adaptation: ",E);sap.ui.require(["sap/ui/rta/Utils"],function(f){M.error(m,{title:this.i18n.getText("ERROR_TITLE"),onClose:null,styleClass:f.getRtaStyleClassName()});}.bind(this));}},_dirtyStateProvider:function(){if(this._oRTA&&this.sStatus===a){var u=this._getContainer();var o=u.getService("URLParsing");var H=h.getHash();var p=o.parseShellHash(H);var e=o.parseShellHash(this.sOldHash);this.sOldHash=H;if(p.semanticObject===e.semanticObject&&p.action===e.action&&p.appSpecificRoute!==e.appSpecificRoute){return false;}return this._oRTA.canUndo();}return false;},_onStartHandler:function(){},_loadPlugins:function(){return Promise.resolve();},_onAppClosed:function(){this._stopRta(true,true);}});return d;},true);
