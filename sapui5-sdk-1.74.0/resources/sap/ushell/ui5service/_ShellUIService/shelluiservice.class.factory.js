// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/EventProvider","sap/ui/thirdparty/hasher","sap/base/util/isPlainObject","sap/base/util/Version"],function(E,h,i,V){"use strict";return function(s){var S=s.serviceRegistry,a=s.serviceFactory,b=s.service;var l;var e=new E();var O={hierarchyChanged:"hierarchyChanged",relatedAppsChanged:"relatedAppsChanged",titleChanged:"titleChanged",backNavigationChanged:"backNavigationChanged"};var A;var c=b.extend("sap.ushell.ui5service.ShellUIService",{init:function(){var t=this,p=this.getInterface();p.init=function(){t._amendPublicServiceInstance.call(t,this);};S.register("sap.ushell.ui5service.ShellUIService",new a(p));},_setActiveComponentId:function(I){A=I;},_getActiveComponentId:function(){return A;},_shouldEnableAutoHierarchy:function(o){return typeof o.getManifestEntry==="function"&&o.getManifestEntry("/sap.ui5/services/ShellUIService/settings/setHierarchy")==="auto";},_shouldEnableAutoTitle:function(o){return typeof o.getManifestEntry==="function"&&o.getManifestEntry("/sap.ui5/services/ShellUIService/settings/setTitle")==="auto";},_enableAutoHierarchy:function(o){var t=this;var r=o.getRouter&&o.getRouter();if(!r){jQuery.sap.log.error("Could not enable automatic setHierarchy on the current app","Router could not be obtained on the app root component via getRouter","sap.ushell.ui5service.ShellUIService");return;}r.attachTitleChanged(function(d){var H=d.getParameter("history");t.setHierarchy(H.reverse().map(function(u){var f=t._getCurrentShellHashWithoutAppRoute();return{title:u.title,intent:f+"&/"+u.hash};}));});},_enableAutoTitle:function(o){var t=this;var r=o.getRouter&&o.getRouter();if(!r){jQuery.sap.log.error("Could not enable automatic setTitle on the current app","Router could not be obtained on the app root component via getRouter","sap.ushell.ui5service.ShellUIService");return;}var T=r.getTitleHistory()[0];if(T&&T.title){setTimeout(function(){t.setTitle(T.title);},0);}r.attachTitleChanged(function(d){var f=d.getParameter("title");t.setTitle(f);});},_getCurrentShellHashWithoutAppRoute:function(){var f="#"+h.getHash();var u=sap.ushell.Container.getService("URLParsing");var U=u.getShellHash(f);if(!U){jQuery.sap.log.error("Cannot get the current shell hash","URLParsing service returned a falsy value for "+f,"sap.ushell.ui5service.ShellUIService");return"";}return"#"+U;},_getEventProvider:function(){return e;},_getLastSetTitle:function(){return l;},_ensureArrayOfObjectOfStrings:function(v,m){var d=Array.isArray(v)&&v.every(function(o){return i(o)&&Object.keys(o).length>0&&Object.keys(o).every(function(k){return typeof o[k]==="string";});});if(!d){jQuery.sap.log.error("'"+m+"' was called with invalid parameters","An array of non-empty objects with string values is expected","sap.ushell.ui5service.ShellUIService");}return d;},_ensureFunction:function(v,m){var t=typeof v;if(t!=="function"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a function, got '"+t+"' instead","sap.ushell.ui5service.ShellUIService");return false;}return true;},_ensureString:function(v,m){var t=typeof v;if(t!=="string"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a string, got '"+t+"' instead","sap.ushell.ui5service.ShellUIService");return false;}return true;},_addCallAllowedCheck:function(p,P){var t=this;p[P]=function(){var C=p.getContext();if(!C||C.scopeObject.getId()!==A){jQuery.sap.log.warning("Call to "+P+" is not allowed","This may be caused by an app component other than the active '"+A+"' that tries to call the method","sap.ushell.ui5service.ShellUIService");return undefined;}if(P==="setHierarchy"&&C.scopeType==="component"&&C.scopeObject&&t._shouldEnableAutoHierarchy(C.scopeObject)){jQuery.sap.log.warning("Call to "+P+" is not allowed","The app defines that setHierarchy should be called automatically","sap.ushell.ui5service.ShellUIService");return undefined;}if(P==="setTitle"&&C.scopeType==="component"&&C.scopeObject&&t._shouldEnableAutoTitle(C.scopeObject)){jQuery.sap.log.warning("Call to "+P+" is not allowed","The app defines that setTitle should be called automatically","sap.ushell.ui5service.ShellUIService");return undefined;}return t[P].apply(p,arguments);};},_amendPublicServiceInstance:function(p){var t=this,C;C=p.getContext();if(typeof C==="undefined"){return;}["setTitle","setHierarchy","setRelatedApps","setBackNavigation"].forEach(function(m){t._addCallAllowedCheck(p,m);});var o=C.scopeObject;if(C.scopeType==="component"&&o){this._setActiveComponentId(o.getId());if(this._shouldEnableAutoHierarchy(o)){this._enableAutoHierarchy(o);}if(this._shouldEnableAutoTitle(o)){this._enableAutoTitle(o);}return;}jQuery.sap.log.error("Invalid context for ShellUIService interface","The context must be empty or an object like { scopeType: ..., scopeObject: ... }","sap.ushell.ui5service.ShellUIService");},setHierarchy:function(H){if(typeof H!=="undefined"&&!c.prototype._ensureArrayOfObjectOfStrings(H,"setHierarchy")){return;}var C=this.getContext().scopeObject;e.fireEvent(O.hierarchyChanged,{data:H,component:C});return;},setTitle:function(t){if(typeof t!=="undefined"&&!c.prototype._ensureString(t,"setTitle")){return;}var C=this.getContext().scopeObject;l=t;e.fireEvent(O.titleChanged,{data:t,component:C});return;},setBackNavigation:function(C){if(typeof C!=="undefined"&&!c.prototype._ensureFunction(C,"setBackNavigation")){return;}var o=this.getContext().scopeObject;e.fireEvent(O.backNavigationChanged,{data:C,component:o});return;},getTitle:function(){return this._getLastSetTitle();},setRelatedApps:function(r){if(typeof r!=="undefined"&&!c.prototype._ensureArrayOfObjectOfStrings(r,"setRelatedApps")){return;}var C=this.getContext().scopeObject;e.fireEvent(O.relatedAppsChanged,{data:r,component:C});return;},getUxdVersion:function(){if((new V(sap.ui.version).compareTo("1.37.0"))>=0){return 2;}return 1;},_attachHierarchyChanged:function(f){this._getEventProvider().attachEvent(O.hierarchyChanged,f);},_detachHierarchyChanged:function(f){this._getEventProvider().detachEvent(O.hierarchyChanged,f);},_attachTitleChanged:function(f){this._getEventProvider().attachEvent(O.titleChanged,f);},_attachBackNavigationChanged:function(f){this._getEventProvider().attachEvent(O.backNavigationChanged,f);},_detachBackNavigationChanged:function(f){this._getEventProvider().detachEvent(O.backNavigationChanged,f);},_detachTitleChanged:function(f){this._getEventProvider().detachEvent(O.titleChanged,f);},_attachRelatedAppsChanged:function(f){this._getEventProvider().attachEvent(O.relatedAppsChanged,f);},_detachRelatedAppsChanged:function(f){this._getEventProvider().detachEvent(O.relatedAppsChanged,f);}});return c;};});
