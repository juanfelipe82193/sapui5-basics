// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/support/Plugin","sap/ui/model/json/JSONModel","sap/m/Button","sap/m/IconTabBar","sap/m/IconTabFilter","sap/m/Label","sap/m/Text","sap/m/MessageStrip","sap/m/FlexBox","sap/ui/model/resource/ResourceModel","sap/m/SearchField","sap/m/MessageBox","sap/base/util/isEmptyObject"],function(P,J,B,I,a,L,T,M,F,R,S,b,c){"use strict";var t=this,o,f=P.extend("sap.ushell.support.plugins.flpConfig.FlpConfigurationPlugin",{constructor:function(s){o=new R({bundleName:"sap/ushell/support/plugins/flpConfig/i18n/FlpConfigurationPlugin"});P.apply(this,["sapUiFlpConfigurationPlugin",o.getResourceBundle().getText("PLUGIN_NAME"),s]);this._oSupportStub=s;if(this.runsAsToolPlugin()){t=this;this._aEventIds=[this.getId()+"ReceiveData"];}else{this._aEventIds=[this.getId()+"RequestData"];}}});f.prototype.isToolPlugin=function(){return true;};f.prototype.isAppPlugin=function(){return true;};f.prototype.init=function(s){P.prototype.init.apply(this,arguments);if(this.runsAsToolPlugin()){var r;setTimeout(function(){t.requestData();},500);r=sap.ui.getCore().createRenderManager();r.write("<div id='"+this.getId()+"'</div>").flush(this.$().get(0));r.destroy();}else{}};f.prototype.exit=function(){P.prototype.exit.apply(this,arguments);};f.prototype.requestData=function(){this._oSupportStub.sendEvent(this.getId()+"RequestData",{eventData:{data:{}}});};f.prototype.onsapUiFlpConfigurationPluginRequestData=function(E){var i={};this.prepareForSending(window["sap-ushell-config"],i);this._oSupportStub.sendEvent(this.getId()+"ReceiveData",{eventData:{data:i}});};f.prototype.onsapUiFlpConfigurationPluginReceiveData=function(E){var t=this;this.flpConfig=E.getParameter("eventData").data;sap.ui.getCore().loadLibraries(["sap.ui.table"],{async:true}).then(function(){sap.ui.require(["sap/ui/table/TreeTable","sap/ui/table/Column","sap/ui/table/library"],function(i,C,j){var k=j.SelectionMode;t.getFlpConfigurationPluginUI(null,i,C,k);});});};function _(){var H=0,s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey(),i=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();if(Array.isArray(i[s])){i[s].forEach(function(j,k){var q=e(i[s][k],s);if(H<q){H=q;}});if(H>0){sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).expandToLevel(H-1);}else{b.error(new L({text:sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("i18n").getResourceBundle().getText("MISSING_HIERARCHY_LEVEL")}));}}}function d(){var s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey();sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).collapseAll();}f.prototype.onPressSearchNewModel=function(E){var q,r,s,A,u,v,w,x,V,y=[],z={},C="",D={},G={},H=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("Full"),K=E.getParameter("query");if(!H){H=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();}else{H=H.getData();}Object.keys(H).forEach(function(N){z[N]=0;});if(K){for(var N in H){C=N;q=[];n(H[N],N,C,q,K);G[N]=q;}Object.keys(G).forEach(function(N){A=G[N];for(var i=0;i<A.length;i++){u=A[i].split(".");v=[];for(var j=0;j<u.length;j++){if(!isNaN(parseInt(u[j],10))){v.push(parseInt(u[j],10));}else{v.push(u[j]);}}for(var k=0;k<v.length;k+=2){w={"property":""};w[v[0]]=[];if(isNaN(parseInt(v[k],10))){r=v.slice(0,k+1);if(!g(D,r)&&typeof g(D,v.slice(0,v.length-2))!=="object"){m(D,r,[w],v[0],r.length);}V=g(H,v.slice(0,k+2));if(V&&g(D,v.slice(0,k+2))){l(D,V.property,v.slice(0,k+2).toString()+",property");}else if(k!==v.length-2){y.push(v.slice(0,k+2).toString());}}}s=v.slice(0);m(D,v,{"property":"","value":""},v[0],r.length);V=g(H,s);if(V){l(D,V.value,s.toString()+",value");l(D,V.property,s.toString()+",property");}}y.forEach(function(C){V=g(H,C.split(","));if(V&&g(D,C.split(","))){l(D,V.property,C+",property");}});y=[];if(D[N]&&Array.isArray(D[N][0][N])&&D[N][0][N].length===0){D[N]=D[N].splice(1);}});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(D));sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(H),"Full");var O=0;Object.keys(z).forEach(function(N){x=N;if(D[x]&&Array.isArray(D[x])){D[x].forEach(function(i,j){var k=e(D[x][j],x);if(O<k){O=k;}});}sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+N).expandToLevel(O-1);sap.ui.getCore().byId(N).setCount(h(D[N],N,0));});}else{Object.keys(z).forEach(function(N){sap.ui.getCore().byId(N).setCount(h(H[N],N,0));});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(H));}};function e(C,s){var H=0;if(C[s]){C[s].forEach(function(i){var j=e(i,s);if(j>H){H=j;}});}return H+1;}function g(j,k){for(var i=0;i<k.length;i++){if(j){j=j[k[i]];}}return j;}function h(C,s,i){if(Array.isArray(C)){C.forEach(function(j){if(j[s]){i=h(j[s],s,i);}else{i+=1;}});return i;}return undefined;}function l(j,v,s){var k=s.split(",");for(var i=0;i<k.length-1;i++){j=j[k[i]];}j[k[k.length-1]]=v;}function m(i,j,v,s,k){if(j.length===1){i[j[0]]=v;}else{var q=j.shift();i[q]=m(typeof i[q]==="undefined"?{}:i[q],j,v,s,k);}if(i[s]&&i.property&&i.value){delete i.value;i.property="";}return i;}function n(C,s,i,j,k){C.forEach(function(q,r){if(q[s]){i=i+"."+r+"."+s;i=n(q[s],s,i,j,k);}else if(q.property.indexOf(k)>-1){i=i+"."+r;j.push(i);i=i.substring(0,i.lastIndexOf("."));}});i=i.substring(0,i.lastIndexOf("."));if(isNaN(parseInt(i.substr(i.lastIndexOf(".")+1),10))){return i;}return i.substring(0,i.lastIndexOf("."));}function p(C,s){if(typeof C!=="object"){return[{property:s,value:C}];}return Object.keys(C).map(function(i){var r={property:i};if(typeof(C[i])==="object"&&Object.keys(C[i]).length!==0){r[s]=p(C[i],s);return r;}if(!c(C[i])||typeof(C[i])!=="object"){r.value=C[i];}else{r.value="";}return r;});}f.prototype.prepareForSending=function(i,j){Object.keys(i).forEach(function(k){var C=i[k];switch(typeof C){case"object":if(C===null){j[k]=C;return;}else if(Array.isArray(C)){j[k]=[];}else{j[k]={};}this.prepareForSending(i[k],j[k]);break;case"undefined":j[k]="undefined";return;case"function":return;default:j[k]=i[k];return;}}.bind(this));};f.prototype.getNewConfigJSON=function(i){var N={};Object.keys(i).forEach(function(s){N[s]=p(i[s],s);});return N;};f.prototype.getFlpConfigurationPluginUI=function(i,j,C,k){var q,r,s,u={};s=this.getNewConfigJSON(this.flpConfig);q=new J(s);for(var v in s){u[v]=h(s[v],v,0);}if(!sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar")){if(!s||c(s)){new M({text:o.getResourceBundle().getText("ERROR_MESSAGE"),type:"Warning",showIcon:true,showCloseButton:false}).placeAt(this.getId());}else{r=new I("sap-ui-support-flpConfigurationPlugin-TabBar",{headerMode:"Inline"});Object.keys(this.flpConfig).forEach(function(x,y){r.insertItem(new a(x,{key:x,text:x,count:u[x],content:[new j("sap-ui-support-flpConfigurationPlugin-TreeTable"+x,{rows:"{/"+x+"/}",selectionMode:k.None,enableCellFilter:true,extension:[new F({items:[new B({icon:"sap-icon://expand",text:"{i18n>EXPAND_BUTTON}",press:_}),new B({icon:"sap-icon://collapse",text:"{i18n>COLLAPSE_BUTTON}",press:d})]})],columns:[new C({label:new L({text:"{i18n>COLUMN_PROPERTY}"}),template:new T({text:"{property}"})}),new C({label:new L({text:"{i18n>COLUMN_VALUE}"}),template:new T({text:"{value}"})})]})]}),y);});var w=new S({search:this.onPressSearchNewModel});w.placeAt(this.getId());r.setModel(q);r.setModel(o,"i18n");r.placeAt(this.getId());}}};return f;});
