// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sinaDefine(['../../../sina/SinaObject'],function(S){"use strict";return S.derive({_init:function(p){this._datasource=p.dataSource;this._cdsAnnotations=p.cdsAnnotations;this._parsedAttributes={};this._knownAttributeGroups={};this._knownAttributeGroupsArray=[];this._attributeGroupReplacements={};this._AttributeUsagePrio={HIGH:"HIGH",MEDIUM:"MEDIUM",NONE:"NONE"};this._detailUsageStubsMap={};this._detailUsageStubsPrioHigh=[];this._detailUsageStubsPrioMedium=[];this._detailUsageStubsPrioNone=[];this._defaultTextArrangement=this.sina.AttributeGroupTextArrangement.TextLast;},parseCDSAnnotationsForDataSource:function(){this._parsingResult={dataSourceIsCdsBased:false,detailAttributesAreSorted:false,titleAttributesAreSorted:false};this._parseDefaultTextArrangement();this._parseAttributeAnnotations();this._parseDataSourceAnnotations();return this._parsingResult;},_addDetailUsageStub:function(a,d,p){var b;if(typeof a==="string"){b=a;a=undefined;}else{b=a.id;}var u={attribute:a,displayOrder:d,prio:p,obsolete:false};this._detailUsageStubsMap[b]=u;if(p===this._AttributeUsagePrio.HIGH){this._detailUsageStubsPrioHigh.push(u);}else if(p===this._AttributeUsagePrio.MEDIUM){this._detailUsageStubsPrioMedium.push(u);}else{this._detailUsageStubsPrioNone.push(u);}},_getDetailUsageStub:function(a){if(!a){return undefined;}var b;if(typeof a==="string"){b=a;}else{b=a.id;}return this._detailUsageStubsMap[b];},_setParsedAttribute:function(a,b){this._parsedAttributes[a.toUpperCase()]=b;},_getParsedAttribute:function(a){return this._parsedAttributes[a.toUpperCase()];},_setknownAttributeGroup:function(q,a){this._knownAttributeGroups[q.toUpperCase()]=a;},_getknownAttributeGroup:function(q){return this._knownAttributeGroups[q.toUpperCase()];},_parseDefaultTextArrangement:function(){try{var d=this._deriveTextArrangementFromCdsAnnotation(this._cdsAnnotations.dataSourceAnnotations.UI&&this._cdsAnnotations.dataSourceAnnotations.UI.TEXTARRANGEMENT);this._defaultTextArrangement=d||this._defaultTextArrangement;}catch(e){}},_parseDataSourceAnnotations:function(){if(Object.keys(this._cdsAnnotations.dataSourceAnnotations).length>0){try{var u=this._cdsAnnotations.dataSourceAnnotations.UI;var h=u&&u.HEADERINFO;var t=h&&h.TITLE;var a,g,b;if(t){a=t.TYPE&&t.TYPE.toUpperCase();if(a==="AS_CONNECTED_FIELDS"){g=t.VALUEQUALIFIER;if(g&&g.trim().length>0){b=this._getknownAttributeGroup(g);if(b){b.usage.Title={displayOrder:1};}}}else if(!a){var c=t.VALUE;if(c){var d=this._getParsedAttribute(c);if(d){d.usage.Title={displayOrder:1};}}}var f=t.URL;if(f){var i=this._getParsedAttribute(f);if(i){i.usage.Navigation={mainNavigation:true};}}}var j=h&&h.DESCRIPTION;if(j){a=j.TYPE;if(a==="AS_CONNECTED_FIELDS"){g=j.VALUEQUALIFIER;if(g&&g.trim().length>0){b=this._getknownAttributeGroup(g);if(b){b.usage.TitleDescription={displayOrder:1};}}}else if(!a){var k=j.VALUE;if(k){var l=this._getParsedAttribute(k);if(l){l.usage.TitleDescription={};}}}}}catch(e){}}},_parseAttributeAnnotations:function(){for(var a in this._datasource.attributeMetadataMap){this._parseSingleAttribute(a);}this._datasource.attributesMetadata=this._datasource.attributesMetadata.concat(this._knownAttributeGroupsArray);this._datasource.attributeMetadataMap=Object.assign(this._datasource.attributeMetadataMap,this._knownAttributeGroups);this._sortAttributes();},_parseSingleAttribute:function(a){var p=this._getParsedAttribute(a);if(!p){p=this._getPropertyFromObject(this._datasource.attributeMetadataMap,a);this._setParsedAttribute(p.id,p);var b=this._cdsAnnotations.attributeAnnotations[p.id]||{};if(Object.keys(b).length>0){this._parsingResult.dataSourceIsCdsBased=true;try{if(b.UI!==undefined){this._parseSingleAnnotationOrArray(p,b.UI.IDENTIFICATION,this._parseIdentification);this._parseSingleAnnotationOrArray(p,b.UI.CONNECTEDFIELDS,this._parseConnectedFields);this._parseURLsForDocumentResultItemThumbnail(p,b.UI.IDENTIFICATION,b.SEMANTICS);if(b.UI.MULTILINETEXT!==undefined){p.format=this.sina.AttributeFormatType.MultilineText;}}this._parseSemantics(p,b.SEMANTICS);this._parseDescriptionAttribute(p,b.OBJECTMODEL,b.UI);}catch(e){}}}return p;},_parseConnectedFields:function(a,c){var q=c.QUALIFIER;if(q){var b={};if(c.NAME){b[c.NAME]=a;}this._createAttributeGroup(q,c.GROUPLABEL,c.TEMPLATE,b);}},_createAttributeGroup:function(q,l,t,a){var b=this._getknownAttributeGroup(q);if(!b){b=this.sina._createAttributeGroupMetadata({id:q,label:l||"",template:t||"",attributes:[],usage:{}});this._setknownAttributeGroup(q,b);this._knownAttributeGroupsArray.push(b);this._datasource.attributeGroupsMetadata.push(b);this._datasource.attributeGroupMetadataMap[q]=b;var u=this._getDetailUsageStub(q);if(u){u.attribute=b;}}else{if(l&&!b.label){b.label=l;}if(t&&!b.template){b.template=t;}}if(a){for(var n in a){var c=a[n];var d=this.sina._createAttributeGroupMembership({group:b,attribute:c,nameInGroup:n});b.attributes.push(d);c.groups.push(d);}}return b;},_parseIdentification:function(a,i){this._parseAttributePositions(a,i);},_parseAttributePositions:function(a,i){var b=i.IMPORTANCE&&i.IMPORTANCE.toUpperCase();var p=i.POSITION;if(b&&!p){p=Number.MAX_VALUE;}if(p!==undefined){switch(b){case"HIGH":case"MEDIUM":case undefined:p=this._parsePosition(p);var t=i.TYPE&&i.TYPE.toUpperCase();switch(t){case"AS_CONNECTED_FIELDS":var q=i.VALUEQUALIFIER;if(q){var c=this._getknownAttributeGroup(q);if(c){a=c;}else{a=q;}}case undefined:var u=this._getDetailUsageStub(a);if(u){if(!u.attribute&&typeof a!=="string"){u.attribute=a;}}else{var d;if(b==="HIGH"){d=this._AttributeUsagePrio.HIGH;}else if(b==="MEDIUM"){d=this._AttributeUsagePrio.MEDIUM;}else{d=this._AttributeUsagePrio.NONE;}this._addDetailUsageStub(a,p,d);}}}}},_parseURLsForDocumentResultItemThumbnail:function(a,b,s){if(!(s&&s.IMAGEURL)){return;}var u;if(b){if(Array.isArray(b)){for(var i=0;i<b.length;i++){if(b[i].URL){u=b[i].URL;break;}}}else{u=b.URL;}}if(u&&s&&s.IMAGEURL){var c=this._getPropertyFromObject(this._cdsAnnotations.attributeAnnotations,u);if(c){var m=c.SEMANTICS&&c.SEMANTICS.URL&&c.SEMANTICS.URL.MIMETYPE;if(m){var d=this._getPropertyFromObject(this._datasource.attributeMetadataMap,u);var e=this._getPropertyFromObject(this._datasource.attributeMetadataMap,m);a.suvUrlAttribute=d;a.suvMimeTypeAttribute=e;a.format=this.sina.AttributeFormatType.DocumentThumbnail;}}}},_parseSemantics:function(a,s){if(s){if(s.CONTACT&&s.CONTACT.PHOTO!==undefined){a.format=this.sina.AttributeFormatType.Round;if(a.type!==this.sina.AttributeType.ImageBlob){a.type=this.sina.AttributeType.ImageUrl;}}if(s.IMAGEURL!==undefined){if(a.type!==this.sina.AttributeType.ImageBlob){a.type=this.sina.AttributeType.ImageUrl;}}if(s.NAME!==undefined){if(s.NAME.GIVENNAME!==undefined){a.semantics=this.sina.AttributeSemanticsType.FirstName;}if(s.NAME.FAMILYNAME!==undefined){a.semantics=this.sina.AttributeSemanticsType.LastName;}}if(s.EMAIL&&s.EMAIL.ADDRESS!==undefined){a.semantics=this.sina.AttributeSemanticsType.EmailAddress;}if(s.TELEPHONE&&s.TELEPHONE.TYPE!==undefined){a.semantics=this.sina.AttributeSemanticsType.PhoneNr;}if(s&&s.URL!==undefined){a.semantics=this.sina.AttributeSemanticsType.HTTPURL;}if(s&&s.CURRENCYCODE!==undefined){a._private.isCurrency=true;}if(s&&s.UNITOFMEASURE!==undefined){a._private.isUnitOfMeasure=true;}var u,t;var b=s.QUANTITY&&s.QUANTITY.UNITOFMEASURE;if(b){a._private.isQuantity=true;u=this._parseSingleAttribute(b);if(u){if(u._private.isUnitOfMeasure){t="{"+a.id+"} {"+u.id+"}";this._createAttributeGroupForParentChildAttributes(a,u,"____UnitOfMeasureGroup",t);}}}var c=s.AMOUNT&&s.AMOUNT.CURRENCYCODE;if(c){u=this._parseSingleAttribute(c);if(u){if(u._private.isCurrency){t="{"+a.id+"} {"+u.id+"}";this._createAttributeGroupForParentChildAttributes(a,u,"____CurrencyGroup",t);}}}}},_parseDescriptionAttribute:function(a,o,u){var d=o&&o.TEXT&&o.TEXT.ELEMENT;if(d){if(Array.isArray(d)){if(d.length>0){d=d[0];}else{return;}}var b=this._parseSingleAttribute(d);if(b){var t=this._deriveTextArrangementFromCdsAnnotation(u&&u.TEXTARRANGEMENT)||this._defaultTextArrangement;var c=!(a.semantics==this.sina.AttributeSemanticsType.FirstName&&b.semantics==this.sina.AttributeSemanticsType.LastName||b.semantics==this.sina.AttributeSemanticsType.FirstName&&a.semantics==this.sina.AttributeSemanticsType.LastName);var p=c?"(":"";var e=c?")":"";var f;if(t===this.sina.AttributeGroupTextArrangement.TextFirst){f="{"+b.id+"} "+p+"{"+a.id+"}"+e;}else if(t===this.sina.AttributeGroupTextArrangement.TextLast){f="{"+a.id+"} "+p+"{"+b.id+"}"+e;}else if(t===this.sina.AttributeGroupTextArrangement.TextOnly){f="{"+b.id+"}";}else{f="{"+a.id+"} "+p+"{"+b.id+"}"+e;}var g=this._createAttributeGroupForParentChildAttributes(a,b,"____Description",f);g._private.isDescription=true;g._private.textArrangement=t;if(a._private.isUnitOfMeasure||b._private.isUnitOfMeasure){g._private.isUnitOfMeasure=true;}if(a._private.isCurrency||b._private.isCurrency){g._private.isCurrency=true;}}}},_deriveTextArrangementFromCdsAnnotation:function(c){if(c){switch(c.toUpperCase()){case"TEXT_FIRST":return this.sina.AttributeGroupTextArrangement.TextFirst;case"TEXT_LAST":return this.sina.AttributeGroupTextArrangement.TextLast;case"TEXT_ONLY":return this.sina.AttributeGroupTextArrangement.TextOnly;case"TEXT_SEPARATE":return this.sina.AttributeGroupTextArrangement.TextSeparate;}}return undefined;},_createAttributeGroupForParentChildAttributes:function(p,c,q,t){var a=p.id+q;var b={};b[p.id]=p;b[c.id]=c;var d=this._createAttributeGroup(a,p.label,t,b);var o=this._getDetailUsageStub(p);if(o){o.obsolete=true;this._addDetailUsageStub(d,o.displayOrder,o.prio);}this._replaceAttributeWithGroup(p,d);d._private.parentAttribute=p;d._private.childAttribute=c;if(c._private&&c._private.isCurrency){d._private.isCurrency=true;}if(c._private&&c._private.isUnitOfMeasure){d._private.isUnitOfMeasure=true;}return d;},_replaceAttributeWithGroup:function(a,b){this._setParsedAttribute(a.id,b);for(var i=0;i<a.groups.length;i++){var g=a.groups[i];if(g.group!=b){g.attribute=b;}}},_sortAttributes:function(){var s=function(b,c){if(b.displayOrder<c.displayOrder){return-1;}else if(b.displayOrder>c.displayOrder){return 1;}return 0;};var i,a;if(this._detailUsageStubsPrioHigh.length>0||this._detailUsageStubsPrioMedium.length>0){this._detailUsageStubsPrioHigh.sort(s);this._detailUsageStubsPrioMedium.sort(s);var _=this._detailUsageStubsPrioHigh.concat(this._detailUsageStubsPrioMedium);for(i=0;i<_.length;i++){if(!_[i].obsolete){a=_;break;}}}if(!a){a=this._detailUsageStubsPrioNone.sort(s);}for(i=0;i<a.length;i++){var e=a[i];if(!e.obsolete&&e.attribute&&typeof e.attribute!=="string"){e.attribute.usage=e.attribute.usage||{};e.attribute.usage.Detail={displayOrder:i};}}this._parsingResult.detailAttributesAreSorted=true;},_parseSingleAnnotationOrArray:function(a,b,p){if(b!==undefined){if(Array.isArray(b)){for(var j=0;j<b.length;j++){p.apply(this,[a,b[j]]);}}else{p.apply(this,[a,b]);}}},_parsePosition:function(p){if(typeof p==='string'){try{p=parseInt(p,10);}catch(e){p=Number.MAX_VALUE;}}if(typeof p!=='number'||isNaN(p)){p=Number.MAX_VALUE;}return p;},_getPropertyFromObject:function(o,p){if(o[p]){return o[p];}p=p.toLowerCase();for(var k in o){if(k.toLowerCase()===p){return o[k];}}return undefined;}});});
