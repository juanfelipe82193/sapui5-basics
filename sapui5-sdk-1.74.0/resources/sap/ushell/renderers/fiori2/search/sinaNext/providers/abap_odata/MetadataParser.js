// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sinaDefine(['../../core/core','../../sina/SinaObject','./typeConverter','./labelCalculation'],function(c,S,t,l){"use strict";return S.derive({_init:function(p){this._provider=p;this._sina=p.sina;this._labelCalculator=l.createLabelCalculator();this._appSearchDataSource=undefined;},getAppSearchDataSource:function(){return this._appSearchDataSource;},parseDataSourceData:function(d,s){for(var i=0;i<d.length;++i){var a=d[i];var b=a.Name;if(!b){b=a.Id;}var e=a.NamePlural;if(!e){e=b;}var f=this._sina._createDataSource({id:a.Id,label:b,labelPlural:e,type:this._sina.DataSourceType.BusinessObject,usage:a.Id.endsWith("TRANSACTIONS~")?{appSearch:{}}:{},attributesMetadata:[{id:'dummy'}]});f._private.system=a.SourceSystem;f._private.client=a.SourceClient;f._private.semanticObjectType=a.SemanticObjectTypeId;f._private.annotations=a.Annotations&&a.Annotations.results||[];this._labelCalculator.calculateLabel(f);this._fillMetadataBufferForDataSource(f,a.Attributes.results);s.registerObjectType({type:f.id,label:f.label,properties:f.attributesMetadata});if(f.id.endsWith("TRANSACTIONS~")&&this._appSearchDataSource===undefined){this._appSearchDataSource=f;}}},_fillMetadataBufferForDataSource:function(d,a){if(d.attributesMetadata[0].id!=='dummy'){return;}d.attributesMetadata=[];d.attributeMetadataMap={};var i;var b=[];var e=[];var f=[];var g=[];var h;var j={dataSourceAnnotations:{},attributeAnnotations:{}};j.dataSourceAnnotations=this._parseAnnotationsIntoJsonStructure(d._private.annotations);for(i=0;i<a.length;i++){h=a[i];var p=this._fillMetadataBufferForAttribute(d,h);var k=h.Annotations&&h.Annotations.results||[];var m=this._parseAnnotationsIntoJsonStructure(k);j.attributeAnnotations[p.id.toUpperCase()]=m;this._parseSemanticsAnnotation(h,m);if(p._private.temporaryUsage.Title!==undefined){b.push(p);}if(p._private.temporaryUsage.Detail!==undefined){if(h.isSummary){e.push(p);}else{f.push(p);}}}var n=this._sina._createCDSAnnotationsParser({dataSource:d,cdsAnnotations:j});var o=n.parseCDSAnnotationsForDataSource();if(!o.dataSourceIsCdsBased){this._sortAttributesOfNonCDSBasedDataSource(d,b,g,e,f);}for(i=0;i<d.attributesMetadata.length;i++){h=d.attributesMetadata[i];if(h._private.temporaryUsage){for(var u in h._private.temporaryUsage){if(u!="Title"&&u!="Detail"){h.usage[u]=h._private.temporaryUsage[u];}}}}},_fillMetadataBufferForAttribute:function(d,a){var b=a.Displayed&&a.DisplayOrder?a.DisplayOrder:-1;var e=this._parseAttributeTypeAndFormat(a);var p=this._sina._createAttributeMetadata({id:a.Id,label:a.Name!==""?a.Name:a.Id,isKey:a.Key,isSortable:a.Sortable,usage:{},type:e.type,format:e.format,matchingStrategy:this._parseMatchingStrategy(a)});p._private.semanticObjectType=a.SemanticObjectTypeId;p._private.temporaryUsage=a.UIAreas?this._parseUsage(a,b):{};d.attributesMetadata.push(p);d.attributeMetadataMap[p.id]=p;return p;},_parseSemanticsAnnotation:function(r,a){var h=false,s="SEMANTICS";for(var b in a){if(b.substr(0,s.length)==s){h=true;break;}}if(r.Semantics&&!h){var d;switch(r.Semantics){case"EMAIL.ADDRESS":case"TELEPHONE.TYPE":case"CURRENCYCODE":case"UNITOFMEASURE":d="TRUE";break;case"QUANTITY.UNITOFMEASURE":case"AMOUNT.CURRENCYCODE":d=r.UnitAttribute;break;}if(d){a[s+r.Semantics]=d;}}},_sortAttributesOfNonCDSBasedDataSource:function(d,a,b,e,f){var i,g;a.sort(this._createSortFunction("Title"));for(i=0;i<a.length;++i){var h=a[i].id;g=d.getAttributeMetadata(h);g.usage.Title=g._private.temporaryUsage.Title;g.usage.Title.displayOrder=i;}var s=this._createSortFunction("Detail");e.sort(s);f.sort(s);b.push.apply(b,e);b.push.apply(b,f);for(i=0;i<b.length;++i){b[i].usage.Detail=b[i]._private.temporaryUsage.Detail;b[i].usage.Detail.displayOrder=i;}},_arrayIncludesEntry:function(a,e,b){var i;if(b){for(i=0;i<a.length;i++){if(b(a[i],e)){return true;}}}else{for(i=0;i<a.length;i++){if(a[i]==e){return true;}}}return false;},_parseAnnotationsIntoJsonStructure:function(a){if(a.length==0){return{};}var i,j;var p={};var b,d;var f,g;var h;var k=[];var m;var n=function(w,x){return w.annotationPointer==x.annotationPointer&&w.annotationName==x.annotationName;};try{for(j=0;j<a.length;j++){b=/\[\d+\]$/g;g=p;h=a[j].Name.split(".");for(i=0;i<h.length;i++){f=h[i].toUpperCase();d=b.exec(f);if(d!==null){f=f.substring(0,d.index);}g[f]=g[f]||{};if(d!==null&&d[0].length>0){m={annotationPointer:g,annotationName:f};if(!this._arrayIncludesEntry(k,m,n)){k.push(m);}if(i<h.length-1){g[f][d[0]]=g[f][d[0]]||{};g=g[f][d[0]];}else{g[f][d[0]]=a[j].Value;}}else if(i<h.length-1){g=g[f];}else{g[f]=a[j].Value;}}}var o;var q;var r,s,u;var v=/\[\d+\]/g;for(j=0;j<k.length;j++){o=k[j].annotationPointer;f=k[j].annotationName;q=o[f];r=[];u={};for(s in q){if(s.match(v)){r.push(q[s]);}else{u[s]=q[s];}}if(Object.keys(u).length>0){r.push(u);}o[f]=r;}}catch(e){return{};}return p;},_createSortFunction:function(u){return function(a,b){if(a._private.temporaryUsage[u].displayOrder<b._private.temporaryUsage[u].displayOrder){return-1;}else if(a._private.temporaryUsage[u].displayOrder>b._private.temporaryUsage[u].displayOrder){return 1;}return 0;};},_parseMatchingStrategy:function(a){if(a.TextIndexed){return this._sina.MatchingStrategy.Text;}return this._sina.MatchingStrategy.Exact;},_parseAttributeTypeAndFormat:function(a){for(var i=0;i<a.UIAreas.results.length;i++){var p=a.UIAreas.results[i];var b=p.Id;switch(b){case'SUMMARY':continue;case'DETAILS':continue;case'TITLE':continue;case'#HIDDEN':case'HIDDEN':continue;case'FACTSHEET':continue;case'DETAILIMAGE':case'PREVIEWIMAGE':return{type:this._sina.AttributeType.ImageUrl};case'LONGTEXT':return{type:this._sina.AttributeType.String,format:this._sina.AttributeFormatType.LongText};default:throw new c.Exception('Unknown presentation usage '+p);}}switch(a.EDMType){case'Edm.String':case'Edm.Binary':case'Edm.Boolean':case'Edm.Byte':case'Edm.Guid':return{type:this._sina.AttributeType.String};case'Edm.Double':case'Edm.Decimal':case'Edm.Float':return{type:this._sina.AttributeType.Double};case'Edm.Int16':case'Edm.Int32':case'Edm.Int64':return{type:this._sina.AttributeType.Integer};case'Edm.Time':return{type:this._sina.AttributeType.Time};case'Edm.DateTime':if(a.TypeLength>8){return{type:this._sina.AttributeType.Timestamp};}return{type:this._sina.AttributeType.Date};case'GeoJson':return{type:this._sina.AttributeType.GeoJson};default:throw new c.Exception('Unknown data type '+a.EDMType);}},_parseUsage:function(a,d){var u=a.UIAreas.results;var b=a.AdvancedSearchRelevant;var f=a.Facet;var e={};u.forEach(function(g){var i=g.Id;if(i==="TITLE"){e.Title={displayOrder:d};}if(i==="SUMMARY"||i==="DETAILIMAGE"||i==="PREVIEWIMAGE"){a.isSummary=true;e.Detail={displayOrder:d};}if(i==="DETAILS"||i==="LONGTEXT"){e.Detail={displayOrder:d};}});if(b){e.AdvancedSearch={};}if(f){e.Facet={};}return e;},parseDynamicMetadata:function(s){var a;try{a=s.ResultList.SearchResults.results;}catch(e){return;}for(var i=0;i<a.length;++i){var b=a[i];if(!b.HitAttributes||!b.HitAttributes.results){continue;}var d=this._sina.getDataSource(b.DataSourceId);var h=b.HitAttributes.results;for(var j=0;j<h.length;++j){var f=h[j];this.parseDynamicAtributeMetadata(d,f);}}},parseDynamicAtributeMetadata:function(d,a){var b;var m=d.getAttributeMetadata(a.Id);if(m){if(!m._private.dynamic){return;}a.UIAreas=a.UIAreas||{results:[]};b=this._parseAttributeTypeAndFormat(a);m.label=a.Name;m.type=b.type;m.format=b.format;}else{a.UIAreas=a.UIAreas||{results:[]};b=this._parseAttributeTypeAndFormat(a);m=this._sina._createAttributeMetadata({id:a.Id,label:a.Name,isKey:false,isSortable:false,usage:{},type:b.type,format:b.format,matchingStrategy:this._sina.MatchingStrategy.Exact,_private:{dynamic:true}});d.attributesMetadata.push(m);d.attributeMetadataMap[m.id]=m;}}});});
