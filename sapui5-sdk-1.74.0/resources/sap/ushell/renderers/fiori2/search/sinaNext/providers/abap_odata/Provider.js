// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sinaDefine(['../../core/core','../../core/util','../../core/lang','../../sina/SinaObject','./ajax','./ajaxTemplates','./conditionSerializer','./dataSourceSerializer','./FacetParser','./ItemParser','./NlqParser','./suggestionParser','./suggestionTermSplitter','./labelCalculation','./UserEventLogger','./MetadataParser'],function(c,u,l,S,a,b,d,e,F,I,N,f,s,g,U,M){"use strict";return S.derive({id:'abap_odata',_initAsync:function(h){this.requestPrefix='/sap/opu/odata/sap/ESH_SEARCH_SRV';this.sina=h.sina;this.ajaxClient=a.createAjaxClient();this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=g.createLabelCalculator();this.userEventLogger=new U(this);this.metadataParser=new M(this);this.itemParser=new I(this);this.nlqParser=new N(this);this.facetParser=new F(this);this.suggestionParser=new f(this,this.itemParser);this.sessionId=c.generateGuid();this.sorsNavigationTargetGenerator=this.sina._createSorsNavigationTargetGenerator({urlPrefix:'#Action-search&/top=10&filter=',getPropertyMetadata:function(m){return{name:m.id,label:m.label,semanticObjectType:m._private.semanticObjectType,response:!!(m.usage&&(m.usage.Detail||m.usage.Title)),request:true};}});return this.loadServerInfo().then(function(i){this.serverInfo=i.d.results[0];if(!this.supports('Search')){return Promise.reject(new c.Exception('Enterprise Search is not active'));}return this.loadBusinessObjectDataSources();}.bind(this)).then(function(){return{capabilities:this.sina._createCapabilities({fuzzy:false})};}.bind(this));},supports:function(h,k){for(var i=0;i<this.serverInfo.Services.results.length;++i){var m=this.serverInfo.Services.results[i];if(m.Id==h){if(!k){return true;}for(var j=0;j<m.Capabilities.length;++j){var n=m.Capabilities[j];if(n.Capability===k){return true;}}}}return false;},loadServerInfo:function(){var r=this.buildQueryUrl(this.requestPrefix,"/ServerInfos?$expand=Services/Capabilities");var h=this.buildQueryUrl(this.requestPrefix,"/$metadata");var i=this.ajaxClient.getJson(r);var m=this.ajaxClient.getXML(h);return Promise.all([i,m]).then(function(v){var j=v[0];var k=v[1];var p=new DOMParser();var D=p.parseFromString(k,"text/xml");if(D.documentElement.nodeName!="parsererror"){this.serviceXML=D;}return j.data;}.bind(this));},loadBusinessObjectDataSources:function(){var r="/DataSources?$expand=Annotations,Attributes/UIAreas,Attributes/Annotations&$filter=Type eq 'View'";if(this.serviceXML){var h="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>NavigationProperty[Name=Annotations],"+"Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSourceAttribute]>NavigationProperty[Name=Annotations]";var i=this.serviceXML.querySelectorAll(h);if(i.length!=2){r="/DataSources?$expand=Attributes/UIAreas&$filter=Type eq 'View'";}var j="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>Property[Name=IsInternal]";if(this.isQueryPropertySupported(j)){r=r+" and IsInternal eq false";}}var k=this.buildQueryUrl(this.requestPrefix,r);return this.ajaxClient.getJson(k).then(function(m){var n=m.data.d.results;this.metadataParser.parseDataSourceData(n,this.sorsNavigationTargetGenerator);this.sorsNavigationTargetGenerator.finishRegistration();}.bind(this));},assembleOrderBy:function(q){var r=[];for(var i=0;i<q.sortOrder.length;++i){var h=q.sortOrder[i];var j=(h.order===this.sina.SortOrder.Descending)?'desc':'asc';r.push({AttributeId:h.id,SortOrder:j});}return r;},executeSearchQuery:function(q){var i,r;var h=b.searchRequest;if(q.nlq){h=b.nlqSearchRequest;}var j="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=SearchOptions]>Property[Name=ClientServiceName]";if(!this.isQueryPropertySupported(j)){delete h.d.QueryOptions.ClientServiceName;}h=JSON.parse(JSON.stringify(h));var k=q.filter.rootCondition.clone();var m=d.serialize(q.filter.dataSource,k);if(m.SubFilters.length!==0){h.d.Filter=m;}else{delete h.d.Filter;}h.d.DataSources=[e.serialize(q.filter.dataSource)];h.d.QueryOptions.SearchTerms=q.filter.searchTerm;h.d.QueryOptions.Top=q.top;h.d.QueryOptions.Skip=q.skip;h.d.OrderBy=this.assembleOrderBy(q);this.addSessionId(h);if(!q.calculateFacets){delete h.d.MaxFacetValues;delete h.d.Facets;}else{h.d.MaxFacetValues=5;h.d.Facets=[{"Values":[]}];}var n=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");return this.ajaxClient.postJson(n,h).then(function(o){r=o;return this.metadataParser.parseDynamicMetadata(r.data.d);}.bind(this)).then(function(){return this.itemParser.parse(q,r.data.d);}.bind(this)).then(function(o){i=o;return this.facetParser.parse(q,r.data.d);}.bind(this)).then(function(o){var p=this.nlqParser.parse(r.data.d);var t=p.success?p.description:'Search Result List';return this.sina._createSearchResultSet({id:r.data.d.ResultList.ExecutionID,title:t,query:q,items:i,nlqSuccess:p.success,totalCount:r.data.d.ResultList.TotalHits,facets:o});}.bind(this)).then(function(o){this.sorsNavigationTargetGenerator.generateNavigationTargets(o);return o;}.bind(this));},executeChartQuery:function(q){var r="";var h={};var i=q.filter.rootCondition.clone();var j;if(this.decideValueHelp(q)){h=JSON.parse(JSON.stringify(b.valueHelperRequest));h.d.ValueHelpAttribute=q.dimension;j=d.serialize(q.filter.dataSource,i);if(j.SubFilters.length!==0){h.d.Filter=j;}else{delete h.d.Filter;}h.d.ValueFilter=this.getFilterValueFromConditionTree(q.dimension,j);h.d.QueryOptions.SearchTerms=q.filter.searchTerm;h.d.DataSources=[e.serialize(q.filter.dataSource)];r=this.buildQueryUrl(this.requestPrefix,"/ValueHelpQueries");}else{h=JSON.parse(JSON.stringify(b.chartRequest));j=d.serialize(q.filter.dataSource,i);if(j.SubFilters.length!==0){h.d.Filter=j;}else{delete h.d.Filter;}h.d.DataSources=[e.serialize(q.filter.dataSource)];h.d.QueryOptions.SearchTerms=q.filter.searchTerm;h.d.QueryOptions.Skip=0;this.addSessionId(h);h.d.FacetRequests=[{DataSourceAttribute:q.dimension}];h.d.MaxFacetValues=q.top;r=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");}return this.ajaxClient.postJson(r,h).then(function(k){return this.facetParser.parse(q,k.data.d);}.bind(this)).then(function(k){if(k.length>0){return k[0];}return this.sina._createChartResultSet({title:q.filter.dataSource.getAttributeMetadata(q.dimension).label,items:[],query:q});}.bind(this));},decideValueHelp:function(q){var h=q.filter.rootCondition.conditions;for(var i=0;i<h.length;i++){if(q.filter._getAttribute(h[i])===q.dimension){return true;}}return false;},executeSuggestionQuery:function(q){return c.Promise.all([this.executeRegularSuggestionQuery(q),this.executeObjectSuggestionQuery(q)]).then(function(r){var h=[];h.push.apply(h,r[1]);h.push.apply(h,r[0]);return this.sina._createSuggestionResultSet({title:'Suggestions',query:q,items:h});}.bind(this));},isObjectSuggestionQuery:function(q){return q.types.indexOf('Object')>=0&&q.filter.dataSource.type===q.sina.DataSourceType.BusinessObject;},executeObjectSuggestionQuery:function(q){if(!this.supports('ObjectSuggestions')||!this.isObjectSuggestionQuery(q)){return c.Promise.resolve([]);}var r=JSON.parse(JSON.stringify(b.objectSuggestionRequest));var h=q.filter.rootCondition.clone();var i=d.serialize(q.filter.dataSource,h);if(i.SubFilters.length!==0){r.d.Filter=i;}else{delete r.d.Filter;}r.d.DataSources=[e.serialize(q.filter.dataSource)];r.d.QueryOptions.Top=q.top;r.d.QueryOptions.Skip=q.skip;r.d.QueryOptions.SearchTerms=q.filter.searchTerm;this.addSessionId(r);var j=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(j,r).then(function(k){return this.suggestionParser.parseObjectSuggestions(q,k.data);}.bind(this));},executeRegularSuggestionQuery:function(q){var r=JSON.parse(JSON.stringify(b.suggestionRequest));var h=q.filter.searchTerm;var i=s.split(this,h);var j=q.filter.rootCondition.clone();var k=d.serialize(q.filter.dataSource,j);if(k.SubFilters.length!==0){r.d.Filter=k;}else{delete r.d.Filter;}r.d.DataSources=[e.serialize(q.filter.dataSource)];r.d.QueryOptions.Top=q.top;r.d.QueryOptions.Skip=q.skip;r.d.SuggestionInput=i.suggestionTerm;r.d.QueryOptions.SearchTerms=i.searchTerm===null?"":i.searchTerm;if(!this.includeSuggestionTypes(q,r)){return[];}this.addSessionId(r);var m=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(m,r).then(function(n){return this.suggestionParser.parseRegularSuggestions(q,n.data);}.bind(this)).then(function(n){s.concatenate(this,i,n);return n;}.bind(this));},includeSuggestionTypes:function(q,h){var k={SearchTerm:{Data:'IncludeAttributeSuggestions',History:'IncludeHistorySuggestions'},Object:{},DataSource:{Data:'IncludeDataSourceSuggestions'}};var m=q.types;var n=q.calculationModes;var o=false;for(var i=0;i<m.length;i++){var p=m[i];for(var j=0;j<n.length;j++){var r=n[j];var v=k[p][r];if(typeof v==='undefined'){continue;}h.d[v]=true;o=true;}}return o;},addSessionId:function(r){r.d.QueryOptions.ClientSessionID=this.sessionId;var t=new Date().getTime();r.d.QueryOptions.ClientCallTimestamp="\\/Date("+t+")\\/";},getFilterValueFromConditionTree:function(h,j){if(j.ConditionAttribute&&j.ConditionAttribute===h){return j.ConditionValue;}else if(j.SubFilters){var i;var r=null;for(i=0;r===null&&i<j.SubFilters.length;i++){r=this.getFilterValueFromConditionTree(h,j.SubFilters[i]);}return r;}return null;},getConfigurationAsync:function(){var r=this.buildQueryUrl(this.requestPrefix,"/PersonalizedSearchMainSwitches?$filter=Selected eq true");return this.ajaxClient.getJson(r).then(function(h){var i={personalizedSearch:false,personalizedSearchIsEditable:false};switch(h.data.d.results[0].MainSwitch){case 3:i.isPersonalizedSearchEditable=true;break;case 4:i.isPersonalizedSearchEditable=true;break;case 2:i.isPersonalizedSearchEditable=false;break;case 1:i.isPersonalizedSearchEditable=false;break;}r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.getJson(r).then(function(h){if(h.data.d.IsEnabledForPersonalizedSearch){i.personalizedSearch=true;}return this.sina._createConfiguration(i);}.bind(this));}.bind(this));},saveConfigurationAsync:function(h){var i={"IsEnabledForPersonalizedSearch":h.personalizedSearch};var r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,i);},resetPersonalizedSearchDataAsync:function(){var h={"ClearPersonalizedSearchHistory":true};var r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,h);},logUserEvent:function(h){return this.userEventLogger.logUserEvent(h);},buildQueryUrl:function(q,h){var w=window.location.href;var r="";var i="";var j="";var k="";i=w.indexOf("esh-system=sid(");if(i!==-1){var m=w.substring(i).indexOf(")");if(m!==-1){j=w.substring(i+15,i+m);if(j.length!==0){k=";o=sid("+j+")";}}}if(j.length===0){i=w.indexOf("esh-system=");if(i!==-1){var n=w.substring(i).indexOf("&");var o=w.substring(i).indexOf("#");if(n!==-1&&o!==-1){if(n<o){j=w.substring(i+11,i+n);}else{j=w.substring(i+11,i+o);}}if(n!==-1&&o===-1){j=w.substring(i+11,i+n);}if(n===-1&&o!==-1){j=w.substring(i+11,i+o);}if(n===-1&&o===-1){j=w.substring(i+11);}}if(j.length!==0){k=";o="+j;}}r=q+k+h;return r;},getDebugInfo:function(){return'Searchsystem: '+this.serverInfo.SystemId+' Client: '+this.serverInfo.Client+' SinaProvider :'+this.id;},isQueryPropertySupported:function(p){if(this.serviceXML===undefined){return false;}var h=this.serviceXML.querySelectorAll(p);if(h.length>0){return true;}return false;}});});
