// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config",'sap/ushell/renderers/fiori2/search/SearchHelper','sap/ushell/renderers/fiori2/search/SearchConfiguration','sap/m/Input','sap/ushell/renderers/fiori2/search/suggestions/SuggestionType','sap/ui/layout/HorizontalLayout','sap/ui/layout/VerticalLayout','sap/base/Log','sap/ushell/renderers/fiori2/search/controls/SearchObjectSuggestionImage',"sap/ushell/services/AppType",'sap/ui/base/Event'],function(C,S,a,I,b,H,V,L,c,A,E){"use strict";sap.m.Input.extend('sap.ushell.renderers.fiori2.search.controls.SearchInput',{constructor:function(i,o){var t=this;o=jQuery.extend({},{width:'100%',showValueStateMessage:false,showTableSuggestionValueHelp:false,enableSuggestionsHighlighting:false,showSuggestion:true,filterSuggests:false,suggestionColumns:[new sap.m.Column({})],autocomplete:false,tooltip:sap.ushell.resources.i18n.getText("search"),placeholder:{path:'/searchTermPlaceholder',mode:sap.ui.model.BindingMode.OneWay},liveChange:this.handleLiveChange.bind(this),suggestionItemSelected:this.handleSuggestionItemSelected.bind(this),enabled:{parts:[{path:"/initializingObjSearch"}],formatter:function(d){return!d;}}},o);var p=sap.ui.Device.system.phone;sap.ui.Device.system.phone=false;sap.m.Input.prototype.constructor.apply(this,[i,o]);sap.ui.Device.system.phone=p;this.bindAggregation("suggestionRows","/suggestions",function(i,d){return t.suggestionItemFactory(i,d);});this.addStyleClass('searchInput');this._bUseDialog=false;this._bFullScreen=false;this._ariaDescriptionIdNoResults=i+"-No-Results-Description";},renderer:'sap.m.InputRenderer',onsapenter:function(e){if(!(this._oSuggestionPopup&&this._oSuggestionPopup.isOpen()&&this._oSuggPopover._iPopupListSelectedIndex>=0)){this.getModel().invalidateQuery();this.triggerSearch(e);}sap.m.Input.prototype.onsapenter.apply(this,arguments);},triggerSearch:function(e){var t=this;var f=sap.ui.getCore().byId(t.getModel().getProperty("/errorPopoverControlId"));if(t.getModel().getProperty("/errors").length>0&&f&&f.getVisible()){f.setVisible(false);}S.subscribeOnlyOnce('triggerSearch','allSearchFinished',function(){t.getModel().autoStartApp();},t);var s=t.getValue();if(s.trim()===''){s='*';}t.getModel().setSearchBoxTerm(s,false);t.navigateToSearchApp();t.destroySuggestionRows();t.getModel().abortSuggestions();},handleLiveChange:function(e){this._oSuggPopover._isSuggestionItemSelectable=function(i){var d=i.getBindingContext().getObject();if(d.uiSuggestionType===b.Header||d.uiSuggestionType===b.BusyIndicator){return false;}return true;};var s=this.getValue();var m=this.getModel();m.setSearchBoxTerm(s,false);if(m.getSearchBoxTerm().length>0){m.doSuggestion();}else{this.destroySuggestionRows();m.abortSuggestions();}},handleSuggestionItemSelected:function(e){var m=this.getModel();var s=m.getSearchBoxTerm();var d;if(e.getId()==="AutoSelectAppSuggestion"){d=e.getParameter("suggestion");}else{d=e.getParameter("selectedRow").getBindingContext().getObject();}var f=d.searchTerm||"";var g=d.dataSource||m.getDataSource();var t=d.url;var h=d.uiSuggestionType;m.eventLogger.logEvent({type:m.eventLogger.SUGGESTION_SELECT,suggestionType:h,suggestionTerm:f,searchTerm:s,targetUrl:t,dataSourceKey:g?g.id:""});this.selectText(0,0);switch(h){case b.App:this.destroySuggestionRows();m.abortSuggestions();if(t[0]==="#"){if(t.indexOf("#Action-search")===0&&t===decodeURIComponent(S.getHashFromUrl())){m.setSearchBoxTerm(m.getLastSearchTerm(),false);sap.ui.getCore().getEventBus().publish("allSearchFinished");return;}if(window.hasher){window.hasher.setHash(t);}else{window.location.href=t;}}else{var l=C.last("/core/shell/enableRecentActivity")&&C.last("/core/shell/enableRecentActivityLogging");if(l){var r={title:d.title,appType:A.URL,url:d.url,appId:d.url};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(r);}window.open(t,"_blank");m.setSearchBoxTerm("",false);this.setValue("");}if(t.indexOf('#Action-search')!==0){sap.ui.require("sap/ushell/renderers/fiori2/search/SearchShellHelper").setSearchState('COL');}else{this.focus();}break;case b.DataSource:m.setDataSource(g,false);m.setSearchBoxTerm('',false);this.setValue('');this.focus();break;case b.SearchTermData:m.setDataSource(g,false);m.setSearchBoxTerm(f,false);this.getModel().invalidateQuery();this.navigateToSearchApp();this.setValue(f);break;case b.SearchTermHistory:m.setDataSource(g,false);m.setSearchBoxTerm(f,false);this.getModel().invalidateQuery();this.navigateToSearchApp();this.setValue(f);break;case b.Object:if(d.titleNavigation){d.titleNavigation.performNavigation();}break;default:break;}},suggestionItemFactory:function(i,o){var s=o.getObject();switch(s.uiSuggestionType){case b.Object:return this.objectSuggestionItemFactory(i,o);case b.Header:return this.headerSuggestionItemFactory(i,o);case b.BusyIndicator:return this.busyIndicatorItemFactory(i,o);default:return this.regularSuggestionItemFactory(i,o);}},busyIndicatorItemFactory:function(i,o){var d=new V({content:[new sap.m.BusyIndicator({size:'0.6rem'})]});d.getText=function(){return this.getValue();}.bind(this);var l=new sap.m.ColumnListItem({cells:[d],type:"Active"});l.addStyleClass('searchSuggestion');l.addStyleClass('searchBusyIndicatorSuggestion');return l;},headerSuggestionItemFactory:function(i,o){var l=new sap.m.Label({text:'{label}'});var d=new V({content:[l]});d.getText=function(){return this.getValue();}.bind(this);var e=new sap.m.ColumnListItem({cells:[d],type:"Active"});e.addStyleClass('searchSuggestion');e.addStyleClass('searchHeaderSuggestion');return e;},assembleObjectSuggestionLabels:function(s){var l=[];var d=new sap.m.Label({text:"{label1}"});d.addEventDelegate({onAfterRendering:function(){S.boldTagUnescaper(this.getDomRef());}},d);d.addStyleClass('sapUshellSearchObjectSuggestion-Label1');l.push(d);if(s.label2){var e=new sap.m.Label({text:"{label2}"});e.addEventDelegate({onAfterRendering:function(){S.boldTagUnescaper(this.getDomRef());}},e);e.addStyleClass('sapUshellSearchObjectSuggestion-Label2');l.push(e);}var v=new V({content:l});v.addStyleClass('sapUshellSearchObjectSuggestion-Labels');return v;},objectSuggestionItemFactory:function(i,o){var s=o.getObject();var d=[];if(s.imageExists){d.push(new c({src:"{imageUrl}",isCircular:"{imageIsCircular}"}));}d.push(this.assembleObjectSuggestionLabels(s));var e=new H({content:d});e.addStyleClass('sapUshellSearchObjectSuggestion-Container');e.getText=function(){return this.getValue();}.bind(this);var l=new sap.m.ColumnListItem({cells:[e],type:"Active"});l.addStyleClass('searchSuggestion');l.addStyleClass('searchObjectSuggestion');return l;},regularSuggestionItemFactory:function(i,o){var t=this;var d=new sap.ui.core.Icon({src:"{icon}"}).addStyleClass('suggestIcon').addStyleClass('sapUshellSearchSuggestAppIcon').addStyleClass('suggestListItemCell');var l=new sap.m.Text({text:"{label}",layoutData:new sap.m.FlexItemData({shrinkFactor:1,minWidth:"4rem"}),wrapping:false}).addStyleClass('suggestText').addStyleClass('suggestNavItem').addStyleClass('suggestListItemCell');l.addEventDelegate({onAfterRendering:function(){S.boldTagUnescaper(this.getDomRef());}},l);var f=new sap.m.CustomListItem({type:sap.m.ListType.Active,content:new sap.m.FlexBox({items:[d,l]})});var s=o.oModel.getProperty(o.sPath);f.getText=function(){return(typeof s.searchTerm)==='string'?s.searchTerm:t.getValue();};var g=new sap.m.ColumnListItem({cells:[f],type:"Active"});if(s.uiSuggestionType===b.App){if(s.title&&s.title.indexOf("combinedAppSuggestion")>=0){g.addStyleClass('searchCombinedAppSuggestion');}else{g.addStyleClass('searchAppSuggestion');}}if(s.uiSuggestionType===b.DataSource){g.addStyleClass('searchDataSourceSuggestion');}if(s.uiSuggestionType===b.SearchTermData){g.addStyleClass('searchBOSuggestion');}if(s.uiSuggestionType===b.SearchTermHistory){g.addStyleClass('searchHistorySuggestion');}g.addStyleClass('searchSuggestion');g.addEventDelegate({onAfterRendering:function(e){var h=g.$().find('.suggestListItemCell');var j=0;h.each(function(k){j+=$(this).outerWidth(true);});if(j>g.$().find('li').get(0).scrollWidth){g.setTooltip($(h[0]).text()+" "+$(h[2]).text());}}});return g;},navigateToSearchApp:function(){if(S.isSearchAppActive()){this.getModel()._firePerspectiveQuery();}else{var h=this.getModel().renderSearchURL();window.location.hash=h;}},getAriaDescriptionIdForNoResults:function(){return this._ariaDescriptionIdNoResults;},onAfterRendering:function(e){var d=$(this.getDomRef()).find("#searchFieldInShell-input-inner");$(this.getDomRef()).find('input').attr('autocomplete','off');$(this.getDomRef()).find('input').attr('autocorrect','off');$(this.getDomRef()).find('input').attr('type','search');$(this.getDomRef()).find('input').attr('name','search');var f=jQuery('<form action=""></form>').on("submit",function(){return false;});$(this.getDomRef()).children('input').parent().append(f);$(this.getDomRef()).children('input').detach().appendTo(f);d.attr("aria-describedby",d.attr("aria-describedby")+" "+this._ariaDescriptionIdNoResults);},onValueRevertedByEscape:function(v){if(S.isSearchAppActive()){return;}this.setValue(" ");}});});
