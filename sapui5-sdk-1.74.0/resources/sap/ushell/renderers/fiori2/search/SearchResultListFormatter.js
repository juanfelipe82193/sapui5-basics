// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/renderers/fiori2/search/SearchConfiguration','sap/ushell/renderers/fiori2/search/SearchHelper','sap/ushell/renderers/fiori2/search/SearchNavigationObject','sap/ushell/renderers/fiori2/search/SearchNavigationObjectForSinaNavTarget'],function(S,a,b,c){"use strict";var m=sap.ushell.renderers.fiori2.search.SearchResultListFormatter=function(){this.init.apply(this,arguments);};m.prototype={init:function(){},format:function(s,t,o){o=o||{};o.suppressHighlightedValues=o.suppressHighlightedValues||false;var d=s.sina;var l={};var f=[];var r=s.items;var i,z;for(i=0;i<r.length;i++){var e=r[i];var g={};var I=[];for(z=0;z<e.detailAttributes.length;z++){var h=e.detailAttributes[z];var k=h.value;switch(h.metadata.type){case d.AttributeType.ImageBlob:if(k&&k.trim().length>0){k="data:;base64,"+k;}case d.AttributeType.ImageUrl:g.imageUrl=k;g.imageFormat=h.metadata.format?h.metadata.format.toLowerCase():undefined;if(h.defaultNavigationTarget){g.imageNavigation=new c(h.defaultNavigationTarget);}break;case d.AttributeType.GeoJson:g.geoJson={value:k,label:(e.title||h.label)};break;case d.AttributeType.Group:var n=this._formatAttributeGroup(h,o,z);I.push(n);break;case d.AttributeType.Double:case d.AttributeType.Integer:case d.AttributeType.String:case d.AttributeType.Date:case d.AttributeType.Time:case d.AttributeType.Timestamp:var p=this._formatSingleAttribute(h,o,z);I.push(p);break;}}g.key=e.key;g.keystatus=e.keystatus;g.dataSource=e.dataSource;g.dataSourceName=e.dataSource.label;if(e.titleAttributes){var q,u,v;var w=[];for(z=0;z<e.titleAttributes.length;z++){q=e.titleAttributes[z];if(q.metadata.type===d.AttributeType.Group){u=this._formatAttributeGroup(q,o,z);}else{u=this._formatSingleAttribute(q,o,z);}v=u.value;w.push(v);}g.title=w.join(' ');}else{g.title=o.suppressHighlightedValues?e.title:e.titleHighlighted;}if(e.titleDescriptionAttributes){var x,y,A;var B=[];var C=[];for(z=0;z<e.titleDescriptionAttributes.length;z++){x=e.titleDescriptionAttributes[z];if(x.metadata.type===d.AttributeType.Group){y=this._formatAttributeGroup(x,o,z);}else{y=this._formatSingleAttribute(x,o,z);}A=y.value;B.push(A);C.push(y.name);}g.titleDescription=B.join(' ');g.titleDescriptionLabel=C.join(' ');}g.itemattributes=I;if(e.defaultNavigationTarget){g.titleNavigation=new c(e.defaultNavigationTarget);if(!g.title||g.title.length===0){g.title=e.defaultNavigationTarget.label;}}if(e.navigationTargets&&e.navigationTargets.length>0){g.navigationObjects=[];for(var j=0;j<e.navigationTargets.length;j++){var D=new c(e.navigationTargets[j]);D.setLoggingType('RESULT_LIST_ITEM_NAVIGATE_CONTEXT');g.navigationObjects.push(D);}}var E=l[e.dataSource.id]||{};l[e.dataSource.id]=E;g.layoutCache=E;g.selected=g.selected||false;g.expanded=g.expanded||false;var F={};this._formatResultForDocuments(e,F);this._formatResultForNotes(e,F);g.additionalParameters=F;g.positionInList=i;g.resultSetId=s.id;f.push(g);}return f;},_formatAttributeGroup:function(d,o,e){var f={};var g={};f.name=d.label;var h=false;var j=false;var p=d.metadata._private;var k,l;for(var i=0;i<d.attributes.length;i++){var n=d.attributes[i];var _=n.attribute;var q=n.metadata.nameInGroup;var r;if(_.metadata.type===_.sina.AttributeType.Group){r=this._formatAttributeGroup(_,o,e);}else{r=this._formatSingleAttribute(_,o,e);}if(p){if(p.parentAttribute===_.metadata){k=r;}else if(p.childAttribute===_.metadata){l=r;}}if(r.value!==undefined&&r.value.length>0){g[q]=r;h=h||r.whyfound;j=j||r.longtext!==undefined;}}f.value="";f.valueRaw=undefined;f.valueWithoutWhyfound="";f.whyfound=false;if(Object.keys(g).length>0){var s=true;if(p&&k&&l&&(p.isUnitOfMeasure||p.isCurrency||p.isDescription)){var t=k.value;var u=l.value;t=t!==undefined&&t.trim().length>0?t:undefined;u=u!==undefined&&u.trim().length>0?u:undefined;if(!(t&&u)){if(p.isUnitOfMeasure||p.isCurrency){if(t&&!u){f.value=k.value;f.valueRaw=k.valueRaw;f.valueWithoutWhyfound=k.valueWithoutWhyfound;s=false;}}else if(p.isDescription){var v=p.textArrangement;var w=d.sina;if(v===w.AttributeGroupTextArrangement.TextFirst){if(!t&&u){f.value=l.value;f.valueRaw=l.valueRaw;f.valueWithoutWhyfound=l.valueWithoutWhyfound;s=false;}}else if(v===w.AttributeGroupTextArrangement.TextLast){if(t&&!u){f.value=k.value;f.valueRaw=k.valueRaw;f.valueWithoutWhyfound=k.valueWithoutWhyfound;s=false;}}else if(v===w.AttributeGroupTextArrangement.TextOnly){if(!u){s=false;}}}}}if(s){f.value=this._formatBasedOnGroupTemplate(d.template,g,"value");f.valueRaw=this._formatBasedOnGroupTemplate(d.template,g,"valueRaw");f.valueWithoutWhyfound=this._formatBasedOnGroupTemplate(d.template,g,"valueWithoutWhyfound");}f.whyfound=h;}f.key=d.id;f.isTitle=false;f.isSortable=d.metadata.isSortable;f.attributeIndex=e;f.displayOrder=d.metadata.usage.Detail&&d.metadata.usage.Detail.displayOrder;if(j){f.longtext=f.value;}return f;},_formatSingleAttribute:function(d,o,i){var I={};var s=d.sina;I.name=d.label;I.valueRaw=d.value;I.value=o.suppressHighlightedValues?d.valueFormatted:d.valueHighlighted;I.valueWithoutWhyfound=d.valueFormatted;I.key=d.id;I.isTitle=false;I.isSortable=d.metadata.isSortable;I.attributeIndex=i;I.displayOrder=d.metadata.usage.Detail&&d.metadata.usage.Detail.displayOrder;I.whyfound=d.isHighlighted;if(d.defaultNavigationTarget){I.defaultNavigationTarget=new c(d.defaultNavigationTarget);}if(d.metadata.format&&(d.metadata.format===s.AttributeFormatType.MultilineText||d.metadata.format===s.AttributeFormatType.Longtext)){I.longtext=d.value;}return I;},_formatBasedOnGroupTemplate:function(t,d,v){if(!(t&&d&&v)){return"";}var e="",p=0;var f,r=/{\w+}/gi;while((f=r.exec(t))!==null){e+=t.substring(p,f.index);var g=f[0].slice(1,-1);e+=d[g]&&d[g][v]||"";p=r.lastIndex;}e+=t.substring(p);return e;},_formatResultForDocuments:function(r,d){var k='';d.isDocumentConnector=false;var j,e;for(j=0;j<r.detailAttributes.length;j++){e=r.detailAttributes[j];if(e.metadata.id==='FILE_PROPERTY'){d.isDocumentConnector=true;}if(e.metadata.isKey===true){if(k.length>0){k+=';';}k=k+e.metadata.id+'='+e.value;}}if(d.isDocumentConnector===true){var s=';o=sid('+r.dataSource.system+'.'+r.dataSource.client+')';var f=r.dataSource.id;d.imageUrl="/sap/opu/odata/SAP/ESH_SEARCH_SRV"+s+"/FileLoaderFiles(ConnectorId='"+f+"',FileType='ThumbNail',SelectionParameters='"+k+"')/$value";d.titleUrl="/sap/opu/odata/SAP/ESH_SEARCH_SRV"+s+"/FileLoaderFiles(ConnectorId='"+f+"',FileType='BinaryContent',SelectionParameters='"+k+"')/$value";var g="/sap/opu/odata/SAP/ESH_SEARCH_SRV"+s+"/FileLoaderFiles(ConnectorId='"+f+"',FileType='SUVFile',SelectionParameters='"+k+"')/$value";d.suvlink='/sap/bc/ui5_ui5/ui2/ushell/resources/sap/fileviewer/viewer/web/viewer.html?file='+encodeURIComponent(g);if(!r.navigationObjects){r.navigationObjects=[];}var n=new b({text:"Show Document",href:d.suvlink,target:"_blank"});r.navigationObjects.push(n);for(j=0;j<r.detailAttributes.length;j++){e=r.detailAttributes[j];if(e.id==="PHIO_ID_THUMBNAIL"&&e.value){d.containsThumbnail=true;}if(e.id==="PHIO_ID_SUV"&&e.value){d.containsSuvFile=true;}}}},_formatResultForNotes:function(r,d){}};return m;});
