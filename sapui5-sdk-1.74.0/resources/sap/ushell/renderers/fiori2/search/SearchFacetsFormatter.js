// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define([],function(){"use strict";jQuery.sap.declare('sap.ushell.renderers.fiori2.search.SearchFacetsFormatter');var c=sap.ushell.renderers.fiori2.search.SearchFacetsFormatter=function(){this.init.apply(this,arguments);};jQuery.sap.declare('sap.ushell.renderers.fiori2.search.Facet');var F=sap.ushell.renderers.fiori2.search.Facet=function(){this.init.apply(this,arguments);};jQuery.sap.declare('sap.ushell.renderers.fiori2.search.FacetItem');var d=sap.ushell.renderers.fiori2.search.FacetItem=function(){this.init.apply(this,arguments);};F.prototype={init:function(p){this.title=p.title;this.facetType=p.facetType;this.dimension=p.dimension;this.dataType=p.dataType;this.matchingStrategy=p.matchingStrategy;this.items=p.items||[];this.totalCount=p.totalCount;},hasFilterCondition:function(f){for(var i=0,l=this.items.length;i<l;i++){var a=this.items[i].filterCondition||this.items[i];if(a.equals&&a.equals(f)){return true;}}return false;},hasFilterConditions:function(){for(var i=0,l=this.items.length;i<l;i++){if(this.items[i].filterCondition){return true;}}return false;},removeItem:function(f){for(var i=0,l=this.items.length;i<l;i++){var a=this.items[i].filterCondition||this.items[i];if(a.equals&&f.filterCondition&&a.equals(f.filterCondition)){return this.items.splice(i,1);}}}};d.prototype={init:function(p){p=p||{};this.selected=p.selected||false;this.level=p.level||0;this.filterCondition=p.filterCondition;this.value=p.value||"";this.label=p.label||"";this.facetTitle=p.facetTitle||"";this.facetAttribute=p.facetAttribute||"";this.valueLabel=this.value;this.advanced=p.advanced||false;this.listed=p.listed||false;},equals:function(o){return(this.facetTitle===o.facetTitle&&this.label===o.label&&this.value===o.value&&this.filterCondition.equals(o.filterCondition));},clone:function(){var n=new sap.ushell.renderers.fiori2.search.FacetItem();n.facetTitle=this.facetTitle;n.selected=this.selected;n.label=this.label;n.level=this.level;n.value=this.value;n.valueLabel=this.valueLabel;n.filterCondition=this.filterCondition.clone();return n;}};c.prototype={init:function(m){this.model=m;},_getAncestorDataSources:function(s){var r=[];var a=s.dataSourceTree.findNode(s.getProperty("/uiFilter/dataSource")).getAncestors().reverse();for(var i=0;i<a.length;i++){var b=a[i].dataSource;var e=new d({label:b.labelPlural,filterCondition:b,level:0,value:a[i].count});r.push(e);}return r;},_getSiblingDataSources:function(s,l){var S=[];var a=s.getProperty("/uiFilter/dataSource");var b=s.dataSourceTree.findNode(a);var e;if(b.parent&&!b.unsureWhetherNodeisBelowRoot){e=b.parent.getChildren();}else{e=[];}if(e.length===0){e.push(b);}for(var j=0,f=e.length;j<f;j++){var g=e[j].dataSource;var h=new d({label:g.labelPlural,value:e[j].count,filterCondition:g,selected:a===g,level:l});S.push(h);if(h.selected){S.push.apply(S,this._getChildrenDataSources(s,l+1));}}return S;},_getChildrenDataSources:function(s,l){var C=[];var a=s.getProperty("/uiFilter/dataSource");var b=s.dataSourceTree.findNode(a).getChildren();for(var j=0,e=b.length;j<e;j++){var f=b[j].dataSource;var g=new d({label:f.labelPlural,value:b[j].count,filterCondition:f,selected:false,level:l});C.push(g);}return C;},getDataSourceFacetFromTree:function(s){var D=new F({facetType:"datasource",title:"Search In"});var a=s.getProperty("/uiFilter/dataSource");var A=this._getAncestorDataSources(s);D.items.push.apply(D.items,A);var S=this._getSiblingDataSources(s,s.allDataSource===a?0:1);D.items.push.apply(D.items,S);return D;},_createFacetItemsFromConditionGroup:function(r){var f=[];for(var i=0;i<r.conditions.length;i++){var a=r.conditions[i];for(var j=0;j<a.conditions.length;j++){var b=a.conditions[j];if(b.type===this.model.sinaNext.ConditionType.Simple){f.push(new d({facetAttribute:b.attribute,label:this._formatLabel(b.valueLabel,b.operator),filterCondition:b,selected:true}));}else{f.push(new d({facetAttribute:b.conditions[0].attribute,label:b.valueLabel,filterCondition:b,selected:true}));}}}return f;},_formatLabel:function(l,o){var a;switch(o){case'Bw':a=l+'*';break;case'Ew':a='*'+l;break;case'Co':a='*'+l+'*';break;default:a=l;break;}return a;},getAttributeFacetsFromPerspective:function(r,s){var D=s.getDataSource();if(D.type===s.sinaNext.DataSourceType.Category){return $.when([]);}var S=r.facets.filter(function(A){return A.type===s.sinaNext.FacetType.Chart;});var C=[];var a={};for(var i=0,l=S.length;i<l;i++){var o=S[i];var b=new F({title:o.title,facetType:'attribute',dimension:o.query.dimension,totalCount:r.totalCount});if(o.items.length===0){continue;}for(var j=0;j<o.items.length;j++){var f=o.items[j];var e=new d({facetAttribute:o.query.dimension,label:this._formatLabel(f.dimensionValueFormatted,f.filterCondition.operator),value:f.measureValue,filterCondition:f.filterCondition});e.facetTitle=o.title;e.serverSideItem=true;b.items.push(e);}a[o.query.dimension]=b;C.push(b);}this.addDataTypeToClientSideFacets(C,s);var g={};var h=this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/rootCondition"));for(var k=0,p=h.length;k<p;k++){var q=h[k];var t=a[q.facetAttribute];if(t){var u=C.indexOf(t);if(u>0){C.splice(u,1);C.splice(0,0,t);}for(var m=0,v=t.items.length;m<v;m++){var w=t.items[m];if(q.filterCondition.equals(w.filterCondition)){w.selected=true;if(!s.config.multiSelect){w.value=null;w.valueLabel=null;}}}}g[q.facetAttribute]=t;}if(!s.config.multiSelect){for(var x in g){if(g.hasOwnProperty(x)){var y=g[x];for(var n=y.items.length-1;n>=0;n--){var z=y.items[n];if(!z.selected){y.items.splice(n,1);}}}}}return $.when(C);},addDataTypeToClientSideFacets:function(C,s){var D=s.getDataSource();for(var i=0;i<C.length;i++){var f=C[i];var m=D.getAttributeMetadata(f.dimension);f.dataType=m.type;}},getFacets:function(D,i,s){var f=[this.getDataSourceFacetFromTree(s)];if(D===s.appDataSource||D.type===s.sinaNext.DataSourceType.Category){return $.when(f);}if(!i){return $.when(f);}var a=this.getAttributeFacetsFromPerspective(i,s);var r=a.then(function(A){if(A.length>0){f.push.apply(f,A);}return f;});return r;},getFacetItemsWithFilterConditions:function(s){return this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/rootCondition"));},getDialogFacetsFromMetaData:function(m,s){var S=jQuery.map(m.attributeMetadataMap,function(a){return a;});var C=[];for(var i=0,l=S.length;i<l;i++){var o=S[i];if(o.usage.Facet||o.usage.AdvancedSearch){var e=new F({title:o.label,facetType:"attribute",dimension:o.id,dataType:o.type,matchingStrategy:o.matchingStrategy});var f=this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/rootCondition"));var g=0;for(var k=0,h=f.length;k<h;k++){var j=f[k];if(j.facetAttribute===e.dimension){g++;e.items.splice(0,0,j);}}e.count=g;C.push(e);}}C.sort(function(a,b){return a.title.localeCompare(b.title);});return C;},getDialogFacetsFromChartQuery:function(r,s,i){var C=new F({dimension:s.chartQuery.dimension});if(r){for(var j=0;j<r.items.length;j++){var f=r.items[j];var a=new d({value:f.measureValue,filterCondition:f.filterCondition,label:f.dimensionValueFormatted,facetAttribute:r.query.dimension});C.items.push(a);}var b;if(i){b=this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/rootCondition"));}else{b=s.aFilters;}for(var k=0,l=b.length;k<l;k++){var S=b[k];if(S.facetAttribute===C.dimension){var e=false;for(var m=0,g=C.items.length;m<g;m++){var h=C.items[m];if(S.filterCondition.equals(h.filterCondition)){h.selected=true;e=true;}}if(!e){C.items.splice(C.items.length,0,S);if(S.filterCondition.userDefined){S.advanced=true;}else{S.listed=true;S.value="";S.valueLabel="";}}else{S.listed=true;}}}}return C;},hasDialogFacetsFromMetaData:function(s){var m=s.getDataSource();var S=jQuery.map(m.attributeMetadataMap,function(e){return e;});var h=false;for(var i=0,l=S.length;i<l;i++){var o=S[i];if(o.usage){if(o.usage.Facet||o.usage.AdvancedSearch){h=true;break;}}}return h;}};return c;});
