/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['./BaseController','sap/m/library','sap/ui/comp/library','./Util','sap/ui/comp/filterbar/VariantConverterTo','sap/ui/comp/filterbar/VariantConverterFrom','sap/base/util/merge'],function(B,M,C,U,V,a,m){"use strict";var F=B.extend("sap.ui.comp.personalization.FilterController",{constructor:function(i,s){B.apply(this,arguments);this.setType(M.P13nPanelType.filter);this.setItemType(M.P13nPanelType.filter+"Items");},metadata:{events:{afterFilterModelDataChange:{}}}});F.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);};F.prototype.getColumn2Json=function(c,s,i){if(this.getTableType()!==C.personalization.TableType.AnalyticalTable&&this.getTableType()!==C.personalization.TableType.Table&&this.getTableType()!==C.personalization.TableType.TreeTable){return null;}if(!U.isFilterable(c)){return null;}if(!c.getFiltered||(c.getFiltered&&!c.getFiltered())){return null;}return{columnKey:s,exclude:false,operation:c.getFilterOperator(),value1:c.getFilterValue(),value2:""};};F.prototype.getColumn2JsonTransient=function(c,s,t,T){if(!U.isFilterable(c)){return null;}var v;if(this.getTableType()===C.personalization.TableType.AnalyticalTable||this.getTableType()===C.personalization.TableType.Table||this.getTableType()===C.personalization.TableType.TreeTable){if(U.getColumnType(c)==="boolean"){v=U._getCustomProperty(c,"values");}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),typeInstance:U._getCustomProperty(c,"typeInstance"),values:v,nullable:U._getCustomProperty(c,"nullable")};}if(this.getTableType()===C.personalization.TableType.ResponsiveTable){if(U.getColumnType(c)==="boolean"){v=U._getCustomProperty(c,"values");}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),typeInstance:U._getCustomProperty(c,"typeInstance"),values:v,nullable:U._getCustomProperty(c,"nullable")};}if(this.getTableType()===C.personalization.TableType.ChartWrapper){return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),typeInstance:U._getCustomProperty(c,"typeInstance"),values:v,nullable:U._getCustomProperty(c,"nullable")};}};F.prototype.handleIgnore=function(j,i){j.sort.sortItems.splice(i,1);};F.prototype.syncJson2Table=function(j){var c=this.getColumnMap();var o=m({},c);this.fireBeforePotentialTableChange();if(this.getTableType()===C.personalization.TableType.AnalyticalTable||this.getTableType()===C.personalization.TableType.Table||this.getTableType()===C.personalization.TableType.TreeTable){j.filter.filterItems.forEach(function(f){var b=c[f.columnKey];if(b){if(!b.getFiltered()){b.setFiltered(true);}delete o[f.columnKey];}});for(var s in o){var b=o[s];if(b&&b.getFiltered()){b.setFiltered(false);}}}this.fireAfterPotentialTableChange();};F.prototype.getDataSuiteFormat2Json=function(d){var j=this.createControlDataStructure();if(!d.SelectOptions||!d.SelectOptions.length){return j;}j.filter.filterItems=d.SelectOptions.map(function(s){var c=a.convertOption(s.Ranges[0].Option,s.Ranges[0].Low);return{columnKey:s.PropertyName,exclude:(s.Ranges[0].Sign==="E"),operation:c.op,value1:c.v,value2:s.Ranges[0].High};});return j;};F.prototype.getDataSuiteFormatSnapshot=function(d){var c=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!c.filter||!c.filter.filterItems||!c.filter.filterItems.length){return;}c.filter.filterItems.forEach(function(f){var r=V.addRangeEntry(d,f.columnKey);V.addRanges(r,[f]);});};F.prototype.getPanel=function(p){if(!U.hasFilterableColumns(this.getColumnMap())){return null;}if(p&&p.column){var c=U.getColumnKey(p.column);if(c){var j=this.getTransientData();j.filter.filterItems.forEach(function(i){i["isDefault"]=i.columnKey===c;});}}return new Promise(function(r){sap.ui.require(['sap/m/P13nFilterPanel','sap/m/P13nItem','sap/m/P13nAnyFilterItem','sap/ui/comp/providers/ValueListProvider'],function(P,b,d,e){var o=new P({containerQuery:true,enableEmptyOperations:true,items:{path:"$sapmP13nPanel>/transientData/filter/filterItems",template:new b({columnKey:'{$sapmP13nPanel>columnKey}',text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",maxLength:"{$sapmP13nPanel>maxLength}",precision:"{$sapmP13nPanel>precision}",scale:"{$sapmP13nPanel>scale}",type:"{$sapmP13nPanel>type}",typeInstance:"{$sapmP13nPanel>typeInstance}",isDefault:"{$sapmP13nPanel>isDefault}",values:"{$sapmP13nPanel>values}",nullable:"{$sapmP13nPanel>nullable}"})},filterItems:{path:"$sapmP13nPanel>/controlDataReduce/filter/filterItems",template:new d({key:"{$sapmP13nPanel>key}",columnKey:"{$sapmP13nPanel>columnKey}",exclude:"{$sapmP13nPanel>exclude}",operation:"{$sapmP13nPanel>operation}",value1:"{$sapmP13nPanel>value1}",value2:"{$sapmP13nPanel>value2}"})},beforeNavigationTo:this.setModelFunction(),filterItemChanged:function(E){var R=E.getParameter("reason");var i=E.getParameter("index");var I=E.getParameter("itemData");var f=this.getControlDataReduce();if(I&&R==="added"){if(i>-1){f.filter.filterItems.splice(i,0,I);}else{f.filter.filterItems.push(I);}}if(R==="removed"&&i>-1){f[this.getType()][this.getItemType()].splice(i,1);}this.setControlDataReduce2Model(f);this.fireAfterPotentialModelChange({json:f});}.bind(this)});var s=function(f,g){var h=this.getColumnMap(true);var i=h[g];var k=U._getCustomProperty(i,"fullName");if(k){f.setShowSuggestion(true);f.setFilterSuggests(false);f.setModel(this.getTable().getModel());return new e({fieldName:g,control:f,model:this.getTable().getModel(),maxLength:U._getCustomProperty(i,"maxLength"),resolveInOutParams:false,loadAnnotation:true,fullyQualifiedFieldName:k,aggregation:"suggestionRows",typeAheadEnabled:true,enableShowTableSuggestionValueHelp:false});}}.bind(this);o._oIncludeFilterPanel._fSuggestCallback=s;o._oExcludeFilterPanel._fSuggestCallback=s;o._enableEnhancedExcludeOperations();return r(o);}.bind(this));}.bind(this));};F.prototype.getChangeType=function(p,P){if(!P||!P.filter||!P.filter.filterItems){return C.personalization.ChangeType.Unchanged;}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}var i=JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems);return i?C.personalization.ChangeType.ModelChanged:C.personalization.ChangeType.Unchanged;};F.prototype.getChangeData=function(p,P){if(!p||!p.filter||!p.filter.filterItems){return this.createControlDataStructure();}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(!P||!P.filter||!P.filter.filterItems){return{filter:U.copy(p.filter)};}if(JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems)){return{filter:U.copy(p.filter)};}return null;};F.prototype.getUnionData=function(j,J){if(!J||!J.filter||!J.filter.filterItems){return{filter:U.copy(j.filter)};}return{filter:U.copy(J.filter)};};F.prototype.exit=function(){B.prototype.exit.apply(this,arguments);};return F;});
