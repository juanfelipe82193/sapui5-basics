/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/m/Link','sap/ui/core/Control','sap/m/VBox','sap/m/HBox','sap/m/Button','sap/m/Title','sap/m/Image','sap/m/Text','sap/ui/layout/form/SimpleForm','./Factory','./LinkData','sap/ui/model/json/JSONModel','./Util','sap/ui/layout/HorizontalLayout','sap/ui/layout/VerticalLayout','sap/ui/layout/library','sap/ui/comp/personalization/Util','sap/ui/base/ManagedObjectObserver','sap/m/FlexItemData','sap/ui/model/BindingMode','sap/m/library','sap/ui/comp/personalization/Controller','sap/ui/comp/personalization/SelectionWrapper','sap/ui/comp/personalization/ColumnWrapper','sap/base/Log','sap/ui/comp/navpopover/flexibility/changes/AddLink','sap/ui/core/CustomData'],function(L,C,V,H,B,T,I,a,S,F,b,J,U,c,d,l,P,M,e,f,m,g,h,i,j,A,k){"use strict";var n=l.form.SimpleFormLayout;var o=m.FlexJustifyContent;var p=m.ButtonType;var N=V.extend("sap.ui.comp.navpopover.NavigationContainer",{metadata:{library:"sap.ui.comp",properties:{mainNavigationId:{type:"string",group:"Misc",defaultValue:null},enableAvailableActionsPersonalization:{type:"boolean",defaultValue:true}},aggregations:{availableActions:{type:"sap.ui.comp.navpopover.LinkData",multiple:true,singularName:"availableAction"},mainNavigation:{type:"sap.ui.comp.navpopover.LinkData",multiple:false}},associations:{extraContent:{type:"sap.ui.core.Control",multiple:false},component:{type:"sap.ui.core.Element",multiple:false}},events:{navigate:{},beforePopoverOpen:{},afterPopoverClose:{}}},renderer:{apiVersion:2}});N.prototype.init=function(){V.prototype.init.call(this);var q=new J({mainNavigationLink:{title:undefined,subtitle:undefined,href:undefined,target:undefined},availableActions:[],enableAvailableActionsPersonalization:undefined,extraContent:undefined,initialAvailableActions:[]});q.setDefaultBindingMode(f.TwoWay);q.setSizeLimit(1000);this.setModel(q,"$sapuicompNavigationContainer");this._oObserver=null;this._oAvailableActionsObserver=new M(this._observeAvailableActionsChanges.bind(this));this._oAvailableActionsObserver.observe(this,{aggregations:["availableActions"]});this.oPersonalizationController=null;};N.prototype.applySettings=function(){V.prototype.applySettings.apply(this,arguments);this._createContent();};N.prototype.exit=function(q){if(this._getInternalModel()){this._getInternalModel().destroy();}if(this._oObserver){this._oObserver.disconnect();this._oObserver=null;}if(this._oAvailableActionsObserver){this._oAvailableActionsObserver.disconnect();this._oAvailableActionsObserver=null;}};N.prototype.openSelectionDialog=function(q,s,r,t,u,v){this.fireBeforePopoverOpen();return this._getFlexRuntimeInfoAPI().then(function(w){return w.waitForChanges({element:this}).then(function(){return new Promise(function(x){var y=this._getInternalModel();var z=U.getStorableAvailableActions(y.getProperty("/initialAvailableActions"));var D=U.getStorableAvailableActions(y.getProperty("/availableActions")).map(function(G){return{columnKey:G.key,visible:G.visible};});var E=false;if(!this.oPersonalizationController){this.oPersonalizationController=new g({resetToInitialTableState:true,table:new h({columns:z.map(function(G){return new i({label:G.text,selected:G.visible,href:q?undefined:G.href,target:G.target,press:function(O){this._onLinkPress(O);}.bind(this),description:G.description,customData:new k({key:"p13nData",value:{columnKey:G.key}})});}.bind(this))}),setting:{selection:{visible:true,payload:{callbackSaveChanges:function(G){var K=(G&&G.selection&&G.selection.selectionItems)||[];if(r){r(K.map(function(R){return{key:R.columnKey,visible:R.visible};}));return Promise.resolve(true);}var O=[];var Q=[];K.forEach(function(R){if(R.visible===true){O.push({key:R.columnKey,visible:R.visible});}else{Q.push({key:R.columnKey,visible:R.visible});}});if(E){return N._discardChanges(this).then(function(){return N._saveChanges(O,Q,this).then(function(){return true;});}.bind(this));}return N._saveChanges(O,Q,this).then(function(){return true;});}.bind(this)}}},dialogConfirmedReset:function(){E=true;},dialogAfterClose:function(){this.fireAfterPopoverClose();x();}.bind(this)});}this.oPersonalizationController.setPersonalizationData({selection:{selectionItems:D}});this.oPersonalizationController.openDialog({contentWidth:"25rem",contentHeight:"35rem",styleClass:""+u,showReset:s,selection:{visible:true}});if(v){v.addDependent(this.oPersonalizationController._oDialog);}}.bind(this));}.bind(this));}.bind(this));};N._discardChanges=function(s){return new Promise(function(r){sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){sap.ui.require(['sap/ui/comp/navpopover/FlexConnector'],function(q){return q.discardChangesForControl(s).then(function(){return r(true);},function(E){j.error("Changes could not be discarded in LRep: "+E);return r(false);});});});});};N._saveChanges=function(q,r,s){return new Promise(function(t){sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){sap.ui.require(['sap/ui/comp/navpopover/FlexConnector'],function(u){return u.createAndSaveChangesForControl(q,r,s).then(function(){return t(true);},function(E){j.error("Changes could not be saved in LRep: "+E);return t(false);});});});});};N.prototype.getDirectLink=function(){var q=this._getInternalModel();if(q.getProperty('/extraContent')){return null;}if(q.getProperty('/mainNavigationLink/href')&&!q.getProperty('/availableActions').length){return this._oHeaderArea.getItems()[0];}if(q.getProperty('/availableActions').length===1&&!q.getProperty('/mainNavigationLink/href')){return this._oActionArea.getItems()[0].getItems()[0];}return null;};N.prototype.hasContent=function(){var q=this._getInternalModel();return!!q.getProperty("/mainNavigationLink/href")||!!q.getProperty("/availableActions").length||!!q.getProperty('/extraContent');};N.prototype.setExtraContent=function(q){this.setAssociation("extraContent",q);if(!q){return this;}var r=this._getInternalModel();if(r.getProperty("/extraContent")){this.removeItem(1);}if(typeof q==="string"){q=sap.ui.getCore().byId(q);}this.insertItem(q,1);r.setProperty("/extraContent",q);return this;};N.prototype.setMainNavigationId=function(s){this.setProperty("mainNavigationId",s,true);var q=this._getInternalModel();if(typeof s==="string"){q.setProperty("/mainNavigationLink/title",s);}return this;};N.prototype.setMainNavigation=function(q){this.setAggregation("mainNavigation",q,true);if(!q){return this;}var r=this._getInternalModel();if(q.getHref()){r.setProperty("/mainNavigationLink/href",this._convertToExternal(q.getHref()));r.setProperty("/mainNavigationLink/target",q.getTarget());}if(!r.getProperty("/mainNavigationLink/title")&&r.getProperty("/mainNavigationLink/title")!==''){r.setProperty("/mainNavigationLink/title",q.getText());}r.setProperty("/mainNavigationLink/subtitle",q.getDescription());return this;};N.prototype.setEnableAvailableActionsPersonalization=function(E){this.setProperty("enableAvailableActionsPersonalization",E,true);this._getInternalModel().setProperty("/enableAvailableActionsPersonalization",E);return this;};N.prototype.onAfterRenderingActionForm=function(){var q=this._getInternalModel();var $=q.getProperty("/extraContent")?q.getProperty("/extraContent").$()[0]:undefined;if($&&$.scrollHeight>$.clientHeight){this.setFitContainer(false).setJustifyContent(o.Start);}};N.prototype._getFlexRuntimeInfoAPI=function(){return sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){return new Promise(function(r){sap.ui.require(["sap/ui/fl/apply/api/FlexRuntimeInfoAPI"],function(q){r(q);});});});};N.prototype._createContent=function(){this.addStyleClass("navigationPopover");this._oObserver=new M(function(r){if((r.type==="property"||r.type==="binding")&&r.name==="visible"){var u=this._getInternalModel().getProperty("/availableActions");var v=u.filter(function(w){return w.visible===true;});q.setVisible(v.length>0||!!this._getInternalModel().getProperty("/enableAvailableActionsPersonalization"));this._oActionArea.setVisible(v.length>0);if(this.hasContent()&&!this._getInternalModel().getProperty("/extraContent")){D.setVisible(false);}}}.bind(this));var t=new L({href:{path:'/mainNavigationLink/href'},text:{path:'/mainNavigationLink/title'},target:{path:'/mainNavigationLink/target'},visible:{path:'/mainNavigationLink/title',formatter:function(r){return!!r;}},enabled:{path:'/mainNavigationLink/href',formatter:function(v){return!!v;}},press:this._onLinkPress.bind(this)});t.addStyleClass("navigationPopoverTitle");this._oObserver.observe(t,{bindings:["visible"],properties:["visible"]});var s=new a({text:{path:'/mainNavigationLink/subtitle'},visible:{path:'/mainNavigationLink/subtitle',formatter:function(v){return!!v;}}});this._oHeaderArea=new V({items:[t,s],visible:{path:'/mainNavigationLink/title',formatter:function(r){return!!r;}}});this._oHeaderArea.addStyleClass("navigationPopoverTitleH1");this._oHeaderArea.addStyleClass("navigationPopoverHeader");var D=new S({layout:n.ResponsiveGridLayout,content:[new T({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_MSG_NO_CONTENT")})]});D.addStyleClass("navigationPopoverDefaultExtraContent");var q=new V({visible:false});q.addStyleClass("navigationPopoverSeparator");this._oActionArea=new V({items:{path:'/availableActions',templateShareable:false,factory:function(r,u){var v=new L({visible:"{visible}",text:"{text}",href:"{href}",target:"{target}",press:u.getProperty("press")});this._oObserver.observe(v,{bindings:["visible"],properties:["visible"]});return new V({visible:"{visible}",layoutData:new e({styleClass:u.getProperty("description")?"navigationPopoverAvailableLinkGroup":"navigationPopoverAvailableLinkWithoutGroup"}),items:[v,new a({visible:"{visible}",text:"{description}"})]});}.bind(this)}});this._oActionArea.addEventDelegate({onAfterRendering:this.onAfterRenderingActionForm.bind(this)});this._oActionArea.addStyleClass("navigationPopoverAvailableLinks");this._oPersonalizationButton=new H({visible:{parts:[{path:'/enableAvailableActionsPersonalization'}],formatter:function(E){return!!E;}},justifyContent:"End",items:new B({type:p.Transparent,text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_DEFINE_LINKS"),press:function(E){this.openSelectionDialog(false,true,undefined,true,undefined,E.getSource());}.bind(this)})});this._oPersonalizationButton.addStyleClass("navigationPopoverPersonalizationButton");this.setFitContainer(true);this.setJustifyContent(o.Start);this.addItem(this._oHeaderArea).addItem(this._getInternalModel().getProperty("/extraContent")||D).addItem(q).addItem(this._oActionArea).addItem(this._oPersonalizationButton);this._oHeaderArea.setModel(this._getInternalModel());q.setModel(this._getInternalModel());this._oActionArea.setModel(this._getInternalModel());this._oPersonalizationButton.setModel(this._getInternalModel());};N.prototype._onLinkPress=function(E){this.fireNavigate({text:E.getSource().getText(),href:E.getSource().getHref()});};N.prototype._convertToExternal=function(s){var x=F.getService("CrossApplicationNavigation");if(!x){return s;}return x.hrefForExternal({target:{shellHash:s}},this._getComponent());};N.prototype._getComponent=function(){var q=this.getComponent();if(typeof q==="string"){q=sap.ui.getCore().getComponent(q);}return q;};N.prototype._observeAvailableActionsChanges=function(q){var r;if(q.object.isA("sap.ui.comp.navpopover.NavigationContainer")){switch(q.name){case"availableActions":r=this._getInternalModel();var s=q.child?[q.child]:q.children;s.forEach(function(t){switch(q.mutation){case"insert":if(!t){return;}t.setHref(this._convertToExternal(t.getHref()));t.setPress(this._onLinkPress.bind(this));this._oAvailableActionsObserver.observe(t,{properties:["visible"]});r.setProperty("/initialAvailableActions/"+this.indexOfAvailableAction(t)+"/",t.getJson());r.setProperty("/availableActions/"+this.indexOfAvailableAction(t)+"/",t.getJson());break;case"remove":j.error("Deletion of AvailableActions is not supported");break;default:j.error("Mutation '"+q.mutation+"' is not supported jet.");}}.bind(this));break;default:j.error("The '"+q.name+"' of NavigationContainer is not supported yet.");}}else if(q.object.isA("sap.ui.comp.navpopover.LinkData")){switch(q.name){case"visible":var t=q.object;r=this._getInternalModel();var u=-1;r.getProperty("/availableActions").some(function(v,w){if(t.getKey()===v.key){u=w;return true;}});if(u<0){j.error("The available action with key '"+t.getKey()+"' does not exist in availableActions.");}if(t.getVisibleChangedByUser()){r.setProperty("/availableActions/"+u+"/visible",t.getVisible());}else{r.setProperty("/initialAvailableActions/"+u+"/visible",t.getVisible());r.setProperty("/availableActions/"+u+"/visible",t.getVisible());}break;default:j.error("The '"+q.name+"' of LinkData is not supported yet.");}}};N.prototype._getInternalModel=function(){return this.getModel("$sapuicompNavigationContainer");};return N;});
