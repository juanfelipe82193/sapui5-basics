/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/comp/util/DateTimeUtil','sap/ui/comp/util/FilterUtil','sap/m/DateTimePicker','sap/m/Select','sap/ui/core/Item','sap/m/ComboBox','sap/m/DatePicker','sap/m/DateRangeSelection','sap/m/TimePicker','sap/m/Input','sap/m/MultiComboBox','sap/ui/comp/smartfilterbar/SFBMultiInput','sap/m/SearchField','sap/m/Token','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/odata/FiscalMetadata','sap/ui/comp/providers/ValueHelpProvider','sap/ui/comp/providers/ValueListProvider','sap/ui/model/Filter','sap/ui/model/json/JSONModel','sap/ui/comp/odata/ODataType','sap/ui/comp/util/FormatUtil','sap/ui/base/EventProvider','sap/ui/comp/util/IdentifierUtil','sap/ui/comp/providers/TokenParser','sap/ui/core/format/DateFormat','sap/ui/comp/library','sap/ui/core/library','sap/ui/model/analytics/odata4analytics','sap/ui/model/FilterOperator',"sap/base/Log","sap/base/util/UriParameters","sap/base/security/encodeURL","sap/base/util/merge"],function(D,F,a,S,I,C,b,c,T,d,M,f,g,h,l,m,V,o,p,J,O,q,E,r,s,t,u,v,w,x,L,U,y,z){"use strict";var A=u.smartfilterbar.ControlType;var B=u.smartfilterbar.DisplayBehaviour;var G=u.smartfilterbar.FilterType;var H=v.ValueState;var K=u.valuehelpdialog.ValueHelpRangeOperation;var N=u.smartfilterbar.MandatoryType;var P=function(e){if(!o){o=sap.ui.require("sap/ui/comp/providers/ValueListProvider");}if(!V){V=sap.ui.require("sap/ui/comp/providers/ValueHelpProvider");}this._bInitialized=false;this._bPending=true;this._bConsiderAnalyticalParameters=false;this._bAttachInitializedDone=false;this._sDeferredGroupId;if(e){this._oParentODataModel=e.model;this._sServiceURL=e.serviceUrl;this._sBasicSearchFieldName=e.basicSearchFieldName;this._isBasicSearchEnabled=e.enableBasicSearch;this._bUseContainsAsDefault=e.useContainsAsDefaultFilter==="true";this.sEntityType=e.entityType;this.sEntitySet=e.entitySet;this._isRunningInValueHelpDialog=e.isRunningInValueHelpDialog;this._oAdditionalConfiguration=e.additionalConfiguration;this.sDefaultDropDownDisplayBehaviour=e.defaultDropDownDisplayBehaviour;this.sDefaultTokenDisplayBehaviour=e.defaultTokenDisplayBehaviour;if(typeof e.dateFormatSettings==="string"){try{this._oDateFormatSettings=e.dateFormatSettings?JSON.parse(e.dateFormatSettings):undefined;}catch(i){}}else{this._oDateFormatSettings=e.dateFormatSettings;}if(!this._oDateFormatSettings){this._oDateFormatSettings={};}if(!this._oDateFormatSettings.hasOwnProperty("UTC")){this._oDateFormatSettings["UTC"]=true;}this._oSmartFilter=e.smartFilter;this._bConsiderAnalyticalParameters=e.considerAnalyticalParameters;this._bUseDateRangeType=e.useDateRangeType;this._bConsiderSelectionVariants=e.considerSelectionVariants;this._aConsiderNavigations=e.considerNavigations;}this.sFilterModelName=P.FILTER_MODEL_NAME;this._sBasicFilterAreaID=P.BASIC_FILTER_AREA_ID;this._aAnalyticalParameters=[];this._aFilterBarViewMetadata=[];this._aFilterBarFieldNames=[];this._aFilterBarMultiValueFieldMetadata=[];this._aFilterBarStringDateFieldNames=[];this._aFilterBarDateFieldNames=[];this._aFilterBarTimeFieldNames=[];this._aFilterBarTimeIntervalFieldNames=[];this._aFilterBarDateTimeMultiValueFieldNames=[];this._aFilterBarStringFieldNames=[];this._aFilterBarDateTimeFieldNames=[];this._aFieldGroupAnnotation=[];this._oMetadataAnalyser=new l(this._oParentODataModel||this._sServiceURL);this.oModel=new J();this._aValueListProvider=[];this._aValueHelpDialogProvider=[];this._mTokenHandler={};this._mConditionTypeFields={};this._aSelectionVariants=[];this._oParameterization=null;this._oNonAnaParameterization=null;this._aPromises=[];};P.FILTER_MODEL_NAME="fi1t3rM0d31";P.BASIC_FILTER_AREA_ID="_BASIC";P.BASIC_SEARCH_FIELD_ID="_BASIC_SEARCH_FIELD";P.CUSTOM_FIELDS_MODEL_PROPERTY="_CUSTOM";P.FIELD_NAME_REGEX=/\./g;P._createFilterProvider=function(e){var i=new P(e);return i._intialiseMetadata();};P.prototype._intialiseMetadata=function(){var e,k,n,Q,R,i,j,W,X,Y,Z,$;this._aPromises=[];this._aFilterBarViewMetadata.push({groupName:this._sBasicFilterAreaID,index:0,fields:[]});if(!this.sEntitySet&&this.sEntityType){this.sEntitySet=this._oMetadataAnalyser.getEntitySetNameFromEntityTypeName(this.sEntityType);}this.sEntityType=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.sEntitySet);R=this._oMetadataAnalyser.getAllFilterableFieldsByEntitySetName(this.sEntitySet,this._bConsiderAnalyticalParameters,this._aConsiderNavigations);if(R){this._updateDisplayBehaviour();this._aFieldGroupAnnotation=this._oMetadataAnalyser.getFieldGroupsByFilterFacetsAnnotation(this.sEntityType);n=this._oMetadataAnalyser.getSelectionFieldsAnnotation(this.sEntityType);if(n&&n.selectionFields){this._aSelectionFields=n.selectionFields;}if(this._aFieldGroupAnnotation){e=this._aFieldGroupAnnotation.length;for(i=0;i<e;i++){Q=this._aFieldGroupAnnotation[i];Y=this._createGroupMetadata(Q);Y.index=this._aFilterBarViewMetadata.length;this._aFilterBarViewMetadata.push(Y);}}e=R.length;for(i=0;i<e;i++){Q=R[i];k=Q.fields.length;Y=this._createGroupMetadata(Q);this._aFilterBarViewMetadata.push(Y);for(j=0;j<k;j++){W=Q.fields[j];if(W.type.indexOf("Edm.")===0){X=this._createFieldMetadata(W);Y.fields.push(X);this._aFilterBarFieldNames.push(X.fieldName);}}}}$=this._getAdditionalConfigurationForCustomGroups(R);e=$.length;for(j=0;j<e;j++){Y=this._createGroupMetadataForCustomGroup($[j]);if(Y){this._aFilterBarViewMetadata.push(Y);}}Z=this._getAdditionalConfigurationForCustomFilterFields();k=Z.length;for(j=0;j<k;j++){X=this._createFieldMetadataForCustomFilterFields(Z[j]);if(X){this._aFilterBarViewMetadata[0].fields.push(X);}}if(this._hasBasicSearch()){X=this._createBasicSearchFieldMetadata();this._aFilterBarViewMetadata[0].fields.push(X);}if(!this._isRunningInValueHelpDialog){this._createParameters();}return new Promise(function(_){Promise.all(this._aPromises).then(function(){if(this._bConsiderSelectionVariants){this._createSelectionVariants();}this._applyGroupId();this._applyIndexes();this._createInitialModel(true);this._initializeConditionTypeFields();this.setPending(this.isPending());this._bInitialized=true;_(this);}.bind(this));}.bind(this));};P.prototype._createSelectionVariants=function(){this._aSelectionVariants=this._oMetadataAnalyser.getSelectionVariantAnnotationList(this.sEntityType);};P.prototype._createParameters=function(){if(this._oMetadataAnalyser.isSemanticAggregation(this.sEntityType)){if(this._bConsiderAnalyticalParameters){var e=sap.ui.require("sap/ui/model/analytics/odata4analytics");if(e){this._createAnalyticalParameters(e);}else{var i=new Promise(function(R){sap.ui.require(["sap/ui/model/analytics/odata4analytics"],function(e){this._createAnalyticalParameters(e);R();}.bind(this));}.bind(this));this._aPromises.push(i);}}}else{this._createNonAnalyticalParameters();}};P.prototype._createAnalyticalParameters=function(e){this._oParameterization=this._getAnalyticParameterization(e);this._createAnalyticParameters(this._oParameterization);};P.prototype._getAnalyticParameterization=function(i){var j,Q;try{j=new i.Model(new i.Model.ReferenceByModel(this._oParentODataModel));}catch(e){throw"Failed to instantiate analytical extensions for given OData model: "+e.message;}Q=j&&j.findQueryResultByName(this.sEntitySet);return(Q&&Q.getParameterization());};P.prototype._createNonAnalyticalParameters=function(){if(this.sEntitySet){this._oNonAnaParameterization=this._oMetadataAnalyser.getParametersByEntitySetName(this.sEntitySet);if(this._oNonAnaParameterization){this._createParametersByEntitySetName(this._oNonAnaParameterization.entitySetName,this._oNonAnaParameterization.parameters);}}};P.prototype.attachPendingChange=function(e){if(!this._oEventProvider){this._oEventProvider=new E();}this._oEventProvider.attachEvent("PendingChange",e);};P.prototype.detachPendingChange=function(e){if(this._oEventProvider){this._oEventProvider.detachEvent("PendingChange",e);}};P.prototype.setPending=function(e){var i=this._bPending!==e;this._bPending=e;if(i&&this._oEventProvider){var j={};j.pending=e;this._oEventProvider.fireEvent("PendingChange",j);}};P.prototype.isPending=function(){if(!this._bInitialized){return true;}for(var n in this._mConditionTypeFields){if(this._mConditionTypeFields[n].conditionType.isPending()){return true;}}return false;};P.prototype._updateDisplayBehaviour=function(){this._sTextArrangementDisplayBehaviour=this._oMetadataAnalyser.getTextArrangementValue(this.sEntityType);if(!this.sDefaultDropDownDisplayBehaviour){if(this._sTextArrangementDisplayBehaviour){this.sDefaultDropDownDisplayBehaviour=this._sTextArrangementDisplayBehaviour;}else{this.sDefaultDropDownDisplayBehaviour=B.descriptionOnly;}}if(!this.sDefaultTokenDisplayBehaviour){if(this._sTextArrangementDisplayBehaviour){this.sDefaultTokenDisplayBehaviour=this._sTextArrangementDisplayBehaviour;}else{this.sDefaultTokenDisplayBehaviour=B.descriptionAndId;}}};P.prototype._hasBasicSearch=function(){return this._isBasicSearchEnabled;};P.prototype._getAdditionalConfigurationForCustomFilterFields=function(){var e,j,i,R;if(!this._oAdditionalConfiguration){return[];}e=this._oAdditionalConfiguration.getControlConfiguration();if(!this._aFilterBarFieldNames||!this._aFilterBarFieldNames.length){return e;}R=[];j=e.length;for(i=0;i<j;i++){if(this._aFilterBarFieldNames.indexOf(e[i].key)<0){R.push(e[i]);}}return R;};P.prototype._getAdditionalConfigurationForCustomGroups=function(e){var k,n,Q,i,R,j,W,X;if(!this._oAdditionalConfiguration){return[];}k=this._oAdditionalConfiguration.getGroupConfiguration();if(!e||!e.length){return k;}R=[];Q=e.length;n=k.length;for(i=0;i<n;i++){W=false;for(j=0;j<Q;j++){X=e[j].groupName||e[j].groupEntitySetName;if(X===k[i].key){W=true;break;}}if(!W){R.push(k[i]);}}return R;};P.prototype._createInitialModelForField=function(j,e,i){var k=false,n,Q,R=false,W=false,X=null,Y=null,Z,$=null,_=[],a1=[];if(!e||e.isCustomFilterField){return;}if(e.filterRestriction!==G.multiple){W=true;}if((e.filterType==="date")||(e.filterType==="time")||(e.filterType==="datetime")){k=true;}if(i){n=e.defaultFilterValues;R=n&&n.length;if(!R){if(e.defaultPropertyValue&&e.isParameter){Q=e.defaultPropertyValue;if(e.filterType==="numeric"){Q=this._getType(e).parseValue(Q,"string");}n=[{low:Q}];R=true;}else if(e.defaultFilterValue){Q=e.defaultFilterValue;n=[{low:Q,high:Q,operator:"EQ",sign:"I"}];R=true;}}}if(e.filterRestriction===G.single){if(R){Q=n[0];X=k?this._createDateTimeValue(e,Q.low):Q.low;}j[e.fieldName]=X;}else if(e.filterRestriction===G.interval&&e.type!=="Edm.Time"){if(R){Q=n[0];X=k?this._createDateTimeValue(e,Q.low):Q.low;Y=k?this._createDateTimeValue(e,Q.high):Q.high;}j[e.fieldName]={low:X,high:Y};}else{if(R){Z=n.length;while(Z--){Q=n[Z];if(W){$={"exclude":Q.sign==="E","operation":Q.operator==="CP"?"Contains":Q.operator,"keyField":e.fieldName,"value1":k?this._createDateTimeValue(e,Q.low):Q.low,"value2":k?null:Q.high};if((e.filterType==="time")&&Q.high){$.value2=new Date(Q.high);}}else{$={key:k?this._createDateTimeValue(e,Q.low):Q.low,text:k?"":Q.low};}_.push($);}}this._aFilterBarMultiValueFieldMetadata.push(e);j[e.fieldName]={value:null};if(W){a1=_.slice(0);_=[];j[e.fieldName].ranges=a1;}j[e.fieldName].items=_;this._updateMultiValueControl(e.control,_,a1);}};P.prototype._createDateTimeValue=function(e,i){switch(e.type){case"Edm.Time":if(i.indexOf("PT")===0){return this._getTime(i);}else{L.error("Default value for "+e.fieldName+" could not be parsed.");}break;case"Edm.DateTime":if(typeof i=="string"&&e.displayFormat&&e.displayFormat.toLowerCase()=="date"){var j=i.split('T');i=j[0]+"T00:00:00";return new Date(i);}else{L.error("Default value for "+e.fieldName+" could not be parsed.");}break;case"Edm.DateTimeOffset":return new Date(i);default:L.error("Default value for "+e.fieldName+" could not be parsed.");}};P.prototype._createInitialModel=function(e){var k,n,Q,R,j,i;k={};this._bCreatingInitialModel=true;this._aFilterBarMultiValueFieldMetadata=[];if(this._aFilterBarViewMetadata){n=this._aFilterBarViewMetadata.length;for(i=0;i<n;i++){R=this._aFilterBarViewMetadata[i];Q=R.fields.length;for(j=0;j<Q;j++){this._createInitialModelForField(k,R.fields[j],e);}}}if(this._aAnalyticalParameters){Q=this._aAnalyticalParameters.length;for(j=0;j<Q;j++){this._createInitialModelForField(k,this._aAnalyticalParameters[j],e);}}this.oModel.setData(k);if(!e){this._clearConditionTypeFields();}this._updateConditionTypeFields();this._bCreatingInitialModel=false;};P.prototype._updateMultiValueControl=function(e,j,R,k){var i=0,n=null,Q=null,W=null,X=null,Y=null,Z,$,_;if(e&&j){i=j.length;if(e instanceof f){n=[];while(i--){X=j[i].text||j[i].key;var Q=new h();Q.setKey(j[i].key);Q.setText(X);Q.setTooltip(X);n.push(Q);}if(R){i=R.length;while(i--){W=R[i];if((W.value1===""||W.value1===null)&&(W.operation===x.EQ)){W.operation=K.Empty;W.tokenText=q.getFormattedRangeText(W.operation,null,null,W.exclude);W.value1=null;}if(W.tokenText){X=W.tokenText;}else{Z=W.value1;$=W.value2;if(k){var a1=["date","datetime","time"];if(a1.indexOf(k.filterType)>-1){_=this._getType(k);if(_){if(Z){if(k.filterType==="time"){Z=D.dateToEdmTime(D.localToUtc(Z));}Z=_.formatValue(Z,"string");}if($){if(k.filterType==="time"){$=D.dateToEdmTime(D.localToUtc($));}$=_.formatValue($,"string");}}}else if((k.filterType==="numeric")||(k.filterType==="boolean")){_=this._getType(k);if(_){if(Z!==""&&(Z!==undefined)){Z=_.formatValue(Z,"string");}if($!==""&&($!==undefined)){$=_.formatValue($,"string");}}}else{var b1=k.isCalendarDate||k.isFiscalDate||((Z instanceof Date)||($ instanceof Date));if(b1){_=this._getType(k);if(Z){Z=_.formatValue(Z,"string");}if($){$=_.formatValue($,"string");}}}}X=q.getFormattedRangeText(W.operation,Z,$,W.exclude);}Q=new h();Q.setText(X);Q.setTooltip(X);Q.data("range",W);n.push(Q);}}e.setTokens(n);e.fireTokenUpdate();}if(e instanceof M){Y=[];while(i--){Y.push(j[i].key);}e.setSelectedKeys(Y);}}};P.prototype._applyIndexes=function(){var e,i;if(!this._aFilterBarViewMetadata){return;}this._aFilterBarViewMetadata=this._sortByIndex(this._aFilterBarViewMetadata);e=this._aFilterBarViewMetadata.length;for(i=0;i<e;i++){if(this._aFilterBarViewMetadata[i].fields){this._aFilterBarViewMetadata[i].fields=this._sortByIndex(this._aFilterBarViewMetadata[i].fields);}}};P.prototype._sortByIndex=function(e){var j,i,k,R,n,Q;if(!e||!e.length){return e;}R=[];j=[];k=e.length;for(i=0;i<k;i++){Q=e[i];n=Q.index;if(n>=0){j.push(Q);}else{R.push(Q);}}k=j.length;if(k){j=j.sort(function(W,X){return W.index-X.index;});if(!R.length){R=j;}else{for(i=0;i<k;i++){Q=j[i];if(Q.index>=R.length){R.push(Q);}else{R.splice(Q.index,0,Q);}}}}return R;};P.prototype._applyGroupId=function(){var e,i,n,j,Q,R,k;e=this._aFilterBarViewMetadata.length;for(i=0;i<e;i++){if(!this._aFilterBarViewMetadata[i].fields){continue;}n=this._aFilterBarViewMetadata[i].fields.length;for(j=0;j<n;j++){Q=this._aFilterBarViewMetadata[i].fields[j];if(Q&&Q.groupId&&Q.groupId!==this._aFilterBarViewMetadata[i].groupName){R=undefined;for(k=0;k<e;k++){if(this._aFilterBarViewMetadata[k].groupName===Q.groupId){R=this._aFilterBarViewMetadata[k];break;}}if(R){this._aFilterBarViewMetadata[i].fields.splice(j,1);j--;n--;R.fields=R.fields||[];R.fields.push(Q);}}}}};P.prototype._createFilterControlId=function(e){var i=this._oSmartFilter?this._oSmartFilter.getId():"unit-test";var j=r.replace(e.groupId||"");var n=r.replace(e.fieldName);return i+"-filterItemControl"+j+"-"+n;};P.prototype._createGroupMetadata=function(e){var i,j=null,k;k=e.groupName||e.groupEntitySetName;if(this._oAdditionalConfiguration){j=this._oAdditionalConfiguration.getGroupConfigurationByKey(k);}i={};i.groupName=k;i.groupLabel=this._getGroupLabel(e,j);i.fields=[];i.index=this._getGroupIndex(j);return i;};P.prototype._createGroupMetadataForCustomGroup=function(e){var i;i={};i.groupName=e.key;i.groupLabel=e.label;i.fields=[];i.index=this._getGroupIndex(e);return i;};P.prototype._getTime=function(e){var i=t.getTimeInstance({pattern:"'PT'hh'H'mm'M'ss'S'"});return i.parse(e);};P.prototype._checkMetadataDefaultValue=function(e){var i=e.defaultFilterValue||e.defaultPropertyValue;if(i){try{if((e.type==="Edm.Time")&&(i.indexOf("PT")===0)){this._getTime(i);}else{this._getType(e);}}catch(j){e.defaultPropertyValue=null;e.defaultFilterValue=null;L.error("default value for "+e.fieldName+" could not be parsed.");}}};P.prototype._getType=function(e){var i,j={},k={},n={};if(e.ui5Type){return e.ui5Type;}if(e.precision||e.scale){k.precision=e.precision;k.scale=e.scale;}if(e.maxLength){k.maxLength=e.maxLength;}if(e.displayFormat){k.displayFormat=e.displayFormat;}if(e.isDigitSequence){k.isDigitSequence=e.isDigitSequence;}if(e.isCalendarDate){n.isCalendarDate=true;}if(e.isFiscalDate&&e.fiscalType){n.isFiscalDate=true;n.fiscalType=e.fiscalType;}if((e.filterType==="date")||(e.filterType==="time")||(e.filterType==="datetime")||e.isCalendarDate){j=Object.assign({},this._oDateFormatSettings,{UTC:false});}i=O.getType(e.type,j,k,n);return i;};P.prototype._setControlDisplayFormat=function(e,i){var j;if(!i){return;}j=i.style||i.pattern;if(!j){return;}e.setDisplayFormat(j);};P.prototype._createControl=function(e){var i,j,k=false,n,Q;if(e.customControl){return e.customControl;}j=this._getType(e);i=new e.fControlConstructor(this._createFilterControlId(e));if(e.fControlConstructor===c){this._setControlDisplayFormat(i,this._oDateFormatSettings);if(e.isCalendarDate){i.bindProperty("dateValue",{path:this.sFilterModelName+">/"+e.fieldName+"/low",type:j});i.bindProperty("secondDateValue",{path:this.sFilterModelName+">/"+e.fieldName+"/high",type:j});}else{i.bindProperty("dateValue",this.sFilterModelName+">/"+e.fieldName+"/low");i.bindProperty("secondDateValue",this.sFilterModelName+">/"+e.fieldName+"/high");}}else if((e.fControlConstructor===C)||(e.fControlConstructor===S)){if(i.setForceSelection){i.setForceSelection(true);}if(e.fControlConstructor===S){i.addItem(new I({key:"",text:""}));i.addItem(new I({key:false,text:j.formatValue(false,"string")}));i.addItem(new I({key:true,text:j.formatValue(true,"string")}));}else{this._associateValueList(i,"items",e);i.attachSelectionChange(function(){if(this._bUpdatingFilterData||this._bCreatingInitialModel){return;}i.fireChange({filterChangeReason:e.fieldName,value:""});}.bind(this));}i.bindProperty('selectedKey',this.sFilterModelName+">/"+e.fieldName);}else if(e.fControlConstructor===M){this._associateValueList(i,"items",e);i.attachSelectionChange(function(W){if(this._bUpdatingFilterData||this._bCreatingInitialModel){return;}var X=W.getSource(),Y=null,Z=[],$;Y=X.getSelectedItems();if(Y){$=Y.length;while($--){Z.push({key:Y[$].getKey(),text:Y[$].getText()});}}if(this.oModel){this.oModel.setProperty("/"+e.fieldName+"/items",Z);}X.fireChange({filterChangeReason:e.fieldName,value:""});}.bind(this));i.bindProperty("value",this.sFilterModelName+">/"+e.fieldName+"/value");}else if(e.fControlConstructor===f){if(e.controlType===A.date||e.type==="Edm.Time"||e.type==="Edm.DateTimeOffset"){i.setValueHelpOnly(true);if(e.filterRestriction===G.interval){this._associateValueHelpDialog(i,e,false,false);}else{this._associateValueHelpDialog(i,e,true,true);}}else{if(e.hasValueHelpDialog){this._associateValueHelpDialog(i,e,e.filterRestriction!==G.multiple,true);}else{i.setShowValueHelp(false);}i.bindProperty("value",{path:this.sFilterModelName+">/"+e.fieldName+"/value",type:j});}this._handleMultiInput(i,e,j);}else if(e.fControlConstructor===d){if(e.filterRestriction===G.interval){k=true;i.bindProperty("value",this.sFilterModelName+">/"+e.fieldName+"/low");if(!this.oResourceBundle){this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}if(!this.sIntervalPlaceholder){this.sIntervalPlaceholder=this.oResourceBundle.getText("INTERVAL_PLACEHOLDER_TEXT");}i.setPlaceholder(this.sIntervalPlaceholder);}else{i.bindProperty('value',{path:this.sFilterModelName+">/"+e.fieldName,type:j});}if(e.hasValueHelpDialog){i.setShowValueHelp(true);this._associateValueHelpDialog(i,e,false,false);}}else if(e.isCalendarDate){this._setControlDisplayFormat(i,this._oDateFormatSettings);i.bindProperty("dateValue",{path:this.sFilterModelName+">/"+e.fieldName,type:j});}else if(e.fControlConstructor===b){i.bindProperty("dateValue",this.sFilterModelName+">/"+e.fieldName);this._setControlDisplayFormat(i,this._oDateFormatSettings);}else if(e.fControlConstructor===T||e.fControlConstructor===a){i.bindProperty("dateValue",this.sFilterModelName+">/"+e.fieldName);if(this._oDateFormatSettings&&this._oDateFormatSettings.style){i.setDisplayFormat(this._oDateFormatSettings.style);}}if(i instanceof b){i.attachChange(function(W){var X=W.getParameter("valid");i.data("__mandatoryEmpty",null);if(X){i.setValueState(H.None);i.setValueStateText();}else{var Y=i._parseValue(W.getParameter("newValue")),Z=this._getSelectedDateRange(Y);i.setValueState(H.Error);if(Z[0]&&Z[1]){var $=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp"),_=this._getDateFieldOutOfRangeErrorText(i,Z,j,$);i.setValueStateText(_);}else if(j){try{j.parseValue("foo","string");}catch(a1){i.setValueStateText(a1.message);}}}}.bind(this));}if(e.hasTypeAhead){i.setShowSuggestion(true);i.setFilterSuggests(false);this._associateValueList(i,"suggestionRows",e,true);}if((e.displayFormat==="UpperCase")&&(e.controlType!==A.dropDownList)&&i.attachChange&&i.getValue&&i.setValue){i.attachChange(function(W){var X=i.getValue();if(X){i.setValue(X.toUpperCase());}});if(this._mTokenHandler[i.getId()]&&this._mTokenHandler[i.getId()].parser){var R=this._mTokenHandler[i.getId()].parser;R.getKeyFields()[0].displayFormat=e.displayFormat;}}if(i instanceof d){if(e.maxLength){n=parseInt(e.maxLength);if(!isNaN(n)){if(this._mTokenHandler[i.getId()]&&this._mTokenHandler[i.getId()].parser){var R=this._mTokenHandler[i.getId()].parser;R.getKeyFields()[0].maxLength=n;}else{if(!e.hasValueListAnnotation&&!k){i.setMaxLength(n);}}}}if(e.isFiscalDate){i.setPlaceholder(j.formatter.getPattern());}}Q=function(W){var X=W.getParameter("exception");var Y=W.getParameter("element");if(i&&Y&&(i.getId()===Y.getId())){if(X){if(i.setValueStateText){i.setValueStateText(X.message);}}if(i.setValueState){i.setValueState(H.Error);}i.data("__mandatoryEmpty",null);}};i.attachParseError(Q);i.attachFormatError(Q);i.attachValidationError(Q);i.attachValidationSuccess(function(W){var X=W.getParameter("element");if(i&&X&&(i.getId()===X.getId())){if(i.setValueState){i.setValueState(H.None);}if(i.setValueStateText){i.setValueStateText();}i.data("__mandatoryEmpty",null);delete i.__sValidationText;}});return i;};P.prototype._getControlConstructor=function(e,i){var j=d,k,n,Q;Q=i?i+e.fieldName:e.fieldName;if(e.isCustomFilterField){j=undefined;}else{k=(e.filterRestriction===G.single);n=(e.filterRestriction===G.interval);if(e.controlType===A.date){e.displayFormat="Date";if(k){j=b;}else{j=n?c:f;}if(e.isCalendarDate){this._aFilterBarStringDateFieldNames.push(Q);}else{this._aFilterBarDateFieldNames.push(Q);}if(e.filterRestriction===G.multiple){this._aFilterBarDateTimeMultiValueFieldNames.push(Q);}}else if(e.controlType===A.dropDownList){if(k){j=this._isBooleanWithFixedValuedButWithoutValueListAnnotation(e)?S:C;}else{j=M;}if(!k){e.filterRestriction=G.multiple;}}else if(e.type==="Edm.Time"){if(k){j=T;}else{j=f;}this._aFilterBarTimeFieldNames.push(Q);if(n){this._aFilterBarTimeIntervalFieldNames.push(Q);}else if(e.filterRestriction===G.multiple){this._aFilterBarDateTimeMultiValueFieldNames.push(Q);}}else if(!n&&e.controlType===A.dateTimePicker){if(k){j=a;}else{j=f;}this._aFilterBarDateTimeFieldNames.push(Q);if(e.filterRestriction===G.multiple){this._aFilterBarDateTimeMultiValueFieldNames.push(Q);}}else if(n&&e.type==="Edm.DateTimeOffset"){this._aFilterBarDateTimeFieldNames.push(Q);}else if(!k&&!n){j=f;}}return j;};P.prototype._handleTokenUpdate=function(e,i){var R,j=i.control,k=i.fieldViewMetadata,n,Q=[],W,X,Y,Z=[],$="/"+k.fieldName;if(this._bUpdatingFilterData||this._bCreatingInitialModel){return;}R=e&&e.getParameter("removedTokens");n=j.getTokens();if(R){n=n.filter(function(X){return R.indexOf(X)===-1;});}if(n){W=n.length;while(W--){X=n[W];Y=X.data("range");if(Y){Y.tokenText=X.getText();if(Y&&(X.getKey().indexOf("range_")===0)){if(k.type==="Edm.Time"){if(Y.value1&&Y.value1.ms){Y.value1=D.utcToLocal(D.edmTimeToDate(Y.value1));}if(Y.value2&&Y.value2.ms){Y.value2=D.utcToLocal(D.edmTimeToDate(Y.value2));}}}Z.push(Y);}else{Q.push({key:X.getKey(),text:X.getText()});}}}if(this.oModel){this.oModel.setProperty($+"/items",Q);this.oModel.setProperty($+"/ranges",Z);}if(j.__bValidatingToken){delete j.__bValidatingToken;}j.fireChange({filterChangeReason:k.fieldName,value:""});};P.prototype._handleMultiInput=function(e,i,j){e.attachTokenUpdate({control:e,fieldViewMetadata:i},this._handleTokenUpdate,this);var k,n=((i.type==="Edm.DateTime"&&i.displayFormat==="Date"));if(i.hasValueListAnnotation||(i.type==="Edm.String")||n){e.attachEvent("_validateOnPaste",function(Q){var R=Q.getParameter("texts"),W,X,Y,Z,$;X=R?R.length:0;if(X>1){Q.preventDefault();W=this.oModel.getProperty("/"+i.fieldName);$=W.ranges||[];e.setValue("");while(X--){Y=R[X];if(Y){Z=null;if(n){k=this._getDateValue(Y,j);if(isNaN(k.getDate())){continue;}else{Z=Y;Y=k;}}$.push({"exclude":false,"operation":"EQ","keyField":i.fieldName,"value1":Y,"value2":null,"tokenText":Z});}}this.oModel.setProperty("/"+i.fieldName+"/ranges",$);this._updateMultiValueControl(e,W.items,$,i);}}.bind(this));}};P.prototype._associateValueHelpDialog=function(e,i,j,k){var n={fieldName:i.fieldName,control:e,model:this._oParentODataModel,filterModel:this.oModel,filterProvider:this,dateFormatSettings:this._oDateFormatSettings,fieldViewMetadata:i,displayFormat:i.displayFormat,displayBehaviour:i.displayBehaviour,loadAnnotation:i.hasValueListAnnotation,fullyQualifiedFieldName:i.fullName,metadataAnalyser:this._oMetadataAnalyser,preventInitialDataFetchInValueHelpDialog:i.preventInitialDataFetchInValueHelpDialog,supportMultiSelect:k,supportRanges:j,isSingleIntervalRange:i.filterRestriction===G.interval,isUnrestrictedFilter:i.filterRestriction!==G.multiple,type:i.filterType,maxLength:i.maxLength,scale:i.scale,precision:i.precision};if(i.isCalendarDate){n.oType=this._getType(i);}var Q=new V(n);Q.attachValueListChanged(function(W){if(this._oSmartFilter){this._oSmartFilter.fireFilterChange(W);this._oSmartFilter.validateMandatoryFields();}}.bind(this));if(i.visibleInAdvancedArea||(i.groupId===P.BASIC_FILTER_AREA_ID)){Q.loadAnnotation();}this._aValueHelpDialogProvider.push(Q);if(j&&e.addValidator){var R=new s();R.addKeyField({key:i.fieldName,label:i.label,type:i.filterType,oType:i.ui5Type});if(i.filterType==="numeric"){R.setDefaultOperation("EQ");}R.associateInput(e);this._mTokenHandler[e.getId()]={parser:R};}};P.prototype._determineFieldLabel=function(e){var i,j=e.label;if(this._oSmartFilter&&this._oSmartFilter.determineFilterItemByName){i=this._oSmartFilter.determineFilterItemByName(e.name);if(i){j=i.getLabel();}}return j;};P.prototype._associateValueList=function(e,i,j,k){var n;if(this._oSmartFilter&&!this._bAttachInitializedDone&&new U(window.location.href).get("sap-ui-comp-filterbar-data-defer")){var Q=this._oParentODataModel;this._sDeferredGroupId="sapUiCompFilterBarData";var R=Q.getDeferredGroups?this._oParentODataModel.getDeferredGroups():null;if(R!==null){R.push(this._sDeferredGroupId);Q.setDeferredGroups(R);var W=function(){Q.submitChanges({groupId:this._sDeferredGroupId});var R=Q.getDeferredGroups().filter(function(X){return X!==this._sDeferredGroupId;}.bind(this));Q.setDeferredGroups(R);delete this._sDeferredGroupId;this._oSmartFilter.detachInitialized(W);}.bind(this);this._oSmartFilter.attachInitialized(W);this._bAttachInitializedDone=true;}}if(j.hasValueListAnnotation){n=new o({fieldName:j.fieldName,control:e,model:this._oParentODataModel,filterModel:this.oModel,filterProvider:this,displayFormat:j.displayFormat,dateFormatSettings:this._oDateFormatSettings,fieldViewMetadata:j,displayBehaviour:j.displayBehaviour,loadAnnotation:true,fullyQualifiedFieldName:j.fullName,metadataAnalyser:this._oMetadataAnalyser,type:j.filterType,aggregation:i,typeAheadEnabled:k,deferredGroupId:this._sDeferredGroupId,context:"SmartFilterBar"});n.attachValueListChanged(function(X){if(this._oSmartFilter){this._oSmartFilter.fireFilterChange(X);this._oSmartFilter.validateMandatoryFields();}}.bind(this));if(j.visibleInAdvancedArea||(j.groupId===P.BASIC_FILTER_AREA_ID)){n.loadAnnotation();}this._aValueListProvider.push(n);}else if(this._mTokenHandler[e.getId()]&&this._mTokenHandler[e.getId()].parser){this._mTokenHandler[e.getId()].parser.setDefaultOperation("EQ");}};P.prototype._createAnalyticParameters=function(e){var i,j;if(e){j=e.getAllParameterNames();i=e.getEntitySet();if(i){this._createParametersByEntitySetName(i.getQName(),j);}}};P.prototype._createParametersByEntitySetName=function(e,j){var k,n=this._oMetadataAnalyser.getFieldsByEntitySetName(e);for(var i=0;i<n.length;i++){if(j.indexOf(n[i].name)>=0){k=this._createAnalyticParameterMetadata(n[i]);if(k&&k.visible){if(this._oNonAnaParameterization&&k.isCustomFilterField){continue;}this._aAnalyticalParameters.push(k);}}}};P.prototype._createAnalyticParameterMetadata=function(e){var i,j=u.ANALYTICAL_PARAMETER_PREFIX;e.filterRestriction="single-value";i=this._createFieldMetadata(e,j);if(i){i.fieldName=j+e.name;i.isMandatory=true;i.isParameter=true;i.visibleInAdvancedArea=true;}else{L.error("_createAnalyticParameterMetadata issue with property: "+e.name);}return i;};P.prototype.getAnalyticParameters=function(){return this._aAnalyticalParameters;};P.prototype.getSelectionVariants=function(){return this._aSelectionVariants;};P.prototype.getAnalyticBindingPath=function(){var e,i=[],j=this.getAnalyticParameters();j.forEach(function(k){i.push(k.fieldName);});e=this.getFilledFilterData(i);if(this._oParameterization){return this._createAnalyticBindingPath(j,e);}else{return this._createNonAnalyticBindingPath(j,e);}};P.prototype._createAnalyticBindingPath=function(e,i){var j,k="",n;n=this._getParameterizationRequest(this._oParameterization);if(n){e.forEach(function(Q){j=i[Q.fieldName];if(!j){j="";}else if(Q.type==="Edm.Time"&&j instanceof Date){if(this._oDateFormatSettings&&!this._oDateFormatSettings.UTC){j=D.utcToLocal(j);}j=D.localToUtc(j);j={__edmType:"Edm.Time",ms:j.valueOf()};}else if((Q.type!=="Edm.DateTimeOffset")&&this._oDateFormatSettings&&this._oDateFormatSettings.UTC&&j instanceof Date){j=D.localToUtc(j);}n.setParameterValue(Q.name,j);}.bind(this));k=n.getURIToParameterizationEntry()+'/'+this._oParameterization.getNavigationPropertyToQueryResult();}return k;};P.prototype._createNonAnalyticBindingPath=function(e,i){var j,k="",n="";if(this._oNonAnaParameterization){k="/"+this._oNonAnaParameterization.entitySetName+'(';e.forEach(function(Q){j=i[Q.fieldName];if(!j){j="";}else if(Q.type==="Edm.Time"&&j instanceof Date){j=D.localToUtc(j);j={__edmType:"Edm.Time",ms:j.valueOf()};}else if((Q.type!=="Edm.DateTimeOffset")&&this._oDateFormatSettings&&this._oDateFormatSettings.UTC&&j instanceof Date){j=D.localToUtc(j);}k+=(n+Q.name+"="+y(this._oParentODataModel.formatValue(j,Q.type)));n=",";}.bind(this));k+=(")/"+this._oNonAnaParameterization.navPropertyName);}return k;};P.prototype._getParameterizationRequest=function(){return this._oParameterization?new w.ParameterizationRequest(this._oParameterization):null;};P.prototype._constructContextUrl=function(e,i){var j=e._getServerUrl();if(j&&(j.lastIndexOf('/')===(j.length-1))){j=j.substr(0,j.length-1);}return j+e.sServiceUrl+"/$metadata#"+i;};P.prototype.getFilterContextUrl=function(){var e,i=null;if(this._oParentODataModel&&this._oParentODataModel.isA("sap.ui.model.odata.v2.ODataModel")&&this._oParentODataModel.getMetaModel()){e=this._oParentODataModel.getMetaModel().getODataEntitySet(this.sEntitySet);if(e){i=this._constructContextUrl(this._oParentODataModel,e.name);}}return i;};P.prototype.getParameterContextUrl=function(){var e,i=null;if(this._oParentODataModel&&this._oParentODataModel.isA("sap.ui.model.odata.v2.ODataModel")&&this._oParentODataModel.getMetaModel()){if(this._oParameterization&&this._oParameterization.getEntitySet()){e=this._oParameterization.getEntitySet().getQName();}else if(this._oNonAnaParameterization){e=this._oNonAnaParameterization.entitySetName;}if(e){i=this._constructContextUrl(this._oParentODataModel,e);}}return i;};P.prototype._createFieldMetadata=function(e,i){var j,k,n;e.fieldName=this._getFieldName(e);e.fieldNameOData=e.fieldName.replace(P.FIELD_NAME_REGEX,"/");k=this._oAdditionalConfiguration?this._oAdditionalConfiguration.getControlConfigurationByKey(e.fieldName):null;j=Object.assign({},e);j.filterRestriction=this._getFilterRestriction(e,k);this._updateValueListMetadata(j,e);j.hasValueHelpDialog=this._hasValueHelpDialog(j,k);j.preventInitialDataFetchInValueHelpDialog=k?k.preventInitialDataFetchInValueHelpDialog:true;j.controlType=this._getControlType(j,k);if(k&&k.displayBehaviour&&k.displayBehaviour!=="auto"){j.displayBehaviour=k.displayBehaviour;}j.isCustomFilterField=!!(k&&k.customControl);j.visibleInAdvancedArea=!!(k&&k.visibleInAdvancedArea);j.label=this._getLabel(e,k);j.isMandatory=this._isMandatory(e,k);j.width=this._getWidth(k);j.isVisible=this._isVisible(k);j.groupId=this._getGroupID(e,k);j.index=this._getIndex(e,k);j.fControlConstructor=this._getControlConstructor(j,i);j.isFiscalDate=m.isFiscalValue(j);j.fiscalType=m.getFiscalAnotationType(j);if(j.isFiscalDate){m.updateViewMetadata(j);}j.filterType=this._getFilterType(j);j.hasTypeAhead=this._hasTypeAhead(j,e,k);j.customControl=k?k.customControl:undefined;j.ui5Type=this._getType(j);if(j.ui5Type&&j.ui5Type.isA("sap.ui.model.odata.type.DateTime")){j.ui5Type.formatValue(new Date(),"string");j.ui5Type.oFormat.oFormatOptions.UTC=false;}j.fCreateControl=function(Y){var Z,$;Y.control=this._createControl(Y);Z=this.oModel.getData();$=Z[Y.fieldName];if($){this._updateMultiValueControl(Y.control,$.items,$.ranges,Y);}}.bind(this);this._applyWidth(j);j.defaultFilterValues=k?k.defaultFilterValues:undefined;if(j.type==="Edm.String"){this._aFilterBarStringFieldNames.push(j.fieldName);}j.conditionType=null;var Q=k?k.conditionType:null;if(!Q&&this._bUseDateRangeType&&(j.fControlConstructor===c)){Q="sap.ui.comp.config.condition.DateRangeType";}if(Q){var R="";if(typeof Q==="object"){R=Q.module;delete Q.module;}else{R=Q;Q=null;}try{R=R.replace(/\./g,"/");var W=sap.ui.require(R);if(W){this._enhanceConditionTypeInfo(W,R,Q,j);}else{n=new Promise(function(Y){sap.ui.require([R],function(W){this._enhanceConditionTypeInfo(W,R,Q,j);Y();}.bind(this));}.bind(this));this._aPromises.push(n);}}catch(X){L.error("Module "+R+" could not be loaded");}}else{this._checkMetadataDefaultValue(j);}return j;};P.prototype._requireConditionType=function(e,i,j){var e=e.replace(/\./g,"/");var k=sap.ui.require(e);if(k){this._enhanceConditionTypeInfo(k,e,i,j);}else{sap.ui.require([e],function(k){this._enhanceConditionTypeInfo(k,e,i,j);}.bind(this));}};P.prototype._enhanceConditionTypeInfo=function(e,i,j,k){var n=e;k.conditionType=new n(k.fieldName,this,k);this._mConditionTypeFields[k.fieldName]=k;if(j&&!this._bUseDateRangeType){k.conditionType.applySettings(j);}this._checkMetadataDefaultValue(k);};P.prototype._getFilterType=function(e){return q._getFilterType(e);};P.prototype._updateValueListMetadata=function(e,i){e.hasValueListAnnotation=i["sap:value-list"]!==undefined;if(e.hasValueListAnnotation){e.hasFixedValues=i["sap:value-list"]==="fixed-values";}else if(i["com.sap.vocabularies.Common.v1.ValueList"]){e.hasValueListAnnotation=true;e.hasFixedValues=this._oMetadataAnalyser.getValueListSemantics(i["com.sap.vocabularies.Common.v1.ValueList"])==="fixed-values";if(!e.hasFixedValues){e.hasFixedValues=l.isValueListWithFixedValues(i);}}};P.prototype._createBasicSearchFieldMetadata=function(){var e;var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");e={};e.filterRestriction=G.single;e.name=P.BASIC_SEARCH_FIELD_ID;e.fieldName=P.BASIC_SEARCH_FIELD_ID;e.label=undefined;e.isMandatory=false;e.isVisible=true;e.groupId=P.BASIC_FILTER_AREA_ID;e.index=-1;e.control=new g(this._oSmartFilter.getId()+"-btnBasicSearch",{showSearchButton:true});if(!this._isRunningInValueHelpDialog){e.control.setPlaceholder(R.getText("FILTER_BAR_BSEARCH_PLACE_HOLDER"));}e.control.bindProperty('value',this.sFilterModelName+">/"+e.fieldName);return e;};P.prototype._applyWidth=function(e){if(e&&e.width&&e.control&&e.control.setWidth&&(typeof e.control.setWidth==='function')){e.control.setWidth(e.width);}};P.prototype._createFieldMetadataForCustomFilterFields=function(e){var i;if(!e||!e.customControl){return undefined;}i={};i.name=e.key;i.fieldName=e.key;i.label=e.label;i.visibleInAdvancedArea=!!(e&&e.visibleInAdvancedArea);i.isVisible=this._isVisible(e);i.groupId=e.groupId;i.isMandatory=this._isMandatory(undefined,e);i.index=e.index;i.width=this._getWidth(e);i.control=e.customControl;i.isCustomFilterField=true;this._applyWidth(i);return i;};P.prototype._getFieldName=function(e){if(!e.parentPropertyName){return e.name;}else{return e.parentPropertyName+"."+e.name;}};P.prototype._hasValueHelpDialog=function(e,i){var j=true;if(i){if(i.controlType===A.dropDownList){j=false;}else if(i.hasValueHelpDialog!==true){j=false;}}if(e&&!e.hasValueListAnnotation){if(e.filterRestriction===G.single||e.filterRestriction===G.multiple){j=false;}}return j;};P.prototype._isVisible=function(e){if(e&&e.isVisible===false){return false;}return true;};P.prototype._getWidth=function(e){if(e&&e.width){return e.width;}return undefined;};P.prototype._isMandatory=function(e,i){if(i&&i.mandatory!==N.auto){return i.mandatory===N.mandatory;}if(e){return e.requiredFilterField;}return false;};P.prototype._getFilterRestriction=function(e,i){var j;if(i&&i.filterType&&i.filterType!==G.auto){j=i.filterType;}else if(e.filterRestriction==="single-value"){j=G.single;}else if(e.filterRestriction==="multi-value"){j=G.multiple;}else if(e.filterRestriction==="interval"){j=G.interval;}else{j=G.auto;}return j;};P.prototype._getControlType=function(e,i){var j;if(i&&i.controlType&&i.controlType!==A.auto){j=i.controlType;}else if(e.type==="Edm.DateTime"&&e.displayFormat==="Date"||e.isCalendarDate){j=A.date;}else if(e.type==="Edm.DateTimeOffset"){j=A.dateTimePicker;}else if(e.hasValueListAnnotation&&e.hasFixedValues){j=A.dropDownList;}else if(this._isBooleanWithFixedValuedButWithoutValueListAnnotation(e)){j=A.dropDownList;}else{j=A.input;}return j;};P.prototype._isBooleanWithFixedValuedButWithoutValueListAnnotation=function(e){if(e.type==="Edm.Boolean"&&!e.hasFixedValues&&!e.hasValueListAnnotation&&(e.filterRestriction==="single")){return true;}return false;};P.prototype._getGroupID=function(e,i){if(i&&i.groupId){return i.groupId;}else if(e&&(e.requiredFilterField||(this._aSelectionFields&&this._aSelectionFields.indexOf(e.fieldNameOData)>-1))){return this._sBasicFilterAreaID;}return this._getGroupIDFromFieldGroup(e);};P.prototype._getGroupIDFromFieldGroup=function(e){var i=0,j=null,k;if(e&&this._aFieldGroupAnnotation&&this._aFieldGroupAnnotation.length){i=this._aFieldGroupAnnotation.length;while(i--){j=this._aFieldGroupAnnotation[i];if(j&&j.fields&&j.fields.indexOf(e.fieldNameOData)>-1){k=j.groupName;break;}}}return k;};P.prototype._getLabel=function(e,i){if(i&&i.label){return i.label;}return this._getLabelFromFieldGroup(e)||e.fieldLabel||e.fieldName;};P.prototype._getLabelFromFieldGroup=function(e){var i=0,j=null,k;if(e&&this._aFieldGroupAnnotation&&this._aFieldGroupAnnotation.length){i=this._aFieldGroupAnnotation.length;while(i--){j=this._aFieldGroupAnnotation[i];if(j&&j.fields&&j.fields.indexOf(e.fieldNameOData)>-1){k=j.labels[e.fieldNameOData];break;}}}return k;};P.prototype._getIndex=function(e,i){if(i&&(i.index>=0)){return i.index;}else if(this._aSelectionFields&&this._aSelectionFields.indexOf(e.fieldNameOData)>-1){return this._aSelectionFields.indexOf(e.fieldNameOData);}return this._getIndexFromFieldGroup(e);};P.prototype._getIndexFromFieldGroup=function(e){var i=0,j=null,k;if(e&&this._aFieldGroupAnnotation&&this._aFieldGroupAnnotation.length){i=this._aFieldGroupAnnotation.length;while(i--){j=this._aFieldGroupAnnotation[i];if(j&&j.fields){k=j.fields.indexOf(e.fieldNameOData);if(k>-1){break;}k=undefined;}}}return k;};P.prototype._getGroupIndex=function(e){if(e&&(e.index||e.index===0)){return e.index;}};P.prototype._getGroupLabel=function(e,i){if(i&&i.label){return i.label;}return e.groupLabel||e.groupName||e.groupEntitySetName;};P.prototype._hasTypeAhead=function(e,i,j){var k;k=true;if(j){k=j.hasTypeAhead;}else if(i.type!=="Edm.String"){return false;}if(!(e.fControlConstructor===d||e.fControlConstructor===f)){return false;}return k;};P.prototype.getModel=function(){return this.oModel;};P.prototype.getFilterBarViewMetadata=function(){return this._aFilterBarViewMetadata;};P.prototype.getAssociatedValueHelpProviders=function(){return this._aValueHelpDialogProvider;};P.prototype.getAssociatedValueListProviders=function(){return this._aValueListProvider;};P.prototype.getParameters=function(){var e,i=null;if(this.oModel){i=this.oModel.getProperty("/"+P.BASIC_SEARCH_FIELD_ID);}if(this._sBasicSearchFieldName||i){e={custom:{}};if(this._sBasicSearchFieldName){e.custom["search-focus"]=this._sBasicSearchFieldName;}e.custom["search"]=i||"";}return e;};P.prototype.getFilters=function(e){var i=null;if(this.oModel){i=this.oModel.getData();}return P.generateFilters(e,i,{dateSettings:this._oDateFormatSettings,useContainsAsDefault:this._bUseContainsAsDefault,stringFields:this._aFilterBarStringFieldNames,timeFields:this._aFilterBarTimeFieldNames,dateTimeOffsetValueFields:this._aFilterBarDateTimeFieldNames,viewMetadataData:this._aFilterBarViewMetadata});};P.prototype.getFilterData=function(){return this.oModel?this.oModel.getData():null;};P.prototype.getFilterDataAsString=function(){return this.oModel?this.oModel.getJSON():null;};P.prototype.getFilledFilterData=function(e){var i,j={},k,n,Q;i=this.oModel?this.oModel.getData():null;if(i&&e){k=e.length;while(k--){n=e[k];if(n&&n!==P.BASIC_SEARCH_FIELD_ID){Q=i[n];if(Q&&Q.hasOwnProperty("low")){if(Q.low){j[n]=Q;}}else if(Q&&Q.hasOwnProperty("items")){if(Q.value&&typeof Q.value==="string"){Q.value=Q.value.trim();}if(Q.items.length||(Q.ranges&&Q.ranges.length)||Q.value||(typeof Q.value==="boolean")){j[n]=Q;}}else if(Q){if(typeof Q==="string"){Q=Q.trim();}if(Q){j[n]=Q;}}}if(k===0){n=P.CUSTOM_FIELDS_MODEL_PROPERTY;Q=i[n];if(Q){j[n]=Q;}}}}return z({},j);};P.prototype.getFilledFilterDataAsString=function(e){return JSON.stringify(this.getFilledFilterData(e));};P.prototype.setFilterData=function(j,R){var e=null,i=null,k=null;if(this.oModel&&j){this._bUpdatingFilterData=true;try{if(R){this._createInitialModel(false);}e=this._parseFilterData(j,R);if(e){this.oModel.setData(e,true);i=[];var n=arguments[2];if(n){i.push(n);}for(k in e){i.push(k);}this._handleFilterDataUpdate(i);}}finally{this._bUpdatingFilterData=false;}}};P.prototype.setFilterDataAsString=function(j,R){if(j){this.setFilterData(JSON.parse(j),R);}};P.prototype._parseFilterData=function(j,R){return P.parseFilterData(this.oModel.getData(),j,{stringDateFields:this._aFilterBarStringDateFieldNames,dateFields:this._aFilterBarDateFieldNames,timeFields:this._aFilterBarTimeFieldNames,timeIntervalFields:this._aFilterBarTimeIntervalFieldNames,dateTimeMultiValueFields:this._aFilterBarDateTimeMultiValueFieldNames,conditionTypeFields:this._mConditionTypeFields,dateTimeOffsetValueFields:this._aFilterBarDateTimeFieldNames,viewMetadataData:this._aFilterBarViewMetadata,filterProvider:this},R);};P.prototype._handleFilterDataUpdate=function(e){var i=0,j,k,n;if(this._aFilterBarMultiValueFieldMetadata){i=this._aFilterBarMultiValueFieldMetadata.length;while(i--){if(!k){k=this.oModel.getData();}if(k){j=this._aFilterBarMultiValueFieldMetadata[i];if(e.indexOf(j.fieldName)>-1){n=k[j.fieldName];if(n){this._updateMultiValueControl(j.control,n.items,n.ranges,j);}}}}this._updateConditionTypeFields();}};P.prototype.clear=function(){this._createInitialModel(false);};P.prototype.reset=function(){this._createInitialModel(true);};P.prototype._initializeConditionTypeFields=function(){var e=function(i){this.setPending(this.isPending());}.bind(this);for(var n in this._mConditionTypeFields){this._mConditionTypeFields[n].conditionType.initialize(this.oModel.getData()[n]);if(this._mConditionTypeFields[n].conditionType.getAsync()){this._mConditionTypeFields[n].conditionType.attachPendingChange(e);}}};P.prototype._updateConditionTypeFields=function(){var e=this._oldData;var i=this.oModel.getData();this._oldData=z({},i);if(e!==undefined){var j=[],n;for(n in i){var k=JSON.stringify(i[n]);var Q=JSON.stringify(e[n]);if(k!==Q){j.push(n);}}if(j.length>0){for(n in this._mConditionTypeFields){this._mConditionTypeFields[n].conditionType.providerDataUpdated(j,i);}}}};P.prototype._clearConditionTypeFields=function(){var e=this.oModel.getData();for(var n in this._mConditionTypeFields){this._mConditionTypeFields[n].conditionType.initialize(e[n]);}};P.prototype._validateConditionTypeFields=function(){var i=false;for(var n in this._mConditionTypeFields){var e=this._mConditionTypeFields[n].conditionType.validate();if(!e&&!i){i=true;}}return i;};P.prototype._getFieldMetadata=function(e){return P._getFieldMetadata(this.getFilterBarViewMetadata(),e);};P._getFieldMetadata=function(e,i){var j=null;e.some(function(k){if(k&&k.fields){k.fields.some(function(n){if(n&&n.fieldName===i){j=n;}return j!==null;});}return j!==null;});return j;};P.prototype._getSelectedDateRange=function(e){if(!Array.isArray(e)){e=[e,e];}return e;};P.prototype._getDateFieldOutOfRangeErrorText=function(e,i,j,R){var k=e.getMinDate()||e._oMinDate,n=e.getMaxDate()||e._oMaxDate;if(i[0].getTime()<k.getTime()){return R.getText("FILTER_BAR_DATE_FIELD_MIN_DATE_ERROR",[j.formatValue(k,"string")]);}if(i[1].getTime()>n.getTime()){return R.getText("FILTER_BAR_DATE_FIELD_MAX_DATE_ERROR",[j.formatValue(n,"string")]);}};P.generateFilters=function(e,i,j){var k=[],n=null,Q=null,R=null,W=null,X=P.FIELD_NAME_REGEX,Y=null,Z,$,_=null,a1=0,b1=0,c1,d1,e1,f1,g1,h1,i1,j1,k1,l1=[],m1,n1,o1;if(j){c1=j.dateSettings;d1=j.useContainsAsDefault;e1=j.stringFields;f1=j.timeFields;i1=j.dateTimeOffsetValueFields;l1=j.viewMetadataData||[];}if(e&&i){b1=e.length;while(b1--){h1=false;j1=false;W=e[b1];k1=P._getFieldMetadata(l1,W);if(k1&&k1.isCustomFilterField){continue;}if(W&&W!==P.BASIC_SEARCH_FIELD_ID){_=null;g1=false;if(d1&&e1){if(e1.indexOf(W)>-1){g1=true;}}else if(f1&&f1.indexOf(W)>-1){h1=true;}else if(i1&&i1.indexOf(W)>-1){j1=true;}Y=i[W];W=W.replace(X,"/");if(Y&&Y.hasOwnProperty("low")){if(Y.low&&Y.high){Z=Y.low;$=Y.high;if(!j1&&c1&&c1.UTC&&Z instanceof Date&&$ instanceof Date){Z=D.localToUtc(Z);$=D.localToUtc($);}Z=P.adaptTime(Z,k1);$=P.adaptTime($,k1);k.push(new p(W,x.BT,Z,$));}else if(Y.low){if(Y.low instanceof Date){Z=Y.low;if(!j1&&c1&&c1.UTC){Z=D.localToUtc(Z);}Z=P.adaptTime(Z,k1);k.push(new p(W,x.EQ,Z));}else if(typeof Y.low==="string"){if(j1&&k1){_=q.parseDateTimeOffsetInterval(Y.low);_[0]=k1.ui5Type.parseValue(_[0],"string");if(_.length===2){_[1]=k1.ui5Type.parseValue(_[1],"string");}}else{_=q.parseFilterNumericIntervalData(Y.low);}if(_&&_.length===2){Y[0]=P.adaptTime(Y[0],k1);Y[1]=P.adaptTime(Y[1],k1);k.push(new p(W,x.BT,_[0],_[1]));}else if(_&&_.length===1){Y[0]=P.adaptTime(Y[0],k1);k.push(new p(W,x.EQ,_[0]));}else{k.push(new p(W,g1?x.Contains:x.EQ,Y.low));}}}}else if(Y&&Y.hasOwnProperty("items")){n=[];R=[];Q=null;if(Y&&Y.hasOwnProperty("ranges")){_=Y.ranges;a1=_.length;while(a1--){m1=_[a1];Z=m1.value1;$=m1.value2;if(h1){if(Z instanceof Date){Z=q.getEdmTimeFromDate(Z);}if($ instanceof Date){$=q.getEdmTimeFromDate($);}}else if(k1&&k1.isCalendarDate){if(Z instanceof Date){Z=k1.ui5Type.parseValue(Z);}if($ instanceof Date){$=k1.ui5Type.parseValue($);}}else if(!j1&&c1&&c1.UTC){if(Z instanceof Date){Z=D.localToUtc(Z);}if($ instanceof Date){$=D.localToUtc($);}}Z=P.adaptTime(Z,k1);$=P.adaptTime($,k1);n1=(m1.exclude?R:n);if(m1.operation===K.Empty){if(k1&&["Edm.DateTime","Edm.DateTimeOffset"].indexOf(k1.type)>-1){n1.push(new p(W,m1.exclude?x.NE:x.EQ,null));}else{n1.push(P._getStringEmptyFilter(W,k1,m1.exclude));}}else{if(m1.operation!==x.BT&&m1.operation!==x.NB){$=undefined;}o1=m1.exclude?F.getTransformedExcludeOperation(m1.operation):m1.operation;n1.push(new p(W,o1,Z,$));}}if(R.length){Q=new p(R,true);}}_=Y.items;a1=_.length;while(a1--){n.push(new p(W,x.EQ,_[a1].key));}if(Y.value||Y.value===0||Y.value===false){if(typeof Y.value==="string"){Y.value=Y.value.trim();}n.push(new p(W,g1?x.Contains:x.EQ,Y.value));}if(n.length){if(Q){k.push(new p([new p(n,false),Q],true));}else{k.push(new p(n,false));}}else if(Q){k.push(Q);}}else if(Y||Y===0||Y===false){if(typeof Y==="string"){Y=Y.trim();}if(Y&&Y instanceof Date){if(h1){Y=q.getEdmTimeFromDate(Y);}else if(!j1&&c1&&c1.UTC){Y=D.localToUtc(Y);}}if(Y||Y===0||Y===false){Y=P.adaptTime(Y,k1);k.push(new p(W,g1?x.Contains:x.EQ,Y));}}}}}return(k.length>1)?[new p(k,true)]:k;};P._getStringEmptyFilter=function(e,i,j){var k=j?x.NE:x.EQ;if(i&&i.nullable==="false"){return new p(e,k,"");}else{return new p({and:!!j,filters:[new p(e,k,""),new p(e,k,null)]});}};P.parseFilterData=function(e,j,k,R){var n={},Q=null,W=null,X=null,Y,Z,i,$,_,a1,b1,c1,d1,e1,f1,g1,h1,i1;if(k){a1=k.stringDateFields;b1=k.dateFields;c1=k.timeFields;d1=k.timeIntervalFields;e1=k.dateTimeMultiValueFields;Q=k.conditionTypeFields||{};f1=k.dateTimeOffsetValueFields;g1=k.viewMetadataData||[];i1=k.filterProvider||null;}if(!a1){a1=[];}if(!b1){b1=[];}if(!c1){c1=[];}if(!d1){d1=[];}if(!e1){e1=[];}if(!f1){f1=[];}if(e&&j){Z=Object.assign({},j,true);for(W in Z){h1=P._getFieldMetadata(g1,W);if(e.hasOwnProperty(W)&&W!==P.CUSTOM_FIELDS_MODEL_PROPERTY){X=e[W];Y=Z[W];if(W in Q){if(Y&&(("conditionTypeInfo"in Y)||(!("conditionTypeInfo"in Y)&&Y.ranges))){Q[W].conditionType.initialize(Y);}}else if(X&&X.hasOwnProperty("low")){n[W]=Y;if(Y){if((Y.low||Y.low===0)&&(Y.high||Y.high===0)){if((b1.indexOf(W)>-1)||(c1.indexOf(W)>-1)){if(!(Y.low instanceof Date)){n[W].low=new Date(Y.low);}if(!(Y.high instanceof Date)){n[W].high=new Date(Y.high);}}else if(i1&&h1&&(f1.indexOf(W)>-1)){n[W].low=h1.ui5Type.formatValue(Y.low,"string")+'-'+h1.ui5Type.formatValue(Y.high,"string");n[W].high=null;}else if(a1.indexOf(W)===-1){n[W].low=Y.low+'-'+Y.high;n[W].high=null;}}else if((Y.low||(Y.low===0)||Y.value)&&!Y.high){if(!Y.low&&Y.value){Y.low=Y.value;}if(((b1.indexOf(W)>-1)||(c1.indexOf(W)>-1)||(f1.indexOf(W)>-1))&&!(Y.low instanceof Date)){n[W].low=new Date(Y.low);}else{n[W].low=Y.low;}n[W].high=null;}}}else if(X&&X.hasOwnProperty("items")){if(Y&&(Y.items||Y.ranges)){if(Y.ranges&&Y.ranges.length){if(d1.indexOf(W)>-1){$=Y.ranges.length;for(i=0;i<$;i++){_=Y.ranges[i];if(!_.exclude&&(_.operation==="EQ"||_.operation==="BT")){break;}_=null;}if(_){if(_.value1&&typeof _.value1==="string"){_.value1=new Date(_.value1);}if(_.value2&&typeof _.value2==="string"){_.value2=new Date(_.value2);}n[W]={ranges:[_],items:[],value:""};}continue;}else if(b1.indexOf(W)>-1||c1.indexOf(W)>-1||f1.indexOf(W)>-1){$=Y.ranges.length;for(i=0;i<$;i++){_=Y.ranges[i];if(_.value1&&typeof _.value1==="string"){_.value1=new Date(_.value1);}if(_.value2&&typeof _.value2==="string"){_.value2=new Date(_.value2);}}}else if(h1&&h1.isCalendarDate){$=Y.ranges.length;for(i=0;i<$;i++){_=Y.ranges[i];if(_.value1&&(typeof _.value1==="string")&&!_.value1.match(/([1-9][0-9]{3,}|0[0-9]{3})(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])/)){_.value1=h1.ui5Type.parseValue(new Date(_.value1),"date");}if(_.value2&&(typeof _.value2==="string")&&!_.value2.match(/([1-9][0-9]{3,}|0[0-9]{3})(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])/)){_.value2=h1.ui5Type.parseValue(new Date(_.value2),"date");}}}else if(h1&&h1.filterType==="boolean"){$=Y.ranges.length;for(i=0;i<$;i++){_=Y.ranges[i];if(_.hasOwnProperty("value1")){if(typeof _.value1==="string"){_.value1=(_.value1==="true");}}if(_.hasOwnProperty("value2")){if(typeof _.value2==="string"){_.value2=(_.value2==="true");}}}}}n[W]=Y;if(!R&&n[W].ranges){for(i=0;i<n[W].ranges.length;i++){n[W].ranges[i].tokenText=null;}}}else if(typeof Y==="string"||typeof Y==="number"||Y instanceof Date){if(Y&&(b1.indexOf(W)>-1||c1.indexOf(W)>-1)){if(typeof Y==="string"){Y=new Date(Y);}n[W]={ranges:[{"exclude":false,"operation":"EQ","keyField":W,"value1":Y,"value2":null}],items:[],value:""};}else{n[W]={value:Y,items:[]};}}}else{n[W]=null;if(typeof Y==="string"||typeof Y==="boolean"||typeof Y==="number"||Y instanceof Date){if(typeof Y==="string"&&(b1.indexOf(W)>-1||c1.indexOf(W)>-1||f1.indexOf(W)>-1)){n[W]=new Date(Y);}else{n[W]=Y;}}else if(Y&&(Y.value||Y.value===0||Y.value===false)){n[W]=Y.value;}else if(Y&&Y.items&&Y.items.length){n[W]=Y.items[0].key;}else if(Y&&Y.ranges&&Y.ranges.length){$=Y.ranges.length;for(i=0;i<$;i++){_=Y.ranges[i];if(!_.exclude&&_.operation==="EQ"){break;}_=null;}if(_&&_.value1){if(typeof _.value1==="string"&&(b1.indexOf(W)>-1||c1.indexOf(W)>-1||f1.indexOf(W)>-1)){n[W]=new Date(_.value1);}else{n[W]=_.value1;}}}}}else if(R||W===P.CUSTOM_FIELDS_MODEL_PROPERTY){n[W]=Z[W];}}}return n;};P.adaptTime=function(e,i){var j;if(!(e instanceof Date)||!i){return e;}if(i.displayFormat==="Date"){return D.normalizeDate(e,true);}j=parseInt(i.precision);return D.adaptPrecision(e,j);};P.prototype.destroy=function(){var e=function(Q){var i;if(Q){i=Q.length;while(i--){Q[i].destroy();}}};this._oParentODataModel=null;this._aAnalyticalParameters=null;this._aFilterBarViewMetadata=null;this._oParameterization=null;this._oNonAnaParameterization=null;this._aFilterBarFieldNames=null;this._aFilterBarStringDateFieldNames=null;this._aFilterBarDateFieldNames=null;this._aFilterBarTimeFieldNames=null;this._aFilterBarTimeIntervalFieldNames=null;this._aFilterBarDateTimeMultiValueFieldNames=null;this._aFilterBarStringFieldNames=null;this._aFilterBarMultiValueFieldMetadata=null;this._aFilterBarDateTimeFieldNames=null;this._aFieldGroupAnnotation=null;this._aSelectionFields=null;this._aSelectionVariants=null;if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;e(this._aValueHelpDialogProvider);this._aValueHelpDialogProvider=null;e(this._aValueListProvider);this._aValueListProvider=null;if(this._mTokenHandler){for(var j in this._mTokenHandler){var k=this._mTokenHandler[j];if(k.parser){k.parser.destroy();k.parser=null;}}delete this._mTokenHandler;}this.oResourceBundle=null;this.sIntervalPlaceholder=null;this.sDefaultDropDownDisplayBehaviour=null;this.sDefaultTokenDisplayBehaviour=null;this._oSmartFilter=null;if(this._oEventProvider){if(this._oEventProvider.destroy){this._oEventProvider.destroy();}this._oEventProvider=null;}for(var n in this._mConditionTypeFields){this._mConditionTypeFields[n].conditionType.destroy();}this._mConditionTypeFields=null;if(this.oModel){this.oModel.destroy();this.oModel=null;}this._aPromises=[];this.bIsDestroyed=true;};return P;},true);
