/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/XMLComposite','sap/ui/mdc/library','sap/m/HBox','sap/m/VBox','sap/m/Text','sap/m/Image','sap/m/Link','sap/ui/mdc/link/ILinkHandler','sap/ui/core/CustomData','sap/base/Log','sap/m/SelectDialog','sap/m/StandardListItem','sap/ui/mdc/link/SelectionDialog','sap/ui/mdc/link/SelectionDialogItem','sap/ui/model/json/JSONModel','sap/ui/model/BindingMode','sap/ui/base/ManagedObjectObserver','sap/ui/mdc/flexibility/PanelItem.flexibility','sap/ui/mdc/flexibility/Panel.flexibility'],function(X,m,H,V,T,I,L,a,C,b,S,c,d,e,J,B,M,P,f){"use strict";var g=X.extend("sap.ui.mdc.link.Panel",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/link/Panel.designtime",defaultAggregation:"items",properties:{enablePersonalization:{type:"boolean",defaultValue:true,invalidate:true},metadataHelperPath:{type:"string"}},aggregations:{items:{type:"sap.ui.mdc.link.PanelItem",multiple:true,singularName:"item"},additionalContent:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--idSectionAdditionalContent",aggregation:"items"}}},events:{beforeSelectionDialogOpen:{},afterSelectionDialogClose:{}}}});g.prototype.init=function(){X.prototype.init.call(this);var o=new J({countMainItems:0,countNonMainItemsWithIcon:0,countNonMainItemsWithoutIcon:0,showResetEnabled:false,runtimeItems:[]});o.setDefaultBindingMode(B.TwoWay);o.setSizeLimit(1000);this.setModel(o,"$sapuimdcbaseinfoPanel");this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["enablePersonalization"],aggregations:["items"]});};g.prototype.exit=function(o){if(this._oObserver){this._oObserver.disconnect();this._oObserver=null;}};g.prototype.onPressLinkPersonalization=function(){this.openSelectionDialog(false,true,undefined);};g.prototype.openSelectionDialog=function(F,s,h){return sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){sap.ui.require(['sap/ui/fl/write/api/ControlPersonalizationWriteAPI','sap/ui/fl/apply/api/FlexRuntimeInfoAPI','sap/ui/fl/Utils',this.getMetadataHelperPath()||"sap/ui/mdc/link/ContentHandler"],function(i,j,U,k){if(!j.isFlexSupported({element:this})){b.error("No AppComponent fount for control "+this+". Without AppComponent the personalization is not available.");return Promise.resolve();}return j.waitForChanges({element:this}).then(function(){return new Promise(function(r){var A=k.retrieveAllMetadata(this).filter(function(t){return t.isMain!==true;});if(!A.length){A=jQuery.extend(true,[],this._getInternalModel().getProperty("/runtimeItems")).filter(function(t){return t.isMain!==true;});}var l=A.some(function(t){return!!t.icon;});var n=jQuery.extend(true,[],this._getInternalModel().getProperty("/runtimeItems")).filter(function(t){return t.isMain!==true;});var o=function(q){q.close();q.destroy();this.fireAfterSelectionDialogClose();}.bind(this);var R=[];var p=function(t,v){R.push({id:t,visible:v});};this.fireBeforeSelectionDialogOpen();var q=new d({showItemAsLink:!F,showReset:false,items:A.map(function(t){var u=g._getItemById(t.id,n);var v=t.icon;if(l&&!v){v="sap-icon://chain-link";}return new e({key:t.id,text:t.text,description:t.description,href:t.href,target:t.target,icon:v,visible:u?u.visible:false});}),visibilityChanged:function(E){var v=U.getViewForControl(this);var t=v.createId(E.getParameter("key"));p(t,E.getParameter("visible"));}.bind(this),ok:function(){o(q);var t=f.createChanges(this,R);var u=[];i.add({changes:t,ignoreVariantManagement:true}).then(function(v){u=u.concat(v);var w=P.createChanges(R);return i.add({changes:w,ignoreVariantManagement:true});}).then(function(v){u=u.concat(v);return i.save({selector:this,changes:u});}.bind(this)).then(function(){return r(true);});}.bind(this),cancel:function(){o(q);return r(true);},reset:function(){}});if(h){q.addStyleClass(h);}jQuery.sap.syncStyleClass("sapUiSizeCompact",this,q);q.setModel(this._getInternalModel(),"$selectionDialog");this.addDependent(q);q.open();}.bind(this));}.bind(this));}.bind(this));}.bind(this));};g._getArrayElementById=function(i,A){var E=A.filter(function(o){return o.id!==undefined&&o.id===i;});return E.length?E[0]:null;};g._getItemById=function(i,A){return A.filter(function(o){return o.id===i;})[0];};g._getDiffToBase=function(h,i){if(!i||!h||h.length!==i.length){return false;}return i.filter(function(o){var j=g._getItemById(o.id,h);return o.id!==j.id||o.visible!==j.visible;});};g._convertSelectionDialogItems2MItems=function(s){return s.map(function(o){return{id:o.getKey(),visible:o.getVisible()};});};g._getUnion=function(h,i){if(!i){return jQuery.extend(true,[],h);}var u=jQuery.extend(true,[],i);h.forEach(function(o){var j=g._getItemById(o.id,u);if(!j){u.push(o);return;}if(j.visible===undefined&&o.visible!==undefined){j.visible=o.visible;}});return u;};g.prototype._getInternalModel=function(){return this.getModel("$sapuimdcbaseinfoPanel");};g.prototype._propagateDefaultIcon=function(s){if(!s){return;}var o=this._getInternalModel();o.getProperty("/runtimeItems").forEach(function(h,i){if(h.isMain===true||!!h.icon){return;}o.setProperty("/runtimeItems/"+i+"/icon","sap-icon://chain-link");});};function _(o){var h=this._getInternalModel();if(o.object.isA("sap.ui.mdc.link.Panel")){switch(o.name){case"items":var i=o.child?[o.child]:o.children;i.forEach(function(p){switch(o.mutation){case"insert":h.setProperty("/countMainItems",p.getIsMain()?h.getProperty("/countMainItems")+1:h.getProperty("/countMainItems"));if(!p.getIsMain()){h.setProperty("/countNonMainItemsWithIcon",p.getIcon()?h.getProperty("/countNonMainItemsWithIcon")+1:h.getProperty("/countNonMainItemsWithIcon"));h.setProperty("/countNonMainItemsWithoutIcon",p.getIcon()?h.getProperty("/countNonMainItemsWithoutIcon"):h.getProperty("/countNonMainItemsWithoutIcon")+1);}var r=h.getProperty("/runtimeItems/");r.splice(this.indexOfItem(p),0,p.getJson());h.setProperty("/runtimeItems",r);this._propagateDefaultIcon(h.getProperty("/countNonMainItemsWithIcon")>0&&h.getProperty("/countNonMainItemsWithoutIcon")>0);this._oObserver.observe(p,{properties:["visible"]});break;case"remove":this._oObserver.unobserve(p);b.error("Deletion of items is not supported yet");break;default:b.error("Mutation '"+o.mutation+"' is not supported yet.");}},this);break;case"enablePersonalization":this.byId("idSectionPersonalizationButton").setVisible(o.current);break;default:b.error("The property or aggregation '"+o.name+"' has not been registered.");}}else if(o.object.isA("sap.ui.mdc.link.PanelItem")){switch(o.name){case"visible":var p=o.object;h.setProperty("/runtimeItems/"+this.indexOfItem(p)+"/visible",p.getVisible());break;default:b.error("The '"+o.name+"' of PanelItem is not supported yet.");}}}return g;});
