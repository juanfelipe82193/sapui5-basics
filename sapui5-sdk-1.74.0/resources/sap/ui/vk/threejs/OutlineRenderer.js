sap.ui.define(["jquery.sap.global","./thirdparty/three","sap/base/Log"],function(q,t,L){"use strict";var O=function(o){this._outlineWidth=o;this._copyMaterial=new THREE.MeshBasicMaterial({transparent:true});this._maskMaterial=new THREE.MeshBasicMaterial({side:THREE.DoubleSide});this._outlineMaterial=new THREE.ShaderMaterial({uniforms:{"mask":{value:null},"offset":{value:new THREE.Vector2(1,0,0,1)}},vertexShader:["varying vec2 vTC;","void main() {","	vTC = uv;","	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vTC;","uniform sampler2D mask;","uniform vec4 offset;","float delta(vec3 c1,  vec3 c2) {","	vec3 dc = c1 - c2;","	return dot(dc, dc);","}","void main() {","	vec3 c = texture2D(mask, vTC).rgb;","	vec3 c1 = texture2D(mask, vTC + offset.xy).rgb;","	vec3 c2 = texture2D(mask, vTC - offset.xy).rgb;","	vec3 c3 = texture2D(mask, vTC + offset.zw).rgb;","	vec3 c4 = texture2D(mask, vTC - offset.yw).rgb;","	vec4 a = vec4(delta(c, c1), delta(c, c2), delta(c, c3), delta(c, c4));","	gl_FragColor = vec4(1.0, 1.0, 1.0, sign(dot(a, a)));","}"].join("\n")});this._expandMaterial=new THREE.ShaderMaterial({uniforms:{"mask":{value:null},"offset":{value:new THREE.Vector2(1,0,0,1)}},vertexShader:["varying vec2 vTC;","void main() {","	vTC = uv;","	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vTC;","uniform sampler2D mask;","uniform vec4 offset;","void main() {","	float a = texture2D(mask, vTC).a;","	a = max(a, texture2D(mask, vTC + offset.xy).a);","	a = max(a, texture2D(mask, vTC - offset.xy).a);","	a = max(a, texture2D(mask, vTC + offset.zw).a);","	a = max(a, texture2D(mask, vTC - offset.yw).a);","	gl_FragColor = vec4(1.0, 1.0, 1.0, a);","}"].join("\n")});this._screenCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1);this._screenMesh=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2));};O.prototype.setOutlineWidth=function(w){this._outlineWidth=w;};O.prototype.render=function(r,s,c,a,o,j){if(!a||!a.length){return;}var b=r.getSize(new THREE.Vector2());var p=2;var w=b.width*p;var h=b.height*p;if(!this._renderTarget1||this._renderTarget1.width!==w||this._renderTarget1.height!==h){var d={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter};this._renderTarget1=new THREE.WebGLRenderTarget(w,h,d);this._renderTarget1.texture.generateMipmaps=false;this._renderTarget2=new THREE.WebGLRenderTarget(w,h,d);this._renderTarget2.texture.generateMipmaps=false;}var n;var e;if(j){n=new Map();e=new Map();j.forEach(function(F){n.set(F.node,F);if(F.parent){var G=e.get(F.parent)||[];G.push(F);e.set(F.parent,G);}});}var f;var g=new Set();var k=function(F){if(F.isMesh){g.add({mesh:F,color:f});}};var i;for(i=0;i<a.length;i++){var l=a[i];f=new THREE.Color(((i+1)&255)/255,(((i+1)>>8)&255)/255,(((i+1)>>16)&255)/255);l._vkTraverseNodes(k,n,e);}var m=r.getClearColor().clone();var u=r.getClearAlpha();var v=r.autoClear;r.autoClear=true;r.setClearColor(0x000000,0);var x;var y=this._renderTarget1;var z=this._renderTarget2;var A=g.values();var B=A.next();while(!B.done){var C=B.value.mesh;this._maskMaterial.color=B.value.color;B=A.next();x=C.material;C.material=this._maskMaterial;r.render(C,c,y);C.material=x;r.autoClear=false;}var D=new THREE.Vector4(1/w,0,0,1/h);x=this._outlineMaterial;x.uniforms.mask.value=y.texture;x.uniforms.offset.value=D;this._screenMesh.material=x;r.render(this._screenMesh,this._screenCamera,z);if(this._outlineWidth>1){x=this._expandMaterial;x.uniforms.offset.value=D;this._screenMesh.material=x;for(i=1;i<this._outlineWidth;i++){var E=y;y=z;z=E;x.uniforms.mask.value=y.texture;r.render(this._screenMesh,this._screenCamera,z);}}x=this._copyMaterial;x.map=z.texture;x.color=o;this._screenMesh.material=x;r.render(this._screenMesh,this._screenCamera);r.setClearColor(m,u);r.autoClear=v;};return O;});
