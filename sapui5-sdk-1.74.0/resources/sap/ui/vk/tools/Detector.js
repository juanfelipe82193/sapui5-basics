/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define([],function(){"use strict";var D=function(){this._verticesMap=new Map();this._objArr=[];this._collidedUuids=new Set();this._sourceObjects=null;this._targetObjects=[];this._srcBoxHelper=null;this._sourceBox=new THREE.Box3();this._originPos=new THREE.Vector3();this._targetBoxHelper=[];this._targetBoxes=[];this._detectDistance=20.0;this._direction=new THREE.Vector3();this._isReady=false;this._finalDistance=null;this._finalSnaps=[];this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;this._detectType={"move":this.detectMove.bind(this),"scale":this.detectScale.bind(this),"rotate":this.detectRotate.bind(this)};};D.prototype.isReady=function(){if(this._isReady&&this._sourceObjects){return true;}else{return false;}};D.prototype.setDetectDistance=function(v){this._detectDistance=parseFloat(v)||20.0;};D.prototype.setMoved=function(v){this._isMoved=v;this._intersectDistance=Number.NEGATIVE_INFINITY;};D.prototype.getObjArray=function(){return this._objArr;};D.prototype.addObjFromScene=function(v){var s=v._scene.getSceneRef();var a=v._viewStateManager;this._objArr.length=0;this._verticesMap.clear();s.traverse(function(c){if(c.isMesh){if(!this._objArr.find(function(o){return o.uuid===c.uuid;})){this._objArr.push(c);var A=this.getVertices(c.geometry);this._verticesMap.set(c.uuid,A);}}}.bind(this));this.setSource(a);this._isReady=true;};D.prototype.setSource=function(v){var s=[];v.enumerateSelection(function(n){s.push(n);});if(s.length>0){var o=s.pop();if(this._isReady){v.setSelectionStates(o,s,false,true);}if(o.children.length===0){this._isGroup=false;this._sourceObjects=o;}else{this._isGroup=true;this._sourceObjects=o.children.filter(function(c){return c.type==="Mesh";})[0];}this._srcBoxHelper=new THREE.BoxHelper(this._sourceObjects);this._srcBoxHelper.update();this._sourceBox.setFromObject(this._srcBoxHelper);}else{this._isReady=false;this._sourceObjects=null;this._sourceBox=new THREE.Box3();}this.setTarget();};D.prototype.setTarget=function(){this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._collidedUuids.clear();this._isMoved=false;if(this._sourceObjects){this._sourceObjects.geometry.computeBoundingSphere();this._originPos=new THREE.Vector3();this._targetObjects=this._objArr.filter(function(o){return o.uuid!==this._sourceObjects.uuid;}.bind(this));this._targetBoxes.length=0;this._targetBoxHelper.length=0;this._targetObjects.forEach(function(t){var a=new THREE.BoxHelper(t);this._targetBoxHelper.push(a);a.update();var c=new THREE.Box3();c.setFromObject(a);this._targetBoxes.push(c);}.bind(this));}else{this._targetObjects.length=0;this._targetBoxes.length=0;this._targetBoxHelper.length=0;}};D.prototype.updateTargetBox=function(){this._targetBoxHelper.forEach(function(t,i){t.update();this._targetBoxes[i].setFromObject(t);}.bind(this));};D.prototype.getVertices=function(g){var i,l,a=[];if(g.isGeometry){a=g.vertices;}else if(g.isBufferGeometry){var c=g.attributes.position;if(c!==undefined){var v=new THREE.Vector3();a=[];var o={};var s="";for(i=0,l=c.count;i<l;i++){v.fromBufferAttribute(c,i);s=JSON.stringify(v);if(!o[s]){a.push(v.clone());o[s]=true;}}}}return a;};D.prototype.findClosestVertex=function(p,r,o){var v=this._verticesMap.get(o.uuid);if(v.length===0){return null;}var d,a=null,l=o.worldToLocal(p.clone());for(var i=0,c=v.length;i<c;i++){d=v[i].distanceTo(l);if(d>r){continue;}r=d;a=v[i];}if(a===null){return null;}return o.localToWorld(a.clone());};D.prototype.findClosestSnap=function(p,r,t){var i=2;var s;while(!s){s=this.findClosestVertex(p,r,t);r*=i;}return s;};D.prototype.intersectDetect=function(i){var s=new Map();var a=this._sourceBox.clone().expandByScalar(this._detectDistance);i.forEach(function(o){var c=this._targetObjects.findIndex(function(t){return t.uuid===o.object.uuid;});if(!this._collidedUuids.has(o.object.uuid)&&c!==-1&&this._targetBoxes&&this._targetBoxes[c].intersectsBox(a)){var d=this.findClosestSnap(this._originPos,this._detectDistance,this._targetObjects[c]);s.set(d,this._targetObjects[c]);if(this._targetBoxes[c].intersectsBox(this._sourceBox)&&this._intersectDistance<this._finalDistance){if(this.detectCollisionGJK(this._sourceObjects,this._targetObjects[c])){this._collidedUuid=o.object.uuid;this._intersectDistance=this._finalDistance;}}}}.bind(this));return s;};D.prototype.getFinalSnaps=function(a){var f=[];if(a.length>0){var s=this.intersectDetect(a);if(s.size!==0){var c=Array.from(s.keys());var m=c[0];var l=m.distanceTo(this._originPos);for(var i=1;i<c.length;++i){var q=c[i];var d=q.distanceTo(this._originPos);if(d<l){m=q;l=d;}}var o=s.get(m);var e=this._originPos.distanceTo(m);var g,n;g=this.findClosestSnap(m,e,this._sourceObjects);var h=g.distanceTo(m);n=this.findClosestSnap(g,h,o);f=[g,n];}}return f;};D.prototype.snapMove=function(){var o=this._op;if(this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>0.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){o.gizmo._tool._handler._gesture=false;o.gizmo._gizmoOffset.add(this._direction.clone().multiplyScalar(0.1));o.gizmo._move(o.gizmo._gizmoOffset);}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;o.viewport.setShouldRenderFrame();}this.detect();}};D.prototype.snapScale=function(){var o=this._op;if(!o.gizmo._gizmoScale.equals(new THREE.Vector3(1,1,1))&&this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>0.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){o.gizmo._tool._handler._gesture=false;var g=o.gizmo._gizmoScale.toArray();g.forEach(function(s,i){if(s>1){o.gizmo._gizmoScale.setComponent(i,s*1.01);}});o.gizmo._scale(o.gizmo._gizmoScale);}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;o.viewport.setShouldRenderFrame();}this.detect();}else if(Math.abs(this._finalDistance-this._intersectDistance)<=0.1){this._collidedUuids.add(this._collidedUuid);}};D.prototype.snapRotate=function(){var o=this._op;if(this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>0.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){o.gizmo._tool._handler._gesture=false;o.angle2+=0.02*(o.angle2-o.angle1)/Math.abs(o.angle2-o.angle1);o.gizmo._setRotationAxisAngle(o.handleIndex,o.angle1,o.angle2);}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;o.viewport.setShouldRenderFrame();}this.detect();}};D.prototype.detectMove=function(){this._direction.copy(this._op.gizmo._gizmoOffset).normalize();var r=new THREE.Raycaster(this._originPos,this._direction,0,this._detectDistance);this._snapAction=b(this.snapMove,1000/60).bind(this);return r.intersectObjects(this._targetObjects,false);};D.prototype.detectScale=function(){if(this._op.gizmo._gizmoScale.toArray().find(function(s){return s<=1;})){this._op.gizmo._tool._handler._gesture=true;this._collidedUuids.forEach(function(e){var f=this._targetObjects.find(function(t){return t.uuid===e;});if(f&&!this.detectCollisionGJK(this._sourceObjects,f)){this._collidedUuids.delete(e);}}.bind(this));}this._gizmoPos=new THREE.Vector3();this._op.gizmo._gizmo.getWorldPosition(this._gizmoPos);var a=new THREE.Vector3();this._sourceObjects.getWorldPosition(a);var S=0.0,c=0.0;c=this._sourceObjects.geometry.boundingSphere.clone().applyMatrix4(this._sourceObjects.matrixWorld).radius;S=new THREE.Sphere(a,c+this._detectDistance);var d=[];this._targetBoxes.forEach(function(t,i){if(t.intersectsSphere(S)){d.push({object:this._targetObjects[i]});}}.bind(this));this._snapAction=b(this.snapScale,1000/60).bind(this);return d;};D.prototype.detectRotate=function(){this._gizmoPos=new THREE.Vector3();this._op.gizmo._gizmo.getWorldPosition(this._gizmoPos);var p=new THREE.Vector3();var s=new THREE.Vector3();var r=new THREE.Raycaster(this._originPos,this._direction,0,this._detectDistance);this._sourceObjects.getWorldPosition(s);this._radius=this._gizmoPos.distanceTo(s);var a=this._op.handleIndex;this._axis=new THREE.Vector3().setFromMatrixColumn(this._op.gizmo._matOrigin,a).normalize();this._axis.transformDirection(this._op.gizmo._gizmo.matrixWorld);if(this._radius>0.01){p.subVectors(s,this._gizmoPos).normalize();this._detectDistance=this._radius;this._direction.crossVectors(p,this._axis).normalize();}else if(this._finalSnaps.length===2){p.subVectors(this._finalSnaps[0],this._gizmoPos).normalize();this._direction.crossVectors(p,this._axis).normalize();}if(this._op.gizmo._gizmoRotation.toArray()[a]>0){this._direction.negate();}var c=new THREE.Plane(this._axis);var d=[],t=[];var S=0.0,e=0.0;if(this._radius<0.01){e=this._sourceObjects.geometry.boundingSphere.clone().applyMatrix4(this._sourceObjects.matrixWorld).radius;S=new THREE.Sphere(this._gizmoPos,e);this._targetBoxes.forEach(function(f,i){if(f.intersectsSphere(S)&&f.intersectsPlane(c)){d.push({object:this._targetObjects[i]});}}.bind(this));}else{S=new THREE.Sphere(this._gizmoPos,this._radius);this._targetBoxes.forEach(function(f,i){if(f.intersectsSphere(S)&&f.intersectsPlane(c)){t.push(this._targetObjects[i]);}}.bind(this));d=r.intersectObjects(t,false);}this._snapAction=b(this.snapRotate,1000/60).bind(this);return d;};D.prototype.detect=function(d){var o=this._op=d||this._op;if(!this.isReady()||!this._verticesMap.has(this._sourceObjects.uuid)){this.addObjFromScene(o.viewport);}else{this._srcBoxHelper.update();this._sourceBox.setFromObject(this._srcBoxHelper);this._sourceBox.getCenter(this._originPos);this.updateTargetBox();var i=this._detectType[o.detectType]();this._finalSnaps=this.getFinalSnaps(i);if(this._finalSnaps.length===2){var f=new THREE.Vector3();f.subVectors(this._finalSnaps[1],this._finalSnaps[0]);this._finalDistance=f.length();if(this._finalDistance){this._snapAction();}}}};function b(f,w){var t;return function(){var a=this,c=arguments;clearTimeout(t);t=setTimeout(function(){t=null;f.apply(a,c);},w);};}D.prototype.detectCollisionGJK=function(o,t){var M=64;var c=this;function G(f,g){var h=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];var n=2;var d=c._direction;h[1]=v(f,g,d);if(h[1].dot(d)<0){return false;}d=h[1].clone().negate();h[0]=v(f,g,d);if(h[0].dot(d)<0){return false;}var j=h[1].clone().sub(h[0]);var k=h[0].clone().negate();d=j.clone().cross(k).cross(j);var m=function(a,O,x,y,z,A,E){if(x.clone().cross(A).dot(O)>0){h[1]=h[0];h[0]=a.clone();d=x.clone().cross(O).cross(x);n=2;}else{h[2]=h[1];h[1]=h[0];h[0]=a.clone();d=A.clone();}};var r=function(a,O,x,y,z,A,E){if(A.clone().cross(y).dot(O)>0){h[0]=a.clone();d=y.clone().cross(O).cross(y);n=2;}else{m(a,O,x,y,z,A,E);}};var u=function(a,O,x,y,z,A,E){if(A.clone().cross(y).dot(O)>0){h[0]=h[1];h[1]=h[2].clone();x=y;y=z.clone();A=E.clone();r(a,O,x,y,z,A,E);}else{m(a,O,x,y,z,A,E);}};function v(f,g,d){var l=d.clone().normalize();var p=w(f,l);var q=w(g,l.negate());return p.clone().sub(q);}function w(L,d){var N=c._verticesMap.get(L.uuid);var p=L.localToWorld(N[0].clone());var l=p.dot(d);for(var i=1;i<N.length;++i){var q=L.localToWorld(N[i].clone());var P=q.dot(d);if(P>l){p=q;l=P;}}return p;}for(var i=0;i<M;++i){var a=v(f,g,d);if(a.dot(d)<0){return false;}var O,x,y,z,A;if(n===2){O=a.clone().negate();x=h[0].clone().sub(a);y=h[1].clone().sub(a);A=x.clone().cross(y);var B=x.clone().cross(A);if(B.dot(O)>0){h[1]=h[0];h[0]=a.clone();d=x.clone().cross(O).cross(x);continue;}var C=A.clone().cross(y);if(C.dot(O)>0){h[0]=a.clone();d=y.clone().cross(O).cross(y);continue;}if(A.dot(O)>0){h[2]=h[1];h[1]=h[0];h[0]=a.clone();d=A.clone();}else{h[2]=h[0];h[0]=a.clone();d=A.clone().negate();}n=3;continue;}O=a.clone().negate();x=h[0].clone().sub(a);y=h[1].clone().sub(a);z=h[2].clone().sub(a);A=x.clone().cross(y);var E=y.clone().cross(z);var F=z.clone().cross(x);var H=0x1;var I=0x2;var J=0x4;var K=(A.dot(O)>0?H:0)|(E.dot(O)>0?I:0)|(F.dot(O)>0?J:0);if(K===0){return true;}if(K===H){r(a,O,x,y,z,A,E);}else if(K===I){h[0]=h[1];h[1]=h[2].clone();x=y;y=z.clone();A=E.clone();r(a,O,x,y,z,A,E);}else if(K===J){h[1]=h[0];h[0]=h[2].clone();y=x;x=z.clone();A=F.clone();r(a,O,x,y,z,A,E);}else if(K===H||I){u(a,O,x,y,z,A,E);}else if(K===I||J){j=h[0];h[0]=h[1];h[1]=h[2];h[2]=j;j=x;x=y;y=z;z=j;A=E;E=F.clone();u(a,O,x,y,z,A,E);}else if(K===J||H){j=h[1];h[1]=h[0];h[0]=h[2];h[2]=j;j=y;y=x;x=z;z=j;E=A;A=F.clone();u(a,O,x,y,z,A,E);}else{return true;}}return true;}var s=performance.now();var e=G(o,t);if(e){console.log("Collide (ms): ",performance.now()-s);return true;}else{console.log("Not Collide (ms): ",performance.now()-s);return false;}};return D;});
