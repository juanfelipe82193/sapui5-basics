/*!
 * SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["./library","./MakitLib","./CategoryAxis","./ValueAxis","./ValueBubble","./CombinationChartRenderer","sap/ui/core/Control","sap/ui/core/Element","sap/ui/core/RenderManager","sap/ui/core/ResizeHandler","sap/ui/thirdparty/jquery","sap/base/assert"],function(m,M,C,V,a,b,c,E,R,d,q,e){"use strict";var f=m.ChartType;var L=m.LegendPosition;var g=c.extend("sap.makit.CombinationChart",{metadata:{deprecated:true,library:"sap.makit",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%'},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%'},showRangeSelector:{type:"boolean",group:"Appearance",defaultValue:true},legendPosition:{type:"sap.makit.LegendPosition",group:"Misc",defaultValue:L.Left},primaryColorPalette:{type:"any",group:"Misc",defaultValue:null},secondaryColorPalette:{type:"any",group:"Misc",defaultValue:null},showTableValue:{type:"boolean",group:"Misc",defaultValue:true},numberOfVisibleCategories:{type:"int",group:"Misc",defaultValue:null},rangeSelectorStartPosition:{type:"int",group:"Misc",defaultValue:0}},aggregations:{categoryRegions:{type:"sap.makit.Category",multiple:true,singularName:"categoryRegion",deprecated:true},layers:{type:"sap.makit.Layer",multiple:true,singularName:"layer",deprecated:true},categoryAxis:{type:"sap.makit.CategoryAxis",multiple:false,deprecated:true},primaryValueAxis:{type:"sap.makit.ValueAxis",multiple:false,deprecated:true},secondaryValueAxis:{type:"sap.makit.ValueAxis",multiple:false,deprecated:true},valueBubble:{type:"sap.makit.ValueBubble",multiple:false,deprecated:true}},events:{doubletap:{},tap:{},longpress:{}}}});g.prototype.init=function(){this._makitChart=null;this._parentCurrentHeight=0;this._selectedCatIdx=0;this._datarows=[];this._styleClasses=[];this.setCategoryAxis(new C());this.setPrimaryValueAxis(new V());this.setSecondaryValueAxis(new V());this.setValueBubble(new a());this.attachEvent("_change",this._onPropertyChanged);sap.ui.getCore().attachThemeChanged(this._applyCSS,this);};g.prototype.onBeforeRendering=function(o){this.fireEvent("_beforeRendering",this);if(this.getDomRef()&&!R.isPreservedContent(this.getDomRef())){R.preserveContent(this.getDomRef(),true,false);}};g.prototype.onAfterRendering=function(o){this.fireEvent("_afterRendering",this);var $=q(document.getElementById("sap-ui-dummy-"+this.getId()));var h=R.findPreservedContent(this.getId());var i=null;if(this.getLayers().length>0){if(h.size()==0){this.fireEvent("_createMAKitObject",this);i=new q(this.getDomRef());$.replaceWith(i);this._createChartObject();var p=document.getElementById(this.getParent().getId());this._parentCurrentHeight=p.offsetHeight;d.register(p,q.proxy(this._onResize,this));}else if(h.size()>0){this.fireEvent("_restoreMAKitObject",this);$.replaceWith(h);}if(i){this._makitChart.setPalette(this.getPrimaryColorPalette(),"primaryaxis");this._makitChart.setPalette(this.getSecondaryColorPalette(),"secondaryaxis");this._makitChart.setNumberOfVisibleCategories(this.getNumberOfVisibleCategories());this._makitChart.setRangeSelectorStartPosition(this.getRangeSelectorStartPosition());this._setDataTable();}}};g.prototype.addStyleClass=function(s,S){if(this._styleClasses.indexOf(s)===-1){this._styleClasses.push(s);}if(this._makitChart){c.prototype.addStyleClass.call(this,s,S);}return this;};g.prototype.removeStyleClass=function(s,S){var i=this._styleClasses.indexOf(s);if(i>-1){this._styleClasses.splice(i,1);}if(this._makitChart){c.prototype.removeStyleClass.call(this,s,S);}return this;};g.prototype.addLayer=function(l){if(this._makitChart){throw new Error("Cannot add layer once the chart has been rendered");}this._checkLayer(l);E.prototype.addAggregation.call(this,"layers",l,false);l.attachEvent("rowsUpdated",this._setDataTable,this);l.attachEvent("dataRegionChanged",this._onDataRegionPropChanged,this);l.attachEvent("_change",this._onLayerPropertyChanged,this);return this;};g.prototype.insertLayer=function(l,i){if(this._makitChart){throw new Error("Cannot add layer once the chart has been rendered");}this._checkLayer(l);E.prototype.insertAggregation.call(this,"layers",l,i,false);l.attachEvent("rowsUpdated",this._setDataTable,this);l.attachEvent("dataRegionChanged",this._onDataRegionPropChanged,this);l.attachEvent("_change",this._onLayerPropertyChanged,this);return this;};g.prototype.removeLayer=function(l){if(this._makitChart){throw new Error("Cannot remove layer once the chart has been rendered");}var r=E.prototype.removeAggregation.call(this,"layers",l,false);if(r!=null){r.detachEvent("rowsUpdated",this._setDataTable,this);r.detachEvent("dataRegionChanged",this._onDataRegionPropChanged,this);r.detachEvent("_change",this._onLayerPropertyChanged,this);}return r;};g.prototype.removeAllLayers=function(){if(this._makitChart){throw new Error("Cannot remove layers once the chart has been rendered");}var r=E.prototype.removeAllAggregation.call(this,"layers",false);var l=r.length;var i;for(i=0;i<l;i++){r[i].detachEvent("rowsUpdated",this._setDataTable,this);r[i].detachEvent("dataRegionChanged",this._onDataRegionPropChanged,this);r[i].detachEvent("_change",this._onLayerPropertyChanged,this);}return r;};g.prototype._checkLayer=function(l){var h=this.getLayers();var j=h.length;var i;if(l.getType()==f.Line){for(i=0;i<j;i++){if(h[i].getType()==f.Bar){l.setLineType("verticalline");break;}else{l.setLineType("line");}}}else{for(i=0;i<j;i++){if(h[i].getType()!=f.Line){throw new Error("Cannot combine 2 different non-line chart type");}}for(i=0;i<j;i++){if(h[i].getType()==f.Line){if(l.getType()==f.Bar){h[i].setLineType("verticalline");}else{h[i].setLineType("line");}}}}};g.prototype.setValueBubble=function(v){if(v instanceof a){E.prototype.setAggregation.call(this,"valueBubble",v,false);v.attachEvent("_change",this._onValueBubbleChanged,this);if(this._makitChart){var h=v.toObject();this._makitChart.setValueBubbleStyle(h);if(this._makitChart.isValueBubbleVisible()!=h.visible){this._makitChart.showValueBubble(h.visible);}}}else{throw new Error("valueBubble property must be of type sap.makit.ValueBubble");}return this;};g.prototype.addCategoryRegion=function(o){E.prototype.addAggregation.call(this,"categoryRegions",o,false);o.attachEvent("_change",{type:"categories"},this._onDataRegionPropChanged,this);return this;};g.prototype.insertCategoryRegion=function(o,i){E.prototype.insertAggregation.call(this,"categoryRegions",o,i,false);o.attachEvent("_change",{type:"categories"},this._onDataRegionPropChanged,this);return this;};g.prototype.removeCategoryRegion=function(o){var r=E.prototype.removeAggregation.call(this,"categoryRegions",o,false);if(r!=null){o.detachEvent("_change",this._onDataRegionPropChanged,this);}return r;};g.prototype.removeAllCategoryRegions=function(){var r=E.prototype.removeAllAggregation.call(this,"categoryRegions",false);var l=r.length;var i;for(i=0;i<l;i++){r[i].detachEvent("_change",this._onDataRegionPropChanged,this);}return r;};g.prototype.setPrimaryValueAxis=function(v){if(v instanceof V){E.prototype.setAggregation.call(this,"primaryValueAxis",v,false);v.attachEvent("_change",{axis:"values",secondaryAxis:false},this._onAxisPropChanged,this);}else{throw new Error("primaryValueAxis property must be of type sap.makit.ValueAxis");}return this;};g.prototype.setSecondaryValueAxis=function(v){if(v instanceof V){E.prototype.setAggregation.call(this,"secondaryValueAxis",v,false);v.attachEvent("_change",{axis:"values",secondaryAxis:true},this._onAxisPropChanged,this);}else{throw new Error("secondaryValueAxis property must be of type sap.makit.ValueAxis");}return this;};g.prototype.setCategoryAxis=function(o){if(o instanceof C){E.prototype.setAggregation.call(this,"categoryAxis",o,false);o.attachEvent("_change",{axis:"category"},this._onAxisPropChanged,this);}else{throw new Error("categoryAxis property must be of type sap.makit.CategoryAxis");}return this;};g.prototype._setRealHeight=function(h){var i=this.getDomRef();var p=i.style.height;var n="0px";if(h.indexOf("%")>-1){var j=document.getElementById(this.getParent().getId());var k=parseInt(h);var r=Math.ceil(j.offsetHeight*(k/100));n=r+"px";}else{n=h;}if(p!=n){i.style.height=n;}};g.prototype._createChartObject=function(){var h=this.getDomRef();e(h,"Chart's DomRef is not ready");h.style.width=this.getWidth();this._setRealHeight(this.getHeight());this._makitChart=new window.$MA.Chart(this.getId(),true);var t=this;this._makitChart.bind("initialized",function(){t._makitChart.showToolBar(false);t._setMakitChartProperties();});this._makitChart.bind("beforerender",function(){t.fireEvent("_makitBeforeRender",t);});this._makitChart.bind("renderstart",function(){t.fireEvent("_makitRenderStart",t);});this._makitChart.bind("renderend",function(){t.fireEvent("_makitRenderEnd",t);});this._makitChart.bind("animationend",function(){t.fireEvent("_makitAnimationEnd",t);});var s=this._getChartSyntax();this._makitChart.create(s);this._makitChart.bind("tap",function(p){t._selectedCatIdx=t._makitChart.getSelectedCategoryIndex();t.fireTap(p);});this._makitChart.bind("doubletap",function(p){t.fireEvent("doubletap",p);});this._makitChart.bind("longpress",function(p){t._selectedCatIdx=t._makitChart.getSelectedCategoryIndex();t.fireEvent("longpress",p);});var l=this._styleClasses.length;for(var i=0;i<l;i++){this.addStyleClass(this._styleClasses[i]);}this._applyCSS();};g.prototype._setMakitChartProperties=function(){if(!this._makitChart){return;}this._makitChart.setLegend(this.getLegendPosition().toLowerCase());this._makitChart.setPalette(this.getPrimaryColorPalette(),"primaryaxis");this._makitChart.setPalette(this.getSecondaryColorPalette(),"secondaryaxis");this._makitChart.showRangeSelectorView(this.getShowRangeSelector());this._makitChart.showTableValue(this.getShowTableValue());this._makitChart.setNumberOfVisibleCategories(this.getNumberOfVisibleCategories());this._makitChart.setRangeSelectorStartPosition(this.getRangeSelectorStartPosition());var v=this.getValueBubble();if(v){var h=v.toObject();this._makitChart.setValueBubbleStyle(h);if(this._makitChart.isValueBubbleVisible()!=h.visible){this._makitChart.showValueBubble(h.visible);}}var l=this.getLayers();var j=l.length;for(var i=0;i<j;i++){var k=l[i];if(k.getType()==f.Line){this._makitChart.setGraphLineWidth(k.getLineThickness(),k.getId());}var p=k.getPrimaryColorPalette();if(p){this._makitChart.setPalette(p,k.getId());}this._makitChart.setProperty(k.getId()+".values.SecondaryAxis",k.getDrawOnSecondaryAxis());}};g.prototype._getChartSyntax=function(){var h=this.getCategoryAxis();var j=this.getCategoryRegions();var k=j.length;if(k>0){var i;var l="<Categories";if(h){if(h.getDisplayAll()){l+=' display ="'+h.getDisplayAll()+'"';}}l+=">";var n="";for(i=k-1;i>=0;i--){var t=j[i].getDisplayName();if(t&&t.length>0){n+=t+" | ";}}n=n.substr(0,n.length-3);for(i=0;i<k;i++){var o=j[i];l+='<Category column ="'+o.getColumn()+'"';if(o.getFormat()){l+=' format ="'+o.getFormat()+'"';}if(i==0){l+=' displayname ="'+n+'"';}if(h){l+=' showprimaryline ="'+h.getShowPrimaryLine()+'"';l+=' showgrid ="'+h.getShowGrid()+'"';l+=' showlabel ="'+h.getShowLabel()+'"';l+=' thickness ="'+h.getThickness()+'"';l+=' color ="'+h.getColor()+'"';l+=' sortorder ="'+h.getSortOrder().toLowerCase()+'"';l+=' displaylastlabel ="'+h.getDisplayLastLabel()+'"';}l+=' />';}l+="</Categories>";}else{throw new Error("CombinationChart '"+this.getId()+"' needs at least one Category data region");}var p=this.getLayers();var r=p.length;var s="";for(var i=0;i<r;i++){var u=p[i];s+=u.getSyntax(this.getPrimaryValueAxis(),this.getSecondaryValueAxis());}var v='<OverlayGroup>';v+=l;v+=s;v+='</OverlayGroup>';return v;};g.prototype._setDataTable=function(){if(this._makitChart){this._setDataTableTimer=this._setDataTableTimer||setTimeout(function(){e(this._makitChart,"_makitChart is not initialized");this.fireEvent("_createDataTable",this);var l=this.getLayers();var h=l.length;this.fireEvent("_beforeSetDataTable",this);for(var i=0;i<h;i++){var j=l[i];this._makitChart.setDataTable(j.getDataTable(),j.getId());}this._dataInitialize=true;this._setDataTableTimer=undefined;}.bind(this),150);}};g.prototype._applyCSS=function(o){if(this._makitChart){this._makitChart.applyCSS();}};g.prototype._getSelectedSeries=function(l){var i=this.indexOfLayer(l);if(i>=0&&this._makitChart){return this._makitChart.getSelectedSeries(l.getId());}};g.prototype._onResize=function(o){var p=document.getElementById(this.getParent().getId());var h=p.offsetHeight;var i=p.offsetWidth;if(this._parentCurrentHeight!=h&&h>0){this._setRealHeight(this.getHeight());this._parentCurrentHeight=p.offsetHeight;}if(this._makitChart!=null&&h>0&&i>0){this._makitChart.refresh();}};g.prototype._onPropertyChanged=function(o){if(!this._makitChart){return;}var n=o.mParameters["name"];var h=o.mParameters["newValue"];if(this._makitChart){if(n==="showRangeSelector"){this._makitChart.showRangeSelectorView(h);}else if(n==="legendPosition"){this._makitChart.setLegend(h.toLowerCase());}else if(n==="width"){this.getDomRef().style.width=this.getWidth();}else if(n==="height"){this._setRealHeight(h);}else if(n==="showTableValue"){this._makitChart.showTableValue(h);}else if(n==="primaryColorPalette"){this._makitChart.setPalette(h,"primaryaxis");}else if(n==="secondaryColorPalette"){this._makitChart.setPalette(h,"secondaryaxis");}else if(n==="numberOfVisibleCategories"){this._makitChart.setNumberOfVisibleCategories(h);}else if(n==="rangeSelectorStartPosition"){this._makitChart.setRangeSelectorStartPosition(h);}this._makitChart.setSelectedCategoryIndex(this._selectedCatIdx);this._makitChart.refresh();}};g.prototype._onLayerPropertyChanged=function(o){if(!this._makitChart){return;}var n=o.mParameters["name"];var h=o.mParameters["newValue"];var j=o.mParameters["oldValue"];if(this._makitChart){if(n==="type"){var l=o.getSource();var k=this.indexOfLayer(l);var p=this.getLayers();var r=p.length;var i;if(h!=f.Line){for(i=0;i<r;i++){var s=p[i].getType();if(k!=i&&s!=f.Line){l.setType(j);throw new Error("CombinationChart : "+h+" chart type cannot be combine with "+s+" chart type");}}}var t=h;if(t==f.Line){for(i=0;i<r;i++){if(p[i].getType()!=f.Line){t=p[i].getType();break;}}}var u="line";if(t==f.Bar){u="verticalline";}var v=h;if(h==f.Line){v=u;}this._makitChart.setProperty(l.getId()+".ChartType",v);for(i=0;i<r;i++){if(p[i].getType()==f.Line&&p[i].getLineType()!=u&&l!=p[i]){p[i].setLineType(u);this._makitChart.setProperty(p[i].getId()+".ChartType",u);}}}else if(n==="lineThickness"){this._makitChart.setGraphLineWidth(h,o.getSource().getId());}else if(n==="primaryColorPalette"){this._makitChart.setPalette(h,o.getSource().getId());}else if(n==="drawOnSecondaryAxis"){this._makitChart.setProperty(o.getSource().getId()+".values.SecondaryAxis",h);}this._makitChart.setSelectedCategoryIndex(this._selectedCatIdx);this._makitChart.refresh();}};g.prototype._onDataRegionPropChanged=function(o,D){if(!this._makitChart){return;}var p=o.mParameters;if(p["type"]=="values"){var i=o.getSource().getId();var h=p["index"];if(h>-1){this._makitChart.setProperty(i+"."+p["type"]+"["+h+"]."+p["name"],p["newValue"]);}}else if(p["type"]=="series"){var i=o.getSource().getId();var h=p["index"];this._makitChart.setProperty(i+"."+p["type"]+"["+h+"]."+p["name"],p["newValue"]);}else if(D!=undefined){this._makitChart.setProperty(D["type"]+"."+p["name"],p["newValue"]);}};g.prototype._onAxisPropChanged=function(o,D){e(D,"oData is expected to be set in _onAxisPropChanged");if(!this._makitChart){return;}var p=o.mParameters;var n=p["name"].toLowerCase();var v=p["newValue"];if(n==="sortorder"){v=v.toLowerCase();}if(D["axis"]=="values"){var w="primaryaxis";if(D["secondaryAxis"]){w="secondaryaxis";}this._makitChart.setProperty(w+"."+D["axis"]+"."+n,v);}else{var h=D["axis"];if(n==="displayall"){h="categories";n="display";if(!v){v="";}}this._makitChart.setProperty(h+"."+n,v);}this._makitChart.refresh();if(n==="sortorder"||n=="display"){this._setDataTable();}};g.prototype._onValueBubbleChanged=function(o){if(!this._makitChart){return;}var v=this.getValueBubble().toObject();this._makitChart.setValueBubbleStyle(v);if(this._makitChart.isValueBubbleVisible()!=v.visible){this._makitChart.showValueBubble(v.visible);}this._makitChart.refresh();};g.prototype.getSelectedCategory=function(){var s=undefined;if(this._makitChart){s=this._makitChart.getSelectedCategory();}return s;};g.prototype.getNumberOfCategories=function(){var n=undefined;if(this._makitChart){n=this._makitChart.getNumberOfCategories();}return n;};g.prototype.getSelectedCategoryGroup=function(){var s=undefined;if(this._makitChart){s=this._makitChart.getSelectedCategoryGroup();}return s;};return g;});
