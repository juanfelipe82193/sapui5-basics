/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/gantt/library","jquery.sap.global","sap/ui/core/Control","sap/ui/model/ChangeReason","sap/base/util/values","sap/ui/layout/Splitter","sap/ui/core/ResizeHandler","./InnerGanttChart","./GanttHeader","./GanttSyncedControl","../control/AssociateContainer","../axistime/ProportionZoomStrategy","./SelectionModel","./ExpandModel","./ShapeScheme","./GanttExtension","./GanttScrollExtension","./GanttZoomExtension","./GanttPointerExtension","./GanttDragDropExtension","./GanttPopoverExtension","./GanttConnectExtension","./GanttResizeExtension","./RenderUtils","../misc/Format","../misc/Utility","../config/TimeHorizon","./GanttChartWithTableRenderer"],function(l,q,C,c,v,S,R,I,G,d,A,P,e,E,f,g,h,j,k,m,n,o,p,r,F,U,T){"use strict";var s=l.simple.GanttChartWithTableDisplayType,V=l.simple.VisibleHorizonUpdateType;var t=Object.freeze({"totalHorizonUpdated":V.TotalHorizonUpdated,"mouseWheelZoom":V.MouseWheelZoom,"syncVisibleHorizon":V.SyncVisibleHorizon,"initialRender":V.InitialRender,"horizontalScroll":V.HorizontalScroll,"zoomLevelChanged":V.ZoomLevelChanged,"timePeriodZooming":V.TimePeriodZooming});var M=10;var u=60;function w(a,b){return a+b;}function x(a,b){return Math.abs(a-b)<M;}var y=C.extend("sap.gantt.simple.GanttChartWithTable",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},shapeSelectionMode:{type:"sap.gantt.SelectionMode",defaultValue:l.SelectionMode.MultiWithKeyboard},shapeSelectionSettings:{type:"object",defaultValue:null},enableCursorLine:{type:"boolean",defaultValue:true},enableNowLine:{type:"boolean",defaultValue:true},nowLineInUTC:{type:"boolean",defaultValue:true},enableVerticalLine:{type:"boolean",defaultValue:true},enableAdhocLine:{type:"boolean",defaultValue:true},adhocLineLayer:{type:"string",defaultValue:l.AdhocLineLayer.Top},dragOrientation:{type:"sap.gantt.DragOrientation",defaultValue:l.DragOrientation.Free},ghostAlignment:{type:"string",defaultValue:l.dragdrop.GhostAlignment.None},showShapeTimeOnDrag:{type:"boolean",defaultValue:false},selectionPanelSize:{type:"sap.ui.core.CSSSize",defaultValue:"30%"},displayType:{type:"sap.gantt.simple.GanttChartWithTableDisplayType",defaultValue:s.Both},disableShapeDoubleClickEvent:{type:"boolean",defaultValue:false}},aggregations:{table:{type:"sap.ui.table.Table",multiple:false},adhocLines:{type:"sap.gantt.AdhocLine",multiple:true,singularName:"adhocLine",bindable:"bindable",visibility:"public"},svgDefs:{type:"sap.gantt.def.SvgDefs",multiple:false,singularName:"svgDef"},shapeSchemes:{type:"sap.gantt.simple.ShapeScheme",multiple:true,singularName:"shapeScheme"},calendarDef:{type:"sap.gantt.def.cal.CalendarDefs",multiple:false,bindable:"bindable"},axisTimeStrategy:{type:"sap.gantt.axistime.AxisTimeStrategyBase",multiple:false,bindable:"bindable"},locale:{type:"sap.gantt.config.Locale",multiple:false},_splitter:{type:"sap.ui.layout.Splitter",multiple:false,visibility:"hidden"},_header:{type:"sap.gantt.simple.GanttHeader",multiple:false,defaultValue:null,visibility:"hidden"},_innerGantt:{type:"sap.gantt.simple.InnerGanttChart",multiple:false,visibility:"hidden"}},events:{shapeSelectionChange:{parameters:{shapeUids:{type:"string[]"}}},shapeResize:{parameters:{shapeUid:{type:"string"},shape:{type:"sap.gantt.shape.BaseShape"},rowObject:{type:"object"},oldTime:{type:"string[]"},newTime:{type:"string[]"}}},shapeMouseEnter:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},pageX:{type:"int"},pageY:{type:"int"}}},shapeMouseLeave:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},originEvent:{type:"object"}}},shapePress:{parameters:{popoverOffsetX:{type:"int"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"},shape:{type:"sap.gantt.shape.BaseShape"}},allowPreventDefault:true},shapeDoubleClick:{parameters:{popoverOffsetX:{type:"int"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"},shape:{type:"sap.gantt.shape.BaseShape"}}},shapeContextMenu:{parameters:{pageX:{type:"int"},pageY:{type:"int"},popoverOffsetX:{type:"int"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"},shape:{type:"sap.gantt.shape.BaseShape"}}},dragStart:{parameters:{sourceGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},draggedShapeDates:{type:"object"},lastDraggedShapeUid:{type:"string"},cursorDateTime:{type:"object"}}},shapeDrop:{parameters:{sourceGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},targetGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},draggedShapeDates:{type:"object"},lastDraggedShapeUid:{type:"string"},targetRow:{type:"sap.ui.table.Row"},cursorDateTime:{type:"object"},newDateTime:{type:"object"},targetShape:{type:"sap.gantt.shape.BaseShape"}}},shapeConnect:{parameters:{fromShapeUid:{type:"string"},toShapeUid:{type:"string"},type:{type:"sap.gantt.simple.RelationshipType"}}},visibleHorizonUpdate:{parameters:{type:{type:"sap.gantt.simple.VisibleHorizonUpdateType"},lastVisibleHorizon:{type:"sap.gantt.config.TimeHorizon"},currentVisibleHorizon:{type:"sap.gantt.config.TimeHorizon"}}}}}});y.prototype.init=function(){this.iGanttRenderedWidth=-1;this._bExtensionsInitialized=false;this._oExpandModel=new E();this._oSplitter=new S();this.setAggregation("_splitter",this._oSplitter);this._oSyncedControl=new d();this.setAggregation("_innerGantt",new I());this.setAggregation("_header",new G());this._sPreviousDisplayType=this.getDisplayType();};y.prototype.getInnerGantt=function(){return this.getAggregation("_innerGantt");};y.prototype.onSplitterResize=function(a){var O=a.getParameter("oldSizes"),N=a.getParameter("newSizes"),b=O.length>0&&N.length>0&&O[0]!==N[0],D=this.getDisplayType(),i=true,z=N[0];if(b){this._onResize();if(D===s.Both){if(this._sPreviousDisplayType===s.Chart){i=false;this._sPreviousDisplayType=D;}if(i&&z){this._iLastTableAreaSize=z;}}var B=function(H){return this.getSelectionPanelSize().startsWith("0")||H[0]!==0;}.bind(this);if(x(O.reduce(w),N.reduce(w))&&O[0]!==N[0]&&B(O)){this.setProperty("selectionPanelSize",z+"px",true);this.fireEvent("_selectionPanelResize",{newWidth:z,displayType:D});}this._draw();}};y.prototype.setLayoutData=function(L){this.setAggregation("layoutData",L,true);this.fireEvent("_layoutDataChange");return this;};y.prototype.setDisplayType=function(D){this._sPreviousDisplayType=this.getDisplayType();delete this._bPreventInitialRender;this.setProperty("displayType",D,false);return this;};y.prototype.applySettings=function(a,b){a=a||{};this._applyMissingSettings(a);C.prototype.applySettings.call(this,a,b);this._initSelectionModel(this.getProperty("shapeSelectionMode"));};y.prototype._applyMissingSettings=function(a){if(!a.axisTimeStrategy){a.axisTimeStrategy=new P();}if(!a.locale){a.locale=l.config.DEFAULT_LOCALE_CET.clone();}if(!a.shapeSchemes){a.shapeSchemes=[new f({key:"default",primary:true})];}else{var H=a.shapeSchemes.some(function(b){return b.getPrimary();});if(!H){q.sap.log.warning("you need set a ShapeSheme with primary:true");}}};y.prototype.getPrimaryShapeScheme=function(){return this.getShapeSchemes().filter(function(a){return a.getPrimary();})[0];};y.prototype.getSyncedControl=function(){return this._oSyncedControl;};y.prototype.getTableRowHeights=function(){return this.getSyncedControl().getRowHeights();};y.prototype.setTable=function(a){this.setAggregation("table",a);a._bVariableRowHeightEnabled=true;var O=this._oSplitter.removeContentArea(0);this._oSplitter.insertContentArea(new A({content:a,enableRootDiv:true}),0);if(O==null){this._oSyncedControl.syncWith(a);this._oSplitter.addContentArea(this._oSyncedControl);}else if(O&&O.getContent()!=a.getId()){this._oSyncedControl.syncWith(a);}a.detachEvent("_rowsUpdated",this._onTableRowsUpdated,this);a.attachEvent("_rowsUpdated",this._onTableRowsUpdated,this);};y.prototype.setEnableVariableRowHeight=function(b){if(this.getTable()){this.getTable()._bVariableRowHeightEnabled=b;}else{q.sap.log.warning("you need to set table aggregation first");}};y.prototype.getRenderedTimeRange=function(){return this.getAxisTime().getTimeRangeSlice(0,this.iGanttRenderedWidth);};y.prototype._initSelectionModel=function(a){if(this.oSelection){this.oSelection.detachSelectionChanged(this._onSelectionChanged,this);}this.oSelection=new e(a);this.oSelection.attachSelectionChanged(this._onSelectionChanged,this);return this;};y.prototype.setShapeSelectionMode=function(a){this.setProperty("shapeSelectionMode",a);if(this.oSelection){this.oSelection.setSelectionMode(a);}return this;};y.prototype.getSelectedShapeUid=function(){var a=this.oSelection.allUid();return a;};y.prototype._onSelectionChanged=function(a){var b=a.getParameter("shapeUid"),D=a.getParameter("deselectedUid"),i=a.getParameter("silent");this._updateShapeSelections(b,D);if(!i){this.fireShapeSelectionChange({shapeUids:b});}};y.prototype.handleShapePress=function(a){var b=a.shape,i=b.getShapeUid(),z=a.ctrlOrMeta;var N=!b.getSelected();this.oSelection.update(i,{selected:N,ctrl:z,draggable:b.getDraggable(),time:b.getTime(),endTime:b.getEndTime()});};y.prototype._updateShapeSelections=function(a,D){var b=this.getShapeSelectionMode();if(b===l.SelectionMode.None){return;}r.updateShapeSelections(this,a,D);};y.prototype.getSelection=function(){return this.oSelection;};y.prototype.getExpandedBackgroundData=function(){if(this._oExpandModel.hasExpandedRows()){var a=this.getTable().getRows();var b=a.length;var z=this.getTable().getFirstVisibleRow();var B=[];for(var i=0;i<b;i++){if(a[i].getIndex()>=z){var D=a[i].getAggregation("_settings");B.push(D.getRowUid());}}return this._oExpandModel.collectExpandedBgData(B);}};y.prototype.setAxisTimeStrategy=function(a){this.setAggregation("axisTimeStrategy",a,false);a.attachEvent("_redrawRequest",this._onRedrawRequest,this);return this;};y.prototype._onTableRowsUpdated=function(a){if(!this.getVisible()){return;}var b=a.getParameter("reason"),i=this.getInnerGantt();var z=v(c).slice();var B=z.concat(["Render","VerticalScroll","FirstVisibleRowChange","Resize"]);if(B.indexOf(b)!==-1){this.getSyncedControl().setAllowContentScroll(false);i.invalidate();}else{i.getRenderer().renderImmediately(this);}};y.prototype.syncVisibleHorizon=function(a,i,K,b){var z=this.getAxisTimeStrategy();var B=z.getTotalHorizon();var D;var H=this.getVisibleWidth();if(i!==undefined){if(H===undefined){return;}if(K){var J=z.getVisibleHorizon();var L=F.abapTimestampToDate(J.getStartTime());D=U.calculateHorizonByWidth(a,i,H,L);}else{D=U.calculateHorizonByWidth(a,i,H);}}else{D=a;}if(B.getEndTime()<D.getEndTime()){var N=F.abapTimestampToDate(D.getEndTime()).getTime()-F.abapTimestampToDate(D.getStartTime()).getTime();var O=F.abapTimestampToDate(B.getEndTime());var Q=new Date();Q.setTime(O.getTime()-N);D=new T({startTime:Q,endTime:O});}this._updateVisibleHorizon(D,b||"syncVisibleHorizon",H);};y.prototype._updateVisibleHorizon=function(a,b,i){var z=this.getAxisTimeStrategy();z.updateGanttVisibleWidth(i);if(a&&a.getStartTime()){z.setVisibleHorizonWithReason(a,b);}};y.prototype.syncMouseWheelZoom=function(a){this._getZoomExtension().performMouseWheelZooming(a.originEvent,true);};y.prototype.syncTimePeriodZoomOperation=function(a,b,O){this._getZoomExtension().syncTimePeriodZoomOperation(a,b,O);};y.prototype._onRedrawRequest=function(a){var b=a.getParameter("valueBeforeChange");var i=a.getParameter("reasonCode");var O=a.getParameter("originEvent");var z=this.getAxisTimeStrategy();if(b&&i!=="totalHorizonUpdated"&&i!=="initialRender"&&i!=="syncVisibleHorizon"){this.fireEvent("_initialRenderGanttChartsSync",{reasonCode:i,visibleHorizon:z.getVisibleHorizon(),visibleWidth:this.getVisibleWidth(),originEvent:O});}this.fireVisibleHorizonUpdate({type:t[i],lastVisibleHorizon:b,currentVisibleHorizon:z.getVisibleHorizon()});this.redraw(i);this._setupDisplayType();};y.prototype.redraw=function(a){this._draw(a);};y.prototype._draw=function(a){var i=this.getVisibleWidth();if(!i){return;}var b=this.getAxisTimeStrategy().syncContext(i);this.fireEvent("_zoomInfoUpdated",b);var z=this._getScrollExtension();if(b.axisTimeChanged){z.clearOffsetWidth();}z.needRerenderGantt(function(){this.getInnerGantt().getRenderer().renderImmediately(this);}.bind(this),a);};y.prototype.onBeforeRendering=function(a){this._updateRowHeightInExpandModel(this.getTable());g.detachEvents(this);this._oSplitter.detachResize(this.onSplitterResize,this);if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);}this.getInnerGantt().invalidate();};y.prototype.onAfterRendering=function(a){this._attachExtensions();g.attachEvents(this);this._oSplitter.attachResize(this.onSplitterResize,this);this._sResizeHandlerId=R.register(this,this._onResize.bind(this));};y.prototype._onResize=function(){var a=this.getAggregation("_splitter"),i=this.getDomRef().offsetWidth,L,b,z,N;if(a.getContentAreas()[0]&&a.getContentAreas()[0].getLayoutData()){L=a.getContentAreas()[0];b=L.getLayoutData();if(i<u*2){N=i/2;}else{z=L.getDomRef().offsetWidth;N=Math.max(Math.min(z,i-u),u);}b.setSize(N+"px");}};y.prototype._setupDisplayType=function(){var D=this.getDisplayType(),i,a;var b=function(a,z){var B=this._oSplitter.getContentAreas(),H=B[0].getLayoutData(),J=B[1].getLayoutData(),K=D===s.Both;H.setSize(a).setResizable(K);J.setSize(z).setResizable(K);}.bind(this);if(D===s.Table){i=this.getSyncedControl().$().find(".sapGanttBackgroundVScrollContentArea").width();if(i!==0){i+=2;}b("auto",i+"px");}else if(D===s.Chart){b("1px","auto");}else if(D!==this._sPreviousDisplayType){a=this._iLastTableAreaSize?this._iLastTableAreaSize+"px":this.getSelectionPanelSize();b(a,"auto");}};y.prototype._updateRowHeightInExpandModel=function(a){var i=a.getRowHeight();if(i===0){i=a._getDefaultRowHeight();}this._oExpandModel.setBaseRowHeight(i);};y.prototype.jumpToVisibleHorizon=function(a){this._updateVisibleHorizon(this.getAxisTimeStrategy().getVisibleHorizon(),a,this.getVisibleWidth());};y.prototype.exit=function(){if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);}this._detachExtensions();delete this._bPreventInitialRender;};y.prototype._attachExtensions=function(){if(this._bExtensionsInitialized){return;}g.enrich(this,h);g.enrich(this,j);g.enrich(this,k);g.enrich(this,m);g.enrich(this,n);g.enrich(this,o);g.enrich(this,p);this._bExtensionsInitialized=true;};y.prototype._detachExtensions=function(){g.cleanup(this);};y.prototype.getAxisTime=function(){var a=this.getAxisTimeStrategy().getAxisTime();if(!a){this.getAxisTimeStrategy().createAxisTime(this.getLocale());a=this.getAxisTimeStrategy().getAxisTime();}return a;};y.prototype.getContentWidth=function(){var a=this.getAxisTime(),b=a.getViewRange();return Math.abs(Math.ceil(b[1])-Math.ceil(b[0]));};y.prototype.getVisibleWidth=function(){return this._getScrollExtension?this._getScrollExtension().getVisibleWidth():undefined;};y.prototype.expand=function(a,b){this.toggleShapeScheme(true,a,b);};y.prototype.collapse=function(a,b){this.toggleShapeScheme(false,a,b);};y.prototype.toggleShapeScheme=function(b,a,i){var z=[];if(typeof i==="number"){z=[i];}else if(Array.isArray(i)){z=i;}if(z.length===0||!a){return;}var B=this.getShapeSchemes().filter(function(J){return J.getKey()===a;});if(B==null||B.length===0||B.length>1){return;}var D=this.getPrimaryShapeScheme();var H=this._oExpandModel.isTableRowHeightNeedChange(b,this.getTable(),z,D,B[0]);if(H){this.getTable().invalidate();}};y.prototype.isShapeVisible=function(a){if(a&&a.isVisible()){return true;}if(!a.getVisible()){return false;}var b=this.getRenderedTimeRange(),i=b[0],z=b[1];var B=a.getTime(),D=a.getEndTime();var H=function(J){return(J>=i&&J<=z);};if(a.getSelected()||!B||!D){return true;}else if(B&&D){return H(B)||H(D)||(B<=i&&D>=z);}else if(B&&!D){return H(B);}else if(!B&&D){return H(D);}};y.prototype.doBirdEye=function(i){var z=this._getZoomExtension();z.doBirdEye(i);};return y;},true);
